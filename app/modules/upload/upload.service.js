'use strict';const _0x2907ef=_0x21d6;function _0x406a(){const _0x2f0773=['当前已开启全球加速----------------->','message','getUploadConfig','../redisCache/redisCache.service','112302bXaKKA','midjourneyEntity','Injectable','error:\x20','mjNotSaveImg','getModalImgById','design:paramtypes','save','queryUploadList','../../common/utils','getService','Logger','cosSecretKey','transferImg','uploadFileByTencentCosFromUrl','originTaskId','data','object','cos-nodejs-sdk-v5','../../common/constants/redisKey.constant','__esModule','tencentCosStatus','UploadService','ali','上传图片失败[ten]','putObject','getConfigs','4564315ZsuDwW','stringify','query','mjdev','typeorm','getOwnPropertyDescriptor','default','uploadFileByAliOssFromUrl','error','aliOssBucket','metadata','ali\x20开始上传','aliOssStatus','getUploadType','http://172.247.48.137:8000','length','cosBucket','tencent','957917scnRYa','createRandomUid','mj-','taskId','上传图片失败[ALI][url]','toString','uploadFile','redisCacheService','BAD_REQUEST','post','from','split','axios','uploadFileByTencentCos','put','95XbkfqV','pop','走代理上传','env','response\x20uploaded\x20url\x20','aliCos','上传图片失败[Chevereto]','/api/upload','cheveretoKey','imageUrl','上传图片失败[Chevereto|buffer]\x20-->\x20','arraybuffer','tencentCosAcceleratedDomain','base64','COS_REGION','decorate','@nestjs/common','RedisCacheService','log','transferFile','12449136XwlcUc','请先前往后台配置上传图片的方式','chevereto','replace','4144248IgKfiB','form-data','ISDEV','transferFile\x20error:\x20','get','上传图片失败[ten][url]','uploadFileByAliOss','aliOssAccessKeyId','globalConfigService','image','set','response','append','getBufferFromUrl','../midjourney/midjourney.entity','InjectRepository','HttpException','MidjourneyEntity','mjProxyUrl','uploadFileByCheveretoFromUrl','removeSpecialCharacters','STANDARD','图床上传','tencentCos','https://','cosRegion','cosSecretId','1323808FgFmwg','cheveretoStatus','uploadFileByChevereto','cheveretoUploadPath','1869552aYaHsT','HttpStatus','mjProxy','__decorate','lock','url','上传图片失败[ali]','aliyun','上传图片失败[Chevereto][url]','findOne','onModuleInit'];_0x406a=function(){return _0x2f0773;};return _0x406a();}function _0x21d6(_0x14ffad,_0x146b1b){const _0x406a17=_0x406a();return _0x21d6=function(_0x21d6b3,_0x29fe20){_0x21d6b3=_0x21d6b3-0x1c3;let _0x2419f8=_0x406a17[_0x21d6b3];return _0x2419f8;},_0x21d6(_0x14ffad,_0x146b1b);}(function(_0x4f45c3,_0x443bc5){const _0x557d80=_0x21d6,_0x57d3d8=_0x4f45c3();while(!![]){try{const _0x17c5d2=-parseInt(_0x557d80(0x23e))/0x1+parseInt(_0x557d80(0x1fe))/0x2+parseInt(_0x557d80(0x202))/0x3+-parseInt(_0x557d80(0x1e3))/0x4+-parseInt(_0x557d80(0x1cb))/0x5*(-parseInt(_0x557d80(0x211))/0x6)+-parseInt(_0x557d80(0x22c))/0x7+parseInt(_0x557d80(0x1df))/0x8;if(_0x17c5d2===_0x443bc5)break;else _0x57d3d8['push'](_0x57d3d8['shift']());}catch(_0xf92d0d){_0x57d3d8['push'](_0x57d3d8['shift']());}}}(_0x406a,0x867ad));var __decorate=this&&this[_0x2907ef(0x205)]||function(_0x2c18f8,_0xb12d22,_0x369927,_0x40e4c5){const _0x13da40=_0x2907ef;var _0x5b3867=arguments[_0x13da40(0x23b)],_0x43221d=_0x5b3867<0x3?_0xb12d22:_0x40e4c5===null?_0x40e4c5=Object[_0x13da40(0x231)](_0xb12d22,_0x369927):_0x40e4c5,_0x55d611;if(typeof Reflect===_0x13da40(0x222)&&typeof Reflect[_0x13da40(0x1da)]==='function')_0x43221d=Reflect[_0x13da40(0x1da)](_0x2c18f8,_0xb12d22,_0x369927,_0x40e4c5);else{for(var _0x5b6591=_0x2c18f8[_0x13da40(0x23b)]-0x1;_0x5b6591>=0x0;_0x5b6591--)if(_0x55d611=_0x2c18f8[_0x5b6591])_0x43221d=(_0x5b3867<0x3?_0x55d611(_0x43221d):_0x5b3867>0x3?_0x55d611(_0xb12d22,_0x369927,_0x43221d):_0x55d611(_0xb12d22,_0x369927))||_0x43221d;}return _0x5b3867>0x3&&_0x43221d&&Object['defineProperty'](_0xb12d22,_0x369927,_0x43221d),_0x43221d;},__metadata=this&&this['__metadata']||function(_0x2376e2,_0xb8ca7){const _0xd393a=_0x2907ef;if(typeof Reflect===_0xd393a(0x222)&&typeof Reflect['metadata']==='function')return Reflect[_0xd393a(0x236)](_0x2376e2,_0xb8ca7);},__param=this&&this['__param']||function(_0x1ffeda,_0x31e30a){return function(_0x5debd5,_0x383af3){_0x31e30a(_0x5debd5,_0x383af3,_0x1ffeda);};};Object['defineProperty'](exports,_0x2907ef(0x225),{'value':!![]}),exports[_0x2907ef(0x227)]=void 0x0;const common_1=require(_0x2907ef(0x1db)),TENCENTCOS=require(_0x2907ef(0x223)),ALIOSS=require('ali-oss'),axios_1=require(_0x2907ef(0x1c8)),image_size_1=require('image-size'),streamToBuffer=require('stream-to-buffer'),utils_1=require(_0x2907ef(0x21a)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),FormData=require(_0x2907ef(0x1e4)),midjourney_entity_1=require(_0x2907ef(0x1f1)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x2907ef(0x230)),redisKey_constant_1=require(_0x2907ef(0x224)),redisCache_service_1=require(_0x2907ef(0x210)),MjConfig_1=require('../../config/MjConfig');let UploadService=class UploadService{constructor(_0x737f3c,_0x1d35b3,_0x1a5ae9){const _0x3a73b0=_0x2907ef;this[_0x3a73b0(0x212)]=_0x737f3c,this['globalConfigService']=_0x1d35b3,this['redisCacheService']=_0x1a5ae9;}async[_0x2907ef(0x20c)](){const _0x50650b=_0x2907ef,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x50650b(0x1eb)]['getConfigs']([_0x50650b(0x226),_0x50650b(0x238),_0x50650b(0x1ff)]);!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&common_1[_0x50650b(0x21c)]['error'](_0x50650b(0x1e0));if(Number(tencentCosStatus)===0x1){const {SecretId:_0x302be2,SecretKey:_0x5682cc}=await this[_0x50650b(0x20f)](_0x50650b(0x23d));this[_0x50650b(0x1fa)]=new TENCENTCOS({'SecretId':_0x302be2,'SecretKey':_0x5682cc,'FileParallelLimit':0xa});}if(Number(aliOssStatus)===0x1){const {region:_0x467289,bucket:_0xd893a3,accessKeyId:_0xb684d8,accessKeySecret:_0x1a6180}=await this[_0x50650b(0x20f)](_0x50650b(0x228));this[_0x50650b(0x1d0)]=new ALIOSS({'region':(0x0,utils_1[_0x50650b(0x1f7)])(_0x467289),'accessKeyId':_0xb684d8,'accessKeySecret':_0x1a6180,'bucket':(0x0,utils_1[_0x50650b(0x1f7)])(_0xd893a3)});}}async[_0x2907ef(0x244)](_0x180826){const _0x4ba139=_0x2907ef,{filename:_0xe1c30f,buffer:_0x18065f,dir:dir='ai'}=_0x180826,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this['globalConfigService'][_0x4ba139(0x22b)]([_0x4ba139(0x226),'aliOssStatus',_0x4ba139(0x1ff)]);if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus))throw new common_1['HttpException'](_0x4ba139(0x1e0),common_1[_0x4ba139(0x203)]['BAD_REQUEST']);if(Number(tencentCosStatus)===0x1)return this[_0x4ba139(0x1c9)]({'filename':_0xe1c30f,'buffer':_0x18065f,'dir':dir});if(Number(aliOssStatus)===0x1)return await this[_0x4ba139(0x1e9)]({'filename':_0xe1c30f,'buffer':_0x18065f,'dir':dir});if(Number(cheveretoStatus)){const {filename:_0x46df00,buffer:_0x2758e5,dir:_0xd16055}=_0x180826;return await this[_0x4ba139(0x200)]({'filename':_0x46df00,'buffer':_0x2758e5[_0x4ba139(0x243)]('base64'),'dir':_0xd16055});}}async[_0x2907ef(0x239)](){const _0x2369a6=_0x2907ef,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x2369a6(0x1eb)]['getConfigs']([_0x2369a6(0x226),'aliOssStatus','cheveretoStatus']);if(Number(tencentCosStatus))return _0x2369a6(0x23d);if(Number(aliOssStatus))return _0x2369a6(0x228);if(Number(cheveretoStatus))return _0x2369a6(0x1e1);}async['uploadFileFromUrl']({filename:_0x4d05d2,url:_0x50a117,dir:dir='mj'}){const _0x48a73e=_0x2907ef;dir=process[_0x48a73e(0x1ce)][_0x48a73e(0x1e5)]?_0x48a73e(0x22f):dir;const {tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x48a73e(0x1eb)][_0x48a73e(0x22b)]([_0x48a73e(0x226),_0x48a73e(0x238),'cheveretoStatus']);if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus))throw new common_1[(_0x48a73e(0x1f3))](_0x48a73e(0x1e0),common_1['HttpStatus'][_0x48a73e(0x1c4)]);if(Number(tencentCosStatus))return common_1[_0x48a73e(0x21c)][_0x48a73e(0x1dd)]('腾讯上传'),this['uploadFileByTencentCosFromUrl']({'filename':_0x4d05d2,'url':_0x50a117,'dir':dir});if(Number(aliOssStatus))return common_1[_0x48a73e(0x21c)][_0x48a73e(0x1dd)]('阿里上传'),await this[_0x48a73e(0x233)]({'filename':_0x4d05d2,'url':_0x50a117,'dir':dir});if(Number(cheveretoStatus))return common_1[_0x48a73e(0x21c)][_0x48a73e(0x1dd)](_0x48a73e(0x1f9)),await this[_0x48a73e(0x1f6)]({'filename':_0x4d05d2,'url':_0x50a117,'dir':dir});}async[_0x2907ef(0x1c9)]({filename:_0x18a910,buffer:_0x1200c6,dir:_0x5b58ab}){const _0x3347b7=_0x2907ef;try{const {Bucket:_0x1d8aff,Region:_0x13fc4e,SecretId:_0x3eb214,SecretKey:_0x2b8560}=await this[_0x3347b7(0x20f)](_0x3347b7(0x23d));!this[_0x3347b7(0x1fa)]&&(this['tencentCos']=new TENCENTCOS({'SecretId':_0x3eb214,'SecretKey':_0x2b8560,'FileParallelLimit':0xa}));const _0x4e7d2b=await this['tencentCos'][_0x3347b7(0x22a)]({'Bucket':(0x0,utils_1[_0x3347b7(0x1f7)])(_0x1d8aff),'Region':(0x0,utils_1['removeSpecialCharacters'])(_0x13fc4e),'Key':_0x5b58ab+'/'+(_0x18a910||(0x0,utils_1[_0x3347b7(0x23f)])()+'.png'),'StorageClass':_0x3347b7(0x1f8),'Body':_0x1200c6});let _0x300601=_0x4e7d2b['Location']['replace'](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,'https://$2');const {acceleratedDomain:_0x444e0c}=await this[_0x3347b7(0x20f)](_0x3347b7(0x23d));return _0x444e0c&&(_0x300601=_0x300601[_0x3347b7(0x1e2)](/^(https:\/\/[^/]+)(\/.*)$/,_0x3347b7(0x1fb)+_0x444e0c+'$2'),console['log'](_0x3347b7(0x20d),_0x300601)),_0x300601;}catch(_0x331939){console['log']('error:\x20',_0x331939);throw new common_1['HttpException'](_0x3347b7(0x229),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x2907ef(0x21f)]({filename:_0x4ef3aa,url:_0x3df7e9,dir:_0x4273bd}){const _0x22fe55=_0x2907ef,{Bucket:_0x47f604,Region:_0x1bc7e0,SecretId:_0x47096e,SecretKey:_0x523bf1}=await this['getUploadConfig'](_0x22fe55(0x23d));try{const _0x5aa815=await this['globalConfigService']['getConfigs'](['mjProxy'])||0x0;if(Number(_0x5aa815)===0x1){const _0x163051={'cosType':'tencent','url':_0x3df7e9,'cosParams':{'Bucket':_0x47f604,'Region':_0x1bc7e0,'SecretId':_0x47096e,'SecretKey':_0x523bf1}},_0x3c65fd=await this[_0x22fe55(0x1eb)]['getConfigs']([_0x22fe55(0x1f5)]);console[_0x22fe55(0x1dd)](_0x22fe55(0x1cd));const _0x47f33f=await axios_1[_0x22fe55(0x232)][_0x22fe55(0x1c5)](_0x3c65fd+_0x22fe55(0x1d2),_0x163051,{'timeout':0xa*0x3c*0x3e8});if(!_0x47f33f[_0x22fe55(0x221)])throw new common_1[(_0x22fe55(0x1f3))]('上传图片失败[ten][url]',common_1[_0x22fe55(0x203)]['BAD_REQUEST']);let _0x35b1f8=_0x47f33f['data'];const {acceleratedDomain:_0x4ea2c5}=await this[_0x22fe55(0x20f)]('tencent');return _0x4ea2c5&&(_0x35b1f8=_0x35b1f8[_0x22fe55(0x1e2)](/^(https:\/\/[^/]+)(\/.*)$/,_0x22fe55(0x1fb)+_0x4ea2c5+'$2'),console[_0x22fe55(0x1dd)](_0x22fe55(0x20d))),console[_0x22fe55(0x1dd)](_0x22fe55(0x1cf),_0x35b1f8),_0x35b1f8;}else{const _0x392d79=await this['getBufferFromUrl'](_0x3df7e9);return await this[_0x22fe55(0x1c9)]({'filename':_0x4ef3aa,'buffer':_0x392d79,'dir':_0x4273bd});}}catch(_0x176be4){console[_0x22fe55(0x1dd)]('TODO->error:\x20\x20',_0x176be4);throw new common_1['HttpException'](_0x22fe55(0x1e8),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x2907ef(0x1e9)]({filename:_0x33669b,buffer:_0xd5a721,dir:_0x2f33f2}){const _0x1a1aa4=_0x2907ef;if(!this[_0x1a1aa4(0x1d0)]){const {region:_0x326e19,bucket:_0x310017,accessKeyId:_0x13585a,accessKeySecret:_0x17eba3}=await this[_0x1a1aa4(0x20f)](_0x1a1aa4(0x228));this[_0x1a1aa4(0x1d0)]=new ALIOSS({'region':(0x0,utils_1[_0x1a1aa4(0x1f7)])(_0x326e19),'accessKeyId':_0x13585a,'accessKeySecret':_0x17eba3,'bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x310017)});}try{console[_0x1a1aa4(0x1dd)](_0x1a1aa4(0x237));const _0x581c1a=await this['aliCos'][_0x1a1aa4(0x1ca)](_0x2f33f2+'/'+(_0x33669b||(0x0,utils_1[_0x1a1aa4(0x23f)])()+'.png'),_0xd5a721);return _0x581c1a[_0x1a1aa4(0x207)];}catch(_0x54d008){throw new common_1[(_0x1a1aa4(0x1f3))](_0x1a1aa4(0x208),common_1[_0x1a1aa4(0x203)]['BAD_REQUEST']);}}async[_0x2907ef(0x233)]({filename:_0x476a60,url:_0x5f1827,dir:_0x368694}){const _0x1ce26c=_0x2907ef,{region:_0xb2888e,bucket:_0x227d79,accessKeyId:_0x410af3,accessKeySecret:_0x331fe9}=await this['getUploadConfig'](_0x1ce26c(0x228));try{const _0x1d0702=await this[_0x1ce26c(0x1eb)][_0x1ce26c(0x22b)]([_0x1ce26c(0x204)])||0x0;if(Number(_0x1d0702)===0x1){const _0x1d03d8={'url':_0x5f1827,'cosParams':{'region':_0xb2888e,'bucket':_0x227d79,'accessKeyId':_0x410af3,'accessKeySecret':_0x331fe9},'cosType':_0x1ce26c(0x209)},_0x4515ff=await this['globalConfigService']['getConfigs']([_0x1ce26c(0x1f5)])||_0x1ce26c(0x23a),_0x16bffc=await axios_1[_0x1ce26c(0x232)][_0x1ce26c(0x1c5)](_0x4515ff+_0x1ce26c(0x1d2),_0x1d03d8,{'timeout':0xa*0x3c*0x3e8});if(!_0x16bffc?.[_0x1ce26c(0x221)])throw new common_1['HttpException'](_0x1ce26c(0x242),common_1[_0x1ce26c(0x203)][_0x1ce26c(0x1c4)]);return _0x16bffc['data'];}else{const _0x18ef36=await this[_0x1ce26c(0x1f0)](_0x5f1827);return await this[_0x1ce26c(0x1e9)]({'filename':_0x476a60,'buffer':_0x18ef36,'dir':_0x368694});}}catch(_0x274ce6){throw new common_1[(_0x1ce26c(0x1f3))](_0x1ce26c(0x242),common_1[_0x1ce26c(0x203)][_0x1ce26c(0x1c4)]);}}async[_0x2907ef(0x200)]({filename:filename='',buffer:_0x6dca75,dir:dir='ai'}){const _0x1d0b77=_0x2907ef,{key:_0x495b96,uploadPath:_0x25315c}=await this[_0x1d0b77(0x20f)](_0x1d0b77(0x1e1)),_0xdc097c=new FormData();_0xdc097c[_0x1d0b77(0x1ef)]('source',_0x6dca75[_0x1d0b77(0x243)]('base64')),_0xdc097c[_0x1d0b77(0x1ef)]('key',_0x495b96);try{const _0x2f4ac5=await axios_1[_0x1d0b77(0x232)][_0x1d0b77(0x1c5)](_0x25315c,_0xdc097c,{'headers':{'X-API-Key':_0x495b96},'timeout':0xa*0x3c*0x3e8});if(_0x2f4ac5?.['status']===0xc8)return _0x2f4ac5[_0x1d0b77(0x221)][_0x1d0b77(0x1ec)][_0x1d0b77(0x207)];else{common_1[_0x1d0b77(0x21c)][_0x1d0b77(0x234)](_0x1d0b77(0x1d1),JSON[_0x1d0b77(0x22d)](_0x2f4ac5[_0x1d0b77(0x221)]));throw new Error(_0x1d0b77(0x1d1));}}catch(_0x4a6750){console[_0x1d0b77(0x1dd)](_0x1d0b77(0x214),_0x4a6750['response']);throw new common_1[(_0x1d0b77(0x1f3))](_0x1d0b77(0x1d5)+_0x4a6750[_0x1d0b77(0x1ee)]?.[_0x1d0b77(0x221)]['error'][_0x1d0b77(0x20e)],common_1[_0x1d0b77(0x203)][_0x1d0b77(0x1c4)]);}}async[_0x2907ef(0x1f6)]({filename:_0x31aca2,url:_0x373cc2,dir:_0x231f27}){const _0x2f23f9=_0x2907ef;try{const _0x30c1ca=await this['globalConfigService'][_0x2f23f9(0x22b)]([_0x2f23f9(0x204)])||0x0;if(Number(_0x30c1ca)===0x1){const {key:_0x538b29,uploadPath:_0x864923}=await this['getUploadConfig']('chevereto'),_0x150fec={'cosType':_0x2f23f9(0x1e1),'url':_0x373cc2,'cosParams':{'key':_0x538b29,'uploadPath':_0x864923}},_0x4f9e84=await this[_0x2f23f9(0x1eb)]['getConfigs'](['mjProxyUrl'])||'http://172.247.48.137:8000',_0x549690=await axios_1[_0x2f23f9(0x232)][_0x2f23f9(0x1c5)](_0x4f9e84+'/api/upload',_0x150fec,{'timeout':0xa*0x3c*0x3e8});if(!_0x549690[_0x2f23f9(0x221)])throw new common_1['HttpException'](_0x2f23f9(0x20a),common_1[_0x2f23f9(0x203)][_0x2f23f9(0x1c4)]);return _0x549690[_0x2f23f9(0x221)];}else{const _0x4e9e04=await this['getBufferFromUrl'](_0x373cc2);return await this['uploadFileByChevereto']({'filename':_0x31aca2,'buffer':_0x4e9e04,'dir':_0x231f27});}}catch(_0x3d48b7){console[_0x2f23f9(0x1dd)]('error:\x20',_0x3d48b7);throw new common_1[(_0x2f23f9(0x1f3))](_0x3d48b7[_0x2f23f9(0x1ee)],common_1[_0x2f23f9(0x203)]['BAD_REQUEST']);}}async[_0x2907ef(0x20f)](_0x3ea51c){const _0x131409=_0x2907ef;if(_0x3ea51c===_0x131409(0x228)){const {aliOssRegion:_0x13fe02,aliOssBucket:_0x4ce04e,aliOssAccessKeyId:_0x4aef09,aliOssAccessKeySecret:_0x2f39d7}=await this[_0x131409(0x1eb)][_0x131409(0x22b)](['aliOssRegion',_0x131409(0x235),_0x131409(0x1ea),'aliOssAccessKeySecret']);return{'region':_0x13fe02,'bucket':_0x4ce04e,'accessKeyId':_0x4aef09,'accessKeySecret':_0x2f39d7};}if(_0x3ea51c===_0x131409(0x23d)){const {cosBucket:_0x3e01c8,cosRegion:_0x4a17b3,cosSecretId:_0x834f4e,cosSecretKey:_0x4672fd,tencentCosAcceleratedDomain:_0x7c7ad7}=await this[_0x131409(0x1eb)][_0x131409(0x22b)]([_0x131409(0x23c),_0x131409(0x1fc),_0x131409(0x1fd),_0x131409(0x21d),_0x131409(0x1d7)]);return{'Bucket':_0x3e01c8,'Region':_0x4a17b3,'SecretId':_0x834f4e,'SecretKey':_0x4672fd,'acceleratedDomain':_0x7c7ad7};}if(_0x3ea51c===_0x131409(0x1e1)){const {cheveretoKey:_0x2bfbe5,cheveretoUploadPath:_0x41d2ef}=await this['globalConfigService'][_0x131409(0x22b)]([_0x131409(0x1d3),_0x131409(0x201)]);return{'key':_0x2bfbe5,'uploadPath':_0x41d2ef};}}async[_0x2907ef(0x1f0)](_0x2195b6){const _0x512464=_0x2907ef,_0x122660=await axios_1[_0x512464(0x232)][_0x512464(0x1e7)](_0x2195b6,{'responseType':'stream'});return new Promise((_0xfcb0fb,_0x34cdba)=>{const _0x283567=_0x512464;streamToBuffer(_0x122660[_0x283567(0x221)],(_0x38ab9e,_0x3a1551)=>{const _0x58e1fc=_0x283567;if(_0x38ab9e)throw new common_1['HttpException']('获取图片资源失败、请重新试试吧！',common_1[_0x58e1fc(0x203)][_0x58e1fc(0x1c4)]);else _0xfcb0fb(_0x3a1551);});});}async[_0x2907ef(0x219)](_0x411787,_0x37a6f5){const _0x4c4f1e=_0x2907ef,{cosBucket:_0x3057dd,cosRegion:_0x25a5ba,cosSecretId:_0x3fe541,cosSecretKey:_0xe5d76a,tencentCosAcceleratedDomain:_0x1aa2dc}=await this['globalConfigService'][_0x4c4f1e(0x22b)]([_0x4c4f1e(0x23c),'cosRegion',_0x4c4f1e(0x1fd),'cosSecretKey',_0x4c4f1e(0x1d7)]);this[_0x4c4f1e(0x1fa)]=new TENCENTCOS({'SecretId':_0x3fe541,'SecretKey':_0xe5d76a,'FileParallelLimit':0xa}),this[_0x4c4f1e(0x1fa)][_0x4c4f1e(0x21b)]({'Region':_0x4c4f1e(0x1d9)},function(_0x1e2d62,_0x4210dc){const _0x298371=_0x4c4f1e;console[_0x298371(0x1dd)](_0x1e2d62||_0x4210dc);});}async[_0x2907ef(0x1de)](_0x47e3cd){const _0xf5b273=_0x2907ef;try{const _0xb55042=await axios_1[_0xf5b273(0x232)][_0xf5b273(0x1e7)](_0x47e3cd,{'responseType':_0xf5b273(0x1d6)}),_0x2eee17=_0x47e3cd[_0xf5b273(0x1c7)]('/')[_0xf5b273(0x1cc)](),_0x1896d6=await this[_0xf5b273(0x244)]({'filename':_0x2eee17,'buffer':_0xb55042[_0xf5b273(0x221)]});return _0x1896d6;}catch(_0x31fd7f){return common_1[_0xf5b273(0x21c)][_0xf5b273(0x234)](_0xf5b273(0x1e6),_0x31fd7f),null;}}async[_0x2907ef(0x21e)](_0x41bba0,_0x492a91){const _0x4fd8a9=_0x2907ef,_0x24daed=redisKey_constant_1['MJ_IMG_TRANSFER']+_0x41bba0;try{const _0x314fd9=await this[_0x4fd8a9(0x1c3)][_0x4fd8a9(0x1e7)]({'key':_0x24daed});if(_0x314fd9)return;this[_0x4fd8a9(0x1c3)][_0x4fd8a9(0x1ed)]({'key':_0x24daed,'val':_0x4fd8a9(0x206)});const _0x2e561b=await axios_1[_0x4fd8a9(0x232)][_0x4fd8a9(0x1e7)](_0x492a91,{'responseType':'arraybuffer'}),{width:_0x55481f,height:_0x57d3ad}=await(0x0,image_size_1[_0x4fd8a9(0x232)])(_0x2e561b[_0x4fd8a9(0x221)]);!MjConfig_1[_0x4fd8a9(0x232)][_0x4fd8a9(0x215)]&&(_0x492a91=await this[_0x4fd8a9(0x244)]({'filename':_0x4fd8a9(0x240)+_0x41bba0+'.png','buffer':_0x2e561b[_0x4fd8a9(0x221)]})),await this[_0x4fd8a9(0x212)][_0x4fd8a9(0x218)]({'id':_0x41bba0,'imageUrl':_0x492a91,'fileInfo':JSON[_0x4fd8a9(0x22d)]({'width':_0x55481f,'height':_0x57d3ad})});}catch(_0x5fe351){common_1[_0x4fd8a9(0x21c)]['error'](_0x24daed,'：',_0x5fe351);}finally{this[_0x4fd8a9(0x1c3)]['del']({'key':_0x24daed});}}async[_0x2907ef(0x216)](_0x185de3){const _0x37784d=_0x2907ef,_0x2c9518=await this[_0x37784d(0x212)][_0x37784d(0x20b)]({'where':{'id':Number(_0x185de3[_0x37784d(0x22e)][_0x37784d(0x241)])}}),_0x417bda=await this['midjourneyEntity']['findOne']({'where':{'id':Number(_0x2c9518[_0x37784d(0x220)])}}),_0x51071a=await axios_1[_0x37784d(0x232)][_0x37784d(0x1e7)](_0x417bda[_0x37784d(0x1d4)],{'responseType':_0x37784d(0x1d6)}),_0x71eba0=Buffer[_0x37784d(0x1c6)](_0x51071a[_0x37784d(0x221)])['toString'](_0x37784d(0x1d8));return'data:image/jpeg;base64,'+_0x71eba0;}};UploadService=__decorate([(0x0,common_1[_0x2907ef(0x213)])(),__param(0x0,(0x0,typeorm_1[_0x2907ef(0x1f2)])(midjourney_entity_1[_0x2907ef(0x1f4)])),__metadata(_0x2907ef(0x217),[typeorm_2['Repository'],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x2907ef(0x1dc)]])],UploadService),exports[_0x2907ef(0x227)]=UploadService;