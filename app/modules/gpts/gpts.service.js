'use strict';const _0x43b745=_0x46a1;function _0x2301(){const _0x1da7f4=['then','2842yqvvie','modelId','342770gkDdUf','chatLogService','清空失败！','canAudio','https://api.openai.com','relModel','1654412rmflbL','id\x20=\x20:id','reduce','set','headers','../chatLog/chatLog.service','getGroupInfoFromId','useCount','handleRemoveGroup','APP','log','modelInfo','当前应用已经开启了一个对话无需新建了！','248165IaEfZI','onModuleInit','删除失败！','handleUpdateGroup','where','design:paramtypes','saveGptsUseLog','4959594tNunNu','get','filter','handleGetChat','Logger','gptsGroupEntity','has','modelName','InjectRepository','error:\x20','title','getModelByType','UNAUTHORIZED','ceil','message','gptsModelEntity','应用分类不存在！','defineProperty','assign','demoData','split','axios','delAllGptsChat','模型组已存在！','name','handleQueryGroup','18Mkuvrq','save','JWT_SECRET','@nestjs/common','allGroupMap','cleared\x20model\x20length','canUpload','groupName','模型组不存在,无法删除！','../app/userApps.entity','favorite','模型组不存在！','removeLogsBatch','findAndCount','use_cnt','getAllGptsFormNetworkStore','isSticky','BAD_REQUEST','UserAppsEntity','logo','非法操作、您在使用一个不存在的应用！','更新对话失败！','./gpts.group.entity','find','delete','handleAddGroup','map','GptsModelEntity','popular','data','cleanAllGptOnlyOne','非法操作、您在使用一个未启用的应用！','verify','Equal','gptsChatEntity','desc','super','add','status','useToken\x20+\x20','getExistGpts','新对话','env','5608vgldeE','../../common/utils','appId','非法操作、您在删除一个非法资源！','stringify','EModelType','GptsChatEntity','HttpStatus','201LrFgWv','getOwnPropertyDescriptor','authorization','includes','key','Repository','ChatLogService','模型不存在！','tempModalMap','groupId','findOne','IsNull','error','config','Like','catch','typeorm','modelsService','gid','mine','default','handleGetGroup','useCount\x20+\x201','userAppsEntity','affected','hideString','handleCreateChat','info','HttpException','execute','请先登录！','110YBzvpc','random','DESC','object','user','delGptsChat','function','decorate','order','initAllModelGroups','push','gptsApp','update','forEach','__param','handleQueryGpts','Injectable','GptsGroupEntity','当前用户没有创建GPT对话！','userId','createQueryBuilder','jsonwebtoken','__decorate','metadata','listByFrontType','updateGptsChat','length','442628LQpkXE','GptsService','应用类型不可更改！','7778iXfazY','role','模型组存在GPTS应用,不允许删除！','author_name'];_0x2301=function(){return _0x1da7f4;};return _0x2301();}(function(_0x517f9c,_0x56cb66){const _0x2948f9=_0x46a1,_0x382de6=_0x517f9c();while(!![]){try{const _0x2fdc52=-parseInt(_0x2948f9(0x238))/0x1+parseInt(_0x2948f9(0x23b))/0x2*(parseInt(_0x2948f9(0x1fe))/0x3)+parseInt(_0x2948f9(0x248))/0x4+-parseInt(_0x2948f9(0x255))/0x5*(-parseInt(_0x2948f9(0x276))/0x6)+-parseInt(_0x2948f9(0x240))/0x7*(parseInt(_0x2948f9(0x1f6))/0x8)+parseInt(_0x2948f9(0x25c))/0x9+parseInt(_0x2948f9(0x242))/0xa*(-parseInt(_0x2948f9(0x21d))/0xb);if(_0x2fdc52===_0x56cb66)break;else _0x382de6['push'](_0x382de6['shift']());}catch(_0x3810b5){_0x382de6['push'](_0x382de6['shift']());}}}(_0x2301,0x4a3ff));var __decorate=this&&this[_0x43b745(0x233)]||function(_0x4f1839,_0x176717,_0x4c2a11,_0x52136b){const _0x26b85a=_0x43b745;var _0x1cf338=arguments[_0x26b85a(0x237)],_0x3c22f1=_0x1cf338<0x3?_0x176717:_0x52136b===null?_0x52136b=Object[_0x26b85a(0x1ff)](_0x176717,_0x4c2a11):_0x52136b,_0x53aaa5;if(typeof Reflect===_0x26b85a(0x220)&&typeof Reflect[_0x26b85a(0x224)]===_0x26b85a(0x223))_0x3c22f1=Reflect['decorate'](_0x4f1839,_0x176717,_0x4c2a11,_0x52136b);else{for(var _0x367be1=_0x4f1839[_0x26b85a(0x237)]-0x1;_0x367be1>=0x0;_0x367be1--)if(_0x53aaa5=_0x4f1839[_0x367be1])_0x3c22f1=(_0x1cf338<0x3?_0x53aaa5(_0x3c22f1):_0x1cf338>0x3?_0x53aaa5(_0x176717,_0x4c2a11,_0x3c22f1):_0x53aaa5(_0x176717,_0x4c2a11))||_0x3c22f1;}return _0x1cf338>0x3&&_0x3c22f1&&Object[_0x26b85a(0x26d)](_0x176717,_0x4c2a11,_0x3c22f1),_0x3c22f1;},__metadata=this&&this['__metadata']||function(_0x272f0a,_0x334986){const _0x39df83=_0x43b745;if(typeof Reflect==='object'&&typeof Reflect[_0x39df83(0x234)]===_0x39df83(0x223))return Reflect['metadata'](_0x272f0a,_0x334986);},__param=this&&this[_0x43b745(0x22b)]||function(_0x1ba965,_0x515c22){return function(_0x226d9f,_0x10bc73){_0x515c22(_0x226d9f,_0x10bc73,_0x1ba965);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x43b745(0x239)]=void 0x0;const common_1=require(_0x43b745(0x279)),typeorm_1=require('@nestjs/typeorm'),gpts_group_entity_1=require(_0x43b745(0x1e1)),typeorm_2=require(_0x43b745(0x20e)),gpts_model_entity_1=require('./gpts.model.entity'),axios_1=require(_0x43b745(0x271)),jwt=require(_0x43b745(0x232)),gpts_chat_entity_1=require('./gpts.chat.entity'),chatLog_service_1=require(_0x43b745(0x24d)),utils_1=require(_0x43b745(0x1f7)),models_service_1=require('../models/models.service'),userApps_entity_1=require(_0x43b745(0x27f)),model_constant_1=require('../../common/constants/model.constant');let GptsService=class GptsService{constructor(_0x1ca402,_0x3e1843,_0x4999b5,_0x2775ae,_0x24d2a5,_0x956c8c){const _0x42540d=_0x43b745;this['userAppsEntity']=_0x1ca402,this[_0x42540d(0x261)]=_0x3e1843,this[_0x42540d(0x26b)]=_0x4999b5,this[_0x42540d(0x1ed)]=_0x2775ae,this[_0x42540d(0x20f)]=_0x24d2a5,this['chatLogService']=_0x956c8c,this[_0x42540d(0x27a)]={},this[_0x42540d(0x206)]=new Map();}async[_0x43b745(0x256)](){const _0x6dd802=_0x43b745;await this[_0x6dd802(0x226)]();}async[_0x43b745(0x226)](){const _0x40687b=_0x43b745;this[_0x40687b(0x27a)]={};const _0x4dd873=await this[_0x40687b(0x261)]['find']();if(_0x4dd873['length']===0x0)return![];return this[_0x40687b(0x27a)]=_0x4dd873['reduce']((_0x4574f7,_0x3a2396)=>{const _0x39c305=_0x40687b;return _0x4574f7[_0x3a2396['id']]={'groupName':_0x3a2396[_0x39c305(0x27d)]},_0x4574f7;},{}),!![];}async[_0x43b745(0x285)](){const _0x62ef73=_0x43b745,_0x4552d2=await axios_1[_0x62ef73(0x212)][_0x62ef73(0x25d)]('https://gpts.ddaiai.com/open/gpts')[_0x62ef73(0x23f)](_0x57c2d4=>_0x57c2d4[_0x62ef73(0x1e8)]);if(_0x4552d2&&_0x4552d2['gpts']){const {gpts:_0xcc8c61}=_0x4552d2;if(_0xcc8c61['length']){const _0x5e5684=_0xcc8c61[_0x62ef73(0x1e5)](_0x16b867=>{const _0x18c92f=_0x62ef73;return{'groupId':0x1,'useCount':~~_0x16b867[_0x18c92f(0x284)],'modelId':_0x16b867[_0x18c92f(0x210)],'logo':_0x16b867[_0x18c92f(0x289)],'desc':_0x16b867[_0x18c92f(0x219)],'modelName':_0x16b867[_0x18c92f(0x274)],'remark':_0x16b867[_0x18c92f(0x23e)]};});await this[_0x62ef73(0x26b)][_0x62ef73(0x277)](_0x5e5684);}}}async[_0x43b745(0x1e9)](){const _0x2bb02d=_0x43b745,_0x526434=await this[_0x2bb02d(0x26b)][_0x2bb02d(0x1e2)]();if(_0x526434[_0x2bb02d(0x237)]===0x0)return;let _0x525df8={};const _0x1fc64d=_0x526434[_0x2bb02d(0x24a)]((_0xba3f55,_0x24b097)=>{const _0x409c76=_0x2bb02d;return!_0x525df8[_0x24b097[_0x409c76(0x263)]]&&(_0x525df8[_0x24b097[_0x409c76(0x263)]]=_0x24b097[_0x409c76(0x263)],_0xba3f55[_0x409c76(0x227)](_0x24b097)),_0xba3f55;},[]);_0x1fc64d[_0x2bb02d(0x237)]>0x0&&(console[_0x2bb02d(0x252)](_0x2bb02d(0x27b),_0x1fc64d[_0x2bb02d(0x237)]),await this[_0x2bb02d(0x26b)][_0x2bb02d(0x277)](_0x1fc64d));}async[_0x43b745(0x1e4)](_0x30fba1){const _0x3606d4=_0x43b745;try{const {groupName:_0x5b9e7e}=_0x30fba1,_0x133523=await this[_0x3606d4(0x261)][_0x3606d4(0x208)]({'where':{'groupName':_0x5b9e7e}});if(_0x133523)throw new common_1[(_0x3606d4(0x21a))](_0x3606d4(0x273),common_1[_0x3606d4(0x1fd)][_0x3606d4(0x287)]);const _0x13db4c=await this[_0x3606d4(0x261)][_0x3606d4(0x277)]({..._0x30fba1})['then'](_0x14320c=>!!_0x14320c);return await this[_0x3606d4(0x226)](),_0x13db4c;}catch(_0x37d7a1){console[_0x3606d4(0x252)]('error:\x20',_0x37d7a1);}}async[_0x43b745(0x258)](_0x57f0ef){const _0x31aa0d=_0x43b745;try{const {id:_0x5e572c,timeout:_0x4ebcb5,groupName:_0xf6c178,status:_0x1a18e8,weight:_0x39159f,key:_0x5361f2,deductType:_0x28a1ef,deduct:_0x3d9d53,maxRounds:_0xaf3428,maxResponseTokens:_0x25fd32,maxModelTokens:_0x5b2449,useToken:_0x4a4dae,useCount:_0xf8245a,remark:_0x595733,proxyUrl:_0x2eb9e1,groupLogo:_0x957822}=_0x57f0ef,_0x3c3b4f=await this[_0x31aa0d(0x261)][_0x31aa0d(0x208)]({'where':{'id':_0x5e572c}});if(!_0x3c3b4f)throw new common_1[(_0x31aa0d(0x21a))](_0x31aa0d(0x281),common_1[_0x31aa0d(0x1fd)][_0x31aa0d(0x287)]);const _0x317e73=await this[_0x31aa0d(0x261)]['update'](_0x5e572c,{'groupName':_0xf6c178,'timeout':_0x4ebcb5,'status':_0x1a18e8,'weight':_0x39159f,'key':_0x5361f2,'deductType':_0x28a1ef,'deduct':_0x3d9d53,'maxRounds':_0xaf3428,'maxResponseTokens':_0x25fd32,'maxModelTokens':_0x5b2449,'useToken':_0x4a4dae,'useCount':_0xf8245a,'remark':_0x595733,'proxyUrl':_0x2eb9e1,'groupLogo':_0x957822})['then'](_0x3356b1=>_0x3356b1[_0x31aa0d(0x216)]>0x0);return await this['initAllModelGroups'](),_0x317e73;}catch(_0x5de9c8){throw new common_1['HttpException'](_0x5de9c8,common_1[_0x31aa0d(0x1fd)][_0x31aa0d(0x287)]);}}async[_0x43b745(0x250)](_0x5f094b){const _0x760fba=_0x43b745,{id:_0x4054a3}=_0x5f094b,_0x1600eb=await this['gptsGroupEntity'][_0x760fba(0x208)]({'where':{'id':_0x4054a3}});if(!_0x1600eb)throw new common_1[(_0x760fba(0x21a))](_0x760fba(0x27e),common_1[_0x760fba(0x1fd)][_0x760fba(0x287)]);const _0x19b857=await this[_0x760fba(0x26b)]['count']({'where':{'groupId':_0x1600eb['id']}});if(_0x19b857>0x0)throw new common_1['HttpException'](_0x760fba(0x23d),common_1[_0x760fba(0x1fd)][_0x760fba(0x287)]);else{const _0x187728=await this[_0x760fba(0x261)]['delete']({'id':_0x4054a3})['then'](_0x3d0b50=>_0x3d0b50[_0x760fba(0x216)]>0x0);return await this[_0x760fba(0x226)](),_0x187728;}}async[_0x43b745(0x275)](_0x1cfefc,_0x402c83){const _0x3b8f8b=_0x43b745;try{const {groupName:_0x1ffb3d,page:page=0x1,status:_0x164e76,size:size=0x14}=_0x1cfefc,_0x3edd95={};_0x1ffb3d&&(_0x3edd95[_0x3b8f8b(0x27d)]=_0x1ffb3d),_0x164e76>=0x0&&(_0x3edd95[_0x3b8f8b(0x1f1)]=_0x164e76);const _0x3b22ec=_0x402c83[_0x3b8f8b(0x221)][_0x3b8f8b(0x23c)],_0x39323f=_0x3b22ec===_0x3b8f8b(0x1ef);return await this['gptsGroupEntity']['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x3edd95,'order':{'weight':_0x3b8f8b(0x21f),'id':_0x3b8f8b(0x21f)}})['then'](([_0x2771e2,_0x3ef6a8])=>({'rows':_0x2771e2[_0x3b8f8b(0x1e5)](_0x596266=>{const _0x512bef=_0x3b8f8b;return{..._0x596266,'key':_0x39323f?_0x596266[_0x512bef(0x202)]:(0x0,utils_1[_0x512bef(0x217)])(_0x596266['key'])};}),'count':_0x3ef6a8}))[_0x3b8f8b(0x20d)](_0x11b58c=>{throw new Error(_0x11b58c);});}catch(_0x474d1c){console[_0x3b8f8b(0x252)](_0x3b8f8b(0x265),_0x474d1c);throw new common_1['HttpException'](_0x474d1c,common_1[_0x3b8f8b(0x1fd)][_0x3b8f8b(0x287)]);}}async[_0x43b745(0x213)](_0x2359f9,_0x5c38b9){const _0xf4f940=_0x43b745;try{const _0x244865=_0x5c38b9[_0xf4f940(0x221)]['role'],_0x48a65e=_0x244865==='super',{groupId:_0x244cfc}=_0x2359f9;return await this[_0xf4f940(0x261)][_0xf4f940(0x208)]({'where':{'id':Number(_0x244cfc)}})[_0xf4f940(0x23f)](_0x14af22=>{const _0x2e30fb=_0xf4f940;return{..._0x14af22,'key':_0x48a65e?_0x14af22[_0x2e30fb(0x202)]:(0x0,utils_1['hideString'])(_0x14af22['key'])};})[_0xf4f940(0x20d)](_0x3d9893=>{throw new Error(_0x3d9893);});}catch(_0x5bcb74){console[_0xf4f940(0x252)](_0xf4f940(0x265),_0x5bcb74);throw new common_1[(_0xf4f940(0x21a))](_0x5bcb74,common_1[_0xf4f940(0x1fd)]['BAD_REQUEST']);}}async['handleAddGpts'](_0x429cc6,_0x42dadf){const _0x55629d=_0x43b745;try{const _0x4c8fe4=_0x429cc6['user']['id'],_0x1da7b5=Object[_0x55629d(0x26e)](new gpts_model_entity_1[(_0x55629d(0x1e6))](),_0x42dadf);_0x1da7b5[_0x55629d(0x1f1)]=Number(_0x42dadf[_0x55629d(0x1f1)]);if(_0x1da7b5['id']){const _0x4575e7=await this[_0x55629d(0x26b)][_0x55629d(0x208)]({'where':{'id':_0x1da7b5['id']}});if(!_0x4575e7)throw new common_1[(_0x55629d(0x21a))](_0x55629d(0x205),common_1[_0x55629d(0x1fd)]['BAD_REQUEST']);if(_0x4575e7[_0x55629d(0x228)]!==_0x1da7b5[_0x55629d(0x228)])throw new common_1[(_0x55629d(0x21a))](_0x55629d(0x23a),common_1['HttpStatus'][_0x55629d(0x287)]);return await this[_0x55629d(0x26b)][_0x55629d(0x229)]({'id':_0x1da7b5['id']},{..._0x1da7b5,'useCount':_0x1da7b5['useCount']??_0x4575e7[_0x55629d(0x24f)],'collectCount':_0x1da7b5['collectCount']??_0x4575e7['collectCount']})['then'](_0x2b4eb5=>_0x2b4eb5['affected']>0x0)[_0x55629d(0x20d)](_0x3755c4=>{throw new Error(_0x3755c4);});}else{const _0x9c9deb=await this[_0x55629d(0x261)][_0x55629d(0x208)]({'where':{'id':_0x1da7b5[_0x55629d(0x207)]}});if(!_0x9c9deb)throw new common_1['HttpException'](_0x55629d(0x26c),common_1[_0x55629d(0x1fd)][_0x55629d(0x287)]);return await this[_0x55629d(0x26b)][_0x55629d(0x277)]({..._0x1da7b5,'userId':_0x4c8fe4})[_0x55629d(0x23f)](_0x3c49a1=>!!_0x3c49a1)[_0x55629d(0x20d)](_0x396c5f=>{throw new Error(_0x396c5f);});}}catch(_0x18d505){throw new common_1[(_0x55629d(0x21a))](_0x18d505,common_1['HttpStatus'][_0x55629d(0x287)]);}}async[_0x43b745(0x1f3)](){const _0x32264c=_0x43b745;return await this['gptsModelEntity'][_0x32264c(0x1e2)]()[_0x32264c(0x23f)](_0x1beb7d=>_0x1beb7d[_0x32264c(0x1e5)](_0x3a4809=>_0x3a4809[_0x32264c(0x263)]));}async['handleAddGptsBatch'](_0x456acb){const _0x585fae=_0x43b745;try{const _0x19d04d=await this[_0x585fae(0x1f3)](),_0x19ccf6=_0x456acb[_0x585fae(0x25e)](_0xea4779=>!_0x19d04d[_0x585fae(0x201)](_0xea4779[_0x585fae(0x263)]))[_0x585fae(0x1e5)](_0x17568c=>({'groupId':_0x17568c['groupId'],'relModel':_0x17568c[_0x585fae(0x247)],'logo':_0x17568c[_0x585fae(0x289)],'desc':_0x17568c[_0x585fae(0x1ee)],'modelName':_0x17568c[_0x585fae(0x263)],'modelId':_0x17568c[_0x585fae(0x241)]}));return await this[_0x585fae(0x26b)][_0x585fae(0x277)](_0x19ccf6)[_0x585fae(0x20d)](_0x23f54f=>{throw new Error(_0x23f54f);});}catch(_0x51499a){console[_0x585fae(0x252)](_0x585fae(0x265),_0x51499a);throw new common_1[(_0x585fae(0x21a))](_0x51499a,common_1[_0x585fae(0x1fd)]['BAD_REQUEST']);}}async[_0x43b745(0x22c)](_0x3277d6,_0x56c566){const _0x4f8e42=_0x43b745;try{let _0x5972e5;const _0x4e40ee=new Set(),_0x1bc3d2=new Map();if(_0x56c566['headers']['authorization']){const _0x485629=_0x56c566['headers']['authorization']['split']('\x20'),_0x4e8d44=jwt[_0x4f8e42(0x1eb)](_0x485629[0x1],process[_0x4f8e42(0x1f5)][_0x4f8e42(0x278)]);_0x5972e5=_0x4e8d44['id'];}const {modelId:_0x4c4929,modelName:_0x42d7e2,groupId:_0x3cf3e0,back:_0x2baf01,status:_0x7e617f,page:_0x52cd49,size:_0x29c877}=_0x3277d6,_0x5e7e51={'delFlag':![]};_0x5972e5?_0x5e7e51['userId']=(0x0,typeorm_2['Or'])((0x0,typeorm_2[_0x4f8e42(0x1ec)])(_0x5972e5),(0x0,typeorm_2[_0x4f8e42(0x209)])()):_0x5e7e51[_0x4f8e42(0x230)]=(0x0,typeorm_2['IsNull'])();!_0x2baf01?_0x5e7e51[_0x4f8e42(0x1f1)]=0x1:(_0x7e617f!==undefined&&(_0x5e7e51['status']=_0x7e617f),delete _0x5e7e51[_0x4f8e42(0x230)]);_0x4c4929&&(_0x5e7e51[_0x4f8e42(0x241)]=_0x4c4929),_0x3cf3e0&&(_0x5e7e51[_0x4f8e42(0x207)]=_0x3cf3e0),_0x42d7e2&&(_0x5e7e51[_0x4f8e42(0x263)]=(0x0,typeorm_2[_0x4f8e42(0x20c)])('%'+_0x42d7e2+'%'));const [_0x5563c0,_0x35a834]=await this[_0x4f8e42(0x26b)][_0x4f8e42(0x283)]({'skip':(_0x52cd49-0x1)*_0x29c877,'take':_0x29c877,'where':_0x5e7e51,'order':{'sortId':'DESC'}});if(_0x5563c0['length']){const _0x164df2=[],_0x111c15=[];_0x5563c0[_0x4f8e42(0x22a)](_0xcd6656=>{const _0x5802d4=_0x4f8e42;_0x164df2[_0x5802d4(0x227)](_0xcd6656['id']),_0x111c15[_0x5802d4(0x227)](_0xcd6656[_0x5802d4(0x207)]);});const _0x3a658a=await this[_0x4f8e42(0x215)][_0x4f8e42(0x1e2)]({'where':{'appId':(0x0,typeorm_2['In'])(_0x164df2)}});_0x3a658a['forEach'](_0x6443cb=>_0x4e40ee[_0x4f8e42(0x1f0)](_0x6443cb[_0x4f8e42(0x1f8)]));const _0x4e30fb=await this['gptsGroupEntity'][_0x4f8e42(0x1e2)]({'where':{'id':(0x0,typeorm_2['In'])(_0x111c15)}});_0x4e30fb['forEach'](_0x1c1205=>_0x1bc3d2['set'](_0x1c1205['id'],_0x1c1205));}return{'count':_0x35a834,'rows':_0x5563c0[_0x4f8e42(0x1e5)](_0x413403=>({..._0x413403,'collected':_0x4e40ee[_0x4f8e42(0x262)](_0x413403['id']),'groupName':_0x1bc3d2[_0x4f8e42(0x25d)](_0x413403['groupId'])?.[_0x4f8e42(0x27d)]}))};}catch(_0x137c07){console['log'](_0x4f8e42(0x265),_0x137c07);throw new common_1[(_0x4f8e42(0x21a))](_0x137c07,common_1['HttpStatus'][_0x4f8e42(0x287)]);}}async[_0x43b745(0x235)](_0x4621a0,_0x178f60){const _0x51765a=_0x43b745;let _0x3bd2d8;if(_0x4621a0[_0x51765a(0x24c)][_0x51765a(0x200)]){const _0x9ca6e4=_0x4621a0['headers'][_0x51765a(0x200)][_0x51765a(0x270)]('\x20'),_0x82cd31=jwt[_0x51765a(0x1eb)](_0x9ca6e4[0x1],process[_0x51765a(0x1f5)]['JWT_SECRET']);_0x3bd2d8=_0x82cd31['id'];}const _0x446b9f={'take':0x1e};if(_0x178f60=='recommend')_0x446b9f['where']={'status':0x1,'delFlag':![],'recommend':!![]},_0x446b9f[_0x51765a(0x225)]={'createdAt':_0x51765a(0x21f)};else{if(_0x178f60===_0x51765a(0x1e7))_0x446b9f[_0x51765a(0x259)]={'status':0x1,'delFlag':![]},_0x446b9f[_0x51765a(0x225)]={'useCount':_0x51765a(0x21f)};else{if(_0x178f60===_0x51765a(0x280))_0x446b9f[_0x51765a(0x259)]={'status':0x1,'delFlag':![]},_0x446b9f[_0x51765a(0x225)]={'collectCount':'DESC'};else{if(_0x178f60===_0x51765a(0x211)){if(!_0x3bd2d8)throw new common_1['HttpException'](_0x51765a(0x21c),common_1[_0x51765a(0x1fd)][_0x51765a(0x268)]);_0x446b9f[_0x51765a(0x259)]={'status':0x1,'delFlag':![],'userId':_0x3bd2d8},_0x446b9f['order']={'createdAt':_0x51765a(0x21f)};}else _0x446b9f[_0x51765a(0x259)]={'status':0x1,'delFlag':![]},_0x446b9f[_0x51765a(0x225)]={'createdAt':_0x51765a(0x21f)};}}}const _0x844352=await this[_0x51765a(0x26b)]['find'](_0x446b9f),_0x1fa7e5=new Set(),_0x26d2bc=new Map(),_0x1cf763=[],_0x2d7e38=[];_0x844352[_0x51765a(0x22a)](_0x51da0a=>{const _0x1c88f6=_0x51765a;_0x1cf763[_0x1c88f6(0x227)](_0x51da0a['id']),_0x2d7e38[_0x1c88f6(0x227)](_0x51da0a[_0x1c88f6(0x207)]);});if(_0x1cf763[_0x51765a(0x237)]){if(_0x3bd2d8){const _0x1ad2da=await this['userAppsEntity']['find']({'where':{'userId':_0x3bd2d8,'appId':(0x0,typeorm_2['In'])(_0x1cf763)}});_0x1ad2da[_0x51765a(0x22a)](_0x5e9fd1=>_0x1fa7e5[_0x51765a(0x1f0)](_0x5e9fd1[_0x51765a(0x1f8)]));}const _0x3f326d=await this[_0x51765a(0x261)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x2d7e38)}});_0x3f326d[_0x51765a(0x22a)](_0x59186f=>_0x26d2bc[_0x51765a(0x24b)](_0x59186f['id'],_0x59186f));}return _0x844352[_0x51765a(0x1e5)](_0x4ee309=>({..._0x4ee309,'collected':_0x1fa7e5[_0x51765a(0x262)](_0x4ee309['id']),'groupName':_0x26d2bc[_0x51765a(0x25d)](_0x4ee309[_0x51765a(0x207)])?.[_0x51765a(0x27d)]}));}async['handleRemoveGpts'](_0x247d1c){const _0x5ac9ab=_0x43b745;try{const {id:_0x21898c}=_0x247d1c,_0x115fad=await this['gptsModelEntity'][_0x5ac9ab(0x208)]({'where':{'id':_0x21898c}});if(!_0x115fad)throw new common_1['HttpException']('gpts不存在,无法删除！',common_1['HttpStatus'][_0x5ac9ab(0x287)]);return await this[_0x5ac9ab(0x26b)]['delete'](_0x21898c)[_0x5ac9ab(0x23f)](_0x5a8648=>_0x5a8648[_0x5ac9ab(0x216)]>0x0)[_0x5ac9ab(0x20d)](_0x16893a=>{throw new Error(_0x16893a);});}catch(_0x472a1f){console[_0x5ac9ab(0x252)](_0x5ac9ab(0x265),_0x472a1f);throw new common_1[(_0x5ac9ab(0x21a))](_0x472a1f,common_1[_0x5ac9ab(0x1fd)][_0x5ac9ab(0x287)]);}}async[_0x43b745(0x218)](_0xe62923,_0x3724eb){const _0xd09bcc=_0x43b745,_0x503d8d=_0xe62923[_0xd09bcc(0x1f8)],_0x1bfc13=_0x3724eb[_0xd09bcc(0x221)]['id'];let _0x343a0e=null,_0x49ac75={'title':_0xd09bcc(0x1f4),'userId':_0x1bfc13};try{_0x343a0e=await this[_0xd09bcc(0x26b)]['findOne']({'where':{'id':_0x503d8d}});if(!_0x343a0e)throw new Error(_0xd09bcc(0x1df));if(_0x343a0e[_0xd09bcc(0x1f1)]!==0x1)throw new Error(_0xd09bcc(0x1ea));const _0x483f8=await this[_0xd09bcc(0x1ed)]['count']({'where':{'modelId':_0x503d8d,'userId':_0x1bfc13,'isDelete':![]}});if(_0x483f8>0x0)throw new Error(_0xd09bcc(0x254));_0x49ac75['modelId']=_0x343a0e['id'],_0x49ac75['model']=_0x343a0e[_0xd09bcc(0x241)],_0x49ac75[_0xd09bcc(0x207)]=_0x343a0e[_0xd09bcc(0x207)],_0x49ac75['desc']=_0x343a0e[_0xd09bcc(0x1ee)]||'',_0x49ac75[_0xd09bcc(0x289)]=_0x343a0e['logo']||'',_0x49ac75[_0xd09bcc(0x266)]=_0x343a0e['modelName'],_0x49ac75[_0xd09bcc(0x26f)]=_0x343a0e[_0xd09bcc(0x26f)]||'';let _0xa25c01=await this[_0xd09bcc(0x20f)][_0xd09bcc(0x267)](model_constant_1[_0xd09bcc(0x1fb)][_0xd09bcc(0x251)]);_0xa25c01['modelInfo'][_0xd09bcc(0x245)]=_0x343a0e['canAudio'],_0xa25c01[_0xd09bcc(0x253)]['modelName']=_0x343a0e['modelName'],_0xa25c01[_0xd09bcc(0x253)][_0xd09bcc(0x27c)]=_0x343a0e[_0xd09bcc(0x27c)];_0x343a0e['gptsApp']?_0xa25c01[_0xd09bcc(0x253)]['model']=_0x343a0e[_0xd09bcc(0x241)]:_0xa25c01[_0xd09bcc(0x253)]['model']=_0x343a0e[_0xd09bcc(0x247)];_0x49ac75['config']=JSON[_0xd09bcc(0x1fa)](_0xa25c01);const _0x4ffbc1=await this[_0xd09bcc(0x1ed)]['save'](_0x49ac75);return _0x343a0e&&(_0x343a0e[_0xd09bcc(0x24f)]=_0x343a0e[_0xd09bcc(0x24f)]+Math[_0xd09bcc(0x269)](Math[_0xd09bcc(0x21e)]()*0xa),await this[_0xd09bcc(0x26b)][_0xd09bcc(0x277)](_0x343a0e)),_0x4ffbc1;}catch(_0x37c4c1){throw new common_1[(_0xd09bcc(0x21a))](_0x37c4c1[_0xd09bcc(0x26a)],common_1[_0xd09bcc(0x1fd)][_0xd09bcc(0x287)]);}}async[_0x43b745(0x25f)](_0x374362){const _0x4227c1=_0x43b745;try{const _0x5553e1=_0x374362[_0x4227c1(0x221)]['id'],_0x123538={'userId':_0x5553e1,'isDelete':![]},_0x50ec44=await this['gptsChatEntity'][_0x4227c1(0x1e2)]({'where':_0x123538,'order':{'isSticky':_0x4227c1(0x21f),'id':'DESC'}}),_0x3e0c7b=new Set(),_0xbbbf2d=new Map(),_0x9dd12a=new Map(),_0x11f317=[],_0x45a166=[];_0x50ec44['forEach'](_0x706bb=>{const _0x2f8c07=_0x4227c1;_0x11f317[_0x2f8c07(0x227)](_0x706bb[_0x2f8c07(0x241)]),_0x45a166[_0x2f8c07(0x227)](_0x706bb[_0x2f8c07(0x207)]);});if(_0x11f317[_0x4227c1(0x237)]){const _0x34202f=await this[_0x4227c1(0x215)][_0x4227c1(0x1e2)]({'where':{'userId':_0x5553e1,'appId':(0x0,typeorm_2['In'])(_0x11f317)}});_0x34202f['forEach'](_0x5a55df=>_0x3e0c7b[_0x4227c1(0x1f0)](_0x5a55df[_0x4227c1(0x1f8)]));const _0x4b8661=await this[_0x4227c1(0x26b)][_0x4227c1(0x1e2)]({'where':{'id':(0x0,typeorm_2['In'])(_0x11f317),'status':0x1,'delFlag':![]}});_0x4b8661[_0x4227c1(0x22a)](_0x4ed25c=>_0xbbbf2d[_0x4227c1(0x24b)](_0x4ed25c['id'],_0x4ed25c));const _0x4a56a5=await this[_0x4227c1(0x261)][_0x4227c1(0x1e2)]({'where':{'id':(0x0,typeorm_2['In'])(_0x45a166)}});_0x4a56a5[_0x4227c1(0x22a)](_0x5724d4=>_0x9dd12a[_0x4227c1(0x24b)](_0x5724d4['id'],_0x5724d4));}return _0x50ec44[_0x4227c1(0x1e5)](_0x3088e4=>{const _0x149c6e=_0x4227c1,_0x40c5ef=_0xbbbf2d['get'](_0x3088e4['modelId']);if(_0x40c5ef?.[_0x149c6e(0x228)]){const _0x40d9e2=JSON['parse'](_0x3088e4[_0x149c6e(0x20b)]);_0x40d9e2[_0x149c6e(0x253)]['model']=_0x40c5ef['modelId'],_0x3088e4[_0x149c6e(0x20b)]=JSON[_0x149c6e(0x1fa)](_0x40d9e2);}return{..._0x3088e4,'modelName':_0x3088e4[_0x149c6e(0x266)],'gptsApp':_0x40c5ef?.[_0x149c6e(0x228)],'collected':_0x3e0c7b[_0x149c6e(0x262)](_0x3088e4[_0x149c6e(0x241)]),'groupName':_0x9dd12a[_0x149c6e(0x25d)](_0x3088e4[_0x149c6e(0x207)])?.['groupName']};});}catch(_0x817c52){console[_0x4227c1(0x252)](_0x4227c1(0x265),_0x817c52);throw new common_1[(_0x4227c1(0x21a))](_0x817c52,common_1[_0x4227c1(0x1fd)][_0x4227c1(0x287)]);}}async[_0x43b745(0x236)](_0x5a1176,_0x55c6ac){const _0x26e20a=_0x43b745,{title:_0x5344ab,isSticky:_0x38ba1a,groupId:_0x53e92f,config:_0x222916}=_0x5a1176,{id:_0x4ee3ce}=_0x55c6ac[_0x26e20a(0x221)],_0x56dd84=await this['gptsChatEntity'][_0x26e20a(0x208)]({'where':{'id':_0x53e92f,'userId':_0x4ee3ce}});if(!_0x56dd84)throw new common_1[(_0x26e20a(0x21a))]('GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！',common_1[_0x26e20a(0x1fd)][_0x26e20a(0x287)]);const _0x5d76f6={};_0x5d76f6['title']=_0x5344ab||_0x56dd84[_0x26e20a(0x266)],_0x5d76f6[_0x26e20a(0x20b)]=_0x222916||_0x56dd84[_0x26e20a(0x20b)],_0x5d76f6[_0x26e20a(0x286)]=_0x38ba1a??_0x56dd84[_0x26e20a(0x286)];const _0xb7a1a9=await this[_0x26e20a(0x1ed)][_0x26e20a(0x229)]({'id':_0x53e92f},_0x5d76f6);if(_0xb7a1a9[_0x26e20a(0x216)])return!![];else throw new common_1[(_0x26e20a(0x21a))](_0x26e20a(0x1e0),common_1[_0x26e20a(0x1fd)]['BAD_REQUEST']);}async[_0x43b745(0x222)](_0x3e6582,_0x4d6586){const _0x4ca744=_0x43b745;try{const {groupId:_0x17a989}=_0x3e6582,{id:_0x1dd3d0}=_0x4d6586[_0x4ca744(0x221)],_0x4c11f1=await this[_0x4ca744(0x1ed)]['findOne']({'where':{'id':_0x17a989,'userId':_0x1dd3d0}})[_0x4ca744(0x20d)](_0x41b44f=>{const _0x2e1d94=_0x4ca744;common_1[_0x2e1d94(0x260)][_0x2e1d94(0x20a)](_0x41b44f);throw new Error(_0x41b44f);});if(!_0x4c11f1)throw new Error(_0x4ca744(0x1f9));await this[_0x4ca744(0x243)][_0x4ca744(0x282)]({'userId':_0x1dd3d0,'ids':[_0x17a989]})[_0x4ca744(0x20d)](_0xd76c29=>{throw new Error(_0xd76c29);});const _0xa26ccf=await this[_0x4ca744(0x1ed)][_0x4ca744(0x1e3)]({'id':_0x17a989})[_0x4ca744(0x20d)](_0xf4c0bd=>{throw new Error(_0xf4c0bd);});if(!_0xa26ccf)throw new Error(_0x4ca744(0x257));return!![];}catch(_0xfcfa4){throw new common_1[(_0x4ca744(0x21a))](_0xfcfa4,common_1['HttpStatus'][_0x4ca744(0x287)]);}}async[_0x43b745(0x272)](_0x32986d){const _0x286c6f=_0x43b745;try{const {id:_0x3db26d}=_0x32986d[_0x286c6f(0x221)],_0x150f6f=await this[_0x286c6f(0x1ed)][_0x286c6f(0x1e2)]({'where':{'userId':_0x3db26d}})[_0x286c6f(0x20d)](_0x599079=>{const _0x271f27=_0x286c6f;common_1[_0x271f27(0x260)][_0x271f27(0x20a)](_0x599079);throw new Error(_0x599079);});if(!_0x150f6f||_0x150f6f[_0x286c6f(0x237)]===0x0)throw new Error(_0x286c6f(0x22f));const _0x1c846b=_0x150f6f['map'](_0x5295b0=>_0x5295b0[_0x286c6f(0x207)]);await this['chatLogService'][_0x286c6f(0x282)]({'ids':_0x1c846b,'userId':_0x3db26d})[_0x286c6f(0x20d)](_0x4ea09d=>{throw new Error(_0x4ea09d);});const _0xc52847=await this[_0x286c6f(0x1ed)][_0x286c6f(0x1e3)]({'userId':_0x3db26d,'isSticky':![]})[_0x286c6f(0x20d)](_0x62c16b=>{throw new Error(_0x62c16b);});if(!_0xc52847)throw new Error(_0x286c6f(0x244));return!![];}catch(_0xd35e04){throw new common_1[(_0x286c6f(0x21a))](_0xd35e04,common_1[_0x286c6f(0x1fd)][_0x286c6f(0x287)]);}}async[_0x43b745(0x24e)](_0x4692f7){const _0x1d20c7=_0x43b745;return await this['gptsChatEntity'][_0x1d20c7(0x208)]({'where':{'id':_0x4692f7}});}async['getCurrentModelKeyInfo'](_0x39b27b){const _0x34a82c=_0x43b745,_0x24048b=await this['gptsChatEntity'][_0x34a82c(0x208)]({'where':{'id':_0x39b27b}}),_0x38a7f6=await this['gptsModelEntity'][_0x34a82c(0x208)]({'where':{'id':_0x24048b[_0x34a82c(0x241)]}}),_0x39e041=await this[_0x34a82c(0x261)]['findOne']({'where':{'id':_0x38a7f6[_0x34a82c(0x207)]}}),{proxyUrl:_0x1b0783,key:_0x54d6aa,timeout:_0x320737,deduct:_0xc6d600,deductType:_0x33d05e}=_0x39e041,_0xbc8645=_0x1b0783||_0x34a82c(0x246),{modelId:_0x3277bd,modelName:_0x55ac26,id:_0x43ad54}=_0x38a7f6;return this[_0x34a82c(0x206)][_0x34a82c(0x24b)](_0x39b27b,{'timeout':_0x320737,'modelName':_0x55ac26,'proxy':_0xbc8645,'deduct':_0xc6d600,'deductType':_0x33d05e,'key':_0x54d6aa,'id':_0x43ad54,'modelId':_0x3277bd}),{'timeout':_0x320737,'modelName':_0x55ac26,'proxy':_0xbc8645,'deduct':_0xc6d600,'deductType':_0x33d05e,'key':_0x54d6aa,'id':_0x43ad54,'modelId':_0x3277bd};}async[_0x43b745(0x25b)](_0x588ab5,_0x559181){const _0x3043e2=_0x43b745;await this[_0x3043e2(0x261)][_0x3043e2(0x231)]()[_0x3043e2(0x229)](gpts_group_entity_1[_0x3043e2(0x22e)])[_0x3043e2(0x24b)]({'useCount':()=>_0x3043e2(0x214),'useToken':()=>_0x3043e2(0x1f2)+_0x559181})[_0x3043e2(0x259)](_0x3043e2(0x249),{'id':_0x588ab5})[_0x3043e2(0x21b)]();}};function _0x46a1(_0x5af851,_0x545e48){const _0x2301f9=_0x2301();return _0x46a1=function(_0x46a1b0,_0x4f2a7f){_0x46a1b0=_0x46a1b0-0x1df;let _0x3806e7=_0x2301f9[_0x46a1b0];return _0x3806e7;},_0x46a1(_0x5af851,_0x545e48);}GptsService=__decorate([(0x0,common_1[_0x43b745(0x22d)])(),__param(0x0,(0x0,typeorm_1[_0x43b745(0x264)])(userApps_entity_1[_0x43b745(0x288)])),__param(0x1,(0x0,typeorm_1[_0x43b745(0x264)])(gpts_group_entity_1[_0x43b745(0x22e)])),__param(0x2,(0x0,typeorm_1[_0x43b745(0x264)])(gpts_model_entity_1[_0x43b745(0x1e6)])),__param(0x3,(0x0,typeorm_1[_0x43b745(0x264)])(gpts_chat_entity_1[_0x43b745(0x1fc)])),__metadata(_0x43b745(0x25a),[typeorm_2[_0x43b745(0x203)],typeorm_2[_0x43b745(0x203)],typeorm_2['Repository'],typeorm_2['Repository'],models_service_1['ModelsService'],chatLog_service_1[_0x43b745(0x204)]])],GptsService),exports[_0x43b745(0x239)]=GptsService;