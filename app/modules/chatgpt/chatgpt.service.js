'use strict';const _0x595a79=_0xb432;function _0x2c50(){const _0x54f1d3=['getModelByType','verify','get','openaiModel4MaxTokens32kRes','size','gpts','请开启并配置腾讯云COS存储参数后再使用','count','uploaded/','当前模型key余额已耗尽','application/octet-stream','修改成功','sendMessageFromXunFei','../badwords/badwords.service','当前模型不是聊天模型','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','DESC','user','error','gomaxai-default-key','action','result','apiBaseUrl','\x20model:\x20','ModelsService','arrayBuffer','/v1','绘制图片失败，请检查你的提示词是否有非法描述！','chatRealTime','UserEntity','AiAgreeLogEntity','getWhiteListUser','defaultBaseUrl','./spark','/v1/dashboard/billing/usage?start_date=','未配置有效key、请先前往后台系统配置！','服务异常、请重新试试吧！！！','getRandomKey',',\x20模型名称:\x20','YYYY年M月D日','../autoreply/autoreply.service','未获取到模型基础配置，请前往后台配置并启用','super','create','request\x20gpt\x20','Catch\x20Error\x20','tts-1','globalConfigService','key\x20%s,\x20proxy\x20%s','openaiModel3MaxTokens16kRes','formatDate','getCurrentModelKeyInfo','model','cosApi','toISOString','390509BnVppw','未配置[卡池3]的有效key、请先前往后台系统配置！','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','openaiBaseUrl','findAndCount','../app/app.entity','buildMessageFromParentMessageId','connection',',\x20模型token:\x20','statusCode','BAD_REQUEST','query','sendMessageFromZhipu','close','conversationId','openAi','getOwnPropertyDescriptor','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','deductFromBalance','maxResponseTokens','sendMessage','userBanance','CHAT_TYPE','keyStatus','Please\x20check\x20the\x20back-end\x20console','save','is_end','addOneIfOdd','uploadService','chatGroupService','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','log','affected','openaiModel4MaxTokensRes','globalTimeoutMs','getConfigs','from','Location','importDynamic','id\x20=\x20:id','modelInfo','onModuleInit','remove\x20file\x20','../../common/constants/model.constant','model3','uploadGpt','useCount\x20+\x201','function','Bearer\x20','PAINT_TYPE','includes','status','当前模型key已被封禁','bulkCreateKey','AppEntity','prompt','forEach','400\x20error','&end_date=','systemMessage','catch','end','default','resolve','模型秘钥错误或模型余额不足','push','userEntity','setHeader','execute','删除成功','PAYMENT_REQUIRED','GptsService','transcriptions','NineStore','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','XunFeiSpark','gpt-3','keyPool','checkBadWords','validateBalance','4172980BbCEvw','base64','ChatGptService','data','1608414KfGMYd','CHAT','Incorrect\x20API\x20key\x20provided','key:\x20','Connection','getUuid','AutoreplyService','../aiLog/aiAgreeLog.entity','1134VfUWNz','、重复key','当前模型key余额已耗尽，请充值！','abortController','ChatLogEntity','MODEL_LIST','腾讯云COS连接成功','object','modelId','badwordsService','split','getRandomGptKeyDetail','语音转文本失败','sendMessageFromBaidu','修改白名单成功','\x0a\x20\x20\x20\x20\x20\x20','openaiModel3MaxTokensRes','本次调用:\x20','ChatgptService','saveChatLog','%\x27\x20)','chatLogEntity','chat-error','now','removeFile','compileNetwork','saveUseLog','request','initOpenAi','gptsService','getTencentCOSStorage','subtract','systemPreMessage','email','application/json','key','checkAutoReply','UserService','GptkeysEntity','./helper','map','deleteKey','REDIS_PORT','config','@nestjs/typeorm','toFixed','checkUserStatus','查询key列表失败','HttpStatus','getModelProxyUrl','getKeyList','unifiedFormattingResponse','apiKey','/v1/dashboard/billing/subscription','whiteListEntity','parse','getRandomAudioKey','用户已在白名单中！','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','getGptModelList','defineProperty','putObject','https://api.openai.com','text','audio','userId','baseURL','formatModelToken','getAllKeyList','Logger','length','333333333333333','chatProcess','toLowerCase','c.createdAt','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20c.id\x20AND\x20ale.relate_type\x20=\x20\x27suno\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.isDelete\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.role\x20=\x20\x27assistant\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27music\x27\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20','ChatGroupService','__metadata','lockKey','b64_json','abort','gpt-4','authorization','remove\x20file\x20%s\x20success','filename','__esModule','418KNsAqj','__decorate','../user/user.entity','getLength','../userBalance/userBalance.service','openaiModel4MaxTokens','floor','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','gomaxai-chatlog','append','delete','aac','模型秘钥错误或模型金额不足，请联系管理员！','preset','uuid','当前记录不存在！','metadata','maxModelTokens','getModelAndKeyFromUser','whisper-1','getKeyDetail','username','timeoutMs','agreeNum','Repository','where','queryUserBalance','openaiaAtoDowngrade','headers','getGroupInfoFromId','then','%\x27\x20OR\x20c.answer\x20LIKE\x20\x27%','redis://','/v1/images/generations','Unauthorized','createReadStream','assistant','\x20OFFSET\x20','slice','reject','../chatLog/chatLog.entity','提供了错误的模型秘钥','UploadService','key已存在','write','total_usage','selectKeyWithWeight','Like','modelsService','fanyi\x20mj-associate','createQueryBuilder','chat','DeductionKey','mergedOptions','form-data','model4','stringify','修改失败','addKey','saveGptsUseLog','autoreplyService','response','key不存在','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','UserBalanceService','findOne','path','48527006fvmZKQ','gomaxAiStore','getRequestParams','axios','filter','/v1/models','292722uZRGqp','modelType','gpt-3.5-turbo-16k-0613','getUserWhiteList','abs','修改白名单失败','typeorm','userBalanceService','90TxhIBX','EModelType','@keyv/redis','all','chatgpt-nine-ai','maskEmail','openaiProxyUrl','post','cosSecretKey','update','openaiTimeoutMs','OpenAiErrorCodeMessage','requestFromGpt','set','find','hideString','../chatLog/chatLog.service','env','signal','DALL-E2','setData','DrawService','个已被排除！','this.api.apiBaseUrl','musicSquare','../models/models.service','1034586XieyUb','GlobalConfigService','debug','extname','@nestjs/common','format','message','JWT_SECRET','HttpException','api','gptKeysEntity','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','appEntity','12YQXWkT','chatLogService','getUploadType','DRAW','./whiteList.entity','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','REDIS_HOST','addWhiteUser','playNum','audio2text\x20','role','getClientIp','./../upload/upload.service','115DXNDkO','获取模型列表失败，请检查你的key是否正确！','语音转换失败','unlink','184EYTttV','keyv','json','tencentCosAcceleratedDomain','InjectRepository','__param','openai','getTokenCount','decorate','relateId','userService','未配置语音模型或语音模型key，请配置并启用语音功能！','file','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','还未配置腾讯云COS存储的的SecretId和SecretKey、配置后才可进行gpt文件上传操作！！！','AND\x20(\x20c.prompt\x20LIKE\x20\x27%','response.length','Injectable','../globalConfig/globalConfig.service','openaiModel3MaxTokens16k','\x20key\x20->\x20','usage'];_0x2c50=function(){return _0x54f1d3;};return _0x2c50();}(function(_0x23bb0c,_0x4079f5){const _0x2de9a2=_0xb432,_0x1f2781=_0x23bb0c();while(!![]){try{const _0x46ac39=parseInt(_0x2de9a2(0x25d))/0x1*(parseInt(_0x2de9a2(0x207))/0x2)+parseInt(_0x2de9a2(0x1ff))/0x3+-parseInt(_0x2de9a2(0x1fb))/0x4+-parseInt(_0x2de9a2(0x2e2))/0x5*(parseInt(_0x2de9a2(0x2a6))/0x6)+-parseInt(_0x2de9a2(0x334))/0x7*(parseInt(_0x2de9a2(0x2e6))/0x8)+parseInt(_0x2de9a2(0x2c8))/0x9*(-parseInt(_0x2de9a2(0x2ae))/0xa)+parseInt(_0x2de9a2(0x2a0))/0xb*(parseInt(_0x2de9a2(0x2d5))/0xc);if(_0x46ac39===_0x4079f5)break;else _0x1f2781['push'](_0x1f2781['shift']());}catch(_0x3ce48e){_0x1f2781['push'](_0x1f2781['shift']());}}}(_0x2c50,0xab4d9));var __decorate=this&&this[_0x595a79(0x25e)]||function(_0xc8aa26,_0x3d575b,_0xb0d14c,_0x3606a8){const _0x4e53ea=_0x595a79;var _0x46a5a0=arguments['length'],_0x6a4e32=_0x46a5a0<0x3?_0x3d575b:_0x3606a8===null?_0x3606a8=Object[_0x4e53ea(0x344)](_0x3d575b,_0xb0d14c):_0x3606a8,_0x303d88;if(typeof Reflect===_0x4e53ea(0x20e)&&typeof Reflect[_0x4e53ea(0x2ee)]===_0x4e53ea(0x363))_0x6a4e32=Reflect['decorate'](_0xc8aa26,_0x3d575b,_0xb0d14c,_0x3606a8);else{for(var _0x41343e=_0xc8aa26['length']-0x1;_0x41343e>=0x0;_0x41343e--)if(_0x303d88=_0xc8aa26[_0x41343e])_0x6a4e32=(_0x46a5a0<0x3?_0x303d88(_0x6a4e32):_0x46a5a0>0x3?_0x303d88(_0x3d575b,_0xb0d14c,_0x6a4e32):_0x303d88(_0x3d575b,_0xb0d14c))||_0x6a4e32;}return _0x46a5a0>0x3&&_0x6a4e32&&Object['defineProperty'](_0x3d575b,_0xb0d14c,_0x6a4e32),_0x6a4e32;},__metadata=this&&this[_0x595a79(0x254)]||function(_0x1f7005,_0x30947b){const _0x316769=_0x595a79;if(typeof Reflect==='object'&&typeof Reflect[_0x316769(0x26d)]===_0x316769(0x363))return Reflect[_0x316769(0x26d)](_0x1f7005,_0x30947b);},__param=this&&this[_0x595a79(0x2eb)]||function(_0x543be7,_0x2eafe2){return function(_0x438ecd,_0x47437d){_0x2eafe2(_0x438ecd,_0x47437d,_0x543be7);};};Object[_0x595a79(0x243)](exports,_0x595a79(0x25c),{'value':!![]}),exports[_0x595a79(0x219)]=void 0x0;function _0xb432(_0x5778b7,_0x103b0f){const _0x2c509c=_0x2c50();return _0xb432=function(_0xb4325a,_0xb2c619){_0xb4325a=_0xb4325a-0x1da;let _0x2b08dd=_0x2c509c[_0xb4325a];return _0x2b08dd;},_0xb432(_0x5778b7,_0x103b0f);}const upload_service_1=require(_0x595a79(0x2e1)),user_service_1=require('./../user/user.service'),openai_1=require(_0x595a79(0x2ec)),common_1=require(_0x595a79(0x2cc)),FormData=require(_0x595a79(0x293)),errorMessage_constant_1=require('../../common/constants/errorMessage.constant'),utils_1=require('../../common/utils'),axios_1=require(_0x595a79(0x2a3)),userBalance_service_1=require(_0x595a79(0x261)),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require(_0x595a79(0x2be)),uuid=require(_0x595a79(0x26b)),fs_1=require('fs'),typeorm_1=require(_0x595a79(0x2ac)),typeorm_2=require(_0x595a79(0x233)),badwords_service_1=require(_0x595a79(0x309)),autoreply_service_1=require(_0x595a79(0x325)),gptKeys_entity_1=require('./gptKeys.entity'),globalConfig_service_1=require(_0x595a79(0x2f8)),whiteList_entity_1=require(_0x595a79(0x2d9)),user_entity_1=require(_0x595a79(0x25f)),dayjs=require('dayjs'),app_entity_1=require(_0x595a79(0x339)),chatGroup_service_1=require('../chatGroup/chatGroup.service'),models_service_1=require(_0x595a79(0x2c7)),baidu_1=require('./baidu'),helper_1=require(_0x595a79(0x22e)),store_1=require('./store'),zhipu_1=require('./zhipu'),spark_1=require(_0x595a79(0x31e)),model_constant_1=require(_0x595a79(0x35f)),fs_2=require('fs'),path_1=require(_0x595a79(0x29f)),COS=require('cos-nodejs-sdk-v5'),gpts_service_1=require('../gpts/gpts.service'),aiAgreeLog_entity_1=require(_0x595a79(0x206)),chatLog_entity_1=require(_0x595a79(0x285)),jwt=require('jsonwebtoken');let ChatgptService=class ChatgptService{constructor(_0x539423,_0x5a4750,_0x263c00,_0x5eb16c,_0x38e8b4,_0x25be41,_0xbdca91,_0x23f7c4,_0x111852,_0x3e390d,_0x18605c,_0x43727f,_0x15cbf6,_0x28cb4f,_0x5e9dbb,_0x39a466,_0x90698d){const _0x44cf61=_0x595a79;this[_0x44cf61(0x1ec)]=_0x539423,this[_0x44cf61(0x2d2)]=_0x5a4750,this[_0x44cf61(0x23d)]=_0x263c00,this[_0x44cf61(0x2d4)]=_0x5eb16c,this[_0x44cf61(0x21c)]=_0x38e8b4,this['aiAgreeLogEntity']=_0x25be41,this[_0x44cf61(0x2ad)]=_0xbdca91,this['chatLogService']=_0x23f7c4,this[_0x44cf61(0x2f0)]=_0x111852,this[_0x44cf61(0x350)]=_0x3e390d,this[_0x44cf61(0x210)]=_0x18605c,this['autoreplyService']=_0x43727f,this[_0x44cf61(0x32c)]=_0x15cbf6,this[_0x44cf61(0x351)]=_0x28cb4f,this['modelsService']=_0x5e9dbb,this[_0x44cf61(0x224)]=_0x39a466,this[_0x44cf61(0x33b)]=_0x90698d,this[_0x44cf61(0x31d)]=_0x44cf61(0x245),this[_0x44cf61(0x2a1)]=null,this[_0x44cf61(0x1f8)]={'list3':[],'list4':[]},this[_0x44cf61(0x21f)]=_0x4a5ec6=>{const _0x3efd7f=_0x44cf61;return fs_1[_0x3efd7f(0x1e8)][_0x3efd7f(0x2e5)](_0x4a5ec6,_0x46f0a4=>{const _0xc90b18=_0x3efd7f;_0x46f0a4?console[_0xc90b18(0x353)](_0xc90b18(0x35e),_0x46f0a4):console[_0xc90b18(0x353)](_0xc90b18(0x25a),_0x4a5ec6);});};}async[_0x595a79(0x35d)](){const _0x5c459f=_0x595a79;let _0x2b38a8=await(0x0,utils_1[_0x5c459f(0x35a)])(_0x5c459f(0x2b2)),_0x3cf015=await(0x0,utils_1['importDynamic'])(_0x5c459f(0x2b0)),_0x4d3ed2=await(0x0,utils_1[_0x5c459f(0x35a)])(_0x5c459f(0x2e7));_0x2b38a8=_0x2b38a8?.['default']?_0x2b38a8[_0x5c459f(0x1e8)]:_0x2b38a8,_0x3cf015=_0x3cf015?.[_0x5c459f(0x1e8)]?_0x3cf015['default']:_0x3cf015,_0x4d3ed2=_0x4d3ed2?.[_0x5c459f(0x1e8)]?_0x4d3ed2[_0x5c459f(0x1e8)]:_0x4d3ed2;const {ChatGPTAPI:_0x3ce722,ChatGPTError:_0x5a522d,ChatGPTUnofficialProxyAPI:_0x22f310}=_0x2b38a8,_0x45f0f8=+process[_0x5c459f(0x2bf)][_0x5c459f(0x231)],_0xa6fcb4=process[_0x5c459f(0x2bf)][_0x5c459f(0x2db)],_0x4c4bcd=process[_0x5c459f(0x2bf)]['REDIS_PASSWORD'],_0x25305a=process[_0x5c459f(0x2bf)]['REDIS_USER'],_0x5173a8=_0x5c459f(0x27d)+(_0x25305a||'')+':'+(_0x4c4bcd||'')+'@'+_0xa6fcb4+':'+_0x45f0f8,_0x4ec4ef=new _0x3cf015(_0x5173a8),_0x493796=new _0x4d3ed2({'store':_0x4ec4ef,'namespace':_0x5c459f(0x265)});this[_0x5c459f(0x2a1)]=new store_1[(_0x5c459f(0x1f3))]({'store':_0x493796,'namespace':_0x5c459f(0x290)}),this[_0x5c459f(0x2d1)]=new _0x3ce722({'apiKey':_0x5c459f(0x310),'apiBaseUrl':this['defaultBaseUrl']+_0x5c459f(0x317),'messageStore':_0x493796}),!this[_0x5c459f(0x343)]&&this[_0x5c459f(0x223)](),await this['getTencentCOSStorage'](!![]);}['initOpenAi'](){const _0x28fabd=_0x595a79;this['openAi']=new openai_1['default']({'apiKey':_0x28fabd(0x310),'baseURL':this[_0x28fabd(0x31d)]+_0x28fabd(0x317)});}async[_0x595a79(0x225)](_0x5ad28e=![]){const _0x467ce5=_0x595a79,{cosSecretId:_0x2cecd8,cosSecretKey:_0x13e146}=await this['globalConfigService'][_0x467ce5(0x357)](['cosSecretId',_0x467ce5(0x2b6)]);if(!_0x2cecd8||!_0x13e146)return common_1[_0x467ce5(0x24c)][_0x467ce5(0x30f)](_0x467ce5(0x2f4),_0x467ce5(0x1fd));this[_0x467ce5(0x332)]=new COS({'SecretId':_0x2cecd8,'SecretKey':_0x13e146}),common_1[_0x467ce5(0x24c)][_0x467ce5(0x353)](_0x467ce5(0x20d));}async[_0x595a79(0x212)](_0x3c19f2){const _0x2d7da6=_0x595a79,{list3:_0x2fb60e,list4:_0x43a982}=this[_0x2d7da6(0x1f8)];if(_0x2fb60e[_0x2d7da6(0x24d)]===0x0&&_0x43a982[_0x2d7da6(0x24d)]===0x0)throw new common_1[(_0x2d7da6(0x2d0))](_0x2d7da6(0x320),common_1['HttpStatus'][_0x2d7da6(0x33e)]);if(_0x3c19f2===0x3){if(_0x2fb60e[_0x2d7da6(0x24d)]===0x0)throw new common_1[(_0x2d7da6(0x2d0))](_0x2d7da6(0x335),common_1['HttpStatus']['BAD_REQUEST']);return(0x0,utils_1[_0x2d7da6(0x28b)])(_0x2fb60e);}if(_0x3c19f2===0x4){if(_0x43a982[_0x2d7da6(0x24d)]===0x0){const _0x1aa87b=await this['globalConfigService'][_0x2d7da6(0x357)]([_0x2d7da6(0x278)]);if(Number(_0x1aa87b)!==0x1)throw new common_1['HttpException']('未配置[卡池4]的有效key、请先前往后台系统配置！',common_1[_0x2d7da6(0x237)][_0x2d7da6(0x33e)]);common_1[_0x2d7da6(0x24c)][_0x2d7da6(0x30f)]('有4的权限但是卡池没有配置、降级为3的卡池');if(_0x2fb60e[_0x2d7da6(0x24d)]===0x0)throw new common_1[(_0x2d7da6(0x2d0))](_0x2d7da6(0x320),common_1[_0x2d7da6(0x237)][_0x2d7da6(0x33e)]);else return(0x0,utils_1[_0x2d7da6(0x28b)])(_0x2fb60e);}else return(0x0,utils_1[_0x2d7da6(0x28b)])(_0x43a982);}}async[_0x595a79(0x2a2)](_0x285780,_0x217539,_0x48e449,_0x527259){const _0x142cbd=_0x595a79,{timeout:timeout=0x3c}=_0x48e449,{topN:_0x4a929c,model:_0x291fc6}=_0x527259,{parentMessageId:parentMessageId=0x0}=_0x285780,_0x4e4c87=await this[_0x142cbd(0x32c)][_0x142cbd(0x357)](['openaiTimeoutMs']),_0x132251=timeout*0x3e8||_0x4e4c87||0x64*0x3e8;common_1[_0x142cbd(0x24c)]['log'](_0x132251,_0x142cbd(0x273)),common_1[_0x142cbd(0x24c)][_0x142cbd(0x353)](_0x4e4c87,_0x142cbd(0x356));const _0x9ec47c={'parentMessageId':parentMessageId,'timeoutMs':+_0x132251,'completionParams':{'model':_0x291fc6,'temperature':_0x4a929c}};return _0x217539&&(_0x9ec47c[_0x142cbd(0x1e5)]=_0x217539),_0x9ec47c;}async[_0x595a79(0x24f)](_0x35934f,_0x2e1362,_0x2933db){const _0x483f30=_0x595a79,_0x50407c=_0x2e1362[_0x483f30(0x20a)],{options:options={},prompt:_0x34c62e,appId:_0x5a7c41,cusromPrompt:_0xc63a28,systemMessage:systemMessage=''}=_0x35934f;let _0x1885e9=systemMessage;const {groupId:_0x153daf,usingNetwork:_0x366020,parentMessageId:_0x4511e1,type:_0x22a990}=options;let _0x600026;_0x22a990&&_0x22a990===_0x483f30(0x301)?_0x600026=await this[_0x483f30(0x224)]['getGroupInfoFromId'](_0x153daf):_0x600026=await this[_0x483f30(0x351)][_0x483f30(0x27a)](_0x153daf);let _0x2f37d1;_0x600026?_0x2f37d1=JSON['parse'](_0x600026[_0x483f30(0x232)]):_0x2f37d1=await this['modelsService'][_0x483f30(0x2fc)](model_constant_1[_0x483f30(0x2af)]['OTHER']);if(!_0x2f37d1)throw new common_1[(_0x483f30(0x2d0))](_0x483f30(0x326),common_1['HttpStatus']['BAD_REQUEST']);const {keyType:_0x2013eb,model:_0x4a81e9,topN:_0x343fa2,systemMessage:_0x9383f2,rounds:_0x31bc97}=_0x2f37d1[_0x483f30(0x35c)];let _0x29fc0b=null;if(!_0xc63a28&&!_0x22a990)_0x29fc0b=await this[_0x483f30(0x28d)][_0x483f30(0x330)](_0x4a81e9);else _0x22a990===_0x483f30(0x301)?(_0x29fc0b=await this[_0x483f30(0x224)][_0x483f30(0x330)](_0x153daf),_0x29fc0b[_0x483f30(0x20f)]&&(options[_0x483f30(0x20f)]=_0x29fc0b['modelId'],_0x2f37d1[_0x483f30(0x35c)][_0x483f30(0x331)]=_0x29fc0b[_0x483f30(0x20f)])):_0x29fc0b=await this['modelsService'][_0x483f30(0x322)](model_constant_1[_0x483f30(0x2af)][_0x483f30(0x200)]);if(!_0x29fc0b)throw new common_1[(_0x483f30(0x2d0))](_0x483f30(0x1f5),common_1[_0x483f30(0x237)]['BAD_REQUEST']);const {deduct:_0x4d7616,deductType:_0x9c59c,key:_0x5d4ab0,modelName:_0x39bc13,id:_0x1af0a9,accessToken:_0x91bffb,proxy:_0x34770f}=_0x29fc0b;await this[_0x483f30(0x2f0)][_0x483f30(0x235)](_0x2e1362['user']),await this[_0x483f30(0x2ad)]['validateBalance'](_0x2e1362,_0x9c59c===0x1?_0x483f30(0x360):_0x483f30(0x294),_0x4d7616),_0x2933db&&_0x2933db[_0x483f30(0x1ed)]('Content-type','application/octet-stream;\x20charset=utf-8'),await this[_0x483f30(0x210)][_0x483f30(0x1f9)](_0x34c62e,_0x2e1362[_0x483f30(0x30e)]['id']);const _0x444fe8=await this[_0x483f30(0x299)][_0x483f30(0x22b)](_0x34c62e);if(_0x444fe8&&_0x2933db){const _0x1c131f={'message':_0x444fe8,'code':0x1f4};return _0x2933db[_0x483f30(0x289)](JSON[_0x483f30(0x295)](_0x1c131f)),_0x2933db[_0x483f30(0x1e7)]();}if(_0x5a7c41){const _0x385b32=await this['appEntity'][_0x483f30(0x29e)]({'where':{'id':_0x5a7c41,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x385b32)throw new common_1['HttpException'](_0x483f30(0x345),common_1['HttpStatus']['BAD_REQUEST']);_0x385b32['preset']&&(_0x1885e9=_0x385b32[_0x483f30(0x26a)]);}else{if(_0xc63a28)_0x1885e9=systemMessage;else{if(_0x9383f2)_0x1885e9=_0x9383f2;else{const _0x4a0253=new Date()['toISOString']()[_0x483f30(0x211)]('T')[0x0];let _0x1b7d1a='';_0x22a990!==_0x483f30(0x301)&&(_0x1b7d1a=await this[_0x483f30(0x32c)][_0x483f30(0x357)](['systemPreMessage']),_0x1885e9=_0x1b7d1a+(_0x483f30(0x1f4)+_0x4a0253));}}}let _0x5765cb='';if(_0x366020){_0x5765cb=await(0x0,utils_1[_0x483f30(0x220)])(_0x34c62e);const _0x40def7=new Date()[_0x483f30(0x333)]()[_0x483f30(0x211)]('T')[0x0],_0x3adc8d=await this[_0x483f30(0x32c)][_0x483f30(0x357)]([_0x483f30(0x227)]);_0x1885e9=_0x3adc8d+(_0x483f30(0x1f4)+_0x40def7);}const _0x34190d=await this[_0x483f30(0x2a2)](options,_0x1885e9,_0x29fc0b,_0x2f37d1[_0x483f30(0x35c)]);console[_0x483f30(0x353)](_0x483f30(0x292),_0x34190d);const {maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000}=_0x29fc0b,_0x36db26=_0x22a990===_0x483f30(0x301)?_0x34770f:await this[_0x483f30(0x238)](_0x29fc0b);this[_0x483f30(0x2d1)]['apiKey']=(0x0,utils_1['removeSpecialCharacters'])(_0x5d4ab0),console[_0x483f30(0x353)]('this.api.apiKey',this['api']['apiKey']),console['log'](_0x483f30(0x2c5),_0x36db26+_0x483f30(0x317)),this[_0x483f30(0x2d1)][_0x483f30(0x313)]=_0x36db26+'/v1',this[_0x483f30(0x2d1)][_0x483f30(0x26e)]=maxModelTokens,this[_0x483f30(0x2d1)]['maxResponseTokens']=maxResponseTokens>=maxModelTokens?Math['abs'](Math['floor'](maxModelTokens/0x2)):maxResponseTokens,_0x2933db&&_0x2933db[_0x483f30(0x1dd)](0xc8);let _0x4c4f38=null,_0x1f3cdc=null,_0x5ddd57=null,_0x59c572=null;if(!_0x22a990)try{const _0xbecd6b=JSON['parse'](_0x600026[_0x483f30(0x232)]),_0x42be4b=_0xbecd6b[_0x483f30(0x35c)];_0x5ddd57=_0x42be4b['id'],_0x59c572=_0x42be4b[_0x483f30(0x2a7)];}catch(_0x4d1801){}try{if(_0x2933db){let _0x4a6022=null,_0x3d1855=![];_0x2933db['on'](_0x483f30(0x341),async()=>{const _0x46a8bd=_0x483f30;if(_0x3d1855)return;_0x50407c[_0x46a8bd(0x257)]();const _0x578917=await this[_0x46a8bd(0x2d1)][_0x46a8bd(0x2ed)](_0x34c62e)||0x0,_0x4f88d0=await this[_0x46a8bd(0x2d1)][_0x46a8bd(0x2ed)](_0x4a6022?.[_0x46a8bd(0x246)]||''),_0x566387=_0x578917+_0x4f88d0,_0x5aa063=(0x0,utils_1[_0x46a8bd(0x2e0)])(_0x2e1362);await this['chatLogService'][_0x46a8bd(0x21a)]({'appId':_0x5a7c41,'curIp':_0x5aa063,'logType':_0x22a990===_0x46a8bd(0x301)?0x2:0x1,'userId':_0x2e1362[_0x46a8bd(0x30e)]['id'],'type':balance_constant_1[_0x46a8bd(0x291)][_0x46a8bd(0x34a)],'prompt':_0x34c62e,'answer':'','promptTokens':_0x578917,'completionTokens':0x0,'totalTokens':_0x578917,'model':_0x4a81e9,'role':_0x46a8bd(0x30e),'groupId':_0x153daf,'requestOptions':JSON[_0x46a8bd(0x295)]({'options':null,'prompt':_0x34c62e}),'modelId':_0x5ddd57,'modelType':_0x59c572}),await this['chatLogService'][_0x46a8bd(0x21a)]({'appId':_0x5a7c41,'curIp':_0x5aa063,'logType':_0x22a990==='gpts'?0x2:0x1,'userId':_0x2e1362[_0x46a8bd(0x30e)]['id'],'type':balance_constant_1['DeductionKey'][_0x46a8bd(0x34a)],'prompt':_0x34c62e,'answer':_0x4a6022?.[_0x46a8bd(0x246)],'promptTokens':_0x578917,'completionTokens':_0x4f88d0,'totalTokens':_0x566387,'model':_0x4a81e9,'role':_0x46a8bd(0x281),'groupId':_0x153daf,'requestOptions':JSON[_0x46a8bd(0x295)]({'options':{'model':_0x4a81e9,'temperature':_0x343fa2},'prompt':_0x34c62e}),'conversationOptions':JSON[_0x46a8bd(0x295)]({'conversationId':_0x4a6022?.[_0x46a8bd(0x342)],'model':_0x4a81e9,'parentMessageId':_0x4a6022?.['id'],'temperature':_0x343fa2}),'modelId':_0x5ddd57,'modelType':_0x59c572}),await this[_0x46a8bd(0x2ad)][_0x46a8bd(0x346)](_0x2e1362['user']['id'],_0x46a8bd(0x331)+(_0x9c59c===0x1?0x3:0x4),0x1,_0x566387);}),_0x2933db['on']('error',_0x3219c8=>{const _0x5a2d27=_0x483f30;console[_0x5a2d27(0x353)](_0x3219c8);});if(Number(_0x2013eb)===0x1){let _0x21ca03=!![];_0x4c4f38=await this[_0x483f30(0x2d1)][_0x483f30(0x348)](_0x366020?_0x5765cb:_0x34c62e,{..._0x34190d,'onProgress':_0x8dfbfb=>{const _0xec8ce1=_0x483f30;_0x2933db[_0xec8ce1(0x289)](_0x21ca03?JSON[_0xec8ce1(0x295)](_0x8dfbfb):'\x0a'+JSON[_0xec8ce1(0x295)](_0x8dfbfb)),_0x21ca03=![],_0x4a6022=_0x8dfbfb;},'abortSignal':_0x50407c[_0x483f30(0x2c0)]}),_0x3d1855=!![];}if(Number(_0x2013eb)===0x2){let _0x2e26b1=!![];const _0x515ac6=await this['gomaxAiStore']['buildMessageFromParentMessageId'](_0x366020?_0x5765cb:_0x34c62e,{'parentMessageId':_0x4511e1,'maxRounds':(0x0,helper_1[_0x483f30(0x34f)])(_0x31bc97)});_0x4c4f38=await(0x0,baidu_1[_0x483f30(0x214)])(_0x366020?_0x5765cb:_0x515ac6,{'temperature':_0x343fa2,'accessToken':_0x91bffb,'model':_0x4a81e9,'onProgress':_0x251321=>{const _0x447efb=_0x483f30;_0x2933db[_0x447efb(0x289)](_0x2e26b1?JSON[_0x447efb(0x295)](_0x251321):'\x0a'+JSON[_0x447efb(0x295)](_0x251321)),_0x2e26b1=![],_0x4a6022=_0x251321;}}),_0x3d1855=!![];}if(Number(_0x2013eb)===0x3){let _0x36517c=!![];const _0x437b7c=await this['gomaxAiStore'][_0x483f30(0x33a)](_0x366020?_0x5765cb:_0x34c62e,{'parentMessageId':_0x4511e1,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x31bc97)});_0x4c4f38=await(0x0,zhipu_1[_0x483f30(0x340)])(_0x366020?_0x5765cb:_0x437b7c,{'temperature':_0x343fa2,'key':_0x5d4ab0,'model':_0x4a81e9,'onProgress':_0x53e191=>{const _0x16629f=_0x483f30;_0x2933db[_0x16629f(0x289)](_0x36517c?JSON[_0x16629f(0x295)](_0x53e191):'\x0a'+JSON[_0x16629f(0x295)](_0x53e191)),_0x36517c=![],_0x4a6022=_0x53e191;}}),_0x3d1855=!![];}if(Number(_0x2013eb)===0x4){let _0x43dba1=!![];const {key:_0x427001,appid:_0x24aa38,secret:_0x2b93b6,model:_0x325168}=_0x29fc0b,_0x20eeb0=await this[_0x483f30(0x2a1)][_0x483f30(0x33a)](_0x366020?_0x5765cb:_0x34c62e,{'parentMessageId':_0x4511e1,'maxRounds':(0x0,helper_1[_0x483f30(0x34f)])(_0x31bc97)}),_0x3192d3=new spark_1[(_0x483f30(0x1f6))]({'appid':_0x24aa38,'secret':_0x2b93b6,'key':_0x427001});_0x4c4f38=await _0x3192d3[_0x483f30(0x308)](_0x366020?_0x5765cb:_0x20eeb0,{'temperature':_0x343fa2,'model':_0x325168,'onProgress':_0x1d814e=>{const _0x20a920=_0x483f30;_0x2933db[_0x20a920(0x289)](_0x43dba1?JSON[_0x20a920(0x295)](_0x1d814e):'\x0a'+JSON['stringify'](_0x1d814e)),_0x43dba1=![],_0x4a6022=_0x1d814e;},'abortController':_0x50407c}),_0x3d1855=!![];}const _0x4ae9d3={'id':this[_0x483f30(0x2a1)][_0x483f30(0x204)](),'text':_0x34c62e,'role':_0x483f30(0x30e),'name':undefined,'usage':null,'parentMessageId':_0x4511e1,'conversationId':_0x4c4f38?.[_0x483f30(0x342)]||null};_0x1f3cdc={'model':_0x4a81e9,'parentMessageId':_0x4511e1},await this[_0x483f30(0x2a1)][_0x483f30(0x2c2)](_0x4ae9d3);const _0xba4295={'id':_0x4c4f38?.['id']||this[_0x483f30(0x2a1)]['getUuid'](),'text':_0x4c4f38[_0x483f30(0x246)],'role':_0x483f30(0x281),'name':undefined,'usage':_0x4c4f38['usage'],'parentMessageId':_0x4ae9d3['id'],'conversationId':_0x4c4f38?.[_0x483f30(0x342)]};await this[_0x483f30(0x2a1)][_0x483f30(0x2c2)](_0xba4295),_0x1f3cdc={'model':_0x4a81e9,'parentMessageId':_0x4ae9d3['id']};}else console[_0x483f30(0x353)](_0x483f30(0x28e)),_0x4c4f38=await this[_0x483f30(0x2d1)]['sendMessage'](_0x366020?_0x5765cb:_0x34c62e,_0x34190d);const _0x4d15ad=(0x0,helper_1['unifiedFormattingResponse'])(_0x2013eb,_0x4c4f38,_0x1f3cdc),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x4d15ad[_0x483f30(0x2fb)];await this[_0x483f30(0x2ad)][_0x483f30(0x346)](_0x2e1362[_0x483f30(0x30e)]['id'],_0x483f30(0x331)+(_0x9c59c===0x1?0x3:0x4),_0x4d7616,total_tokens);_0x22a990===_0x483f30(0x301)?await this[_0x483f30(0x224)][_0x483f30(0x298)](_0x1af0a9,total_tokens):await this[_0x483f30(0x28d)][_0x483f30(0x221)](_0x1af0a9,total_tokens);const _0x3db42a=(0x0,utils_1[_0x483f30(0x2e0)])(_0x2e1362);await this[_0x483f30(0x2d6)]['saveChatLog']({'appId':_0x5a7c41,'curIp':_0x3db42a,'logType':_0x22a990===_0x483f30(0x301)?0x2:0x1,'userId':_0x2e1362[_0x483f30(0x30e)]['id'],'type':balance_constant_1[_0x483f30(0x291)][_0x483f30(0x34a)],'prompt':_0x34c62e,'answer':'','promptTokens':prompt_tokens,'completionTokens':0x0,'totalTokens':total_tokens,'model':_0x4d15ad['model'],'role':_0x483f30(0x30e),'groupId':_0x153daf,'requestOptions':JSON[_0x483f30(0x295)]({'options':null,'prompt':_0x34c62e}),'modelId':_0x5ddd57,'modelType':_0x59c572});const _0x5f193e=await this[_0x483f30(0x2d6)][_0x483f30(0x21a)]({'appId':_0x5a7c41,'curIp':_0x3db42a,'logType':_0x22a990===_0x483f30(0x301)?0x2:0x1,'userId':_0x2e1362[_0x483f30(0x30e)]['id'],'type':balance_constant_1[_0x483f30(0x291)][_0x483f30(0x34a)],'prompt':_0x34c62e,'answer':_0x4d15ad?.['text'],'promptTokens':prompt_tokens,'completionTokens':completion_tokens,'totalTokens':total_tokens,'model':_0x4a81e9,'role':_0x483f30(0x281),'groupId':_0x153daf,'requestOptions':JSON['stringify']({'options':{'model':_0x4a81e9,'temperature':_0x343fa2},'prompt':_0x34c62e}),'conversationOptions':JSON['stringify']({'conversationId':_0x4c4f38[_0x483f30(0x342)],'model':_0x4a81e9,'parentMessageId':_0x4c4f38['id'],'temperature':_0x343fa2}),'modelId':_0x5ddd57,'modelType':_0x59c572});common_1['Logger'][_0x483f30(0x2ca)](_0x483f30(0x218)+_0x2e1362['user']['id']+_0x483f30(0x314)+_0x4a81e9+_0x483f30(0x2fa)+_0x5d4ab0+_0x483f30(0x323)+_0x39bc13+_0x483f30(0x33c)+maxModelTokens+',\x20最大回复token:\x20'+maxResponseTokens,_0x483f30(0x219));const _0x48fd17=await this['userBalanceService'][_0x483f30(0x277)](_0x2e1362[_0x483f30(0x30e)]['id']);return _0x4c4f38[_0x483f30(0x349)]={..._0x48fd17},_0x4c4f38[_0x483f30(0x312)]&&(_0x4c4f38[_0x483f30(0x312)]=''),_0x4c4f38[_0x483f30(0x34e)]=!![],_0x4c4f38['chatLogId']=_0x5f193e['id'],_0x2933db?_0x2933db[_0x483f30(0x289)]('\x0a'+JSON[_0x483f30(0x295)](_0x4c4f38)):_0x4c4f38[_0x483f30(0x246)];}catch(_0x24374f){console[_0x483f30(0x353)](_0x483f30(0x21d),_0x5d4ab0,_0x24374f);const _0x175b50=_0x24374f['statusCode'];if(_0x24374f['status']&&_0x24374f['status']===0x192){const _0x3ebdf7={'message':_0x483f30(0x32a)+_0x24374f[_0x483f30(0x2ce)],'code':0x192};if(_0x2933db)return _0x2933db[_0x483f30(0x289)](JSON[_0x483f30(0x295)](_0x3ebdf7));else throw new common_1[(_0x483f30(0x2d0))](_0x24374f[_0x483f30(0x2ce)],common_1['HttpStatus'][_0x483f30(0x1f0)]);}if(!_0x175b50){if(_0x2933db)return _0x2933db['write'](JSON[_0x483f30(0x295)]({'message':_0x24374f['message'],'code':0x1f4}));else throw new common_1[(_0x483f30(0x2d0))](_0x24374f['message'],common_1[_0x483f30(0x237)][_0x483f30(0x33e)]);}let _0x6f14dd=errorMessage_constant_1[_0x483f30(0x2b9)][_0x175b50]?errorMessage_constant_1[_0x483f30(0x2b9)][_0x175b50]:_0x483f30(0x321);_0x24374f?.[_0x483f30(0x2ce)][_0x483f30(0x1dc)](_0x483f30(0x241))&&Number(_0x2013eb)===0x1&&(await this[_0x483f30(0x28d)][_0x483f30(0x255)](_0x1af0a9,_0x483f30(0x30b),-0x1),_0x6f14dd=_0x483f30(0x1de));_0x24374f?.[_0x483f30(0x33d)]===0x1ad&&_0x24374f['message'][_0x483f30(0x1dc)](_0x483f30(0x352))&&Number(_0x2013eb)===0x1&&(await this['modelsService']['lockKey'](_0x1af0a9,_0x483f30(0x2da),-0x3),_0x6f14dd=_0x483f30(0x305));_0x24374f?.[_0x483f30(0x33d)]===0x191&&_0x24374f[_0x483f30(0x2ce)]['includes'](_0x483f30(0x201))&&Number(_0x2013eb)===0x1&&(await this[_0x483f30(0x28d)]['lockKey'](_0x1af0a9,'模型秘钥错误或模型余额不足',-0x2),_0x6f14dd=_0x483f30(0x269));_0x24374f?.[_0x483f30(0x33d)]===0x191&&Number(_0x2013eb)===0x1&&(_0x6f14dd=_0x483f30(0x269));_0x24374f?.[_0x483f30(0x33d)]===0x191&&_0x24374f[_0x483f30(0x2ce)]['includes'](_0x483f30(0x27f))&&Number(_0x2013eb)===0x1&&(await this['modelsService']['lockKey'](_0x1af0a9,_0x483f30(0x1ea),-0x2),_0x6f14dd=_0x483f30(0x269));_0x24374f?.[_0x483f30(0x33d)]===0x194&&_0x24374f['message'][_0x483f30(0x1dc)](_0x483f30(0x29c))&&Number(_0x2013eb)===0x1&&(await this[_0x483f30(0x28d)]['lockKey'](_0x1af0a9,_0x483f30(0x30a),-0x4),_0x6f14dd=_0x483f30(0x30c));_0x175b50===0x190&&console[_0x483f30(0x353)]('400\x20error',_0x24374f,_0x24374f[_0x483f30(0x2ce)]);const _0x4b31d3={'message':_0x6f14dd||_0x483f30(0x34c),'code':_0x175b50===0x191?0x191:_0x175b50||0x1f4};if(_0x2933db)_0x2933db['statusCode']=0x190,_0x2933db['write'](JSON[_0x483f30(0x295)](_0x4b31d3));else throw new common_1['HttpException'](_0x4b31d3[_0x483f30(0x2ce)],common_1[_0x483f30(0x237)][_0x483f30(0x33e)]);}finally{_0x2933db&&_0x2933db[_0x483f30(0x1e7)]();}}async[_0x595a79(0x319)](_0x2021d2,_0x32a5eb,_0x517dd9){const _0x1d663b=_0x595a79,{audio:_0x12a39f,voice:_0x1a985b}=_0x2021d2,_0x26acb3=_0x32a5eb[_0x1d663b(0x20a)],_0x434307=await this[_0x1d663b(0x28d)][_0x1d663b(0x23f)]();if(!_0x434307)throw _0x1d663b(0x2f1);const {deduct:_0x1f60cf,deductType:_0x26c2b9,key:_0x151a22,timeout:_0x1cd884,proxyUrl:_0x42c51d}=_0x434307;await this[_0x1d663b(0x2f0)][_0x1d663b(0x235)](_0x32a5eb[_0x1d663b(0x30e)]),await this[_0x1d663b(0x2ad)][_0x1d663b(0x1fa)](_0x32a5eb,_0x26c2b9===0x1?_0x1d663b(0x360):_0x1d663b(0x294),_0x1f60cf),console[_0x1d663b(0x353)](_0x1d663b(0x32d),_0x151a22,_0x42c51d),this['openAi']['apiKey']=_0x151a22,this[_0x1d663b(0x343)][_0x1d663b(0x249)]=(_0x42c51d||this[_0x1d663b(0x31d)])+'/v1',this['openAi']['timeout']=0x989680;const _0x5522f2=await this['openAi'][_0x1d663b(0x247)][_0x1d663b(0x1f2)][_0x1d663b(0x328)]({'file':(0x0,fs_2[_0x1d663b(0x280)])((0x0,path_1[_0x1d663b(0x1e9)])(_0x12a39f[_0x1d663b(0x29f)])),'model':_0x1d663b(0x270),'language':'zh','response_format':_0x1d663b(0x2e8),'temperature':0x0})[_0x1d663b(0x27b)](_0x3ef75e=>_0x3ef75e[_0x1d663b(0x246)])[_0x1d663b(0x1e6)](_0x16cc40=>{const _0x26ecb5=_0x1d663b;common_1[_0x26ecb5(0x24c)]['error'](_0x16cc40);});console[_0x1d663b(0x353)](_0x1d663b(0x2de),_0x5522f2);if(!_0x5522f2){this[_0x1d663b(0x21f)]((0x0,path_1['resolve'])(_0x12a39f[_0x1d663b(0x29f)]));throw new common_1[(_0x1d663b(0x2d0))](_0x1d663b(0x213),common_1[_0x1d663b(0x237)]['BAD_REQUEST']);}const _0x33d280=await this[_0x1d663b(0x2ba)]({'userId':_0x32a5eb[_0x1d663b(0x30e)]['id'],'prompt':_0x5522f2,'abortController':_0x26acb3})[_0x1d663b(0x1e6)](_0xb9256e=>{const _0x4a13d7=_0x1d663b;common_1[_0x4a13d7(0x24c)][_0x4a13d7(0x30f)](_0xb9256e);});console[_0x1d663b(0x353)](_0x1d663b(0x329),_0x33d280);if(!_0x33d280){this[_0x1d663b(0x21f)]((0x0,path_1[_0x1d663b(0x1e9)])(_0x12a39f['path']));throw new common_1[(_0x1d663b(0x2d0))]('内容提取失败',common_1['HttpStatus'][_0x1d663b(0x33e)]);}console['log'](_0x1d663b(0x2f6),_0x33d280[_0x1d663b(0x24d)]);let _0x151d47=_0x33d280['length']>0x1000?_0x33d280[_0x1d663b(0x283)](0x0,0xfff):_0x33d280;const _0x3d4711=await this[_0x1d663b(0x343)][_0x1d663b(0x247)]['speech'][_0x1d663b(0x328)]({'input':_0x151d47,'model':_0x1d663b(0x32b),'response_format':_0x1d663b(0x268),'voice':_0x1a985b,'speed':0x1})['then'](_0x2e7b53=>_0x2e7b53[_0x1d663b(0x316)]())[_0x1d663b(0x1e6)](_0x45d483=>{const _0x56e1ae=_0x1d663b;common_1[_0x56e1ae(0x24c)][_0x56e1ae(0x30f)](_0x45d483);});if(!_0x3d4711){this['removeFile']((0x0,path_1[_0x1d663b(0x1e9)])(_0x12a39f[_0x1d663b(0x29f)]));throw new common_1[(_0x1d663b(0x2d0))](_0x1d663b(0x2e4),common_1[_0x1d663b(0x237)]['BAD_REQUEST']);}const _0x260152=Buffer[_0x1d663b(0x358)](_0x3d4711);return _0x517dd9[_0x1d663b(0x1ed)]('Content-type',_0x1d663b(0x306)),_0x517dd9[_0x1d663b(0x289)](_0x260152),_0x517dd9['end'](_0x260152),this[_0x1d663b(0x21f)]((0x0,path_1['resolve'])(_0x12a39f[_0x1d663b(0x29f)])),_0x260152;}async['requestFromGpt'](_0x53bdb1){const _0xff1f90=_0x595a79,{prompt:_0x44c3a2,userId:_0x54edb2,abortController:_0x445322}=_0x53bdb1,_0x91f1bf=await this[_0xff1f90(0x28d)][_0xff1f90(0x2fc)](model_constant_1['EModelType'][_0xff1f90(0x200)]),{keyType:_0x896033,model:_0x5259fb,topN:_0x5a71d5}=_0x91f1bf[_0xff1f90(0x35c)];let _0x48f13b=await this[_0xff1f90(0x28d)][_0xff1f90(0x330)](_0x5259fb);if(!_0x48f13b)throw new common_1[(_0xff1f90(0x2d0))](_0xff1f90(0x1f5),common_1['HttpStatus']['BAD_REQUEST']);const {deduct:_0x1db8fa,deductType:_0x3c4e18,key:_0x4c8bbf,id:_0x1429d0,parentMessageId:_0x332dc9,timeoutMs:_0x2ad56d}=_0x48f13b,{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000}=_0x48f13b,_0x35b563=await this[_0xff1f90(0x238)](_0x48f13b);this[_0xff1f90(0x2d1)][_0xff1f90(0x23b)]=(0x0,utils_1['removeSpecialCharacters'])(_0x4c8bbf),this['api']['apiBaseUrl']=_0x35b563+'/v1',this[_0xff1f90(0x2d1)]['maxModelTokens']=maxModelTokens,this[_0xff1f90(0x2d1)]['maxResponseTokens']=maxResponseTokens>=maxModelTokens?Math[_0xff1f90(0x2aa)](Math['floor'](maxModelTokens/0x2)):maxResponseTokens;let _0x37582d=null,_0x211748=null;try{const _0x4cc28b={'parentMessageId':_0x332dc9,'timeoutMs':+_0x2ad56d,'completionParams':{'model':_0x5259fb,'temperature':_0x5a71d5}};_0x37582d=await this[_0xff1f90(0x2d1)][_0xff1f90(0x348)](_0x44c3a2,{..._0x4cc28b,'abortSignal':_0x445322[_0xff1f90(0x2c0)]});const _0x2bef2c=(0x0,helper_1[_0xff1f90(0x23a)])(_0x896033,_0x37582d,_0x211748),{total_tokens:total_tokens=0x0}=_0x2bef2c[_0xff1f90(0x2fb)];return await this[_0xff1f90(0x2ad)][_0xff1f90(0x346)](_0x54edb2,_0xff1f90(0x331)+(_0x3c4e18===0x1?0x3:0x4),_0x1db8fa,total_tokens),await this['modelsService'][_0xff1f90(0x221)](_0x1429d0,total_tokens),_0x37582d[_0xff1f90(0x246)];}catch(_0x484af4){common_1['Logger'][_0xff1f90(0x353)](_0x484af4);const _0x41af2e=_0x484af4['statusCode'];console[_0xff1f90(0x353)](_0x41af2e);if(_0x484af4[_0xff1f90(0x1dd)]&&_0x484af4[_0xff1f90(0x1dd)]===0x192){const _0x3656a1={'message':_0xff1f90(0x32a)+_0x484af4[_0xff1f90(0x2ce)],'code':0x192};throw new common_1[(_0xff1f90(0x2d0))](_0x484af4[_0xff1f90(0x2ce)],common_1[_0xff1f90(0x237)]['PAYMENT_REQUIRED']);}if(!_0x41af2e)throw new common_1[(_0xff1f90(0x2d0))](_0x484af4[_0xff1f90(0x2ce)],common_1['HttpStatus'][_0xff1f90(0x33e)]);let _0x2d35e4=errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x41af2e]?errorMessage_constant_1[_0xff1f90(0x2b9)][_0x41af2e]:_0xff1f90(0x321);_0x484af4?.[_0xff1f90(0x2ce)][_0xff1f90(0x1dc)](_0xff1f90(0x241))&&Number(_0x896033)===0x1&&(await this[_0xff1f90(0x28d)][_0xff1f90(0x255)](_0x1429d0,_0xff1f90(0x30b),-0x1),_0x2d35e4='当前模型key已被封禁');_0x484af4?.[_0xff1f90(0x33d)]===0x1ad&&_0x484af4[_0xff1f90(0x2ce)]['includes']('You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.')&&Number(_0x896033)===0x1&&(await this[_0xff1f90(0x28d)][_0xff1f90(0x255)](_0x1429d0,_0xff1f90(0x2da),-0x3),_0x2d35e4=_0xff1f90(0x305));_0x484af4?.[_0xff1f90(0x33d)]===0x191&&_0x484af4[_0xff1f90(0x2ce)][_0xff1f90(0x1dc)](_0xff1f90(0x201))&&Number(_0x896033)===0x1&&(await this[_0xff1f90(0x28d)][_0xff1f90(0x255)](_0x1429d0,_0xff1f90(0x286),-0x2),_0x2d35e4='提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！');_0x484af4?.[_0xff1f90(0x33d)]===0x191&&_0x484af4[_0xff1f90(0x2ce)][_0xff1f90(0x1dc)](_0xff1f90(0x27f))&&Number(_0x896033)===0x1&&(await this[_0xff1f90(0x28d)][_0xff1f90(0x255)](_0x1429d0,_0xff1f90(0x305),-0x2),_0x2d35e4=_0xff1f90(0x209));_0x484af4?.[_0xff1f90(0x33d)]===0x194&&_0x484af4['message'][_0xff1f90(0x1dc)](_0xff1f90(0x29c))&&Number(_0x896033)===0x1&&(await this[_0xff1f90(0x28d)][_0xff1f90(0x255)](_0x1429d0,_0xff1f90(0x30a),-0x4),_0x2d35e4='当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！');_0x484af4?.[_0xff1f90(0x33d)]===0x133&&_0x484af4[_0xff1f90(0x2ce)][_0xff1f90(0x1dc)]('bad\x20response\x20status\x20code\x20307')&&Number(_0x896033)===0x1&&(console[_0xff1f90(0x353)](_0xff1f90(0x24e)),_0x2d35e4='\x20！');_0x41af2e===0x190&&console[_0xff1f90(0x353)](_0xff1f90(0x1e3),_0x484af4,_0x484af4['message']);const _0x1e7a62={'message':_0x2d35e4||_0xff1f90(0x34c),'code':_0x41af2e===0x191?0x191:_0x41af2e||0x1f4};throw new common_1[(_0xff1f90(0x2d0))](_0x1e7a62['message'],common_1[_0xff1f90(0x237)][_0xff1f90(0x33e)]);}}async['draw'](_0x21d499,_0x115a55){const _0x1cc2d9=_0x595a79;await this[_0x1cc2d9(0x210)]['checkBadWords'](_0x21d499[_0x1cc2d9(0x1e1)],_0x115a55[_0x1cc2d9(0x30e)]['id']),common_1[_0x1cc2d9(0x24c)][_0x1cc2d9(0x353)]('draw\x20paompt\x20info\x20<======*******======>\x20'+_0x21d499[_0x1cc2d9(0x1e1)],_0x1cc2d9(0x2c3)),await this[_0x1cc2d9(0x2f0)][_0x1cc2d9(0x235)](_0x115a55['user']),await this[_0x1cc2d9(0x2ad)][_0x1cc2d9(0x1fa)](_0x115a55,balance_constant_1[_0x1cc2d9(0x291)][_0x1cc2d9(0x1db)],_0x21d499['n']||0x1);let _0x5431c0=[];const _0x110dbb=await this[_0x1cc2d9(0x28d)][_0x1cc2d9(0x322)](model_constant_1['EModelType'][_0x1cc2d9(0x2d8)]),{key:_0x130e11,model:_0x26db98,proxyUrl:_0x4713a8}=await this[_0x1cc2d9(0x24a)](_0x110dbb),_0x3db10e=_0x4713a8+_0x1cc2d9(0x27e);try{const _0x333159=await axios_1[_0x1cc2d9(0x1e8)][_0x1cc2d9(0x2b5)](_0x3db10e,{..._0x21d499,'model':_0x26db98,'response_format':_0x1cc2d9(0x256)},{'headers':{'Authorization':_0x1cc2d9(0x1da)+_0x130e11}});_0x5431c0=_0x333159[_0x1cc2d9(0x1fe)]['data'];}catch(_0x512829){console[_0x1cc2d9(0x353)]('openai-draw',_0x512829);const _0x248c7a=_0x512829?.[_0x1cc2d9(0x29a)]?.[_0x1cc2d9(0x1dd)]||0x1f4,_0x2a9987=_0x512829?.[_0x1cc2d9(0x29a)]?.[_0x1cc2d9(0x1fe)]?.[_0x1cc2d9(0x30f)]?.[_0x1cc2d9(0x2ce)];if(_0x248c7a===0x1ad)throw new common_1['HttpException']('当前请求已过载、请稍等会儿再试试吧！',common_1[_0x1cc2d9(0x237)][_0x1cc2d9(0x33e)]);if(_0x248c7a===0x190||_0x2a9987['includes'](_0x1cc2d9(0x2f3)))throw new common_1[(_0x1cc2d9(0x2d0))]('您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',common_1['HttpStatus'][_0x1cc2d9(0x33e)]);if(_0x248c7a===0x1f4)throw new common_1[(_0x1cc2d9(0x2d0))](_0x1cc2d9(0x318),common_1[_0x1cc2d9(0x237)][_0x1cc2d9(0x33e)]);if(_0x248c7a===0x191)throw new common_1['HttpException']('绘制图片失败，此次绘画被拒绝了！',common_1[_0x1cc2d9(0x237)][_0x1cc2d9(0x33e)]);throw new common_1[(_0x1cc2d9(0x2d0))]('绘制图片失败，请稍后试试吧！',common_1[_0x1cc2d9(0x237)][_0x1cc2d9(0x33e)]);}const _0x3f662e=[];for(const _0x3448e8 of _0x5431c0){const _0x410d7b=uuid['v4']()['slice'](0x0,0xa)+'.png',_0x1c7050=Buffer[_0x1cc2d9(0x358)](_0x3448e8['b64_json'],_0x1cc2d9(0x1fc));_0x3f662e[_0x1cc2d9(0x1eb)](this[_0x1cc2d9(0x350)]['uploadFile']({'filename':_0x410d7b,'buffer':_0x1c7050}));}const _0x33e8e0=await Promise[_0x1cc2d9(0x2b1)](_0x3f662e);await this['userBalanceService'][_0x1cc2d9(0x346)](_0x115a55[_0x1cc2d9(0x30e)]['id'],_0x1cc2d9(0x360),_0x21d499['n'],_0x21d499['n']||0x1);const _0x1e58ba=(0x0,utils_1['getClientIp'])(_0x115a55),_0x27ed2d=[],_0x38ba9d=await this[_0x1cc2d9(0x350)][_0x1cc2d9(0x2d7)](),[_0xbca6bc,_0x2a17b8]=_0x21d499[_0x1cc2d9(0x300)][_0x1cc2d9(0x211)]('x');return _0x33e8e0[_0x1cc2d9(0x1e2)](_0x2cb0e9=>{const _0x189288=_0x1cc2d9;_0x27ed2d['push'](this['chatLogService'][_0x189288(0x21a)]({'curIp':_0x1e58ba,'logType':0x3,'userId':_0x115a55[_0x189288(0x30e)]['id'],'type':balance_constant_1['DeductionKey'][_0x189288(0x1db)],'prompt':_0x21d499[_0x189288(0x1e1)],'answer':_0x2cb0e9,'fileInfo':JSON[_0x189288(0x295)]({'cosType':_0x38ba9d,'width':_0xbca6bc,'height':_0x2a17b8,'cosUrl':_0x2cb0e9}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x189288(0x2c1)}));}),await Promise[_0x1cc2d9(0x2b1)](_0x27ed2d),_0x33e8e0;}async['getKeyDetail'](_0x264dc3){const _0x23822c=_0x595a79,_0x1c6781=await this[_0x23822c(0x32c)][_0x23822c(0x357)](['openaiBaseUrl'])||'https://api.openai.com';try{const _0x561ef8={'Content-Type':_0x23822c(0x229),'Authorization':_0x23822c(0x1da)+_0x264dc3},_0x284c4d=dayjs()[_0x23822c(0x2cd)]('YYYY-MM-DD'),_0x51eec5=dayjs()[_0x23822c(0x226)](0x63,'day')['format']('YYYY-MM-DD'),_0x343f97=await axios_1[_0x23822c(0x1e8)][_0x23822c(0x2fe)](_0x1c6781+_0x23822c(0x31f)+_0x51eec5+_0x23822c(0x1e4)+_0x284c4d,{'headers':_0x561ef8}),_0x5168b4=_0x343f97?.[_0x23822c(0x1fe)][_0x23822c(0x28a)]??0x0,_0x5e2314=await axios_1[_0x23822c(0x1e8)][_0x23822c(0x2fe)](_0x1c6781+_0x23822c(0x23c),{'headers':_0x561ef8}),{has_payment_method:_0x50e666,hard_limit_usd:_0x2270c5,access_until:_0x372d08}=_0x5e2314[_0x23822c(0x1fe)],_0x5656f9=(_0x5168b4/0x64)['toFixed'](0x2),_0x141992=Number(_0x2270c5)[_0x23822c(0x234)](0x0);return{'totalAmount':_0x141992+'$','useAmount':_0x5656f9+'$','balance':(Number(_0x141992)-Number(_0x5656f9))[_0x23822c(0x234)](0x2)+'$','isBindCard':_0x50e666,'expirDate':dayjs(_0x372d08*0x3e8)['format'](_0x23822c(0x324)),'status':0x1};}catch(_0x5aa977){return{'status':-0x1};}}async[_0x595a79(0x26f)](_0x4a5650,_0x5b15c2){const _0x3c29b3=_0x595a79;let _0x362b42={};_0x5b15c2===0x3?_0x362b42=await this[_0x3c29b3(0x212)](0x3):_0x362b42=await this[_0x3c29b3(0x212)](0x4);const {model:_0x75385c,key:_0x4f04c1,id:_0x282b27}=_0x362b42;return await this[_0x3c29b3(0x2d2)][_0x3c29b3(0x28f)]()['update'](gptKeys_entity_1[_0x3c29b3(0x22d)])['set']({'useCount':()=>_0x3c29b3(0x362)})[_0x3c29b3(0x276)](_0x3c29b3(0x35b),{'id':_0x282b27})[_0x3c29b3(0x1ee)](),_0x362b42;}async[_0x595a79(0x242)](_0xfbd031){const _0x141bde=_0x595a79,_0x4125f5=await this[_0x141bde(0x32c)][_0x141bde(0x357)]([_0x141bde(0x337)])||_0x141bde(0x245),_0x23becf=_0x4125f5+_0x141bde(0x2a5);try{const _0x44ee0d=await axios_1[_0x141bde(0x1e8)]['get'](_0x23becf,{'headers':{'Authorization':_0x141bde(0x1da)+_0xfbd031}}),_0x3decba=_0x44ee0d[_0x141bde(0x1fe)][_0x141bde(0x1fe)][_0x141bde(0x22f)](_0x4e3f77=>_0x4e3f77['id']);return model_constant_1[_0x141bde(0x20c)][_0x141bde(0x2a4)](_0x5d9220=>_0x3decba[_0x141bde(0x1dc)](_0x5d9220));}catch(_0xf60f73){throw new common_1[(_0x141bde(0x2d0))](_0x141bde(0x2e3),common_1[_0x141bde(0x237)]['BAD_REQUEST']);}}async[_0x595a79(0x239)](_0x47cdeb,_0x2be815){const _0x1712d7=_0x595a79;try{const _0x51e317={},{page:page=0x1,size:size=0xa,key:_0x400d37,status:_0x5797ef,keyStatus:_0x543aee,model:_0x14ba15}=_0x47cdeb;_0x400d37&&(_0x51e317[_0x1712d7(0x22a)]=(0x0,typeorm_1[_0x1712d7(0x28c)])('%'+_0x400d37+'%')),_0x543aee&&(_0x51e317[_0x1712d7(0x34b)]=_0x543aee),_0x14ba15&&(_0x51e317[_0x1712d7(0x331)]=_0x14ba15),[0x0,0x1,'0','1','-1',-0x1][_0x1712d7(0x1dc)](_0x5797ef)&&(_0x51e317[_0x1712d7(0x1dd)]=_0x5797ef);const [_0xe1794d,_0x205317]=await this[_0x1712d7(0x2d2)][_0x1712d7(0x338)]({'skip':(page-0x1)*size,'take':size,'where':_0x51e317,'order':{'id':_0x1712d7(0x30d)}}),_0x90043b=[];_0xe1794d[_0x1712d7(0x1e2)](_0x414fd1=>_0x90043b[_0x1712d7(0x1eb)](this[_0x1712d7(0x271)](_0x414fd1[_0x1712d7(0x22a)])));const _0x2ca2de=await Promise['all'](_0x90043b);return _0xe1794d['forEach']((_0x2775af,_0x38919e)=>_0x2775af['keyDetail']=_0x2ca2de[_0x38919e]),_0x2be815[_0x1712d7(0x30e)][_0x1712d7(0x2df)]!==_0x1712d7(0x327)&&_0xe1794d[_0x1712d7(0x1e2)](_0x17c4e8=>{const _0xc69e5a=_0x1712d7;_0x17c4e8[_0xc69e5a(0x22a)]=_0x17c4e8['key']?(0x0,utils_1[_0xc69e5a(0x2bd)])(_0x17c4e8['key']):'',_0x17c4e8[_0xc69e5a(0x2b4)]=_0x17c4e8[_0xc69e5a(0x2b4)]?(0x0,utils_1['hideString'])(_0x17c4e8[_0xc69e5a(0x2b4)]):'';}),{'rows':_0xe1794d,'count':_0x205317};}catch(_0x319791){console['log']('error:\x20',_0x319791);throw new common_1['HttpException'](_0x1712d7(0x236),common_1['HttpStatus'][_0x1712d7(0x33e)]);}}async[_0x595a79(0x297)](_0x3e84f9){const _0x3d86c1=_0x595a79,{key:_0x12774f}=_0x3e84f9,_0x4cf51a=await this[_0x3d86c1(0x2d2)][_0x3d86c1(0x29e)]({'where':{'key':_0x12774f}});if(_0x4cf51a)throw new common_1[(_0x3d86c1(0x2d0))](_0x3d86c1(0x288),common_1[_0x3d86c1(0x237)][_0x3d86c1(0x33e)]);const _0x5c422f=await this[_0x3d86c1(0x2d2)][_0x3d86c1(0x34d)](_0x3e84f9);return await this[_0x3d86c1(0x24b)](),_0x5c422f;}async[_0x595a79(0x1df)](_0x53434e){const _0x3a5a17=_0x595a79,{keyList:_0x4bffac}=_0x53434e,_0x66ac35=await this[_0x3a5a17(0x2d2)][_0x3a5a17(0x2bc)]({'where':{'key':(0x0,typeorm_1['In'])(_0x4bffac)}}),_0x204a89=_0x66ac35['map'](_0x1854aa=>_0x1854aa[_0x3a5a17(0x22a)]),_0x1a50e5=_0x4bffac[_0x3a5a17(0x2a4)](_0x2689fe=>!_0x204a89[_0x3a5a17(0x1dc)](_0x2689fe)),_0x2089ec=_0x1a50e5[_0x3a5a17(0x22f)](_0x1b8ba3=>{const _0x392191=_0x3a5a17;return{'key':_0x1b8ba3,'status':0x1,'model':_0x392191(0x2a8)};}),_0x122903=await this['gptKeysEntity']['save'](_0x2089ec);let _0x2ee22d='本次成功添加'+_0x2089ec[_0x3a5a17(0x24d)]+'个key';return _0x204a89[_0x3a5a17(0x24d)]&&(_0x2ee22d+=_0x3a5a17(0x208)+_0x204a89['length']+_0x3a5a17(0x2c4)),_0x2ee22d;}async['updateKey'](_0x498271){const _0x5c8402=_0x595a79,{id:_0x428bad}=_0x498271,_0x4c41eb=await this[_0x5c8402(0x2d2)]['findOne']({'where':{'id':_0x428bad}});if(!_0x4c41eb)throw new common_1[(_0x5c8402(0x2d0))](_0x5c8402(0x29b),common_1[_0x5c8402(0x237)]['BAD_REQUEST']);const _0x52d871=await this[_0x5c8402(0x2d2)][_0x5c8402(0x2b7)]({'id':_0x428bad},_0x498271);if(_0x52d871[_0x5c8402(0x354)]>0x0)return await this[_0x5c8402(0x24b)](),_0x5c8402(0x307);else throw new common_1[(_0x5c8402(0x2d0))](_0x5c8402(0x296),common_1[_0x5c8402(0x237)][_0x5c8402(0x33e)]);}async[_0x595a79(0x230)](_0x4082f9){const _0x1c3fd5=_0x595a79,{id:_0x2302e1}=_0x4082f9,_0x18a52d=await this[_0x1c3fd5(0x2d2)]['findOne']({'where':{'id':_0x2302e1}});if(!_0x18a52d)throw new common_1[(_0x1c3fd5(0x2d0))]('key不存在',common_1[_0x1c3fd5(0x237)]['BAD_REQUEST']);const _0x3614c8=await this['gptKeysEntity'][_0x1c3fd5(0x267)]({'id':_0x2302e1});if(_0x3614c8[_0x1c3fd5(0x354)]>0x0)return await this[_0x1c3fd5(0x24b)](),_0x1c3fd5(0x1ef);else throw new common_1[(_0x1c3fd5(0x2d0))]('删除失败',common_1[_0x1c3fd5(0x237)]['BAD_REQUEST']);}async[_0x595a79(0x24b)](){const _0x206e73=_0x595a79,_0x1a7eff=await this[_0x206e73(0x2d2)][_0x206e73(0x2bc)]({'where':{'status':0x1},'select':['id',_0x206e73(0x22a),'weight',_0x206e73(0x331),'maxModelTokens',_0x206e73(0x347),_0x206e73(0x2b4),_0x206e73(0x2b8)]}),_0x553859=_0x1a7eff['filter'](_0xcefc5=>_0xcefc5['model'][_0x206e73(0x1dc)]('gpt-3')),_0x1e36f3=_0x1a7eff[_0x206e73(0x2a4)](_0x3f1579=>_0x3f1579[_0x206e73(0x331)][_0x206e73(0x1dc)](_0x206e73(0x258)));this[_0x206e73(0x1f8)]={'list3':_0x553859,'list4':_0x1e36f3};}async['getUserWhiteList'](){const _0x83d5df=_0x595a79;return await this[_0x83d5df(0x23d)][_0x83d5df(0x2bc)]({'where':{'status':0x1,'count':(0x0,typeorm_1['MoreThan'])(0x0)},'select':[_0x83d5df(0x248)]});}async[_0x595a79(0x2dc)](_0x6ddc86){const _0xeaa530=_0x595a79,{userId:_0x39e676,count:_0x483455}=_0x6ddc86,_0x509533=await this[_0xeaa530(0x23d)][_0xeaa530(0x29e)]({'where':{'userId':_0x39e676}});if(_0x509533)throw new common_1[(_0xeaa530(0x2d0))](_0xeaa530(0x240),common_1[_0xeaa530(0x237)]['BAD_REQUEST']);const _0x153d4d=await this[_0xeaa530(0x23d)][_0xeaa530(0x34d)](_0x6ddc86);return await this[_0xeaa530(0x2a9)](),_0x153d4d;}async['updateWhiteUser'](_0x8e4077){const _0x45b35a=_0x595a79,{id:_0x356fa8}=_0x8e4077,_0x5de5d4=await this[_0x45b35a(0x23d)][_0x45b35a(0x29e)]({'where':{'id':_0x356fa8}});if(!_0x5de5d4)throw new common_1[(_0x45b35a(0x2d0))](_0x45b35a(0x26c),common_1[_0x45b35a(0x237)][_0x45b35a(0x33e)]);const _0x7f609=await this[_0x45b35a(0x23d)][_0x45b35a(0x2b7)]({'id':_0x356fa8},_0x8e4077);if(_0x7f609[_0x45b35a(0x354)]>0x0)return await this['getUserWhiteList'](),_0x45b35a(0x215);else throw new common_1[(_0x45b35a(0x2d0))](_0x45b35a(0x2ab),common_1[_0x45b35a(0x237)][_0x45b35a(0x33e)]);}async[_0x595a79(0x31c)](_0x435f53,_0x34ec32){const _0x551ea4=_0x595a79,{page:page=0x1,size:size=0xa}=_0x435f53,[_0x3b4083,_0x517f38]=await this[_0x551ea4(0x23d)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'order':{'id':'DESC'}}),_0x469a16=_0x3b4083['map'](_0x24f826=>_0x24f826[_0x551ea4(0x248)]),_0x235567=await this[_0x551ea4(0x1ec)][_0x551ea4(0x2bc)]({'where':{'id':(0x0,typeorm_1['In'])(_0x469a16)}});return _0x3b4083['forEach'](_0x3c8801=>{const _0x50f57d=_0x551ea4,_0x37117b=_0x235567['find'](_0x1150db=>_0x1150db['id']===_0x3c8801[_0x50f57d(0x248)]);_0x3c8801[_0x50f57d(0x272)]=_0x37117b?.[_0x50f57d(0x272)]??'',_0x3c8801['email']=_0x37117b?.['email']??'';}),_0x34ec32[_0x551ea4(0x30e)][_0x551ea4(0x2df)]!=='super'&&_0x3b4083['forEach'](_0x1fcaba=>_0x1fcaba[_0x551ea4(0x228)]=(0x0,utils_1[_0x551ea4(0x2b3)])(_0x1fcaba[_0x551ea4(0x228)])),{'rows':_0x3b4083,'count':_0x517f38};}async['getModelProxyUrl'](_0x82a0bd){const _0x3298e3=_0x595a79,{proxyUrl:_0x3e5467}=_0x82a0bd,_0x47185f=await this[_0x3298e3(0x32c)][_0x3298e3(0x357)](['openaiBaseUrl']);return _0x3e5467||_0x47185f||_0x3298e3(0x245);}async['uploadFile'](_0x238b14,_0x285b03){const _0x3442ad=_0x595a79;try{const {cosBucket:_0x3e29ab,cosRegion:_0x535148,tencentCosStatus:_0x22d33,tencentCosAcceleratedDomain:_0x44bdc1}=await this[_0x3442ad(0x32c)][_0x3442ad(0x357)](['cosBucket','cosRegion','tencentCosStatus',_0x3442ad(0x2e9)]);if(_0x22d33!=='1')throw new common_1['HttpException'](_0x3442ad(0x302),common_1['HttpStatus'][_0x3442ad(0x33e)]);!this[_0x3442ad(0x332)]&&await this[_0x3442ad(0x225)](!![]);const _0x929ea7=_0x3442ad(0x304),_0x426c24=(0x0,path_1[_0x3442ad(0x2cb)])(_0x285b03[_0x3442ad(0x25b)]),_0x17d8b8=await this[_0x3442ad(0x332)][_0x3442ad(0x244)]({'Bucket':_0x3e29ab,'Region':_0x535148,'Key':_0x929ea7+Date[_0x3442ad(0x21e)]()+(''+_0x426c24),'Body':(0x0,fs_2['createReadStream'])((0x0,path_1[_0x3442ad(0x1e9)])(_0x285b03[_0x3442ad(0x29f)])),'onProgress':_0x44ecd0=>{const _0x54c289=_0x3442ad;common_1['Logger'][_0x54c289(0x353)](_0x44ecd0,'upload\x20cos');}})['catch'](_0x1923f2=>{throw _0x1923f2;});return'https://'+_0x17d8b8[_0x3442ad(0x359)];}catch(_0x3dfc95){return console[_0x3442ad(0x353)](_0x3dfc95),Promise[_0x3442ad(0x284)](_0x3dfc95);}}async[_0x595a79(0x361)](_0x2e52e2){const _0x3c2f8d=_0x595a79,{purpose:_0x67fc21,files:_0x2cb6ac}=_0x2e52e2,_0x249537=new FormData(),_0x1c79d2=(0x0,fs_2['createReadStream'])((0x0,path_1[_0x3c2f8d(0x1e9)])(_0x2cb6ac[_0x3c2f8d(0x29f)]));_0x249537[_0x3c2f8d(0x266)]('purpose',_0x67fc21),_0x249537[_0x3c2f8d(0x266)](_0x3c2f8d(0x2f2),_0x1c79d2);const _0x18f43e=_0x249537['getHeaders'](),_0x38c70a=()=>{return new Promise((_0x41a9f1,_0x5611ae)=>{const _0x110873=_0xb432;_0x249537[_0x110873(0x260)]((_0x1c5ec6,_0x26bf97)=>{const _0x5365c3=_0x110873;if(_0x1c5ec6)_0x5611ae(_0x1c5ec6);console[_0x5365c3(0x353)](_0x5365c3(0x24d),_0x26bf97),_0x41a9f1(_0x26bf97);});});};_0x18f43e['content-length']=await _0x38c70a();const _0x42e413=await this[_0x3c2f8d(0x32c)][_0x3c2f8d(0x357)](['openaiBaseUrl']),_0xc134a4='',_0x5783d1=_0xc134a4||_0x42e413||'https://api.openai.com';await axios_1['default'][_0x3c2f8d(0x222)]({'baseURL':_0x5783d1+'/v1/files','method':_0x3c2f8d(0x2b5),'headers':_0x18f43e,'data':_0x249537,'onUploadProgress':_0x33a9ad=>{console['log'](_0x33a9ad);}})[_0x3c2f8d(0x27b)](_0x5d6038=>{const _0x2e9399=_0x3c2f8d;console[_0x2e9399(0x353)](_0x5d6038);});}async[_0x595a79(0x24a)](_0x4ee33d){const _0x4d61ff=_0x595a79,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x4d61ff(0x32c)][_0x4d61ff(0x357)](['openaiModel3MaxTokens',_0x4d61ff(0x217),_0x4d61ff(0x2f9),_0x4d61ff(0x32e),_0x4d61ff(0x262),_0x4d61ff(0x355),'openaiModel4MaxTokens32k',_0x4d61ff(0x2ff),_0x4d61ff(0x337)]);let _0x8fdc23=null,_0x3d5a9c=null,_0x421984=null;const {model:_0x291cd5,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x1f877b,key:_0xe2e96d}=_0x4ee33d;return _0x291cd5[_0x4d61ff(0x250)]()['includes'](_0x4d61ff(0x258))&&(_0x291cd5[_0x4d61ff(0x250)]()[_0x4d61ff(0x1dc)]('32k')?(_0x8fdc23=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x3d5a9c=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x8fdc23=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x3d5a9c=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x291cd5[_0x4d61ff(0x250)]()[_0x4d61ff(0x1dc)](_0x4d61ff(0x1f7))&&(_0x291cd5[_0x4d61ff(0x250)]()[_0x4d61ff(0x1dc)]('16k')?(_0x8fdc23=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x3d5a9c=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x8fdc23=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x3d5a9c=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x421984=_0x1f877b||openaiBaseUrl||_0x4d61ff(0x245),_0x3d5a9c>=_0x8fdc23&&(_0x3d5a9c=Math[_0x4d61ff(0x263)](_0x8fdc23/0x2),common_1['Logger'][_0x4d61ff(0x2ca)](_0x4d61ff(0x202)+_0xe2e96d+_0x4d61ff(0x336)+_0x3d5a9c)),{'key':_0xe2e96d,'model':_0x291cd5,'maxToken':_0x8fdc23,'maxTokenRes':_0x3d5a9c,'proxyUrl':_0x421984};}async[_0x595a79(0x2c6)](_0x36dde3,_0xc4ae7){const _0x43a98e=_0x595a79;let _0x84be44;if(_0x36dde3[_0x43a98e(0x279)][_0x43a98e(0x259)]){const _0x35a468=_0x36dde3[_0x43a98e(0x279)][_0x43a98e(0x259)][_0x43a98e(0x211)]('\x20'),_0x560ca3=jwt[_0x43a98e(0x2fd)](_0x35a468[0x1],process['env'][_0x43a98e(0x2cf)]);_0x84be44=_0x560ca3['id'];}try{const {page:page=0x1,size:size=0x14,order:_0x19da71,keyword:_0x3808ad}=_0xc4ae7,_0x42a421=await this[_0x43a98e(0x33b)][_0x43a98e(0x33f)](_0x43a98e(0x252)+(_0x3808ad?'AND\x20(\x20c.prompt\x20LIKE\x20\x27%'+_0x3808ad+'%\x27\x20OR\x20c.answer\x20LIKE\x20\x27%'+_0x3808ad+_0x43a98e(0x21b):'')+_0x43a98e(0x216)),_0x34f2f3=await this[_0x43a98e(0x33b)][_0x43a98e(0x33f)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20c.id\x20AND\x20ale.relate_type\x20=\x20\x27suno\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.isDelete\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.role\x20=\x20\x27assistant\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27music\x27\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x3808ad?_0x43a98e(0x2f5)+_0x3808ad+_0x43a98e(0x27c)+_0x3808ad+_0x43a98e(0x21b):'')+_0x43a98e(0x2d3)+(_0x19da71?_0x19da71:_0x43a98e(0x251))+_0x43a98e(0x264)+size+_0x43a98e(0x282)+(page-0x1)*size+_0x43a98e(0x216)),_0x5a56b6=_0x34f2f3[_0x43a98e(0x22f)](_0x4e002c=>_0x4e002c['id']),_0x325114=new Map();if(_0x84be44&&_0x5a56b6[_0x43a98e(0x24d)]){const _0x5987a0=await this['aiAgreeLogEntity'][_0x43a98e(0x2bc)]({'where':{'userId':_0x84be44,'relateId':(0x0,typeorm_1['In'])(_0x5a56b6)}});_0x5987a0[_0x43a98e(0x1e2)](_0x267648=>{const _0x33748d=_0x43a98e;_0x325114[_0x33748d(0x2bb)](_0x267648[_0x33748d(0x2ef)],_0x267648[_0x33748d(0x311)]);});}const _0x5c5c07=_0x34f2f3[_0x43a98e(0x22f)](_0x5ea58b=>{const _0x429b82=_0x43a98e,{prompt:_0x4a9df5,role:_0xf5c6a6,answer:_0x42bbc7,createdAt:_0xc4e949,model:_0x461753,conversationOptions:_0x41fdfa,requestOptions:_0x66c9a9,id:_0xfefb92}=_0x5ea58b;return{'chatId':_0xfefb92,'error':![],'playNum':_0x5ea58b[_0x429b82(0x2dd)],'agreeNum':_0x5ea58b[_0x429b82(0x274)],'inversion':_0xf5c6a6===_0x429b82(0x30e),'agree':_0x325114[_0x429b82(0x2fe)](_0xfefb92)||null,'dateTime':(0x0,utils_1[_0x429b82(0x32f)])(_0xc4e949),'text':_0xf5c6a6===_0x429b82(0x30e)?_0x4a9df5:_0x42bbc7,'requestOptions':_0x66c9a9?JSON[_0x429b82(0x23e)](_0x66c9a9):null,'conversationOptions':_0x41fdfa?JSON[_0x429b82(0x23e)](_0x41fdfa):null};});return{'records':_0x5c5c07,'count':Number(_0x42a421[0x0]?.[_0x43a98e(0x303)]||0x0)};}catch(_0x5f0733){throw new common_1[(_0x43a98e(0x2d0))](_0x5f0733[_0x43a98e(0x2ce)],common_1['HttpStatus'][_0x43a98e(0x33e)]);}}};ChatgptService=__decorate([(0x0,common_1[_0x595a79(0x2f7)])(),__param(0x0,(0x0,typeorm_2[_0x595a79(0x2ea)])(user_entity_1[_0x595a79(0x31a)])),__param(0x1,(0x0,typeorm_2[_0x595a79(0x2ea)])(gptKeys_entity_1[_0x595a79(0x22d)])),__param(0x2,(0x0,typeorm_2[_0x595a79(0x2ea)])(whiteList_entity_1['WhiteListEntity'])),__param(0x3,(0x0,typeorm_2[_0x595a79(0x2ea)])(app_entity_1[_0x595a79(0x1e0)])),__param(0x4,(0x0,typeorm_2[_0x595a79(0x2ea)])(chatLog_entity_1[_0x595a79(0x20b)])),__param(0x5,(0x0,typeorm_2['InjectRepository'])(aiAgreeLog_entity_1[_0x595a79(0x31b)])),__metadata('design:paramtypes',[typeorm_1[_0x595a79(0x275)],typeorm_1[_0x595a79(0x275)],typeorm_1[_0x595a79(0x275)],typeorm_1[_0x595a79(0x275)],typeorm_1[_0x595a79(0x275)],typeorm_1['Repository'],userBalance_service_1[_0x595a79(0x29d)],chatLog_service_1['ChatLogService'],user_service_1[_0x595a79(0x22c)],upload_service_1[_0x595a79(0x287)],badwords_service_1['BadwordsService'],autoreply_service_1[_0x595a79(0x205)],globalConfig_service_1[_0x595a79(0x2c9)],chatGroup_service_1[_0x595a79(0x253)],models_service_1[_0x595a79(0x315)],gpts_service_1[_0x595a79(0x1f1)],typeorm_1[_0x595a79(0x203)]])],ChatgptService),exports[_0x595a79(0x219)]=ChatgptService;