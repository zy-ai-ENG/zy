'use strict';const _0x176999=_0x3a13;(function(_0x43ded6,_0x18f5d7){const _0x11d81b=_0x3a13,_0x234ada=_0x43ded6();while(!![]){try{const _0x213ae3=parseInt(_0x11d81b(0x187))/0x1+-parseInt(_0x11d81b(0x223))/0x2+-parseInt(_0x11d81b(0x204))/0x3+parseInt(_0x11d81b(0x19e))/0x4*(-parseInt(_0x11d81b(0x2b0))/0x5)+-parseInt(_0x11d81b(0x227))/0x6+parseInt(_0x11d81b(0x168))/0x7*(-parseInt(_0x11d81b(0x2a8))/0x8)+parseInt(_0x11d81b(0x14c))/0x9;if(_0x213ae3===_0x18f5d7)break;else _0x234ada['push'](_0x234ada['shift']());}catch(_0x4fb786){_0x234ada['push'](_0x234ada['shift']());}}}(_0x26da,0xcd9e8));var __decorate=this&&this['__decorate']||function(_0x4e2059,_0x391bc5,_0x503b70,_0x4409b2){const _0x36df16=_0x3a13;var _0x2adec1=arguments['length'],_0x2df11d=_0x2adec1<0x3?_0x391bc5:_0x4409b2===null?_0x4409b2=Object[_0x36df16(0x253)](_0x391bc5,_0x503b70):_0x4409b2,_0xf283a1;if(typeof Reflect===_0x36df16(0x1d6)&&typeof Reflect['decorate']===_0x36df16(0x28b))_0x2df11d=Reflect[_0x36df16(0x148)](_0x4e2059,_0x391bc5,_0x503b70,_0x4409b2);else{for(var _0x55b26c=_0x4e2059[_0x36df16(0x1f6)]-0x1;_0x55b26c>=0x0;_0x55b26c--)if(_0xf283a1=_0x4e2059[_0x55b26c])_0x2df11d=(_0x2adec1<0x3?_0xf283a1(_0x2df11d):_0x2adec1>0x3?_0xf283a1(_0x391bc5,_0x503b70,_0x2df11d):_0xf283a1(_0x391bc5,_0x503b70))||_0x2df11d;}return _0x2adec1>0x3&&_0x2df11d&&Object[_0x36df16(0x1ca)](_0x391bc5,_0x503b70,_0x2df11d),_0x2df11d;},__metadata=this&&this['__metadata']||function(_0x340b28,_0x133b5e){const _0xcca336=_0x3a13;if(typeof Reflect===_0xcca336(0x1d6)&&typeof Reflect[_0xcca336(0x22a)]===_0xcca336(0x28b))return Reflect[_0xcca336(0x22a)](_0x340b28,_0x133b5e);},__param=this&&this[_0x176999(0x15e)]||function(_0x21e304,_0x3ee8ad){return function(_0x2c01bb,_0x47c220){_0x3ee8ad(_0x2c01bb,_0x47c220,_0x21e304);};};Object[_0x176999(0x1ca)](exports,_0x176999(0x33e),{'value':!![]}),exports['MidjourneyService']=void 0x0;const user_entity_1=require(_0x176999(0x2bd)),common_1=require(_0x176999(0x174)),typeorm_1=require(_0x176999(0x273)),midjourney_entity_1=require('./midjourney.entity'),typeorm_2=require('typeorm'),axios_1=require(_0x176999(0x2c3)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),midjourney_constant_1=require(_0x176999(0x263)),upload_service_1=require(_0x176999(0x175)),badwords_service_1=require('../badwords/badwords.service'),userBalance_service_1=require(_0x176999(0x1d3)),utils_1=require(_0x176999(0x2c4)),mjPrompts_entity_1=require(_0x176999(0x18d)),mjParam_entity_1=require(_0x176999(0x24d)),mjIncantationClassify_entity_1=require('./mjIncantationClassify.entity'),mjInspireClassify_entity_1=require(_0x176999(0x1b3)),mjIncantation_entity_1=require(_0x176999(0x2e1)),createRandomId_1=require(_0x176999(0x335)),fanyi_service_1=require('../fanyi/fanyi.service'),mjSuggestWord_entity_1=require(_0x176999(0x217)),user_service_1=require(_0x176999(0x2ee)),midjourney_1=require(_0x176999(0x207)),redisCache_service_1=require('../redisCache/redisCache.service'),socket_io_client_1=require(_0x176999(0x196)),mjpAccount_service_1=require(_0x176999(0x14e)),mjpTask_service_1=require(_0x176999(0x2c7)),addDrawQueue_dto_1=require(_0x176999(0x308)),MjConfig_1=require(_0x176999(0x1ad)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),aiLog_service_1=require(_0x176999(0x214)),relate_contant_1=require('../../common/constants/relate.contant'),jwt=require(_0x176999(0x28e));function _0x26da(){const _0x308c3e=['getRandomKey','findOneBy','socketWs','../userBalance/userBalance.service','get','insightFace','object','querySuggestWords','pid','finally','本次图片上传耗时为','MID_JOURNEY','是否翻译\x20','syncMjpAccountAutomatic','components','badwordsService','cosUrl','filter','DESC','/api/mj/setting_update','role','/api/mj/region_redraw','MidjourneyService','createdAt','runImageToTextJob','getOneDraw','attachments','/api/pipe?url=','versionSelector','UserService','save\x20db\x20drawInfo\x20','assign','/api/attachment','save','application/json','DRAWFAIL','removeSuggestWords','imageSeed','length','保存到redis','aiLogService','Mj\x20Modal\x20通知','label','createRandomUid','Subscription','https://cdn.discordapp.com%','形象设计','mjNotSaveImg','TURBO','upload_filename','buffer','env','2816277IFdQgM','mjProxyImgUrl','transaction','../../core/midjourney','SUCCESS','action','forEach','transferImg','polling','stringify','jobId','error:\x20','redisCacheService','getRegionInfoByProxy','getAccountInfo','version','../aiLog/aiLog.service','------>\x20开始上传图片！！！','setPrompt','./mjSuggestWord.entity','分页参数错误','progress','mjDraw','modifyMjIncantationClassify','执行图混图是否代理','Modal已处理，无需更新','账户不存在','名称不能重复','不需要灵感广场分类','saveImageToMixed','number','2936720qKXaHG','configVal','delete','type','186078nEfOVA','deductFromBalance','then','metadata','?imageView2/1/w/','MjIncantationEntity','checkLimit','初始化灵感广场分类失败','Not','MjpTaskService','fastRemainTime','Modal\x20状态\x20手动同步任务信息','headers','删除成功！','?x-oss-process=image/resize,w_','BadwordsService','ELogRelateType','getAdminDrawList','TODO->存储图片失败','lock','InjectRepository','remixSubmit','modifyMjIncantation','uploadService','catch\x20runMjRegionTask\x20error\x20','userBalanceService','任务类型错误','/api/mj/setting_get','url','fast','account','api','非法操作！','join','calcCost','MjPromptsEntity','当前图片不存在！','replace','./mjParam.entity','userEntity','/q/55','prompt包含敏感词','getModelProxyUrl','MESSAGE_CREATE','getOwnPropertyDescriptor','value','Describe','removeMjInspireClassify','nickname','totalTime','apiBaseUrl','buttons','turbo_mjDeduction','jobIds','MESSAGE_CREATE\x20jobId','status','runMjBlendProxy','log','blend','isSaveImg','../../common/constants/midjourney.constant','socket断开成功','配置不存图片','Repository','prompt','MjpStateMap','保存推荐关键词','relax_mjDeduction','走到解析','RedisCacheService','connect','email','formatFileInfo','isChinese','mjpId','content','@nestjs/typeorm','heartbeatTask','initSocket','推荐关键词不存在','MidjourneyEntity','error','头像制作','queryTopMjIncantationClassify','执行图混图','checkBadWords','走保存','validateBalance','/api/mj/setting','ali','imagine|variation|outpaint|pan|blend|inpaint|picreader|reroll','avatar','receive','runMjBlendTask\x20type,\x20runMjBlendTaskmsg\x20','mjModel','subscribePlan','getMjIncantationClassify','map','updateDrawData','rec','function','botType','parse','jsonwebtoken','update','oss','MidjourneyStatusEnum','extraParam','connected','lifetimeUsage','摄影拍照','updateReconnect','thumbImg','varyRegion','modal','runMjRegionTask','走代理','description','queryMjIncantationAll','drawFailed','美女形象','runMjActionTask','trim','AiLogService','创建图生文任务失败','removeMjAccount','initInspireData','getMjDefaultParams','mjProxy','8dIegZr','mode','toString','put','getAgreeByRelateId','globalConfigService','Connection','MjInspireClassifyEntity','1945BThCha','MJ\x20通知内容：','https://cdn.discordapp.com','MoreThan','提交动作失败','uploadFileFromUrl','执行按钮操作','runMjDescribeTask\x20type,\x20msg\x20','catch','REGION_ACTION','formatCreateOrUpdateDate','updateDrawStatus','super','./../user/user.entity','level','上传文件失败...,\x20\x20no\x20attachment','MODAL','relaxedUsage','classifyName','axios','../../common/utils','timeoutMinutes','round','../mjp/mjpTask.service','modifyMjAccount','Standard','finishTime','embed','relax','getTime','syncMjpAccountManual','mjSocketProxyUrl','runGetSettingByProxy','setAttachment','addMjIncantationClassify','distributeAccount','runMjDrawTask','queryMjIncantationClassify','saveToRedis','mjProxyUrl','resolve','initMidJourney','TODO->error:\x20','response\x20result','favorite','runAction','操作失败！','不走代理','runVaryRegionDrawJob','./mjIncantation.entity','mjLimitCount','squire-images','hideString','socket已连接，不需要重连','imageUrl','increaseVisit','FanyiService','mjTaskUpdateJob:\x20','socket.connected','IMAGE_ACTION','call','chevereto','../user/user.service','无绘图记录','MjParamEntity','艺术设计','JWT_SECRET','https://discord.com/api/v9/channels/','getMjAccount','extend','INTERACTION_SUCCESS','HttpException','orderPlan','filterStar','DESCRIBE','visitNum','midJourney','userId','notify','FaceSwap','reconnectionTask','Mj任务通知异常:\x20','imagine','getDrawList','runImageMixImageJob','图混图任务至少需要两张图片','getMjIncantation','name','./dto/addDrawQueue.dto','syncInfo','执行图生文任务失败，attachments\x20参数为空','MidJourneyDrawEnum','findOne','init','Like','账号不存在','initMj','创建图混图任务失败','onModuleInit','\x20--cref\x20','/api/mj/action','design:paramtypes','DRAWED','openaiBaseUrl','handleGetIsRemix','mjNotSaveImg:\x20','查询咒语分类失败','INTERACTION_MODAL_CREATE','任务不存在！','authorization','gomaxai','includes','renewDate','setting','mjInspireClassifyEntity','type,\x20msg\x20','fileInfo','wsBaseUrl','商拍摄影','result','queryMjInspireClassify','verify','now','绘制的任务不存在！','copyAccountInfo','获取我得绘制列表失败','fast_mjDeduction','data','/api/mj/imagine','MESSAGE_UPDATE\x20jobId','updateSettingByProxy','mjIncantationClassifyEntity','uploadImage','../../common/utils/createRandomId','test','初始化灵感广场分类成功','\x20--sw\x20','message','findBy','mjParamEntity','syncTaskInfo','getList','__esModule','changeVersion','exist','split','runImageJobByProxy','IMAGE_TO_TEXT','\x20--sref\x20','setImageFavorite','code','mjVersion','HttpStatus','convertMode4Transfer','mjpId:\x20','未查询到咒语一级分类','find','getDetailByIds','data:image/png;base64,','查询咒语失败','enable','wss://gateway.discord.gg/?encoding=json&v=9','getAccountInfoByProxy','set','post','upload_url','addMjInspireClassify','/attachments','settings','listByCondition','concat','runActionSetting','region\x20proxy\x20line','syncMjpAccount','https://discord.com','无可用MJ账号，请后台添加或启用MJ账号','getRandomItemFromArray','mjSuggestWordEntity','originPrompt','IsNull','decorate','socketClient','active','MjpAccountService','33737751MdobsU','PRO','../mjp/mjpAccount.service','channelId','Logger','guildId','del','deleteDraw','fastTimeRemaining','删除失败！','info','uploadByProxy','user','updateAllUnfinishedTaskStatus','推荐关键词已存在，不可重复添加','/api/mj/region_info','handleAddDrawTask','绘制中的图片任务、禁止删除！','__param','default','查询灵感分类失败','midjourneyEntity','queryPromptByPage','DrawSpeed','findAndCount','Lifetime\x20Usage','文生图是否代理','没有满足条件的MJ账号，请联系管理员！','5319447nNhdEu','style','reject','DRAWING','mjpAccountService','cleanQueue','affected','durationSpent','region','saveImageToText','/messages','绘画制作','@nestjs/common','../upload/upload.service','MidjourneyActionEnum','mjIncantationEntity','runVaryRegionJobByProxy','startTime','runMjBlendTask','removeMjIncantationClassify','cancel','addMjAccount','上传文件失败...','timestamp','Imagine\x20all','checkUserStatus','UserEntity','tencent','mjpTaskId','modifyMjInspireClassify','fetch','1137316QfXNUL','队列已满，请稍后尝试','图混图上传图片完成','userInfo','查询推荐关键词失败','TEXT_TO_IMAGE','./mjPrompts.entity','Relaxed\x20Usage','isGroup','MJ_TASK_UPDATE','flags','action\x20MESSAGE_UPDATE','socketUrl','fanyiService','/h/','socket.io-client','Injectable','runActionJobByProxy','MEGA','emoji','精选分享','userService','/api/mj/describe','8696wOHZiQ','remix','MjSuggestWordEntity','handleSubmitRemix','base64','turbo','fullPrompt','toLowerCase','swap','addDrawQueue','mjpTaskService','MidjourneySdk','socket协议地址错误','IMAGE_TO_TEXT_ACTION','查询失败！','../../config/MjConfig','/api/mj/blend','recDraw','提交图片:\x20','count','incantationCn','./mjInspireClassify.entity','push','runMjBlendTask\x20finalResult','添加绘图任务失败','AddDrawQueueDto','runImageJob','BAD_REQUEST','IMAGE_MIX_IMAGE','response\x20cosUrl','mjPromptsEntity','BASIC','MjIncantationClassifyEntity','convertToEnglish','describe','squareType','删除记录失败！','open','socket.active','图混图代理执行','checkIsActionDone','originalname','getConfigs','getConfigByKey','defineProperty','removeMjIncantation','username','MESSAGE_UPDATE','connection','initHasAccount'];_0x26da=function(){return _0x308c3e;};return _0x26da();}let MidjourneyService=class MidjourneyService{constructor(_0x27adef,_0x25588d,_0x2ce729,_0x3095bc,_0xef29ab,_0x33470a,_0x200d3d,_0xddefee,_0x5760b8,_0x459b2a,_0x5a0f9c,_0x34287a,_0x1cccfa,_0x45bd9e,_0x512005,_0x494712,_0x4db8f4,_0xeb8fc9,_0x3abd89){const _0x5a132c=_0x176999;this[_0x5a132c(0x161)]=_0x27adef,this['userEntity']=_0x25588d,this[_0x5a132c(0x1bc)]=_0x2ce729,this[_0x5a132c(0x33b)]=_0x3095bc,this['mjIncantationClassifyEntity']=_0xef29ab,this[_0x5a132c(0x322)]=_0x33470a,this[_0x5a132c(0x145)]=_0x200d3d,this[_0x5a132c(0x177)]=_0xddefee,this[_0x5a132c(0x2ad)]=_0x5760b8,this[_0x5a132c(0x23e)]=_0x459b2a,this[_0x5a132c(0x1df)]=_0x5a0f9c,this[_0x5a132c(0x240)]=_0x34287a,this['fanyiService']=_0x1cccfa,this[_0x5a132c(0x19c)]=_0x45bd9e,this[_0x5a132c(0x210)]=_0x512005,this['mjpAccountService']=_0x494712,this['mjpTaskService']=_0x4db8f4,this[_0x5a132c(0x1f8)]=_0xeb8fc9,this['connection']=_0x3abd89,this[_0x5a132c(0x325)]=_0x5a132c(0x351),this[_0x5a132c(0x259)]=_0x5a132c(0x142),this[_0x5a132c(0x2fc)]={},this[_0x5a132c(0x274)]=null,this['reconnectionTask']=null,this['getSyncAccountInfo']=async _0x222ffd=>{const _0x40f651=_0x5a132c,{authorization:_0x3f743f,guildId:_0x92b80c,channelId:_0x2eae7a,mode:_0x2ab75d}=_0x222ffd,_0x28f4dd=this['wsBaseUrl'],_0x315772=this[_0x40f651(0x259)];!this[_0x40f651(0x2fc)][_0x2ab75d]&&await this[_0x40f651(0x2d9)]({'channel_id':_0x2eae7a,'guild_id':_0x92b80c,'token':_0x3f743f,'wsBaseUrl':_0x28f4dd,'apiBaseUrl':_0x315772},_0x2ab75d);const _0x1e950c=await this['getAccountInfo'](_0x2ab75d),_0x3e0792=await this['getSettingInfo'](_0x2ab75d),_0xa936a4=_0x1e950c[_0x40f651(0x2cb)][_0x40f651(0x29c)],_0x32923c=_0xa936a4[_0x40f651(0x341)]('\x0a')['filter'](_0x4a1edc=>_0x4a1edc)[_0x40f651(0x288)](_0x31ff51=>_0x31ff51[_0x40f651(0x24c)](/\*/g,''));let _0x165557={};_0x32923c[_0x40f651(0x20a)](_0x2935bb=>{const _0x3e0222=_0x40f651,_0x57362c=_0x2935bb[_0x3e0222(0x341)](':');!_0x165557[_0x57362c[0x0]]&&(_0x165557[_0x57362c[0x0]]=_0x57362c[0x1]);});const _0x181644=_0x165557['Fast\x20Time\x20Remaining']||'',_0x21f482=_0x165557[_0x40f651(0x165)]||'',_0x312205=_0x165557[_0x40f651(0x18e)]||'',_0xf5a239=_0x165557[_0x40f651(0x1fc)]||'',_0x5ecc96=_0xf5a239?.[_0x40f651(0x341)]('\x20')[0x0]===_0x40f651(0x2c9)?0x1:0x2;return{'settingInfo':_0x3e0792,'fastRemainTime':_0x181644,'lifetimeUsage':_0x21f482,'relaxedUsage':_0x312205,'orderPlan':_0x5ecc96,'subscription':_0xf5a239,'info':_0xa936a4};};}async[_0x176999(0x312)](){const _0x2e5d28=_0x176999;await this[_0x2e5d28(0x2a5)](),await this[_0x2e5d28(0x1cf)](),await this[_0x2e5d28(0x159)]();}async[_0x176999(0x275)](_0x3b828d){const _0x3d02e0=_0x176999;if(!this['socketClient']||!this[_0x3d02e0(0x149)]['active']){const _0xe14ca6=_0x3b828d||'';common_1[_0x3d02e0(0x150)][_0x3d02e0(0x260)](_0xe14ca6,_0x3d02e0(0x193));if(!_0xe14ca6)throw new common_1[(_0x3d02e0(0x2f7))](_0x3d02e0(0x1aa),common_1['HttpStatus'][_0x3d02e0(0x1b9)]);return common_1[_0x3d02e0(0x150)][_0x3d02e0(0x260)](_0xe14ca6,_0x3d02e0(0x1d2)),this[_0x3d02e0(0x149)]=(0x0,socket_io_client_1['io'])(_0xe14ca6,{'transports':[_0x3d02e0(0x20c),'websocket'],'reconnection':!![],'autoConnect':!![],'query':{'token':_0x3d02e0(0x31e)}}),this[_0x3d02e0(0x149)]['on']('unauthorized',_0x5d6dc5=>{const _0x21942b=_0x3d02e0;console[_0x21942b(0x260)](_0x5d6dc5);}),this[_0x3d02e0(0x149)]['on'](_0x3d02e0(0x1c3),_0x23c374=>{const _0x56c48c=_0x3d02e0;console['log']('socket-open'),_0x23c374['emit']('socket-open'),this['reconnectionTask']&&(clearTimeout(this[_0x56c48c(0x300)]),this[_0x56c48c(0x300)]=null);}),this['socketClient']['on']('close',()=>{const _0x8f1e73=_0x3d02e0;console[_0x8f1e73(0x260)]('close'),this[_0x8f1e73(0x300)]=setTimeout(()=>{const _0x40bab8=_0x8f1e73;this['heartbeatTask']&&typeof this['heartbeatTask']===_0x40bab8(0x222)&&(clearInterval(this['heartbeatTask']),this[_0x40bab8(0x274)]=null),this[_0x40bab8(0x149)]=this[_0x40bab8(0x275)][_0x40bab8(0x2ec)](this);},0xfa0);}),this['socketClient']['on'](_0x3d02e0(0x26d),async()=>{const _0x5ceedc=_0x3d02e0;common_1[_0x5ceedc(0x150)][_0x5ceedc(0x260)]('socket连接成功');}),this['socketClient']['on']('disconnect',async(_0x56f41c,_0x400f5f)=>{const _0x27dc74=_0x3d02e0;console[_0x27dc74(0x260)](_0x56f41c,_0x400f5f),common_1[_0x27dc74(0x150)][_0x27dc74(0x260)](_0x27dc74(0x264));}),this[_0x3d02e0(0x149)];}return common_1[_0x3d02e0(0x150)][_0x3d02e0(0x260)](_0x3d02e0(0x2e5)),this[_0x3d02e0(0x149)];}async[_0x176999(0x1cf)](){const _0x31c704=_0x176999,_0x4d4ffd=await this[_0x31c704(0x33b)][_0x31c704(0x1b1)]({'where':{'enable':0x1},'order':{'weight':'DESC'}});_0x4d4ffd===0x0&&common_1[_0x31c704(0x150)]['error']('要使用MJ绘画功能，至少需要配置一个MJ账号,并且启用该账号');}async[_0x176999(0x2a5)](){const _0x5b3777=_0x176999,_0x3932e6=await this[_0x5b3777(0x322)][_0x5b3777(0x1b1)]();if(_0x3932e6===0x0){const _0x32e76a=[{'name':_0x5b3777(0x173),'value':0x1},{'name':_0x5b3777(0x295),'value':0x2},{'name':_0x5b3777(0x279),'value':0x3},{'name':_0x5b3777(0x29f),'value':0x4},{'name':'动漫漫画','value':0x5},{'name':'壁纸绘画','value':0x6},{'name':_0x5b3777(0x2f1),'value':0x7},{'name':_0x5b3777(0x326),'value':0x8},{'name':_0x5b3777(0x1fe),'value':0x9},{'name':_0x5b3777(0x19b),'value':0xa}][_0x5b3777(0x288)](_0x47f56e=>{const _0x501f35=_0x5b3777;return{'name':_0x47f56e[_0x501f35(0x307)],'value':_0x47f56e[_0x501f35(0x254)]+'','inner':0x1};});await this['mjInspireClassifyEntity'][_0x5b3777(0x1f1)](_0x32e76a)[_0x5b3777(0x2b8)](_0x489946=>{const _0x41bd87=_0x5b3777;common_1[_0x41bd87(0x150)][_0x41bd87(0x278)](_0x41bd87(0x22e));}),common_1[_0x5b3777(0x150)][_0x5b3777(0x260)](_0x5b3777(0x337));}common_1['Logger'][_0x5b3777(0x260)](_0x5b3777(0x220));}async[_0x176999(0x159)](){const _0x954744=_0x176999,_0x81938f=await this[_0x954744(0x161)][_0x954744(0x34c)]({'where':{'status':(0x0,typeorm_2['In'])([midjourney_constant_1[_0x954744(0x291)][_0x954744(0x16b)]])}})[_0x954744(0x229)](_0x5628e=>_0x5628e[_0x954744(0x1e1)](_0x560a7b=>Date[_0x954744(0x32a)]()-_0x560a7b[_0x954744(0x1e7)]['getTime']()>0x5*0x3c*0x3e8))[_0x954744(0x229)](_0x229072=>_0x229072['map'](_0x110845=>_0x110845['id']))[_0x954744(0x2b8)](_0x2b6be6=>{const _0x508124=_0x954744;common_1[_0x508124(0x150)]['error'](_0x2b6be6);});if(!_0x81938f||_0x81938f['length']===0x0)return;await this[_0x954744(0x161)]['update'](_0x81938f,{'status':midjourney_constant_1[_0x954744(0x291)][_0x954744(0x1f3)]})[_0x954744(0x229)](_0x6c9be2=>_0x6c9be2[_0x954744(0x16e)]>0x0)[_0x954744(0x2b8)](_0x505234=>{const _0x3a6820=_0x954744;common_1[_0x3a6820(0x150)][_0x3a6820(0x278)](_0x505234);});}async[_0x176999(0x310)](_0x1f94fb){const _0x59bf40=_0x176999,_0x30cd9c=this[_0x59bf40(0x325)],_0x39550c=this[_0x59bf40(0x259)];if(!this[_0x59bf40(0x2fc)][_0x1f94fb]){const {guild_id:_0x5f2a73,channel_id:_0x52e6bc,authorization:_0x54cc24}=await this[_0x59bf40(0x2a6)](_0x1f94fb)['catch'](_0x3fa0e8=>{const _0x1557fe=_0x59bf40;return Promise[_0x1557fe(0x16a)](_0x3fa0e8);});return await this[_0x59bf40(0x2d9)]({'channel_id':_0x52e6bc,'guild_id':_0x5f2a73,'token':_0x54cc24,'wsBaseUrl':_0x30cd9c,'apiBaseUrl':_0x39550c},_0x1f94fb),!![];}return!![];}async['initMidJourney'](_0x7b6dd2,_0x16976d){const _0x457ec2=_0x176999,{token:_0x1e0509,channel_id:_0x77f3bd,guild_id:_0x3c6ed1,apiBaseUrl:_0x36099f,wsBaseUrl:_0x3eb6bd}=_0x7b6dd2;this[_0x457ec2(0x2fc)][_0x16976d]=new midjourney_1[(_0x457ec2(0x1a9))]({'token':_0x1e0509,'guild_id':_0x3c6ed1,'channel_id':_0x77f3bd,'apiBaseUrl':_0x36099f,'wsBaseUrl':_0x3eb6bd,'skipHeartbeat':!![]}),await this[_0x457ec2(0x2fc)][_0x16976d][_0x457ec2(0x30d)]();}async[_0x176999(0x1a7)](_0x8a2a6a){const _0x2d9705=_0x176999,_0x729f96=new addDrawQueue_dto_1['AddDrawQueueDto'](_0x8a2a6a);await this[_0x2d9705(0x1df)][_0x2d9705(0x27c)](_0x729f96[_0x2d9705(0x1a4)],_0x729f96[_0x2d9705(0x2fd)]);const _0x5025f5=await this[_0x2d9705(0x161)]['save'](_0x729f96);return _0x5025f5;}async[_0x176999(0x15c)](_0x160833,_0x5d5187){const _0x38b320=_0x176999;let _0x4e9345,_0x39afb8;try{const {type:_0x2035f8,params:_0x4cec41}=_0x160833;await this[_0x38b320(0x19c)][_0x38b320(0x181)](_0x5d5187[_0x38b320(0x158)]);if(_0x2035f8===midjourney_constant_1['MidJourneyDrawEnum'][_0x38b320(0x18c)]){let {botType:_0x3b2bf6,prompt:_0x5a9793,extend:_0x4f9d95,action:_0x18d0cc,mode:_0x2b65f6,translate:_0x2d3918,base64Array:_0x13ac57,mats:mats=[],iw:_0x3dab7f,roles:roles=[],cw:_0x5741fb,styles:styles=[],sw:_0x285eec}=_0x4cec41,_0xb57ade=await this[_0x38b320(0x249)]('Imagine',_0x2b65f6);await this[_0x38b320(0x240)][_0x38b320(0x27e)](_0x5d5187,_0x38b320(0x21a),_0xb57ade);const _0x3189b4=_0x5a9793,_0x289707=await this['distributeAccount'](_0x2b65f6);_0x5a9793&&await this[_0x38b320(0x1df)][_0x38b320(0x27c)](_0x5a9793,_0x5d5187[_0x38b320(0x158)]['id']),_0x5a9793=_0x2d3918===0x1&&(0x0,utils_1['isChinese'])(_0x5a9793)?await this['fanyiService']['convertToEnglish'](_0x5a9793):_0x5a9793;let _0x26d245=_0x5a9793;mats[_0x38b320(0x1f6)]&&(_0x26d245=mats[_0x38b320(0x248)]('\x20')+'\x20'+_0x26d245);_0x3dab7f&&(_0x26d245=_0x26d245+'\x20--iw\x20'+_0x3dab7f);styles['length']&&(_0x26d245=_0x26d245+_0x38b320(0x344)+styles[_0x38b320(0x248)]('\x20'));roles[_0x38b320(0x1f6)]&&(_0x26d245=_0x26d245+_0x38b320(0x313)+roles['join']('\x20'));_0x5741fb&&(_0x26d245=_0x26d245+'\x20--cw\x20'+_0x5741fb);_0x285eec&&(_0x26d245=_0x26d245+_0x38b320(0x338)+_0x285eec);_0x4f9d95&&(_0x26d245=_0x26d245+'\x20'+_0x4f9d95);const _0x5efc2b=await this[_0x38b320(0x1a8)][_0x38b320(0x302)]({'data':{'mode':this['convertMode4Transfer'](_0x2b65f6),'prompt':_0x26d245,'botType':_0x3b2bf6||_0x38b320(0x1db),'base64Array':_0x13ac57,'accountFilter':{'instanceId':_0x289707[_0x38b320(0x271)]}}});if(_0x5efc2b[_0x38b320(0x346)]===0x17)throw new Error(_0x38b320(0x188));if(_0x5efc2b['code']===0x18)throw new Error('prompt包含敏感词');if(_0x5efc2b[_0x38b320(0x346)]!==0x1&&_0x5efc2b[_0x38b320(0x346)]!==0x16)throw new Error(_0x5efc2b[_0x38b320(0x29c)]);_0x39afb8=_0x5efc2b['result'],_0x4e9345=await this[_0x38b320(0x1ce)][_0x38b320(0x206)](async _0x339d99=>{const _0x2a6eb3=_0x38b320,_0x4e6482={'mode':_0x2b65f6,'prompt':_0x5a9793,'action':_0x18d0cc,'translate':_0x2d3918,'fullPrompt':_0x26d245,'originPrompt':_0x3189b4,'extraParam':_0x4f9d95,'userId':_0x5d5187[_0x2a6eb3(0x158)]['id'],'mjpId':_0x289707[_0x2a6eb3(0x271)],'mjpTaskId':_0x5efc2b['result'],'botType':_0x3b2bf6||_0x2a6eb3(0x1db)},_0x1231c7=await this[_0x2a6eb3(0x1a7)](_0x4e6482);if(!_0x1231c7)throw new Error(_0x2a6eb3(0x1b6));return await this[_0x2a6eb3(0x240)]['deductFromBalance'](_0x5d5187[_0x2a6eb3(0x158)]['id'],_0x2a6eb3(0x21a),_0xb57ade,_0xb57ade),_0x1231c7['jobId'];});}else{if(_0x2035f8===midjourney_constant_1[_0x38b320(0x30b)][_0x38b320(0x2b9)]){let {taskId:_0x389d85,prompt:_0x2f76f4,mask:_0x5a9812,action:_0x1ec696,customId:_0x9859f6}=_0x4cec41;const _0x3c1583=await this[_0x38b320(0x161)]['findOne']({'where':{'id':_0x389d85}});if(!_0x3c1583)throw new Error(_0x38b320(0x2ef));const _0x233627=_0x2f76f4;_0x2f76f4&&await this['badwordsService'][_0x38b320(0x27c)](_0x2f76f4,_0x5d5187['user']['id']),_0x2f76f4=(0x0,utils_1[_0x38b320(0x270)])(_0x2f76f4)?await this['fanyiService'][_0x38b320(0x1bf)](_0x2f76f4):_0x2f76f4;const _0x59558a=await this[_0x38b320(0x1a8)][_0x38b320(0x299)]({'data':{'prompt':_0x2f76f4,'maskBase64':_0x5a9812,'taskId':_0x3c1583[_0x38b320(0x184)]}});if(_0x59558a[_0x38b320(0x346)]!==0x1&&_0x59558a[_0x38b320(0x346)]!==0x16)throw new Error(_0x59558a[_0x38b320(0x29c)]);return this[_0x38b320(0x161)][_0x38b320(0x1f1)]({'id':_0x389d85,'prompt':_0x2f76f4,'status':0x1,'originPrompt':_0x233627,'messageFlags':0x1}),_0x3c1583[_0x38b320(0x20e)];}else{if(_0x2035f8===midjourney_constant_1[_0x38b320(0x30b)][_0x38b320(0x2eb)]){const {action:_0x457d18,taskId:_0x197f09,customId:_0x26fbf3}=_0x4cec41;await this[_0x38b320(0x1c6)](_0x197f09,_0x26fbf3);const _0x3b242a=await this[_0x38b320(0x161)][_0x38b320(0x30c)]({'where':{'id':_0x197f09}});if(!_0x3b242a)throw new Error('无绘图记录');let _0x343ae6=await this['calcCost'](_0x26fbf3,_0x3b242a[_0x38b320(0x2a9)]);await this[_0x38b320(0x240)][_0x38b320(0x27e)](_0x5d5187,_0x38b320(0x21a),_0x343ae6);const _0x2630fc=await this[_0x38b320(0x1a8)][_0x38b320(0x209)]({'data':{'customId':_0x26fbf3,'taskId':_0x3b242a[_0x38b320(0x184)],'accountFilter':{'instanceId':_0x3b242a['mjpId']},'mode':this[_0x38b320(0x349)](_0x3b242a['mode'])}});if(_0x2630fc[_0x38b320(0x346)]===0x17)throw new Error(_0x38b320(0x188));else{if(_0x2630fc[_0x38b320(0x346)]===0x18)throw new Error(_0x38b320(0x250));else{if(_0x2630fc[_0x38b320(0x346)]===0x15)setTimeout(()=>this['syncTaskInfo'](_0x2630fc['result']));else{if(_0x2630fc[_0x38b320(0x346)]!==0x1&&_0x2630fc['code']!==0x16)throw new Error(_0x2630fc[_0x38b320(0x29c)]);}}}_0x39afb8=_0x2630fc['result'],_0x4e9345=await this[_0x38b320(0x1ce)][_0x38b320(0x206)](async _0x28ab0a=>{const _0x6a61a6=_0x38b320,_0x28f5b2={'action':_0x457d18,'customId':_0x26fbf3,'userId':_0x5d5187[_0x6a61a6(0x158)]['id'],'mjpTaskId':_0x2630fc[_0x6a61a6(0x327)],'originTaskId':String(_0x197f09),'mode':_0x3b242a[_0x6a61a6(0x2a9)],'mjpId':_0x3b242a['mjpId'],'prompt':_0x3b242a[_0x6a61a6(0x267)],'botType':_0x3b242a[_0x6a61a6(0x28c)],'extraParam':_0x3b242a[_0x6a61a6(0x292)],'fullPrompt':_0x3b242a[_0x6a61a6(0x1a4)],'originPrompt':_0x3b242a['originPrompt']},_0x52eb8d=await this[_0x6a61a6(0x1a7)](_0x28f5b2);if(!_0x52eb8d)throw new Error(_0x6a61a6(0x2b4));return await this[_0x6a61a6(0x240)][_0x6a61a6(0x228)](_0x5d5187[_0x6a61a6(0x158)]['id'],_0x6a61a6(0x21a),_0x343ae6,_0x343ae6),_0x52eb8d[_0x6a61a6(0x20e)];});}else return new common_1[(_0x38b320(0x2f7))](_0x38b320(0x241),common_1[_0x38b320(0x348)][_0x38b320(0x1b9)]);}}return _0x4e9345;}catch(_0x571edf){if(_0x571edf instanceof common_1[_0x38b320(0x2f7)])throw _0x571edf;else{_0x39afb8&&await this['mjpTaskService'][_0x38b320(0x17c)]({},_0x39afb8);throw new common_1[(_0x38b320(0x2f7))](_0x571edf[_0x38b320(0x339)],common_1[_0x38b320(0x348)][_0x38b320(0x1b9)]);}}}async['handleImagesUploadTask'](_0x1e947b,_0x1681c8){const _0x23397d=_0x176999;let _0x59c8a0,_0x203467;try{const {type:_0x5610de,botType:_0x2610c0,files:_0x3eddc1,mode:_0x2fac57,action:_0x51eb97,size:_0xfcd1c0,base64Array:base64Array=[]}=_0x1e947b;await this['userService'][_0x23397d(0x181)](_0x1681c8[_0x23397d(0x158)]);let _0xaf07c8='';if(Number(_0x5610de)===midjourney_constant_1['MidJourneyDrawEnum']['IMAGE_MIX_IMAGE'])_0xaf07c8='Blend';else Number(_0x5610de)===midjourney_constant_1[_0x23397d(0x30b)][_0x23397d(0x343)]&&(_0xaf07c8=_0x23397d(0x255));let _0x38d9d0=await this[_0x23397d(0x249)](_0xaf07c8,_0x1e947b[_0x23397d(0x2a9)]);await this[_0x23397d(0x240)][_0x23397d(0x27e)](_0x1681c8,_0x23397d(0x21a),_0x38d9d0);const _0x22890c=await this['distributeAccount'](_0x2fac57);if(!base64Array['length'])for(let _0x52213f=0x0;_0x52213f<_0x3eddc1[_0x23397d(0x1f6)];_0x52213f++){base64Array[_0x23397d(0x1b4)](_0x23397d(0x34e)+_0x3eddc1[_0x52213f]['buffer'][_0x23397d(0x2aa)](_0x23397d(0x1a2)));}if(Number(_0x5610de)===midjourney_constant_1[_0x23397d(0x30b)][_0x23397d(0x1ba)]){if(base64Array['length']<0x2)throw new Error(_0x23397d(0x305));const _0x4e7218=await this[_0x23397d(0x1a8)][_0x23397d(0x261)]({'data':{'mode':this['convertMode4Transfer'](_0x2fac57),'dimensions':_0xfcd1c0,'botType':'MID_JOURNEY','base64Array':base64Array,'accountFilter':{'instanceId':_0x22890c['mjpId']}}});if(_0x4e7218[_0x23397d(0x346)]===0x17)throw new Error(_0x23397d(0x188));if(_0x4e7218['code']!==0x1&&_0x4e7218[_0x23397d(0x346)]!==0x16)throw new Error(_0x4e7218[_0x23397d(0x29c)]);_0x203467=_0x4e7218[_0x23397d(0x327)],_0x59c8a0=await this[_0x23397d(0x1ce)]['transaction'](async _0x19fa17=>{const _0x2a40dc=_0x23397d,_0x3d804b={'mode':_0x2fac57,'action':_0x51eb97,'imgUrl':'','userId':_0x1681c8[_0x2a40dc(0x158)]['id'],'jobId':(0x0,utils_1[_0x2a40dc(0x1fb)])(),'botType':_0x2610c0||_0x2a40dc(0x1db),'extraParam':JSON[_0x2a40dc(0x20d)]({'attachments':[]}),'originPrompt':'','mjpTaskId':_0x4e7218[_0x2a40dc(0x327)]},_0xe82e8c=await this[_0x2a40dc(0x1a7)](_0x3d804b);if(!_0xe82e8c)throw new Error(_0x2a40dc(0x311));return await this['userBalanceService'][_0x2a40dc(0x228)](_0x1681c8[_0x2a40dc(0x158)]['id'],_0x2a40dc(0x21a),_0x38d9d0,_0x38d9d0),_0xe82e8c[_0x2a40dc(0x20e)];});}else{if(Number(_0x5610de)===midjourney_constant_1['MidJourneyDrawEnum'][_0x23397d(0x343)]){const _0xcef615=await this['mjpTaskService'][_0x23397d(0x1c0)]({'data':{'mode':this[_0x23397d(0x349)](_0x2fac57),'botType':'MID_JOURNEY','base64':base64Array[0x0],'accountFilter':{'instanceId':_0x22890c[_0x23397d(0x271)]}}});if(_0xcef615['code']===0x17)throw new Error(_0x23397d(0x188));if(_0xcef615[_0x23397d(0x346)]!==0x1&&_0xcef615['code']!==0x16)throw new Error(_0xcef615['description']);_0x203467=_0xcef615[_0x23397d(0x327)],_0x59c8a0=await this[_0x23397d(0x1ce)][_0x23397d(0x206)](async _0x265b58=>{const _0x315e4a=_0x23397d,_0x385331={'mode':_0x2fac57,'action':_0x51eb97,'imgUrl':'','userId':_0x1681c8[_0x315e4a(0x158)]['id'],'jobId':(0x0,utils_1[_0x315e4a(0x1fb)])(),'botType':_0x2610c0||_0x315e4a(0x1db),'extraParam':JSON[_0x315e4a(0x20d)]({'attachments':[]}),'originPrompt':'','mjpTaskId':_0xcef615[_0x315e4a(0x327)]},_0x1eb3a9=await this[_0x315e4a(0x1a7)](_0x385331);if(!_0x1eb3a9)throw new Error(_0x315e4a(0x2a3));return await this[_0x315e4a(0x240)]['deductFromBalance'](_0x1681c8['user']['id'],_0x315e4a(0x21a),_0x38d9d0,_0x38d9d0),_0x1eb3a9[_0x315e4a(0x20e)];})[_0x23397d(0x2b8)](async _0x1308c7=>{const _0x356c6a=_0x23397d;await this['mjpTaskService']['cancel']({},_0xcef615[_0x356c6a(0x327)]);throw _0x1308c7;});}else return new common_1[(_0x23397d(0x2f7))](_0x23397d(0x241),common_1[_0x23397d(0x348)]['BAD_REQUEST']);}return _0x59c8a0;}catch(_0x4bbada){if(_0x4bbada instanceof common_1[_0x23397d(0x2f7)])throw _0x4bbada;else{_0x203467&&await this[_0x23397d(0x1a8)][_0x23397d(0x17c)]({},_0x203467);throw new common_1['HttpException'](_0x4bbada['message'],common_1['HttpStatus'][_0x23397d(0x1b9)]);}}}async[_0x176999(0x1d5)](_0x10e912,_0x4eb2f8){const _0x596147=_0x176999;let _0x152c57,_0x2e79c7;try{const {type:_0x1fe801,params:_0x561d84}=_0x10e912,{mode:_0x5827d2,botType:_0x2e9d88,action:_0x171853,extend:_0x5dc72b,sourceBase64:_0x438172,targetBase64:_0x18ca64}=_0x561d84;await this[_0x596147(0x19c)][_0x596147(0x181)](_0x4eb2f8[_0x596147(0x158)]);let _0x309a31=await this[_0x596147(0x249)](_0x596147(0x2ff),_0x5827d2);await this[_0x596147(0x240)][_0x596147(0x27e)](_0x4eb2f8,_0x596147(0x21a),_0x309a31);const _0xb86fe7=await this[_0x596147(0x2d3)](_0x5827d2),_0x181c87=await this[_0x596147(0x1a8)][_0x596147(0x1a6)]({'data':{'sourceBase64':_0x438172,'targetBase64':_0x18ca64,'state':_0x5dc72b,'mode':this[_0x596147(0x349)](_0x5827d2),'accountFilter':{'instanceId':_0xb86fe7['mjpId']}}});if(_0x181c87[_0x596147(0x346)]===0x17)throw new Error('队列已满，请稍后尝试');if(_0x181c87['code']===0x18)throw new Error('prompt包含敏感词');if(_0x181c87[_0x596147(0x346)]!==0x1&&_0x181c87['code']!==0x16)throw new Error(_0x181c87['description']);return _0x2e79c7=_0x181c87['result'],_0x152c57=await this[_0x596147(0x1ce)]['transaction'](async _0x2e554e=>{const _0x280cd7=_0x596147,_0x352911={'mode':_0x5827d2,'action':_0x171853,'prompt':null,'extraParam':_0x5dc72b,'originPrompt':null,'userId':_0x4eb2f8[_0x280cd7(0x158)]['id'],'mjpId':_0xb86fe7['mjpId'],'mjpTaskId':_0x181c87[_0x280cd7(0x327)],'botType':_0x2e9d88||_0x280cd7(0x1db)},_0xe7e6bc=new addDrawQueue_dto_1[(_0x280cd7(0x1b7))](_0x352911),_0x3cc6e0=await this[_0x280cd7(0x161)][_0x280cd7(0x1f1)](_0xe7e6bc);if(!_0x3cc6e0)throw new Error(_0x280cd7(0x1b6));return await this['userBalanceService'][_0x280cd7(0x228)](_0x4eb2f8['user']['id'],'mjDraw',_0x309a31,_0x309a31),_0x3cc6e0[_0x280cd7(0x20e)];}),_0x152c57;}catch(_0x1b6e8b){throw new common_1['HttpException'](_0x1b6e8b[_0x596147(0x339)],common_1['HttpStatus'][_0x596147(0x1b9)]);}}async['calcCost'](_0x164466,_0x562a15){const _0x2b4148=_0x176999;var _0xd28b5c=_0x164466[_0x2b4148(0x1a5)](),_0x3b213d=new RegExp(_0x2b4148(0x281)),_0x24ed3a=new RegExp('upsample|upscale|describe|picread::retry|faceSwap|shorten'),_0x579b0d=new RegExp('fetch|listbyids|modal|seed'),_0x503528='';if(_0x562a15===midjourney_constant_1[_0x2b4148(0x163)][_0x2b4148(0x244)])_0x503528=_0x2b4148(0x32e);else{if(_0x562a15===midjourney_constant_1['DrawSpeed'][_0x2b4148(0x2cc)])_0x503528=_0x2b4148(0x26a);else _0x562a15===midjourney_constant_1[_0x2b4148(0x163)][_0x2b4148(0x1a3)]&&(_0x503528=_0x2b4148(0x25b));}if(_0x3b213d[_0x2b4148(0x336)](_0xd28b5c))_0x503528=_0x503528+0x1;else{if(_0x24ed3a[_0x2b4148(0x336)](_0xd28b5c))_0x503528=_0x503528+0x2;else _0x579b0d[_0x2b4148(0x336)](_0xd28b5c)&&(_0x503528=_0x503528+0x3);}const _0xa156f7=await this['globalConfigService'][_0x2b4148(0x1c9)](_0x503528);if(!_0xa156f7)return 0x4;return Number(_0xa156f7[_0x2b4148(0x224)])||0x4;}async[_0x176999(0x221)](_0x3fb773){const _0x3074d8=_0x176999,{files:_0x291da0,mode:_0x713ec0,action:_0x2e85a9,jobId:_0x595267,userId:_0x506c83}=_0x3fb773;let _0xd2a15a=0x0;const {channel_id:_0x4371a5,authorization:_0x1f2ab7,mjProxy:_0x4014a6,mjProxyUrl:_0x3b78e4}=await this['getMjDefaultParams'](_0x713ec0)[_0x3074d8(0x2b8)](_0x4aea56=>{const _0x3f8074=_0x3074d8;return Promise[_0x3f8074(0x16a)](_0x4aea56);});let _0xd2f57e=[];if(_0x4014a6==0x0)while(_0xd2a15a<_0x291da0['length']){const _0x1435c1=_0x291da0[_0xd2a15a],_0x30f5e3=await this[_0x3074d8(0x334)]({'channel_id':_0x4371a5,'authorization':_0x1f2ab7,'filename':(0x0,utils_1['createRandomUid'])()+_0x1435c1[_0x3074d8(0x1c7)],'buffer':_0x1435c1[_0x3074d8(0x202)],'needImage':![]})[_0x3074d8(0x2b8)](_0x1be896=>{const _0x4ded9e=_0x3074d8;return common_1['Logger'][_0x4ded9e(0x278)](_0x1be896),Promise[_0x4ded9e(0x2d8)]({'attachments':[]});});_0xd2f57e=_0xd2f57e[_0x3074d8(0x13e)](_0x30f5e3['attachments']||[]),_0xd2a15a++;}else common_1[_0x3074d8(0x150)]['log']('图混图上传图片'),_0xd2f57e=await this[_0x3074d8(0x157)]({'proxy':_0x3b78e4,'channel_id':_0x4371a5,'authorization':_0x1f2ab7,'file':_0x291da0,'needImage':![]})['then'](_0x1c5b0c=>_0x1c5b0c[_0x3074d8(0x288)](_0x12291c=>_0x12291c[_0x3074d8(0x1ea)]))['then'](_0x566cbf=>_0x566cbf['flat']())['catch'](_0x4dffd0=>{const _0x5ec7f9=_0x3074d8;return common_1[_0x5ec7f9(0x150)]['error'](_0x4dffd0),Promise['resolve']({'attachments':[]});});common_1[_0x3074d8(0x150)][_0x3074d8(0x260)](_0x3074d8(0x189));const _0x8517a4={'mode':_0x713ec0,'action':_0x2e85a9,'jobId':_0x595267,'userId':_0x506c83,'imgUrl':'','extraParam':JSON['stringify']({'attachments':_0xd2f57e}),'originPrompt':'','mjpTaskId':''},_0x1a064e=await this[_0x3074d8(0x1a7)](_0x8517a4)[_0x3074d8(0x2b8)](_0xe3be0a=>{const _0x114b2d=_0x3074d8;common_1[_0x114b2d(0x150)][_0x114b2d(0x278)](_0xe3be0a);});if(!_0x1a064e)throw new common_1[(_0x3074d8(0x2f7))](_0x3074d8(0x1b6),common_1[_0x3074d8(0x348)][_0x3074d8(0x1b9)]);this[_0x3074d8(0x17a)]({'jobId':_0x595267})[_0x3074d8(0x2b8)](_0x354b38=>{const _0x508d22=_0x3074d8;common_1[_0x508d22(0x150)]['error'](_0x354b38);}),await this[_0x3074d8(0x240)][_0x3074d8(0x228)](_0x506c83,_0x3074d8(0x21a),0x4,0x4);return;}async[_0x176999(0x171)](_0x5b6fdc){const _0x5b0391=_0x176999,{file:_0xb7e6b9,mode:_0x336666,action:_0x5a169f,jobId:_0x1882d2,userId:_0x3896f4}=_0x5b6fdc;console[_0x5b0391(0x260)](_0x5b0391(0x20e),_0x1882d2);const {channel_id:_0x13991c,authorization:_0x169e83,mjProxy:_0x8fdd0,mjProxyUrl:_0x43aef3}=await this['getMjDefaultParams'](_0x336666)[_0x5b0391(0x2b8)](_0x2bad98=>{const _0x297de5=_0x5b0391;return Promise[_0x297de5(0x16a)](_0x2bad98);});let _0x5041a8;Number(_0x8fdd0)==0x1?_0x5041a8=await this[_0x5b0391(0x157)]({'proxy':_0x43aef3,'authorization':_0x169e83,'channel_id':_0x13991c,'file':[_0xb7e6b9],'needImage':!![]})[_0x5b0391(0x229)](_0x49861a=>_0x49861a[0x0]):_0x5041a8=await this[_0x5b0391(0x334)]({'authorization':_0x169e83,'channel_id':_0x13991c,'filename':(0x0,utils_1[_0x5b0391(0x1fb)])()+_0xb7e6b9[_0x5b0391(0x1c7)],'buffer':_0xb7e6b9['buffer'],'needImage':!![]})[_0x5b0391(0x2b8)](_0x3524ed=>{const _0x614a5d=_0x5b0391;throw new common_1['HttpException'](_0x3524ed,common_1['HttpStatus'][_0x614a5d(0x1b9)]);});if(!_0x5041a8)throw new common_1[(_0x5b0391(0x2f7))](_0x5b0391(0x278),common_1[_0x5b0391(0x348)][_0x5b0391(0x1b9)]);const {image:_0x521c2e,attachments:_0x412f85}=_0x5041a8,_0x1c4b7a={'mode':_0x336666,'action':_0x5a169f,'jobId':_0x1882d2,'userId':_0x3896f4,'imgUrl':_0x521c2e?.[_0x5b0391(0x243)]||'','extraParam':JSON[_0x5b0391(0x20d)]({'attachments':_0x412f85,..._0x521c2e}),'originPrompt':'','mjpTaskId':''},_0x3841c2=await this[_0x5b0391(0x1a7)](_0x1c4b7a)[_0x5b0391(0x2b8)](_0x757a1=>{const _0x6774d6=_0x5b0391;common_1[_0x6774d6(0x150)]['error'](_0x757a1);});if(!_0x3841c2)throw new common_1['HttpException']('添加绘图任务失败',common_1[_0x5b0391(0x348)][_0x5b0391(0x1b9)]);return this['runMjDescribeTask']({'jobId':_0x1882d2})['catch'](_0xc6de7d=>{const _0x190ec9=_0x5b0391;common_1[_0x190ec9(0x150)][_0x190ec9(0x278)](_0xc6de7d);}),await this[_0x5b0391(0x240)]['deductFromBalance'](_0x3896f4,_0x5b0391(0x21a),0x4,0x4),_0x1882d2;}async[_0x176999(0x1e8)](_0x31d285,_0x5b9107){const _0x9008f4=_0x176999,{attachments:_0x5bc826,mode:_0x55838f}=_0x31d285;return await this['initMj'](_0x55838f),await this[_0x9008f4(0x2fc)][_0x55838f][_0x9008f4(0x246)]['describe'](_0x5bc826,(_0x44e80e,_0x339f9a)=>{_0x5b9107(_0x44e80e,_0x339f9a);});}async[_0x176999(0x2e0)](_0x4e255e,_0x48ceca){const _0x1bf4a1=_0x176999,{customId:_0x266dd9,prompt:_0x2a2fa2,mask:_0x3e1893,mode:_0x1655df}=_0x4e255e;return await this[_0x1bf4a1(0x310)](_0x1655df),await this[_0x1bf4a1(0x2fc)][_0x1655df]['api'][_0x1bf4a1(0x298)](_0x266dd9,_0x2a2fa2,_0x3e1893,(_0xa67f0,_0x2be2e1)=>{_0x48ceca(_0xa67f0,_0x2be2e1);});}async[_0x176999(0x304)](_0x103b2e,_0x2e8b0e){const _0x3c34ec=_0x176999,{attachments:_0x33fa01,mode:_0x3e3c79}=_0x103b2e;return await this[_0x3c34ec(0x310)](_0x3e3c79),await this['midJourney'][_0x3e3c79][_0x3c34ec(0x246)]['blend'](_0x33fa01,(_0xba44c0,_0x59f7ed)=>{_0x2e8b0e(_0xba44c0,_0x59f7ed);});}async[_0x176999(0x1b8)](_0x30eea1,_0x449532){const _0x28187b=_0x176999,{prompt:_0x2ab5ba,mode:_0x217930}=_0x30eea1;return await this[_0x28187b(0x310)](_0x217930),await this[_0x28187b(0x2fc)][_0x217930]['api']['imagine'](_0x2ab5ba,(_0x264936,_0x30105c)=>{_0x449532(_0x264936,_0x30105c);});}async[_0x176999(0x2dd)](_0x5ea71c,_0x551558){const _0x961571=_0x176999,{messageId:_0x34ff5d,customId:_0x57f655,messageFlags:_0x2636f7,mode:_0x487a68}=_0x5ea71c;return await this[_0x961571(0x310)](_0x487a68),await this[_0x961571(0x2fc)][_0x487a68][_0x961571(0x246)][_0x961571(0x209)](_0x34ff5d,_0x57f655,_0x2636f7,_0x551558);}async[_0x176999(0x342)](_0x12ffff){const _0x4be5a5=_0x176999,{proxy:_0x248248,guild_id:_0x5d9e45,channel_id:_0x27fde3,authorization:_0xa78b1a,prompt:_0x447184}=_0x12ffff;return await axios_1[_0x4be5a5(0x15f)][_0x4be5a5(0x138)](_0x248248+_0x4be5a5(0x330),{'guild_id':_0x5d9e45,'channel_id':_0x27fde3,'token':_0xa78b1a,'prompt':_0x447184});}async[_0x176999(0x198)](_0x17c69b){const _0x31d54f=_0x176999,{proxy:_0x25b109,guild_id:_0x54477e,channel_id:_0x54401d,message_id:_0x550b08,custom_id:_0x266c1b,flags:_0x276b00,authorization:_0x40068b}=_0x17c69b;return await axios_1['default'][_0x31d54f(0x138)](_0x25b109+_0x31d54f(0x314),{'message_id':_0x550b08,'custom_id':_0x266c1b,'flags':_0x276b00,'guild_id':_0x54477e,'channel_id':_0x54401d,'token':_0x40068b});}async[_0x176999(0x2d0)](_0x11d73f){const _0x217ea5=_0x176999,{proxy:_0x581d3b,guild_id:_0x3e21e6,channel_id:_0x4eb1da,message_id:_0x2650a9,custom_id:_0x56cfd9,flags:_0x41feff,authorization:_0x172b85}=_0x11d73f;return await axios_1[_0x217ea5(0x15f)][_0x217ea5(0x138)](_0x581d3b+_0x217ea5(0x27f),{'message_id':_0x2650a9,'custom_id':_0x56cfd9,'flags':_0x41feff,'guild_id':_0x3e21e6,'channel_id':_0x4eb1da,'token':_0x172b85});}async[_0x176999(0x2d4)](_0x23b9da){const _0x14da96=_0x176999,_0x21f33c=await this[_0x14da96(0x161)][_0x14da96(0x30c)]({'where':{'jobId':_0x23b9da}}),{id:_0x82d5f8,createdAt:_0x3ca26a,mode:_0x3789f5,action:_0x235ca5,imgUrl:_0x22bdd3,extraParam:_0x17de40,prompt:_0x541f08,translate:_0x3769e7}=_0x21f33c;await this[_0x14da96(0x2bb)](_0x23b9da,midjourney_constant_1[_0x14da96(0x291)]['DRAWING']);let _0x32a87e=_0x3769e7===0x1&&(0x0,utils_1[_0x14da96(0x270)])(_0x541f08)?await this[_0x14da96(0x194)][_0x14da96(0x1bf)](_0x541f08):_0x541f08;common_1[_0x14da96(0x150)][_0x14da96(0x260)](_0x32a87e,'翻译后的\x20'),common_1[_0x14da96(0x150)][_0x14da96(0x260)](_0x3769e7===0x1&&(0x0,utils_1['isChinese'])(_0x541f08)?'是':'否',_0x14da96(0x1dc));const _0x9b84cf=_0x22bdd3?_0x22bdd3+'\x20'+_0x32a87e+'\x20'+_0x17de40:_0x32a87e+'\x20'+_0x17de40;return _0x3769e7===0x1&&(0x0,utils_1[_0x14da96(0x270)])(_0x541f08)&&await this[_0x14da96(0x161)]['update']({'id':_0x82d5f8},{'fullPrompt':_0x9b84cf,'prompt':_0x32a87e})[_0x14da96(0x2b8)](_0x4e07a4=>{const _0x608508=_0x14da96;console[_0x608508(0x260)](_0x4e07a4),this[_0x608508(0x29e)]({'id':_0x82d5f8,'userId':_0x21f33c[_0x608508(0x2fd)],'action':_0x21f33c['action']});}),!![];}async[_0x176999(0x29a)](_0x50ffc1){const _0x426097=_0x176999,{jobId:_0x36a561,customId:_0x5b3bfa,prompt:_0x2f431f,mask:_0x3ad4aa}=_0x50ffc1,_0x5ba984=await this['midjourneyEntity']['findOne']({'where':{'jobId':_0x36a561}});await this[_0x426097(0x2bb)](_0x36a561,midjourney_constant_1[_0x426097(0x291)][_0x426097(0x16b)]);const _0x511126=await this['globalConfigService'][_0x426097(0x1c8)]([_0x426097(0x2a7)]),{mode:_0x4476e5,id:_0x23ee09,createdAt:_0x526581}=_0x5ba984;if(Number(_0x511126)===0x0){const _0x2baf41=await this[_0x426097(0x2e0)]({'customId':_0x5b3bfa,'prompt':_0x2f431f,'mask':_0x3ad4aa,'mode':_0x4476e5},async(_0x15bfac,_0x726a2e)=>{const _0x14452d=_0x426097;console[_0x14452d(0x260)](_0x14452d(0x323),_0x15bfac,_0x726a2e);if(_0x15bfac==='MESSAGE_UPDATE'||_0x15bfac===_0x14452d(0x252)){const {progress:_0x457739,content:_0x10d743,url:_0x2d138b,id:_0x2829e4,attachments:_0x1495e0,flags:_0x1ee1d0,components:_0x11e415}=_0x726a2e;await this[_0x14452d(0x2d6)]({'messageId':_0x2829e4,'messageFlags':_0x1ee1d0,'id':_0x23ee09,'jobId':_0x36a561,'createdAt':_0x526581,'extend':JSON['stringify']({'components':_0x11e415,'attachments':_0x1495e0[0x0]||{}})||'','url':_0x2d138b,'action':_0x5ba984[_0x14452d(0x209)],'progress':_0x457739,'type':_0x14452d(0x1cd),'mode':_0x4476e5,'prompt':_0x10d743});}})[_0x426097(0x2b8)](_0x2e11bb=>{const _0xdde8f6=_0x426097;common_1[_0xdde8f6(0x150)]['error'](_0x2e11bb,_0xdde8f6(0x23f)),this[_0xdde8f6(0x29e)]({'id':_0x23ee09,'userId':_0x5ba984['userId'],'action':_0x5ba984[_0xdde8f6(0x209)]});});if(!_0x2baf41)return;const _0x2bcdb3=(new Date(_0x2baf41[_0x426097(0x17f)])[_0x426097(0x2cd)]()-new Date(_0x526581)[_0x426097(0x2cd)]())/0x3e8,{url:_0x243f1b,progress:_0x5879fa,components:_0x32177b,attachments:_0x337ab9}=_0x2baf41;await this[_0x426097(0x289)](_0x36a561,{..._0x2baf41,'components':_0x32177b,'attachments':_0x337ab9[0x0]||{},'messageFlags':_0x2baf41[_0x426097(0x191)],'messageId':_0x2baf41['id'],'url':_0x243f1b,'progress':_0x5879fa,'action':_0x5ba984[_0x426097(0x209)],'durationSpent':_0x2bcdb3,'prompt':_0x2baf41['content']}),await this[_0x426097(0x2d6)]({'durationSpent':_0x2bcdb3,'messageId':_0x2baf41['id'],'messageFlags':_0x2baf41[_0x426097(0x191)],'id':_0x23ee09,'jobId':_0x36a561,'createdAt':_0x526581,'extend':JSON[_0x426097(0x20d)]({'components':_0x32177b,'attachments':_0x337ab9[0x0]||{}})||'','url':_0x243f1b,'action':_0x5ba984[_0x426097(0x209)],'progress':_0x5879fa,'type':_0x426097(0x2f6),'mode':_0x4476e5,'prompt':_0x2baf41['content']});}else{console['log'](_0x426097(0x140));const {guild_id:_0x337ebd,channel_id:_0x5c5df2,authorization:_0x117493,mjProxyUrl:_0x2fae08,mjSocketProxyUrl:_0x8ebabc}=await this['getMjDefaultParams'](_0x4476e5)['catch'](_0x107c4a=>{const _0x12fd76=_0x426097;return Promise[_0x12fd76(0x16a)](_0x107c4a);}),_0x17e3b4=await this['runVaryRegionJobByProxy']({'guild_id':_0x337ebd,'channel_id':_0x5c5df2,'authorization':_0x117493,'custom_id':_0x5b3bfa,'prompt':_0x2f431f,'mask':_0x3ad4aa,'proxy':_0x2fae08});await this[_0x426097(0x275)](_0x8ebabc)[_0x426097(0x229)](_0x58f273=>{const _0x2e1b41=_0x426097;common_1[_0x2e1b41(0x150)]['log'](_0x2e1b41(0x1c4),_0x58f273[_0x2e1b41(0x14a)]),common_1[_0x2e1b41(0x150)]['log'](_0x2e1b41(0x2ea),_0x58f273[_0x2e1b41(0x293)]),(!_0x58f273['active']||!_0x58f273[_0x2e1b41(0x293)])&&_0x58f273[_0x2e1b41(0x26d)](),_0x58f273['active']&&!_0x58f273[_0x2e1b41(0x293)]&&_0x58f273['connect'](),_0x58f273['on'](_0x2e1b41(0x170),async _0x1b42fa=>{const _0x12c64a=_0x2e1b41,{nonceId:_0xbd09fd,msg:_0x35310f,type:_0x7f39d0}=_0x1b42fa;console[_0x12c64a(0x260)](_0xbd09fd,_0x35310f,_0x7f39d0);if(_0x17e3b4['data']===_0xbd09fd){if(_0x7f39d0===_0x12c64a(0x1cd)||_0x7f39d0===_0x12c64a(0x252)){const {progress:_0x28afdc,content:_0x2de2e5,url:_0x1c15f6,timestamp:_0x412f08,id:_0x1ff195,flags:_0x574695,components:_0x3cbcce,attachments:_0x4f8b1d}=_0x35310f;if(_0x28afdc<0x64)await this[_0x12c64a(0x2d6)]({'id':_0x23ee09,'messageId':_0x1ff195,'messageFlags':_0x574695,'extend':JSON[_0x12c64a(0x20d)]({'components':_0x3cbcce,'attachments':_0x4f8b1d[0x0]})||'','jobId':_0x36a561,'createdAt':_0x5ba984[_0x12c64a(0x1e7)],'progress':_0x28afdc,'action':_0x5ba984[_0x12c64a(0x209)],'url':_0x1c15f6||'','type':_0x7f39d0,'mode':_0x4476e5,'prompt':_0x2de2e5});else{const _0x329287=(new Date(_0x412f08)[_0x12c64a(0x2cd)]()-new Date(_0x5ba984[_0x12c64a(0x1e7)])[_0x12c64a(0x2cd)]())/0x3e8;await this[_0x12c64a(0x289)](_0x36a561,{..._0x35310f,'components':_0x3cbcce,'attachments':{'width':0x0,'height':0x0},'messageId':_0x1ff195,'messageFlags':_0x574695,'url':_0x1c15f6||'','action':_0x5ba984[_0x12c64a(0x209)],'prompt':_0x2de2e5,'progress':_0x28afdc,'durationSpent':_0x329287}),await this['saveToRedis']({'durationSpent':_0x329287,'id':_0x23ee09,'messageId':_0x1ff195,'messageFlags':_0x574695,'extend':JSON[_0x12c64a(0x20d)]({'components':_0x3cbcce,'attachments':_0x4f8b1d[0x0]})||'','jobId':_0x36a561,'createdAt':_0x5ba984[_0x12c64a(0x1e7)],'progress':_0x28afdc,'action':_0x5ba984[_0x12c64a(0x209)],'url':_0x1c15f6||'','type':_0x7f39d0,'mode':_0x4476e5,'prompt':_0x2de2e5});}}}});});}}async[_0x176999(0x178)](_0x48619d){const _0x356f9b=_0x176999,{proxy:_0x2c5d35,guild_id:_0x18150e,custom_id:_0x3ae150,prompt:_0x3afe84,mask:_0xe1f3aa,channel_id:_0xd5dc2,authorization:_0x59a1c7}=_0x48619d;return await axios_1[_0x356f9b(0x15f)]['post'](_0x2c5d35+_0x356f9b(0x1e5),{'guild_id':_0x18150e,'channel_id':_0xd5dc2,'token':_0x59a1c7,'prompt':_0x3afe84,'mask':_0xe1f3aa,'custom_id':_0x3ae150});}async['runMjDescribeTask'](_0x795c14){const _0x5060b4=_0x176999,{jobId:_0x3872af}=_0x795c14,_0x59b8f5=await this[_0x5060b4(0x161)]['findOne']({'where':{'jobId':_0x3872af}});await this['updateDrawStatus'](_0x3872af,midjourney_constant_1[_0x5060b4(0x291)][_0x5060b4(0x16b)]);const _0x4963cf=await this[_0x5060b4(0x2ad)][_0x5060b4(0x1c8)]([_0x5060b4(0x2a7)]),{mode:_0x15bb8a,id:_0x17ffa7,extraParam:_0x1035b9,action:_0x365a23}=_0x59b8f5;if(!_0x1035b9){common_1['Logger']['error'](_0x5060b4(0x30a)),await this[_0x5060b4(0x29e)]({'id':_0x17ffa7,'userId':_0x59b8f5['userId'],'action':_0x59b8f5[_0x5060b4(0x209)]});return;}const _0x461d3e=JSON[_0x5060b4(0x28d)](_0x1035b9),{attachments:_0x52052c}=_0x461d3e;common_1[_0x5060b4(0x150)][_0x5060b4(0x260)](_0x5060b4(0x166),_0x4963cf);if(Number(_0x4963cf)===0x0)await this[_0x5060b4(0x1e8)]({'attachments':_0x52052c,'mode':_0x15bb8a},async(_0x2d43db,_0x54270f)=>{const _0x301057=_0x5060b4;console[_0x301057(0x260)](_0x301057(0x2b7),_0x2d43db,_0x54270f);if(_0x2d43db===_0x301057(0x1cd)){const {progress:_0x5272a7,url:_0x5eed10,timestamp:_0x3825b5,id:_0x4c645c,flags:_0x35666a,components:_0x52f551,embed:_0xa87749}=_0x54270f,_0x10f1c4=(new Date(_0x3825b5)[_0x301057(0x2cd)]()-new Date(_0x59b8f5[_0x301057(0x1e7)])[_0x301057(0x2cd)]())/0x3e8;await this[_0x301057(0x289)](_0x3872af,{..._0x54270f,'components':_0x52f551,'attachments':{'width':0x0,'height':0x0},'messageId':_0x4c645c,'messageFlags':_0x35666a,'url':_0x5eed10||'','action':_0x365a23,'prompt':_0xa87749[_0x301057(0x29c)],'progress':_0x5272a7,'durationSpent':_0x10f1c4}),await this[_0x301057(0x2d6)]({'durationSpent':_0x10f1c4,'id':_0x17ffa7,'messageId':_0x4c645c,'messageFlags':_0x35666a,'extend':JSON[_0x301057(0x20d)]({'components':_0x52f551,'attachments':{}})||'','jobId':_0x3872af,'createdAt':_0x59b8f5[_0x301057(0x1e7)],'progress':_0x5272a7,'action':_0x365a23,'url':_0x5eed10||'','type':_0x2d43db,'mode':_0x15bb8a,'prompt':_0xa87749[_0x301057(0x29c)]});}})['catch'](_0x47348b=>{const _0x364feb=_0x5060b4;common_1['Logger'][_0x364feb(0x278)](_0x47348b),this[_0x364feb(0x29e)]({'id':_0x17ffa7,'userId':_0x59b8f5[_0x364feb(0x2fd)],'action':_0x59b8f5['action']});});else{const {guild_id:_0x35d05b,channel_id:_0x12c6c4,authorization:_0x403ec5,mjProxyUrl:_0x172ae4,mjSocketProxyUrl:_0x4fcd51}=await this[_0x5060b4(0x2a6)](_0x15bb8a)[_0x5060b4(0x2b8)](_0x1211af=>{const _0x2051cf=_0x5060b4;return Promise[_0x2051cf(0x16a)](_0x1211af);}),_0x4514e6=await this['runMjDescribeProxy']({'guild_id':_0x35d05b,'channel_id':_0x12c6c4,'authorization':_0x403ec5,'files':_0x52052c,'proxy':_0x172ae4});await this[_0x5060b4(0x275)](_0x4fcd51)[_0x5060b4(0x229)](_0xb89d36=>{const _0x128457=_0x5060b4;common_1[_0x128457(0x150)][_0x128457(0x260)]('socket.active',_0xb89d36[_0x128457(0x14a)]),common_1[_0x128457(0x150)][_0x128457(0x260)](_0x128457(0x2ea),_0xb89d36['connected']),(!_0xb89d36['active']||!_0xb89d36[_0x128457(0x293)])&&_0xb89d36['connect'](),_0xb89d36['active']&&!_0xb89d36['connected']&&_0xb89d36['connect'](),_0xb89d36['on'](_0x128457(0x1c0),async _0x3d8561=>{const _0x413bcf=_0x128457,{nonceId:_0x277261,msg:_0x5e9b2b,type:_0x2b4271}=_0x3d8561;if(_0x4514e6[_0x413bcf(0x32f)]===_0x277261){if(_0x2b4271===_0x413bcf(0x1cd)){const {progress:_0x1a9b2f,url:_0x12c4c0,timestamp:_0x4629c2,id:_0x5ba876,flags:_0x53c501,components:_0x1e5d0e,embed:_0x56cd51}=_0x5e9b2b;console['log'](_0x413bcf(0x26b),_0x5e9b2b);const _0x1925c4=(new Date(_0x4629c2)[_0x413bcf(0x2cd)]()-new Date(_0x59b8f5[_0x413bcf(0x1e7)])[_0x413bcf(0x2cd)]())/0x3e8;await this[_0x413bcf(0x289)](_0x3872af,{..._0x5e9b2b,'components':_0x1e5d0e,'attachments':{'width':0x0,'height':0x0},'messageId':_0x5ba876,'messageFlags':_0x53c501,'url':_0x12c4c0||'','action':_0x365a23,'prompt':_0x56cd51[_0x413bcf(0x29c)],'progress':_0x1a9b2f,'durationSpent':_0x1925c4}),common_1[_0x413bcf(0x150)][_0x413bcf(0x260)](_0x413bcf(0x1f7)),await this[_0x413bcf(0x2d6)]({'durationSpent':_0x1925c4,'id':_0x17ffa7,'messageId':_0x5ba876,'messageFlags':_0x53c501,'extend':JSON['stringify']({'components':_0x1e5d0e,'attachments':{}})||'','jobId':_0x3872af,'createdAt':_0x59b8f5[_0x413bcf(0x1e7)],'progress':_0x1a9b2f,'action':_0x365a23,'url':_0x12c4c0||'','type':_0x2b4271,'mode':_0x15bb8a,'prompt':_0x56cd51[_0x413bcf(0x29c)]});}}});});}return!![];}async['runMjDescribeProxy'](_0x297185){const _0x18ce22=_0x176999,{proxy:_0xf0dba7,guild_id:_0x5ad568,files:_0x30bac4,channel_id:_0x515823,authorization:_0x397dc2}=_0x297185;return await axios_1[_0x18ce22(0x15f)][_0x18ce22(0x138)](_0xf0dba7+_0x18ce22(0x19d),{'guild_id':_0x5ad568,'channel_id':_0x515823,'token':_0x397dc2,'files':_0x30bac4});}async[_0x176999(0x25f)](_0x5c232f){const _0x5d1792=_0x176999,{proxy:_0x324828,guild_id:_0x4898bf,files:_0x1813b7,channel_id:_0x1232ad,authorization:_0x1e06c1}=_0x5c232f;return await axios_1[_0x5d1792(0x15f)][_0x5d1792(0x138)](_0x324828+_0x5d1792(0x1ae),{'guild_id':_0x4898bf,'channel_id':_0x1232ad,'token':_0x1e06c1,'files':_0x1813b7});}async[_0x176999(0x17a)](_0x29f294){const _0x11a8d3=_0x176999;common_1[_0x11a8d3(0x150)][_0x11a8d3(0x260)](_0x11a8d3(0x27b));const {jobId:_0x39b374}=_0x29f294,_0x2ce931=await this['midjourneyEntity'][_0x11a8d3(0x30c)]({'where':{'jobId':_0x39b374}});await this[_0x11a8d3(0x2bb)](_0x39b374,midjourney_constant_1['MidjourneyStatusEnum'][_0x11a8d3(0x16b)]);const _0x10b5c0=await this['globalConfigService'][_0x11a8d3(0x1c8)]([_0x11a8d3(0x2a7)]),{mode:_0x3e0e45,id:_0x242f21,createdAt:_0x3c869b,extraParam:_0xd3ea3f,action:_0x1aeaf2}=_0x2ce931;if(!_0xd3ea3f){common_1['Logger']['error'](_0x11a8d3(0x30a)),this[_0x11a8d3(0x29e)]({'id':_0x242f21,'userId':_0x2ce931[_0x11a8d3(0x2fd)],'action':_0x2ce931[_0x11a8d3(0x209)]});return;}const _0x245272=JSON['parse'](_0xd3ea3f),{attachments:_0x173e3e}=_0x245272;common_1[_0x11a8d3(0x150)]['log'](_0x10b5c0==0x0,_0x11a8d3(0x21c));if(Number(_0x10b5c0)===0x0){const _0x4388af=await this[_0x11a8d3(0x304)]({'attachments':_0x173e3e,'mode':_0x3e0e45},async(_0x27d8e6,_0xd5d771)=>{const _0x51b298=_0x11a8d3;console['log'](_0x51b298(0x284),_0x27d8e6,_0xd5d771);if(_0x27d8e6===_0x51b298(0x1cd)){console[_0x51b298(0x260)](_0x51b298(0x192),_0x1aeaf2);const {progress:_0x1af0e0,content:_0x4d55d4,url:_0x2e33aa,id:_0x356aa3,attachments:_0x299da5,flags:_0xbc99a8,components:_0x5bb50f}=_0xd5d771;await this[_0x51b298(0x2d6)]({'messageId':_0x356aa3,'messageFlags':_0xbc99a8,'id':_0x242f21,'jobId':_0x39b374,'createdAt':_0x3c869b,'extend':JSON[_0x51b298(0x20d)]({'components':_0x5bb50f,'attachments':_0x299da5[0x0]||{}})||'','url':_0x2e33aa,'action':_0x2ce931[_0x51b298(0x209)],'progress':_0x1af0e0,'type':'MESSAGE_UPDATE','mode':_0x3e0e45,'prompt':_0x4d55d4});}})[_0x11a8d3(0x2b8)](_0x81efe7=>{const _0xbb1416=_0x11a8d3;common_1[_0xbb1416(0x150)][_0xbb1416(0x278)](_0x81efe7),this[_0xbb1416(0x29e)]({'id':_0x242f21,'userId':_0x2ce931[_0xbb1416(0x2fd)],'action':_0x2ce931['action']});});console['log'](_0x11a8d3(0x1b5),_0x4388af);const _0x628f5a=(new Date(_0x4388af[_0x11a8d3(0x17f)])[_0x11a8d3(0x2cd)]()-new Date(_0x3c869b)[_0x11a8d3(0x2cd)]())/0x3e8,{url:_0x5c2b0c,progress:_0x5e74b7,components:_0x1c2b60,attachments:_0x41837f}=_0x4388af;await this['updateDrawData'](_0x39b374,{..._0x4388af,'components':_0x1c2b60,'attachments':_0x41837f[0x0]||{},'messageFlags':_0x4388af[_0x11a8d3(0x191)],'messageId':_0x4388af['id'],'url':_0x5c2b0c,'progress':_0x5e74b7,'action':_0x2ce931['action'],'durationSpent':_0x628f5a,'prompt':_0x4388af[_0x11a8d3(0x272)]}),await this['saveToRedis']({'durationSpent':_0x628f5a,'messageId':_0x4388af['id'],'messageFlags':_0x4388af['flags'],'id':_0x242f21,'jobId':_0x39b374,'createdAt':_0x3c869b,'extend':JSON[_0x11a8d3(0x20d)]({'components':_0x1c2b60,'attachments':_0x41837f[0x0]||{}})||'','url':_0x5c2b0c,'action':_0x2ce931[_0x11a8d3(0x209)],'progress':_0x5e74b7,'type':_0x11a8d3(0x2f6),'mode':_0x3e0e45,'prompt':_0x4388af['content']});}else{common_1[_0x11a8d3(0x150)]['log'](_0x11a8d3(0x1c5));const {guild_id:_0x136e3b,channel_id:_0x41ba4b,authorization:_0x26754c,mjProxyUrl:_0x38d1b4,mjSocketProxyUrl:_0x2d0fdd}=await this['getMjDefaultParams'](_0x3e0e45)[_0x11a8d3(0x2b8)](_0x20e07a=>{return Promise['reject'](_0x20e07a);}),_0x28a0f8=await this[_0x11a8d3(0x25f)]({'guild_id':_0x136e3b,'channel_id':_0x41ba4b,'authorization':_0x26754c,'files':_0x173e3e,'proxy':_0x38d1b4});await this['initSocket'](_0x2d0fdd)[_0x11a8d3(0x229)](_0x3a34a1=>{const _0xa4f3e4=_0x11a8d3;common_1['Logger'][_0xa4f3e4(0x260)]('socket.active',_0x3a34a1['active']),common_1[_0xa4f3e4(0x150)][_0xa4f3e4(0x260)](_0xa4f3e4(0x2ea),_0x3a34a1[_0xa4f3e4(0x293)]),(!_0x3a34a1['active']||!_0x3a34a1[_0xa4f3e4(0x293)])&&_0x3a34a1[_0xa4f3e4(0x26d)](),_0x3a34a1[_0xa4f3e4(0x14a)]&&!_0x3a34a1['connected']&&_0x3a34a1[_0xa4f3e4(0x26d)](),_0x3a34a1['on']('blend',async _0x445cf6=>{const _0x4cb16e=_0xa4f3e4,{nonceId:_0x64a9b8,msg:_0x1de5e3,type:_0x4d3943}=_0x445cf6;if(_0x28a0f8[_0x4cb16e(0x32f)]===_0x64a9b8){if(_0x4d3943===_0x4cb16e(0x1cd)||_0x4d3943===_0x4cb16e(0x252)){const {progress:_0x1e217e,content:_0x306cbe,url:_0x43c2b6,id:_0x1f5e37,attachments:_0x5f54a3,flags:_0x42bcff,components:_0x25b280}=_0x1de5e3;if(_0x1e217e<0x64)await this[_0x4cb16e(0x2d6)]({'messageId':_0x1f5e37,'messageFlags':_0x42bcff,'id':_0x242f21,'jobId':_0x39b374,'createdAt':_0x3c869b,'extend':JSON[_0x4cb16e(0x20d)]({'components':_0x25b280,'attachments':_0x5f54a3[0x0]||{}})||'','url':_0x43c2b6,'action':_0x2ce931['action'],'progress':_0x1e217e,'type':_0x4cb16e(0x1cd),'mode':_0x3e0e45,'prompt':_0x306cbe});else{const _0x108ded=(new Date(_0x1de5e3[_0x4cb16e(0x17f)])[_0x4cb16e(0x2cd)]()-new Date(_0x3c869b)['getTime']())/0x3e8,{components:_0x206926,attachments:_0x15c3b7}=_0x1de5e3;await this['updateDrawData'](_0x39b374,{'components':_0x206926,'attachments':_0x15c3b7[0x0]||{},'messageFlags':_0x42bcff,'messageId':_0x1f5e37,'url':_0x43c2b6,'progress':_0x1e217e,'action':_0x2ce931[_0x4cb16e(0x209)],'durationSpent':_0x108ded,'prompt':_0x306cbe}),await this['saveToRedis']({'durationSpent':_0x108ded,'messageId':_0x1f5e37,'messageFlags':_0x42bcff,'id':_0x242f21,'jobId':_0x39b374,'createdAt':_0x3c869b,'extend':JSON['stringify']({'components':_0x206926,'attachments':_0x15c3b7[0x0]||{}})||'','url':_0x43c2b6,'action':_0x2ce931[_0x4cb16e(0x209)],'progress':_0x1e217e,'type':'INTERACTION_SUCCESS','mode':_0x3e0e45,'prompt':_0x306cbe});}}}});});}return!![];}async[_0x176999(0x2a0)](_0x499f99){const _0xac91ea=_0x176999,{jobId:_0x5e8938,messageId:_0x52626a,drawId:_0x3db909,customId:_0x5d4474,messageFlags:_0x2e506e}=_0x499f99,_0x436ff1=await this['midjourneyEntity'][_0xac91ea(0x30c)]({'where':{'jobId':_0x5e8938}});await this[_0xac91ea(0x2bb)](_0x5e8938,midjourney_constant_1['MidjourneyStatusEnum'][_0xac91ea(0x16b)]);const _0x458baf=await this[_0xac91ea(0x2ad)][_0xac91ea(0x1c8)]([_0xac91ea(0x2a7)]),{mode:_0x51d33e}=_0x436ff1;if(Number(_0x458baf)===0x0){const _0x1ee60e=await this[_0xac91ea(0x2dd)]({'messageId':_0x52626a,'customId':_0x5d4474,'messageFlags':_0x2e506e,'mode':_0x51d33e},async(_0x2e6f00,_0x389b79)=>{const _0xc4c9b5=_0xac91ea;if(_0x2e6f00===_0xc4c9b5(0x1cd)){common_1['Logger']['log'](_0xc4c9b5(0x331),_0x5e8938);const {progress:_0x4548f8,content:_0x38e789,url:_0x273f41,id:_0x2d59d2,flags:_0x1fd68b,components:_0x5f2095}=_0x389b79;_0x436ff1['action']!==midjourney_constant_1[_0xc4c9b5(0x176)][_0xc4c9b5(0x1ab)]&&await this[_0xc4c9b5(0x2d6)]({'id':_0x3db909,'messageId':_0x2d59d2,'messageFlags':_0x1fd68b,'extend':JSON[_0xc4c9b5(0x20d)]({'components':_0x5f2095})||'','jobId':_0x5e8938,'action':_0x436ff1['action'],'createdAt':_0x436ff1['createdAt'],'progress':_0x4548f8,'url':_0x273f41||'','type':_0x2e6f00,'mode':_0x51d33e,'prompt':_0x38e789||''});}if(_0x2e6f00==='MESSAGE_CREATE'){const {progress:_0x34833d,id:_0x1c685c,flags:_0x5befde,url:_0x25ed3a,attachments:_0x1fabba,components:_0x50dfc0}=_0x389b79;common_1[_0xc4c9b5(0x150)][_0xc4c9b5(0x260)](_0xc4c9b5(0x25d),_0x5e8938),await this[_0xc4c9b5(0x2d6)]({'id':_0x3db909,'messageId':_0x1c685c,'messageFlags':_0x5befde,'extend':JSON[_0xc4c9b5(0x20d)]({'components':_0x50dfc0,'attachments':_0x1fabba})||'','jobId':_0x5e8938,'action':_0x436ff1[_0xc4c9b5(0x209)],'createdAt':_0x436ff1[_0xc4c9b5(0x1e7)],'progress':_0x34833d,'url':_0x25ed3a||'','type':_0x2e6f00,'mode':_0x51d33e,'prompt':_0x389b79['content']||_0x436ff1[_0xc4c9b5(0x1a4)]});}if(_0x2e6f00==='INTERACTION_MODAL_CREATE'){const {components:_0x2dad03,id:_0x6f9210,custom_id:_0x5a7f}=_0x389b79;await this[_0xc4c9b5(0x1a1)]({'mode':_0x51d33e,'components':_0x2dad03,'customId':_0x5a7f,'id':_0x6f9210,'action':_0x436ff1['action'],'jobId':_0x5e8938,'drawId':_0x3db909,'createdAt':_0x436ff1[_0xc4c9b5(0x1e7)]});}})[_0xac91ea(0x2b8)](_0x4b6e4f=>{const _0x1986b1=_0xac91ea;common_1[_0x1986b1(0x150)][_0x1986b1(0x278)](_0x4b6e4f),this['drawFailed']({'id':_0x3db909,'userId':_0x436ff1['userId'],'action':_0x436ff1[_0x1986b1(0x209)]});});if(!_0x1ee60e)return;const _0x1eab9c=(new Date(_0x1ee60e[_0xac91ea(0x17f)])[_0xac91ea(0x2cd)]()-new Date(_0x436ff1['createdAt'])[_0xac91ea(0x2cd)]())/0x3e8,{url:_0x4d4b0a,progress:_0x4c08fb,attachments:_0x15cef6,components:_0x199e0c}=_0x1ee60e;await this['updateDrawData'](_0x5e8938,{..._0x1ee60e,'components':_0x199e0c,'attachments':_0x15cef6[0x0]||{},'messageId':_0x1ee60e['id'],'messageFlags':_0x1ee60e[_0xac91ea(0x191)],'url':_0x4d4b0a,'action':_0x436ff1['action'],'prompt':_0x1ee60e[_0xac91ea(0x272)],'progress':_0x4c08fb,'durationSpent':_0x1eab9c}),await this['saveToRedis']({'durationSpent':_0x1eab9c,'messageId':_0x1ee60e['id'],'messageFlags':_0x1ee60e[_0xac91ea(0x191)],'id':_0x436ff1['id'],'jobId':_0x5e8938,'createdAt':_0x436ff1['createdAt'],'extend':JSON['stringify']({'components':_0x199e0c,'attachments':_0x15cef6}),'action':_0x436ff1[_0xac91ea(0x209)],'url':_0x4d4b0a,'progress':_0x4c08fb,'type':_0xac91ea(0x2f6),'mode':_0x51d33e,'prompt':_0x1ee60e[_0xac91ea(0x272)]});}else{const {guild_id:_0x37534b,channel_id:_0x13a107,authorization:_0x417de0,mjProxyUrl:_0x14ec8b,mjSocketProxyUrl:_0x1cb154}=await this[_0xac91ea(0x2a6)](_0x51d33e)['catch'](_0x48c638=>{const _0x45432f=_0xac91ea;return Promise[_0x45432f(0x16a)](_0x48c638);}),_0x5ce8da=await this[_0xac91ea(0x198)]({'message_id':_0x52626a,'custom_id':_0x5d4474,'channel_id':_0x13a107,'proxy':_0x14ec8b,'flags':_0x2e506e,'authorization':_0x417de0,'guild_id':_0x37534b});await this['initSocket'](_0x1cb154)['then'](_0x34ec96=>{const _0x22d9c7=_0xac91ea;common_1[_0x22d9c7(0x150)][_0x22d9c7(0x260)]('socket.active',_0x34ec96[_0x22d9c7(0x14a)]),common_1['Logger']['log'](_0x22d9c7(0x2ea),_0x34ec96[_0x22d9c7(0x293)]),(!_0x34ec96['active']||!_0x34ec96[_0x22d9c7(0x293)])&&_0x34ec96['connect'](),_0x34ec96[_0x22d9c7(0x14a)]&&!_0x34ec96['connected']&&_0x34ec96[_0x22d9c7(0x26d)](),_0x34ec96['on']('action',async _0xe9ecfe=>{const _0x422447=_0x22d9c7,{nonceId:_0x25667,msg:_0x7a34cd,type:_0x355349}=_0xe9ecfe;if(_0x5ce8da[_0x422447(0x32f)]===_0x25667){if(_0x355349===_0x422447(0x1cd)){const {progress:_0x1eed1f,content:_0x2ec391,createdAt:_0xb0061d,url:_0x44f418,id:_0x55bdce,flags:_0x55b814,attachments:_0x12e3a5,components:_0x189846}=_0x7a34cd;_0x436ff1[_0x422447(0x209)]!==midjourney_constant_1[_0x422447(0x176)][_0x422447(0x1ab)]&&(console[_0x422447(0x260)](_0x422447(0x2b6),_0x1eed1f,_0x436ff1['action']),await this[_0x422447(0x2d6)]({'id':_0x3db909,'messageId':_0x55bdce,'messageFlags':_0x55b814,'extend':JSON[_0x422447(0x20d)]({'components':_0x189846})||'','jobId':_0x5e8938,'action':_0x436ff1[_0x422447(0x209)],'createdAt':_0x436ff1['createdAt'],'progress':_0x1eed1f,'url':_0x44f418||'','type':_0x355349,'mode':_0x51d33e,'prompt':_0x2ec391||''}));}if(_0x355349===_0x422447(0x252)){console[_0x422447(0x260)]('按钮操作');const {progress:_0x1d6b7f,timestamp:_0x1da858,createdAt:_0x485cfc,content:_0x1328c3,id:_0x5a8400,flags:_0x42714d,url:_0x32ab52,attachments:_0x2d2c58,components:_0x8613b6}=_0x7a34cd;if(_0x1d6b7f===0x64){console[_0x422447(0x260)](_0x1da858),console[_0x422447(0x260)](_0x436ff1[_0x422447(0x1e7)]);const _0x31a5c1=(new Date(_0x1da858)[_0x422447(0x2cd)]()-new Date(_0x436ff1[_0x422447(0x1e7)])[_0x422447(0x2cd)]())/0x3e8;console[_0x422447(0x260)](_0x31a5c1),await this[_0x422447(0x289)](_0x436ff1[_0x422447(0x20e)],{..._0x7a34cd,'url':_0x32ab52,'attachments':_0x2d2c58,'action':_0x436ff1[_0x422447(0x209)],'progress':_0x1d6b7f,'prompt':_0x1328c3,'messageId':_0x52626a,'messageFlags':_0x42714d,'durationSpent':_0x31a5c1}),await this[_0x422447(0x2d6)]({'progress':_0x1d6b7f,'url':_0x32ab52,'type':'MESSAGE_UPDATE','durationSpent':_0x31a5c1,'jobId':_0x436ff1['jobId'],'createdAt':_0x485cfc,'action':_0x436ff1[_0x422447(0x209)],'messageId':_0x52626a,'messageFlags':_0x42714d,'extend':JSON['stringify']({'components':_0x8613b6,'attachments':_0x2d2c58[0x0]||{}})||'','id':_0x436ff1['id'],'mode':_0x51d33e,'prompt':_0x1328c3});}else await this[_0x422447(0x2d6)]({'id':_0x3db909,'messageId':_0x5a8400,'messageFlags':_0x42714d,'extend':JSON[_0x422447(0x20d)]({'components':_0x8613b6,'attachments':_0x2d2c58})||'','jobId':_0x5e8938,'action':_0x436ff1[_0x422447(0x209)],'createdAt':_0x436ff1[_0x422447(0x1e7)],'progress':_0x1d6b7f,'url':_0x32ab52||'','type':_0x355349,'mode':_0x51d33e,'prompt':_0x7a34cd[_0x422447(0x272)]||_0x436ff1[_0x422447(0x1a4)]});}if(_0x355349===_0x422447(0x31b)){const {components:_0x495749,id:_0x2789bb,custom_id:_0x156465}=_0x7a34cd;await this['handleSubmitRemix']({'mode':_0x51d33e,'components':_0x495749,'customId':_0x156465,'id':_0x2789bb,'action':_0x436ff1[_0x422447(0x209)],'jobId':_0x5e8938,'drawId':_0x3db909,'createdAt':_0x436ff1[_0x422447(0x1e7)]});}}});});}return!![];}async[_0x176999(0x2d6)](_0x20173d){const _0x33938f=_0x176999,{jobId:_0x3aeab8,durationSpent:_0x1e909c,action:_0x3ca905,messageId:_0x278eaa,messageFlags:_0x4982f8,id:_0x1dad48,type:_0x52bb00,extend:_0x205800,createdAt:_0x2e55af,progress:_0x2737e2,url:_0x3f405f,prompt:_0x5f1063,mode:_0x5d290d}=_0x20173d;let _0x2b17c8='';if(_0x3f405f){const _0x51c8d1=await this[_0x33938f(0x2ad)][_0x33938f(0x1c8)]([_0x33938f(0x205)]);_0x2b17c8=_0x51c8d1+_0x33938f(0x1eb)+_0x3f405f;}return this['redisCacheService']['set']({'key':_0x3aeab8,'val':JSON['stringify']({'durationSpent':_0x1e909c,'messageId':_0x278eaa,'messageFlags':_0x4982f8,'id':_0x1dad48,'action':_0x3ca905,'extend':_0x205800,'progress':_0x2737e2,'createdAt':_0x2e55af,'status':_0x2737e2<0x64?midjourney_constant_1[_0x33938f(0x291)][_0x33938f(0x16b)]:midjourney_constant_1[_0x33938f(0x291)]['DRAWED'],'prompt':_0x5f1063,'mode':_0x5d290d,'type':_0x52bb00,'cosUrl':_0x2b17c8})},0x5*0x3c*0x3e8);}async['handleGetRegionInfo'](_0x1c57af){const {messageId:_0x55f6dd,customId:_0x39bdf7,messageFlags:_0xd218b3,mode:_0x53a6c3}=_0x1c57af;return new Promise(async _0x126242=>{const _0x314cf3=_0x3a13,{guild_id:_0x234074,channel_id:_0x5d4434,authorization:_0x4ea270,mjProxyUrl:_0x457016,mjProxy:_0xf5216a}=await this['getMjDefaultParams'](_0x53a6c3)[_0x314cf3(0x2b8)](_0x300026=>{const _0x25f145=_0x314cf3;return Promise[_0x25f145(0x16a)](_0x300026);});if(_0xf5216a==0x0)await this[_0x314cf3(0x310)](_0x53a6c3),await this[_0x314cf3(0x2dd)]({'messageId':_0x55f6dd,'customId':_0x39bdf7,'messageFlags':_0xd218b3,'mode':_0x53a6c3},async(_0x5ee9c5,_0x4dc98b)=>{if(_0x5ee9c5==='INTERACTION_IFRAME_MODAL_CREATE'){const {custom_id:_0x4715e4,id:_0x5a19f7,nonce:_0x17d83e,varyRegionImgBase64:_0x2b8776,varyRegionPrompt:_0x5ed90a}=_0x4dc98b;_0x126242({'customId':_0x4715e4,'messageId':_0x5a19f7,'nonce':_0x17d83e,'varyRegionImgBase64':_0x2b8776,'varyRegionPrompt':_0x5ed90a});}})[_0x314cf3(0x2b8)](_0x515c01=>{const _0x22bae4=_0x314cf3;common_1[_0x22bae4(0x150)][_0x22bae4(0x278)](_0x515c01);});else{const _0x1ed124=await this[_0x314cf3(0x211)]({'messageId':_0x55f6dd,'customId':_0x39bdf7,'messageFlags':_0xd218b3,'guild_id':_0x234074,'channel_id':_0x5d4434,'authorization':_0x4ea270,'mjProxyUrl':_0x457016});_0x126242(_0x1ed124);}});}async[_0x176999(0x1f5)](_0x4ce102){const _0x5ea9fd=_0x176999;try{const _0x51f83f=await this[_0x5ea9fd(0x161)][_0x5ea9fd(0x30c)]({'where':{'jobId':_0x4ce102}});if(!_0x51f83f)throw new Error(_0x5ea9fd(0x31c));const _0x562aeb=await this[_0x5ea9fd(0x1a8)][_0x5ea9fd(0x1f5)]({},_0x51f83f['mjpTaskId']);if(_0x562aeb[_0x5ea9fd(0x346)]!==0x1)throw new Error(_0x562aeb['description']);return _0x562aeb[_0x5ea9fd(0x327)];}catch(_0x25878a){throw new common_1[(_0x5ea9fd(0x2f7))](_0x25878a[_0x5ea9fd(0x339)],common_1[_0x5ea9fd(0x348)][_0x5ea9fd(0x1b9)]);}}async[_0x176999(0x211)](_0x2dd79c){const _0x318f85=_0x176999,{messageId:_0x5eeb60,customId:_0x581cc2,messageFlags:_0x332cc1,guild_id:_0x3d783d,channel_id:_0x1bc09a,authorization:_0x171807,mjProxyUrl:_0x1fa42a}=_0x2dd79c;return axios_1[_0x318f85(0x15f)][_0x318f85(0x138)](_0x1fa42a+_0x318f85(0x15b),{'message_id':_0x5eeb60,'custom_id':_0x581cc2,'flags':_0x332cc1,'guild_id':_0x3d783d,'channel_id':_0x1bc09a,'token':_0x171807})[_0x318f85(0x229)](_0x4ae200=>_0x4ae200[_0x318f85(0x32f)]);}async[_0x176999(0x1a1)](_0x33c6d1){const _0x23506d=_0x176999,{mode:_0x361ea9,id:_0x515da7,customId:_0x415728,createdAt:_0x32926f,jobId:_0x5e18c6,drawId:_0x16bffe,action:_0x4f20b0,components:_0x278591}=_0x33c6d1;await this[_0x23506d(0x310)](_0x361ea9);const _0x5272bb=await this[_0x23506d(0x2fc)][_0x361ea9][_0x23506d(0x246)][_0x23506d(0x23c)](_0x515da7,_0x415728,_0x278591,(_0x23007e,_0x5e580e)=>{const _0x528c01=_0x23506d;if(_0x23007e==='MESSAGE_UPDATE'){const {progress:_0x4c1ef3,content:_0x3ff270,url:_0xbad154,id:_0x2ae9ae,flags:_0x5a7a57,components:_0x242c53}=_0x5e580e;this[_0x528c01(0x2d6)]({'messageId':_0x2ae9ae,'messageFlags':_0x5a7a57,'id':_0x16bffe,'extend':JSON['stringify']({'components':_0x242c53})||'','jobId':_0x5e18c6,'createdAt':_0x32926f,'progress':_0x4c1ef3,'action':_0x4f20b0,'url':_0xbad154,'type':_0x23007e,'mode':_0x361ea9,'prompt':_0x3ff270});}});console[_0x23506d(0x260)]('finally\x20remixSubmit',_0x5272bb);const _0x339377=(new Date(_0x5272bb['timestamp'])['getTime']()-new Date(_0x32926f)[_0x23506d(0x2cd)]())/0x3e8,{url:_0x1a000f,progress:_0x2d17eb,components:_0x19a0c7,attachments:_0x546311}=_0x5272bb;await this[_0x23506d(0x289)](_0x5e18c6,{..._0x5272bb,'components':_0x19a0c7,'action':_0x4f20b0,'attachments':_0x546311[0x0]||{},'prompt':_0x5272bb['content'],'messageFlags':_0x5272bb[_0x23506d(0x191)],'messageId':_0x5272bb['id'],'url':_0x1a000f,'progress':_0x2d17eb,'durationSpent':_0x339377}),await this[_0x23506d(0x2d6)]({'jobId':_0x5e18c6,'messageId':_0x5272bb['id'],'messageFlags':_0x5272bb[_0x23506d(0x191)],'id':_0x16bffe,'durationSpent':_0x339377,'createdAt':_0x32926f,'extend':JSON[_0x23506d(0x20d)]({'components':_0x19a0c7,'attachments':_0x546311[0x0]||{}})||'','url':_0x1a000f,'action':_0x4f20b0,'progress':_0x2d17eb,'type':_0x23506d(0x2f6),'mode':_0x361ea9,'prompt':_0x5272bb['content']});}async[_0x176999(0x289)](_0x583a05,_0x3ed990){const _0x4cabfc=_0x176999;try{const {url:_0x3a9420,messageId:_0x1f494b,action:_0x4bb3fa,components:_0x513150,messageFlags:_0x54d378,prompt:prompt='',attachments:_0x3c54b2,durationSpent:_0x5dd8a5,progress:_0x5b91dd}=_0x3ed990;console['log'](_0x4cabfc(0x27d),_0x5b91dd);const {width:width=0x0,height:height=0x0}=_0x3c54b2,_0x35a3a4=await this[_0x4cabfc(0x2ad)]['getConfigs']([_0x4cabfc(0x1ff)]);common_1[_0x4cabfc(0x150)][_0x4cabfc(0x260)](_0x4cabfc(0x319),_0x35a3a4);let _0x6fb34b='';const _0x399da5=Date['now']();if(!Number(_0x35a3a4)||Number(_0x35a3a4)===0x0){common_1[_0x4cabfc(0x150)][_0x4cabfc(0x260)](_0x4cabfc(0x215),_0x4cabfc(0x1e6));const _0x5e660d=new Date();_0x6fb34b=await this[_0x4cabfc(0x23e)][_0x4cabfc(0x2b5)]({'filename':_0x399da5,'url':_0x3a9420}),console[_0x4cabfc(0x260)](_0x4cabfc(0x1bb),_0x6fb34b);const _0x1bf450=new Date();common_1['Logger']['log'](_0x4cabfc(0x1da)+(_0x1bf450['getTime']()-_0x5e660d[_0x4cabfc(0x2cd)]())/0x3e8+'秒','MidjourneyService');}else{const _0x4649f3=await this['globalConfigService'][_0x4cabfc(0x1c8)]([_0x4cabfc(0x205)]);_0x6fb34b=_0x4649f3+'/api/pipe?url='+_0x3a9420,common_1[_0x4cabfc(0x150)][_0x4cabfc(0x260)](_0x4cabfc(0x265));}const _0x18f51b=await this[_0x4cabfc(0x23e)]['getUploadType'](),_0x29fab7={'prompt':prompt,'messageId':_0x1f494b,'messageFlags':_0x54d378,'status':midjourney_constant_1[_0x4cabfc(0x291)][_0x4cabfc(0x316)],'progress':_0x5b91dd,'action':_0x4bb3fa,'fileInfo':JSON[_0x4cabfc(0x20d)]({'filename':_0x399da5,'cosUrl':_0x6fb34b,'width':width,'height':height,'cosType':_0x18f51b}),'extend':JSON[_0x4cabfc(0x20d)]({'attachments':_0x3c54b2,'components':_0x513150,'url':_0x3a9420}),'durationSpent':_0x5dd8a5||0x0,'isSaveImg':!Number(_0x35a3a4)||Number(_0x35a3a4)===0x0};console['log'](_0x4cabfc(0x1ee),_0x29fab7),await this['midjourneyEntity'][_0x4cabfc(0x28f)]({'jobId':_0x583a05},_0x29fab7)['then'](_0x268e74=>_0x268e74[_0x4cabfc(0x16e)]>0x0)[_0x4cabfc(0x2b8)](_0x54406e=>{throw new Error(_0x54406e);});}catch(_0x4c2a2f){console[_0x4cabfc(0x260)](_0x4cabfc(0x239),_0x583a05,_0x4c2a2f);}}[_0x176999(0x26f)](_0x343fb4,_0x1e8c51,_0x3d488c,_0x5b9f9c){const _0x455e0f=_0x176999;if(!_0x343fb4)return{};const _0x579941=JSON[_0x455e0f(0x28d)](_0x343fb4),{cosUrl:_0xe281a6,width:_0x45a5b7,height:_0x54e055,cosType:_0x5223e9}=_0x579941,_0x16ca52=0x136,_0x20a653=_0x5223e9||(_0xe281a6[_0x455e0f(0x31f)]('cos')?_0x455e0f(0x183):_0xe281a6[_0x455e0f(0x31f)](_0x455e0f(0x290))?_0x455e0f(0x280):'chevereto');let _0x5ba613;if(_0x20a653===_0x455e0f(0x183)){const _0x206016=_0x45a5b7/_0x54e055,_0x1472f9=Math[_0x455e0f(0x2c6)](_0x16ca52/_0x206016);_0x5ba613=_0xe281a6+(_0x455e0f(0x22b)+_0x16ca52+_0x455e0f(0x195)+_0x1472f9+_0x455e0f(0x24f));}if(_0x20a653===_0x455e0f(0x280)){const _0x26354b=_0x54e055/_0x45a5b7,_0x3327c4=Math[_0x455e0f(0x2c6)](_0x16ca52/_0x26354b);_0x5ba613=_0xe281a6+(_0x455e0f(0x235)+_0x3327c4);}_0x20a653===_0x455e0f(0x2ed)&&(_0x5ba613=_0xe281a6[_0x455e0f(0x24c)](/\.png$/,'.md.png'));_0x579941[_0x455e0f(0x297)]=_0x5ba613;if(!_0x1e8c51){const _0x1f7398=_0x3d488c+'/api/pipe?url='+_0x5b9f9c;_0x579941[_0x455e0f(0x297)]=_0x1f7398,_0x579941[_0x455e0f(0x1e0)]=_0x1f7398;}return _0x579941;}['isVaryImage'](_0x109792){const _0x5d429c=_0x176999,_0x1987bd=/- Variations \(.*?\)/;return _0x1987bd[_0x5d429c(0x336)](_0x109792);}async['hasAccount'](){const _0x574f88=_0x176999;return await this['mjParamEntity']['count']({'where':{'enable':0x1,'mode':(0x0,typeorm_2['In'])([midjourney_constant_1['DrawSpeed'][_0x574f88(0x244)],midjourney_constant_1[_0x574f88(0x163)][_0x574f88(0x2cc)],midjourney_constant_1[_0x574f88(0x163)][_0x574f88(0x1a3)]])}})[_0x574f88(0x229)](_0x5d946d=>_0x5d946d>0x0)[_0x574f88(0x2b8)](_0x359016=>{const _0x2ece77=_0x574f88;return common_1['Logger'][_0x2ece77(0x278)](_0x359016),![];});}async[_0x176999(0x1d0)](_0x592dc1=midjourney_constant_1['DrawSpeed'][_0x176999(0x244)]){const _0x567535=_0x176999,_0xc3b742=await this[_0x567535(0x33b)][_0x567535(0x34c)]({'where':{'enable':0x1,'mode':_0x592dc1},'order':{'weight':_0x567535(0x1e2)}});if(!_0xc3b742['length'])return Promise[_0x567535(0x16a)]('未指定'+(_0x592dc1===midjourney_constant_1[_0x567535(0x163)][_0x567535(0x244)]?'快速':_0x592dc1===midjourney_constant_1['DrawSpeed'][_0x567535(0x2cc)]?'休闲':'turbo')+'模式账号，请前往后台配置！');return(0x0,utils_1[_0x567535(0x144)])(_0xc3b742);}async[_0x176999(0x2d3)](_0x5e5b0a){const _0x214e66=_0x176999;if(MjConfig_1[_0x214e66(0x15f)][_0x214e66(0x285)]!=='mjProxy')return new mjParam_entity_1[(_0x214e66(0x2f0))]();const _0x71dc2c=await this[_0x214e66(0x33b)]['find']({'where':{'enable':0x1,'mode':_0x5e5b0a,'fastRemainTime':(0x0,typeorm_2[_0x214e66(0x22f)])((0x0,typeorm_2[_0x214e66(0x147)])())},'order':{'weight':_0x214e66(0x1e2)}});if(!_0x71dc2c['length'])throw new Error(_0x214e66(0x167));return _0x71dc2c[0x0];}async[_0x176999(0x251)](_0xe2b68c){const _0x2dc027=_0x176999,{proxyUrl:_0x575ba4}=_0xe2b68c,_0xbaec91=await this[_0x2dc027(0x2ad)]['getConfigs']([_0x2dc027(0x317)]);return _0x575ba4||_0xbaec91||'https://api.openai.com';}async[_0x176999(0x17d)](_0x4a3a6e){const _0x4035fb=_0x176999;try{const {guildId:_0x5d3dfb,account:_0x206165,authorization:_0x2e7b03,mode:_0x51a993,timeout:_0x5f21c0,channelId:_0x365575,remark:_0x5a65b7,mjBotChannelId:_0xa3785d,nijiBotChannelId:_0x252bb7}=_0x4a3a6e;var _0x5c15f3=await this[_0x4035fb(0x16c)]['create']({'data':{'channelId':_0x365575,'coreSize':0x3,'guildId':_0x5d3dfb,'mjBotChannelId':_0xa3785d||'','nijiBotChannelId':_0x252bb7||'','queueSize':0xa,'remark':_0x5a65b7,'remixAutoSubmit':![],'timeoutMinutes':_0x5f21c0,'userAgent':'Mozilla/5.0\x20(Macintosh;\x20Intel\x20Mac\x20OS\x20X\x2010_15_7)\x20AppleWebKit/537.36\x20(KHTML,\x20like\x20Gecko)\x20Chrome/112.0.0.0\x20Safari/537.36','userToken':_0x2e7b03}});if(_0x5c15f3[_0x4035fb(0x346)]!==0x1)throw new Error(_0x5c15f3['description']);const _0x27c2f9=await this[_0x4035fb(0x33b)][_0x4035fb(0x1f1)]({'account':_0x206165,'authorization':_0x2e7b03,'mode':_0x51a993,'timeout':_0x5f21c0,'channelId':_0x365575,'guildId':_0x5d3dfb,'remark':_0x5a65b7,'mjpId':_0x5c15f3['result'],'mjBotChannelId':_0xa3785d||'','nijiBotChannelId':_0x252bb7||''});return await this['syncMjpAccount'](_0x5c15f3['result']),!!_0x27c2f9;}catch(_0x42dd01){common_1[_0x4035fb(0x150)]['error'](_0x42dd01);throw new common_1[(_0x4035fb(0x2f7))](_0x42dd01[_0x4035fb(0x339)],common_1['HttpStatus'][_0x4035fb(0x1b9)]);}}async[_0x176999(0x2c8)](_0x3a62ca){const _0x3a7e47=_0x176999,{id:_0x36640b,account:_0x56b37a,authorization:_0x3a3927,mode:_0x8e5702,guildId:_0x522ad3,remark:_0x20324b,channelId:_0xe27c4e,timeout:_0x5f2c0f,enable:_0x24c728,mjBotChannelId:_0x12f273,nijiBotChannelId:_0x175f18}=_0x3a62ca;try{const _0xa1283c=await this[_0x3a7e47(0x33b)][_0x3a7e47(0x1d1)]({'id':Number(_0x36640b)});var _0xd63892=await this[_0x3a7e47(0x16c)][_0x3a7e47(0x296)]({'data':{'channelId':_0xe27c4e,'coreSize':0x3,'guildId':_0x522ad3,'mjBotChannelId':_0x12f273||'','nijiBotChannelId':_0x175f18||'','queueSize':0xa,'remark':_0x20324b,'remixAutoSubmit':![],'timeoutMinutes':_0x5f2c0f,'userAgent':'Mozilla/5.0\x20(Macintosh;\x20Intel\x20Mac\x20OS\x20X\x2010_15_7)\x20AppleWebKit/537.36\x20(KHTML,\x20like\x20Gecko)\x20Chrome/112.0.0.0\x20Safari/537.36','userToken':_0x3a3927,'enable':Boolean(_0x24c728)}},_0xa1283c[_0x3a7e47(0x271)]);if(_0xd63892[_0x3a7e47(0x346)]!==0x1)throw new Error(_0xd63892[_0x3a7e47(0x29c)]);return await this['mjParamEntity'][_0x3a7e47(0x28f)](_0x36640b,{'account':_0x56b37a,'authorization':_0x3a3927,'mode':_0x8e5702,'guildId':_0x522ad3,'remark':_0x20324b,'channelId':_0xe27c4e,'timeout':_0x5f2c0f,'mjBotChannelId':_0x12f273||'','nijiBotChannelId':_0x175f18||''});}catch(_0x3f630e){common_1[_0x3a7e47(0x150)]['error'](_0x3f630e);throw new common_1['HttpException'](_0x3f630e[_0x3a7e47(0x339)],common_1[_0x3a7e47(0x348)][_0x3a7e47(0x1b9)]);}}async[_0x176999(0x32c)](_0x5cd12a,_0x57f3ae){const _0x33ecac=_0x176999;_0x5cd12a['mjVersion']=_0x57f3ae[_0x33ecac(0x213)];if(_0x57f3ae['mode']==='FAST')_0x5cd12a[_0x33ecac(0x2a9)]=midjourney_constant_1['DrawSpeed']['fast'];else{if(_0x57f3ae[_0x33ecac(0x2a9)]==='RELAX')_0x5cd12a[_0x33ecac(0x2a9)]=midjourney_constant_1['DrawSpeed'][_0x33ecac(0x2cc)];else _0x57f3ae[_0x33ecac(0x2a9)]===_0x33ecac(0x200)&&(_0x5cd12a['mode']=midjourney_constant_1[_0x33ecac(0x163)][_0x33ecac(0x1a3)]);}_0x5cd12a[_0x33ecac(0x231)]=_0x57f3ae[_0x33ecac(0x154)],_0x5cd12a[_0x33ecac(0x258)]=_0x57f3ae['fastTimeRemaining'],_0x5cd12a[_0x33ecac(0x294)]=_0x57f3ae[_0x33ecac(0x294)],_0x5cd12a['relaxedUsage']=_0x57f3ae[_0x33ecac(0x2c1)],_0x5cd12a[_0x33ecac(0x19f)]=Number(_0x57f3ae[_0x33ecac(0x19f)]);if(_0x57f3ae[_0x33ecac(0x286)]===_0x33ecac(0x1bd))_0x5cd12a[_0x33ecac(0x2f8)]=0x1;else{if(_0x57f3ae[_0x33ecac(0x286)]==='STANDARD')_0x5cd12a[_0x33ecac(0x2f8)]=0x2;else{if(_0x57f3ae[_0x33ecac(0x286)]===_0x33ecac(0x14d))_0x5cd12a['orderPlan']=0x3;else _0x57f3ae[_0x33ecac(0x286)]===_0x33ecac(0x199)&&(_0x5cd12a[_0x33ecac(0x2f8)]=0x4);}}_0x5cd12a[_0x33ecac(0x320)]=_0x57f3ae[_0x33ecac(0x320)],_0x5cd12a['timeout']=_0x57f3ae[_0x33ecac(0x2c5)],_0x5cd12a[_0x33ecac(0x321)]=JSON[_0x33ecac(0x20d)](_0x57f3ae['buttons']),_0x5cd12a['info']=JSON[_0x33ecac(0x20d)](_0x57f3ae[_0x33ecac(0x1ec)]),await this['mjParamEntity'][_0x33ecac(0x1f1)](_0x5cd12a);}async['syncMjpAccount'](_0x4d62b8){const _0x56f253=_0x176999;try{if(MjConfig_1[_0x56f253(0x15f)][_0x56f253(0x285)]!==_0x56f253(0x2a7))return;const _0x97cbb9=await this[_0x56f253(0x16c)][_0x56f253(0x186)]({},_0x4d62b8);if(!_0x97cbb9)return;const _0x4feb51=await this[_0x56f253(0x33b)][_0x56f253(0x30c)]({'where':{'mjpId':_0x4d62b8}});await this['copyAccountInfo'](_0x4feb51,_0x97cbb9);}catch(_0x50946c){common_1[_0x56f253(0x150)][_0x56f253(0x278)]('自动同步账号信息失败：',_0x50946c);}}async[_0x176999(0x1dd)](){const _0x145cce=_0x176999,_0x40e9b8=await this[_0x145cce(0x33b)][_0x145cce(0x34c)]();if(!_0x40e9b8[_0x145cce(0x1f6)])return;for(let _0x3e1c61=0x0;_0x3e1c61<_0x40e9b8[_0x145cce(0x1f6)];_0x3e1c61++){this[_0x145cce(0x141)](_0x40e9b8[_0x3e1c61][_0x145cce(0x271)]);}}async[_0x176999(0x2ce)]({id:_0x406452}){const _0x21ca00=_0x176999;try{const _0x282648=await this[_0x21ca00(0x33b)][_0x21ca00(0x1d1)]({'id':Number(_0x406452)}),_0x35e7db=await this[_0x21ca00(0x16c)][_0x21ca00(0x309)]({},_0x282648[_0x21ca00(0x271)]);if(_0x35e7db[_0x21ca00(0x346)]!==0x1)throw new Error(_0x35e7db[_0x21ca00(0x29c)]);await this[_0x21ca00(0x32c)](_0x282648,_0x35e7db['result']);}catch(_0x1b7b24){throw new common_1[(_0x21ca00(0x2f7))](_0x1b7b24['message'],common_1[_0x21ca00(0x348)][_0x21ca00(0x1b9)]);}}async['changeVersion'](_0x5df803){const _0x269307=_0x176999;try{const _0xbf9f47=await this[_0x269307(0x33b)][_0x269307(0x1d1)]({'id':Number(_0x5df803['id'])}),_0x41171a=await this['mjpAccountService'][_0x269307(0x33f)]({'data':_0x5df803},_0xbf9f47[_0x269307(0x271)]);if(_0x41171a[_0x269307(0x346)]!==0x1)throw new Error(_0x41171a[_0x269307(0x29c)]);return _0xbf9f47[_0x269307(0x347)]=_0x5df803['version'],await this['mjParamEntity'][_0x269307(0x1f1)](_0xbf9f47),!![];}catch(_0x21da1d){throw new common_1['HttpException'](_0x21da1d[_0x269307(0x339)],common_1['HttpStatus'][_0x269307(0x1b9)]);}}async['action'](_0x422b87){const _0x59fef8=_0x176999;try{const _0x4eb2d6=await this[_0x59fef8(0x33b)][_0x59fef8(0x1d1)]({'id':Number(_0x422b87['id'])}),_0x3cbfad=await this[_0x59fef8(0x16c)][_0x59fef8(0x209)]({'data':_0x422b87},_0x4eb2d6[_0x59fef8(0x271)]);if(_0x3cbfad[_0x59fef8(0x346)]!==0x1)throw new Error(_0x3cbfad[_0x59fef8(0x29c)]);return!![];}catch(_0x59f0bd){throw new common_1[(_0x59fef8(0x2f7))](_0x59f0bd[_0x59fef8(0x339)],common_1[_0x59fef8(0x348)]['BAD_REQUEST']);}}async[_0x176999(0x2a4)](_0x546e16){const _0x35f4b0=_0x176999,{id:_0x5e3865}=_0x546e16;try{const _0x1e6677=await this[_0x35f4b0(0x33b)][_0x35f4b0(0x30c)]({'where':{'id':Number(_0x5e3865)}});if(!_0x1e6677)throw new Error(_0x35f4b0(0x30f));common_1[_0x35f4b0(0x150)][_0x35f4b0(0x278)](_0x35f4b0(0x34a),_0x1e6677[_0x35f4b0(0x271)]);const _0x7c872=await this[_0x35f4b0(0x16c)][_0x35f4b0(0x225)]({},_0x1e6677['mjpId']);if(_0x7c872['code']!==0x1)throw new Error(_0x7c872[_0x35f4b0(0x29c)]);const _0x49e8eb=await this[_0x35f4b0(0x33b)]['delete']({'id':_0x5e3865});return _0x49e8eb[_0x35f4b0(0x16e)];}catch(_0x4f7c90){throw new common_1['HttpException'](_0x4f7c90[_0x35f4b0(0x339)],common_1[_0x35f4b0(0x348)][_0x35f4b0(0x1b9)]);}}async['syncMjAccount'](_0x4c2dea){const _0x1bfbec=_0x176999,{id:_0x8188a6}=_0x4c2dea,_0x3afac4=await this['mjParamEntity'][_0x1bfbec(0x30c)]({'where':{'id':_0x8188a6}});if(!_0x3afac4)throw new common_1[(_0x1bfbec(0x2f7))]('账号信息配置不存在！',common_1[_0x1bfbec(0x348)][_0x1bfbec(0x1b9)]);try{return await this['syncInfo'](_0x3afac4)[_0x1bfbec(0x2b8)](_0x39775b=>{const _0x3af032=_0x1bfbec;console[_0x3af032(0x260)](_0x39775b);});}catch(_0x3c2199){throw new common_1['HttpException']('同步信息失败！',common_1['HttpStatus'][_0x1bfbec(0x1b9)]);}}async[_0x176999(0x136)](_0x449e73){const _0x8a9299=_0x176999,{channelId:_0x2a3b3a,guildId:_0x214373,authorization:_0x45bce4,proxy:_0x586731}=_0x449e73;return await axios_1[_0x8a9299(0x15f)]['post'](_0x586731+_0x8a9299(0x242),{'token':_0x45bce4,'channel_id':_0x2a3b3a,'guild_id':_0x214373})[_0x8a9299(0x229)](_0x44bd82=>_0x44bd82['data']);}async[_0x176999(0x309)](_0xbe3f35,_0x192f18=![]){const _0x3bc376=_0x176999,{mjProxy:_0x405c4f,mjProxyUrl:_0x30e2c2,mjSocketProxyUrl:_0x221740}=await this['globalConfigService'][_0x3bc376(0x1c8)]([_0x3bc376(0x2a7),_0x3bc376(0x2d7),'mjSocketProxyUrl']),{channelId:_0x110c43,guildId:_0x336d15,authorization:_0x3ea015}=_0xbe3f35;let _0xe77448;_0x405c4f==0x0?_0xe77448=await this['getSyncAccountInfo'](_0xbe3f35):(_0xe77448=await this[_0x3bc376(0x136)]({'channelId':_0x110c43,'guildId':_0x336d15,'authorization':_0x3ea015,'proxy':_0x30e2c2}),console[_0x3bc376(0x260)](_0xe77448));const {settingInfo:_0x436282,info:_0x300964,subscription:_0x42cd85,fastRemainTime:_0x5f41af,lifetimeUsage:_0x494154,relaxedUsage:_0x5974ff,orderPlan:_0x354396}=_0xe77448,_0x24b2cc=await this['mjParamEntity'][_0x3bc376(0x28f)](_0xbe3f35['id'],{'remix':_0x436282[_0x3bc376(0x1de)][0x1][_0x3bc376(0x1de)][0x1][_0x3bc376(0x169)]===0x3?0x1:0x0,'setting':JSON[_0x3bc376(0x20d)](_0x436282),'fastRemainTime':_0x5f41af[_0x3bc376(0x2a1)](),'info':_0x300964,'renewDate':_0x42cd85[_0x3bc376(0x2a1)](),'orderPlan':_0x354396,'lifetimeUsage':_0x494154['trim'](),'relaxedUsage':_0x5974ff[_0x3bc376(0x2a1)]()})[_0x3bc376(0x229)](_0x11597e=>_0x11597e[_0x3bc376(0x16e)]>0x0)[_0x3bc376(0x2b8)](_0x160292=>{throw _0x160292;});if(_0x192f18){const _0xc658db=_0x436282[_0x3bc376(0x1de)];return _0xc658db[0x1][_0x3bc376(0x1de)][0x1]['style']===0x3;}else return _0x24b2cc;}async[_0x176999(0x212)](_0x5a5b3c){return new Promise(async _0x59f24a=>{const _0x376267=_0x3a13;await this['midJourney'][_0x5a5b3c][_0x376267(0x246)][_0x376267(0x156)]((_0x5cb43f,_0x5b8908)=>{const _0x4e9bea=_0x376267;_0x5cb43f===_0x4e9bea(0x1cd)&&_0x59f24a(_0x5b8908);});});}async['getSettingInfo'](_0x50f0d2){return new Promise(async _0x5eb6ce=>{const _0x1d90c8=_0x3a13;await this[_0x1d90c8(0x2fc)][_0x50f0d2][_0x1d90c8(0x246)][_0x1d90c8(0x13c)]((_0x5ecfa2,_0x1b9f6a)=>{const _0xe8986b=_0x1d90c8;_0x5ecfa2===_0xe8986b(0x1cd)&&_0x5eb6ce(_0x1b9f6a);});});}async['setMjAccountEnable'](_0x3dced0){const _0x36963b=_0x176999,{id:_0x29b622,enable:_0x40f455}=_0x3dced0;return await this[_0x36963b(0x33b)][_0x36963b(0x28f)](_0x29b622,{'enable':_0x40f455})[_0x36963b(0x229)](_0xa436d7=>_0xa436d7['affected']>0x0);}async[_0x176999(0x2f4)](_0x2f5ca8,_0x30972c){const _0x519640=_0x176999,_0x4e53f7=_0x30972c[_0x519640(0x158)][_0x519640(0x1e4)],_0x6187c6=_0x4e53f7===_0x519640(0x2bc),{id:_0x22b96b}=_0x2f5ca8;let _0x9e0528=null;try{const _0x4c405e=await this[_0x519640(0x33b)][_0x519640(0x30c)]({'where':{'id':_0x22b96b}});return _0x6187c6&&(_0x9e0528=await this[_0x519640(0x16c)]['fetch']({},_0x4c405e[_0x519640(0x271)])),{..._0x4c405e,'mjpAccountInfo':_0x9e0528,'authorization':_0x6187c6?_0x4c405e[_0x519640(0x31d)]:(0x0,utils_1['hideString'])(_0x4c405e[_0x519640(0x31d)]),'guildId':_0x6187c6?_0x4c405e[_0x519640(0x151)]:(0x0,utils_1['hideString'])(_0x4c405e['guildId']),'channelId':_0x6187c6?_0x4c405e[_0x519640(0x14f)]:(0x0,utils_1[_0x519640(0x2e4)])(_0x4c405e[_0x519640(0x14f)])};}catch(_0x11ea89){throw new common_1[(_0x519640(0x2f7))](_0x11ea89,common_1[_0x519640(0x348)]['BAD_REQUEST']);}}async['queryMjAccountList'](_0xe5e92e,_0x154ad4){const _0x1f3a91=_0x176999,_0x844667=_0x154ad4[_0x1f3a91(0x158)][_0x1f3a91(0x1e4)],{page:page=0x1,size:size=0x14,account:_0x36d342,channelId:_0x265799,enable:_0x47b2d8}=_0xe5e92e;if(!page||!size)throw new common_1[(_0x1f3a91(0x2f7))](_0x1f3a91(0x218),common_1[_0x1f3a91(0x348)][_0x1f3a91(0x1b9)]);const _0x109372={};_0x36d342&&Object[_0x1f3a91(0x1ef)](_0x109372,{'account':(0x0,typeorm_2[_0x1f3a91(0x30e)])('%'+_0x36d342+'%')}),_0x265799&&Object['assign'](_0x109372,{'channelId':(0x0,typeorm_2[_0x1f3a91(0x30e)])('%'+_0x265799+'%')}),_0x47b2d8>0x0&&Object[_0x1f3a91(0x1ef)](_0x109372,{'enable':_0x47b2d8});const [_0x3dec60,_0x351c79]=await this[_0x1f3a91(0x33b)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x109372,'take':size,'order':{'createdAt':_0x1f3a91(0x1e2)},'cache':!![],'select':['id','guildId',_0x1f3a91(0x14f),_0x1f3a91(0x31d),_0x1f3a91(0x245),'weight',_0x1f3a91(0x350),_0x1f3a91(0x231),_0x1f3a91(0x2f8),_0x1f3a91(0x320),_0x1f3a91(0x1e7),'mode']});return{'rows':_0x844667===_0x1f3a91(0x2bc)?_0x3dec60:_0x3dec60[_0x1f3a91(0x288)](_0x1f6756=>({..._0x1f6756,'authorization':(0x0,utils_1[_0x1f3a91(0x2e4)])(_0x1f6756[_0x1f3a91(0x31d)]),'guildId':(0x0,utils_1[_0x1f3a91(0x2e4)])(_0x1f6756['guildId']),'channelId':(0x0,utils_1[_0x1f3a91(0x2e4)])(_0x1f6756[_0x1f3a91(0x14f)])}))||[],'count':_0x351c79||0x0};}async['setAttachment'](_0x1ad47d){const _0x63090=_0x176999,{authorization:_0x3439f9,channel_id:_0x1adc2b}=_0x1ad47d,_0x11b06c=_0x63090(0x2f3)+_0x1adc2b+_0x63090(0x13b),_0x470fbc={'Content-Type':_0x63090(0x1f2),'authorization':_0x3439f9};try{return await axios_1[_0x63090(0x15f)][_0x63090(0x138)](_0x11b06c,{'files':_0x1ad47d['files']},{'headers':_0x470fbc});}catch(_0x3a7ddc){console[_0x63090(0x260)](_0x63090(0x1b0),_0x3a7ddc);throw new common_1[(_0x63090(0x2f7))](_0x63090(0x17e),common_1[_0x63090(0x348)][_0x63090(0x1b9)]);}}async[_0x176999(0x157)](_0xdada89){const _0x3c3053=_0x176999,{proxy:_0x5e6db1,needImage:_0x5f33c7,file:_0x3b656a,authorization:_0x427271,channel_id:_0xd1daeb}=_0xdada89,_0x4c35ce={'authorization':_0x427271,'needImage':_0x5f33c7,'channel_id':_0xd1daeb,'files':_0x3b656a[_0x3c3053(0x288)](_0x55e48c=>_0x55e48c[_0x3c3053(0x202)][_0x3c3053(0x2aa)](_0x3c3053(0x1a2)))};return await axios_1['default']['post'](_0x5e6db1+_0x3c3053(0x1f0),_0x4c35ce)['then'](_0x1a9edd=>_0x1a9edd[_0x3c3053(0x32f)])[_0x3c3053(0x2b8)](_0x5233c1=>Promise[_0x3c3053(0x16a)](_0x5233c1));}async[_0x176999(0x334)](_0x4ae956){const _0x1229ae=_0x176999,{buffer:_0x2e1c7d,channel_id:_0x444f4f,authorization:_0xcfbfb2,filename:_0x53f7dc,needImage:needImage=![]}=_0x4ae956,_0x56a1c2=_0x2e1c7d[_0x1229ae(0x1f6)],_0x11eb18=(0x0,createRandomId_1['createRandomId'])(),_0x52ea7b=await this[_0x1229ae(0x2d1)]({'authorization':_0xcfbfb2,'channel_id':_0x444f4f,'files':[{'filename':_0x53f7dc,'file_size':_0x56a1c2,'id':_0x11eb18}]});if(_0x52ea7b[_0x1229ae(0x25e)]!=0xc8)return Promise['reject'](_0x1229ae(0x17e));const _0x2bc51e=_0x52ea7b[_0x1229ae(0x32f)];if(_0x2bc51e['attachments']?.[_0x1229ae(0x1f6)]!=0x1)return Promise['reject'](_0x1229ae(0x2bf));const _0x8f3a9c=await axios_1[_0x1229ae(0x15f)][_0x1229ae(0x2ab)](_0x2bc51e[_0x1229ae(0x1ea)][0x0][_0x1229ae(0x139)],_0x2e1c7d,{'headers':{'Content-Type':'image/png'}})['catch'](_0x4bb436=>{const _0x3284b4=_0x1229ae;return Promise[_0x3284b4(0x16a)](_0x3284b4(0x17e)+_0x4bb436);});if(_0x8f3a9c&&_0x8f3a9c[_0x1229ae(0x25e)]!=0xc8&&_0x8f3a9c[_0x1229ae(0x25e)]!=0xc9)throw new common_1[(_0x1229ae(0x2f7))]('上传文件失败...,\x20\x20upload\x20fail',common_1[_0x1229ae(0x348)][_0x1229ae(0x1b9)]);const _0x23c79f=_0x2bc51e['attachments'][0x0][_0x1229ae(0x201)],_0x7df913=_0x23c79f[_0x1229ae(0x341)]('/'),_0x5514a0=_0x7df913[_0x1229ae(0x1f6)]>0x1?_0x7df913[0x1]:_0x7df913[0x0];if(needImage){const _0x5b3e12='https://discord.com/api/v9/channels/'+_0x444f4f+_0x1229ae(0x172),_0x3da5bb=await(0x0,axios_1[_0x1229ae(0x15f)])({'url':''+_0x5b3e12,'method':_0x1229ae(0x138),'headers':{'Authorization':''+_0xcfbfb2,'Content-Type':_0x1229ae(0x1f2)},'data':{'content':_0x5514a0,'channel_id':_0x444f4f,'type':0x0,'sticker_ids':[],'attachments':[{'id':0x0,'filename':_0x5514a0,'uploaded_filename':_0x23c79f}]}});if(_0x3da5bb[_0x1229ae(0x25e)]!==0xc8)throw new common_1['HttpException']('上传文件失败...,\x20upload\x20message\x20fail',common_1[_0x1229ae(0x348)][_0x1229ae(0x1b9)]);const _0x502d77=await _0x3da5bb[_0x1229ae(0x32f)];if(_0x502d77[_0x1229ae(0x1ea)]?.[_0x1229ae(0x1f6)]!=0x1)throw new common_1[(_0x1229ae(0x2f7))]('上传文件失败...,\x20\x20upload\x20message\x20fail',common_1['HttpStatus']['BAD_REQUEST']);return{'attachments':[{'id':_0x11eb18,'filename':_0x5514a0,'uploaded_filename':_0x23c79f}],'image':_0x502d77[_0x1229ae(0x1ea)][0x0]};}else return{'attachments':[{'id':_0x11eb18,'filename':_0x5514a0,'uploaded_filename':_0x23c79f}],'image':{'url':''}};}async[_0x176999(0x2bb)](_0x23d173,_0x588b22){const _0x438e4e=_0x176999;return await this[_0x438e4e(0x161)][_0x438e4e(0x28f)]({'jobId':_0x23d173},{'status':_0x588b22});}async[_0x176999(0x2a6)](_0xeaf9f1=midjourney_constant_1['DrawSpeed'][_0x176999(0x244)]){const _0x17562d=_0x176999;try{const _0x4e57be=await this[_0x17562d(0x1d0)](_0xeaf9f1)[_0x17562d(0x2b8)](_0x5ec9b8=>{throw _0x5ec9b8;}),_0x4de86a=await this[_0x17562d(0x2ad)][_0x17562d(0x1c8)]([_0x17562d(0x2a7),_0x17562d(0x2d7),_0x17562d(0x2cf)]);return{'guild_id':_0x4e57be[_0x17562d(0x151)],'channel_id':_0x4e57be[_0x17562d(0x14f)],'authorization':_0x4e57be['authorization'],'mjProxy':_0x4de86a[_0x17562d(0x2a7)],'mjProxyUrl':_0x4de86a[_0x17562d(0x2d7)],'mjSocketProxyUrl':_0x4de86a['mjSocketProxyUrl']};}catch(_0x3adde0){return Promise[_0x17562d(0x16a)](_0x3adde0);}}async[_0x176999(0x303)](_0x41f2f2,_0x188276){const _0xb80470=_0x176999;try{const _0x18c3d9=_0x41f2f2[_0xb80470(0x158)]['id'],{page:page=0x1,size:size=0x14,status:_0x60aa6c,rec:_0x5208e0,favorite:_0x4c897c}=_0x188276,_0x262e44={};_0x18c3d9&&Object[_0xb80470(0x1ef)](_0x262e44,{'userId':_0x18c3d9});Number(_0x4c897c)===0x1?Object[_0xb80470(0x1ef)](_0x262e44,{'favorite':Number(_0x4c897c)}):_0x60aa6c>0x0&&Object[_0xb80470(0x1ef)](_0x262e44,{'status':_0x60aa6c});const [_0xc71c76,_0x53ee72]=await this[_0xb80470(0x161)][_0xb80470(0x164)]({'where':_0x262e44,'order':{'id':_0xb80470(0x1e2)},'take':size,'skip':(page-0x1)*size});return{'rows':(0x0,utils_1[_0xb80470(0x2ba)])(_0xc71c76),'count':_0x53ee72};}catch(_0x3d00ea){console[_0xb80470(0x260)](_0x3d00ea);throw new common_1['HttpException'](_0xb80470(0x32d),common_1['HttpStatus'][_0xb80470(0x1b9)]);}}async[_0x176999(0x1c6)](_0xbdbba4,_0x120901){const _0x5482f1=_0x176999,_0x47cf47=await this[_0x5482f1(0x161)][_0x5482f1(0x1b1)]({'where':{'originTaskId':String(_0xbdbba4),'customId':_0x120901}});if(_0x47cf47>0x0)throw new common_1[(_0x5482f1(0x2f7))]('当前图片已经执行过相同指令！',common_1[_0x5482f1(0x348)][_0x5482f1(0x1b9)]);return![];}async[_0x176999(0x153)](_0x440ad5,_0x31ff45){const _0x35e913=_0x176999;try{const _0x27df87=await this[_0x35e913(0x161)][_0x35e913(0x30c)]({'where':{'id':_0x440ad5,'userId':_0x31ff45['user']['id']}});if(!_0x27df87)throw new Error(_0x35e913(0x32b));if(_0x27df87[_0x35e913(0x25e)]===midjourney_constant_1[_0x35e913(0x291)][_0x35e913(0x16b)])throw new Error(_0x35e913(0x15d));await this[_0x35e913(0x1a8)][_0x35e913(0x17c)](null,_0x27df87['mjpTaskId']);const _0x3ecd18=await this['midjourneyEntity'][_0x35e913(0x225)]({'id':_0x440ad5});if(_0x3ecd18[_0x35e913(0x16e)]>0x0)return _0x35e913(0x234);else throw new Error(_0x35e913(0x155));}catch(_0x3c3da2){throw new common_1[(_0x35e913(0x2f7))](_0x3c3da2[_0x35e913(0x339)],common_1[_0x35e913(0x348)]['BAD_REQUEST']);}}async[_0x176999(0x22d)](_0xdce3f4,_0x5a6476){const _0x5adc3e=_0x176999,{id:_0x3ef47c}=_0xdce3f4[_0x5adc3e(0x158)],_0x1915cd=await this[_0x5adc3e(0x161)]['count']({'where':{'userId':_0x3ef47c,'status':(0x0,typeorm_2['In'])([0x1,0x2])}}),_0x378cc7=await this[_0x5adc3e(0x2a6)](_0x5a6476)[_0x5adc3e(0x2b8)](_0x4eae90=>{return Promise['reject'](_0x4eae90);});if(!_0x378cc7)throw new common_1[(_0x5adc3e(0x2f7))](_0x5adc3e(0x143),common_1[_0x5adc3e(0x348)]['BAD_REQUEST']);const _0x3c589f=await this['globalConfigService']['getConfigs']([_0x5adc3e(0x2e2)]),_0x91938e=_0x3c589f?Number(_0x3c589f):0xa;if(_0x1915cd>=_0x91938e)throw new common_1['HttpException']('当前管理员限制单用户同时最多能执行'+_0x91938e+'个任务',common_1['HttpStatus'][_0x5adc3e(0x1b9)]);}async['drawFailed'](_0x20b491){const _0x95a45b=_0x176999,{id:_0x561143,userId:_0xbec1b4,action:_0x29e4c2}=_0x20b491,_0x1eee7d=0x4;await this[_0x95a45b(0x240)]['refundMjBalance'](_0xbec1b4,_0x1eee7d),await this['midjourneyEntity'][_0x95a45b(0x28f)]({'id':_0x561143},{'status':midjourney_constant_1[_0x95a45b(0x291)][_0x95a45b(0x1f3)]});}async[_0x176999(0x33d)](_0x17cc70){const _0x86095d=_0x176999,{page:page=0x1,size:size=0x14,rec:_0x422f8a,squareType:_0x20cc07,userId:_0x284b95,status:_0x165023,favorite:favorite=0x0,keyword:_0x39e9ec}=_0x17cc70,_0x3f710c={};_0x284b95&&Object[_0x86095d(0x1ef)](_0x3f710c,{'userId':_0x284b95}),favorite&&Object[_0x86095d(0x1ef)](_0x3f710c,{'favorite':favorite}),_0x422f8a&&Object[_0x86095d(0x1ef)](_0x3f710c,{'rec':_0x422f8a}),_0x39e9ec&&Object[_0x86095d(0x1ef)](_0x3f710c,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x39e9ec+'%')}),_0x165023>0x0&&Object[_0x86095d(0x1ef)](_0x3f710c,{'status':_0x165023}),_0x20cc07!==''&&Object[_0x86095d(0x1ef)](_0x3f710c,{'squareType':_0x20cc07});const [_0xc9db9a,_0x3dbb31]=await this[_0x86095d(0x161)][_0x86095d(0x164)]({'where':_0x3f710c,'take':size,'order':{'id':_0x86095d(0x1e2)},'skip':(page-0x1)*size,'select':['fileInfo',_0x86095d(0x2f5),_0x86095d(0x209),_0x86095d(0x2a9),_0x86095d(0x267),_0x86095d(0x146),_0x86095d(0x1c1),_0x86095d(0x2dc),'createdAt','id',_0x86095d(0x20e),_0x86095d(0x2e6),_0x86095d(0x2f5),'fullPrompt',_0x86095d(0x28a),_0x86095d(0x262)]});return _0xc9db9a[_0x86095d(0x20a)](_0x18c317=>{const _0x4de091=_0x86095d;_0x18c317[_0x4de091(0x324)]=_0x18c317[_0x4de091(0x324)]?JSON[_0x4de091(0x28d)](_0x18c317[_0x4de091(0x324)]):{};}),{'rows':_0xc9db9a,'count':_0x3dbb31};}async[_0x176999(0x1e9)](_0x103b24,_0x3c8e43){const _0xf70503=_0x176999;try{let _0x48ddc9,_0x546f2b,_0x4f65c0,_0x4d8403;const {jobId:_0x12340c,detail:_0x19030e}=_0x3c8e43;if(_0x103b24[_0xf70503(0x233)]['authorization']){const _0x561be1=_0x103b24['headers'][_0xf70503(0x31d)][_0xf70503(0x341)]('\x20'),_0x4dcdc3=jwt[_0xf70503(0x329)](_0x561be1[0x1],process[_0xf70503(0x203)][_0xf70503(0x2f2)]);_0x546f2b=_0x4dcdc3['id'];}const _0x1756a0=await this[_0xf70503(0x161)][_0xf70503(0x30c)]({'where':{'jobId':_0x12340c}});return _0x19030e&&(this[_0xf70503(0x1f8)][_0xf70503(0x2e7)](relate_contant_1['ELogRelateType']['mj'],_0x1756a0['id']),_0x48ddc9=await this[_0xf70503(0x24e)]['findOne']({'where':{'id':_0x1756a0['userId']}}),_0x4f65c0=await this[_0xf70503(0x1f8)]['getByRelateId'](relate_contant_1[_0xf70503(0x237)]['mj'],_0x1756a0['id']),_0x546f2b&&(_0x4d8403=await this['aiLogService'][_0xf70503(0x2ac)](relate_contant_1[_0xf70503(0x237)]['mj'],_0x1756a0['id']))),{..._0x1756a0,'avatar':_0x48ddc9?_0x48ddc9[_0xf70503(0x282)]:null,'username':_0x48ddc9?_0x48ddc9[_0xf70503(0x1cc)]:null,'nickname':_0x48ddc9?_0x48ddc9[_0xf70503(0x257)]:null,'visitNum':_0x4f65c0?_0x4f65c0[_0xf70503(0x2fb)]:0x0,'agreeNum':_0x4f65c0?_0x4f65c0['agreeNum']:0x0,'agree':_0x4d8403?_0x4d8403[_0xf70503(0x209)]:null};}catch(_0x3b750a){throw new common_1['HttpException'](_0x3b750a['message'],common_1[_0xf70503(0x348)][_0xf70503(0x1b9)]);}}async[_0x176999(0x34d)](_0x5e7e3a,_0x1acb81){const _0x256df2=_0x176999;try{if(!_0x1acb81[_0x256df2(0x25c)]||!_0x1acb81[_0x256df2(0x25c)][_0x256df2(0x1f6)])return[];const _0x44e5b2=_0x1acb81[_0x256df2(0x25c)]['split'](','),_0x3c5765=await this[_0x256df2(0x161)][_0x256df2(0x34c)]({'where':{'jobId':(0x0,typeorm_2['In'])(_0x44e5b2)}});return _0x3c5765;}catch(_0x4f15e3){throw new common_1[(_0x256df2(0x2f7))](_0x4f15e3[_0x256df2(0x339)],common_1[_0x256df2(0x348)][_0x256df2(0x1b9)]);}}async[_0x176999(0x238)](_0x3d2ce4,_0x11f535){const _0x3cfd4a=_0x176999;try{const {page:page=0x1,size:size=0xa,rec:_0x16141a,userId:_0x252269,status:_0x5968d3}=_0x11f535,_0x4f141a={};_0x16141a&&Object[_0x3cfd4a(0x1ef)](_0x4f141a,{'rec':_0x16141a}),_0x252269&&Object['assign'](_0x4f141a,{'userId':_0x252269}),_0x5968d3&&Object['assign'](_0x4f141a,{'status':_0x5968d3});const [_0x37701c,_0x350137]=await this[_0x3cfd4a(0x161)][_0x3cfd4a(0x164)]({'where':_0x4f141a,'order':{'id':_0x3cfd4a(0x1e2)},'take':size,'skip':(page-0x1)*size}),_0x231622=_0x37701c[_0x3cfd4a(0x288)](_0x23a6b2=>_0x23a6b2['userId'])[_0x3cfd4a(0x1e1)](_0x3c6bc8=>_0x3c6bc8<0x186a0),_0x117dd6=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x231622)},'select':['id','username','avatar',_0x3cfd4a(0x26e)]});return _0x37701c['forEach'](_0x47912a=>{const _0x2376e3=_0x3cfd4a;_0x47912a[_0x2376e3(0x18a)]=_0x117dd6[_0x2376e3(0x34c)](_0x3ef497=>_0x3ef497['id']===_0x47912a[_0x2376e3(0x2fd)]),_0x47912a[_0x2376e3(0x18f)]=![];}),_0x3d2ce4['user'][_0x3cfd4a(0x1e4)]!==_0x3cfd4a(0x2bc)&&_0x37701c['forEach'](_0x1cbffe=>{const _0x3dced2=_0x3cfd4a;_0x1cbffe[_0x3dced2(0x18a)]&&_0x1cbffe[_0x3dced2(0x18a)][_0x3dced2(0x26e)]&&(_0x1cbffe['userInfo']['email']=_0x1cbffe[_0x3dced2(0x18a)][_0x3dced2(0x26e)][_0x3dced2(0x24c)](/(.{2}).+(.{2}@.+)/,'$1****$2'));}),{'rows':_0x37701c,'count':_0x350137};}catch(_0x5a9ee3){throw new common_1[(_0x3cfd4a(0x2f7))](_0x3cfd4a(0x1ac),common_1[_0x3cfd4a(0x348)]['BAD_REQUEST']);}}[_0x176999(0x2f9)](_0x317513){const _0x218210=_0x176999;return _0x317513[_0x218210(0x24c)](/^\**/g,'');}async[_0x176999(0x1af)](_0x72dfa1){const _0x1582d5=_0x176999,{id:_0x1fafc0,squareType:_0x27c1af}=_0x72dfa1,_0x48847a=await this[_0x1582d5(0x161)][_0x1582d5(0x30c)]({'where':{'id':_0x1fafc0,'status':midjourney_constant_1['MidjourneyStatusEnum']['DRAWED']}});if(!_0x48847a)throw new common_1[(_0x1582d5(0x2f7))](_0x1582d5(0x24b),common_1['HttpStatus'][_0x1582d5(0x1b9)]);const _0x2c4ae1=await this['midjourneyEntity'][_0x1582d5(0x28f)]({'id':_0x1fafc0},{'rec':0x1,'squareType':_0x27c1af})[_0x1582d5(0x2b8)](_0x186a26=>{const _0x4a758a=_0x1582d5;throw new common_1[(_0x4a758a(0x2f7))](_0x186a26,common_1[_0x4a758a(0x348)][_0x4a758a(0x1b9)]);});if(_0x2c4ae1[_0x1582d5(0x16e)]<=0x0)throw new common_1['HttpException']('操作失败！',common_1['HttpStatus'][_0x1582d5(0x1b9)]);return await this[_0x1582d5(0x210)][_0x1582d5(0x152)]({'key':_0x1582d5(0x2e3)}),!![];}async[_0x176999(0x345)](_0x4fa34d){const _0x3da6c6=_0x176999,{id:_0x36549a,favorite:_0x30b978}=_0x4fa34d,_0x503c98=await this['midjourneyEntity'][_0x3da6c6(0x30c)]({'where':{'id':_0x36549a}})[_0x3da6c6(0x2b8)](_0x14c8ce=>{const _0x35398b=_0x3da6c6;common_1[_0x35398b(0x150)][_0x35398b(0x278)](_0x14c8ce);});if(!_0x503c98)throw new common_1['HttpException'](_0x3da6c6(0x24b),common_1['HttpStatus'][_0x3da6c6(0x1b9)]);const _0x17fc4d=await this[_0x3da6c6(0x161)]['update']({'id':_0x36549a},{'favorite':_0x30b978});if(_0x17fc4d[_0x3da6c6(0x16e)]<=0x0)throw new common_1[(_0x3da6c6(0x2f7))](_0x3da6c6(0x2de),common_1[_0x3da6c6(0x348)]['BAD_REQUEST']);return!![];}async[_0x176999(0x16d)](){const _0x3de0f9=_0x176999;try{await this['midjourneyEntity']['update']({'status':0x2},{'status':0x4});}catch(_0x47ce25){console[_0x3de0f9(0x260)](_0x3de0f9(0x2da),_0x47ce25);}}async['delLog'](_0x2d81fd,_0x18d1e1){const _0x3a266c=_0x176999,{id:_0x561699}=_0x18d1e1;if(!_0x561699)throw new common_1[(_0x3a266c(0x2f7))](_0x3a266c(0x247),common_1[_0x3a266c(0x348)]['BAD_REQUEST']);const _0x30b449=await this[_0x3a266c(0x161)][_0x3a266c(0x225)]({'id':_0x561699});if(_0x30b449[_0x3a266c(0x16e)]<=0x0)throw new common_1[(_0x3a266c(0x2f7))](_0x3a266c(0x1c2),common_1[_0x3a266c(0x348)][_0x3a266c(0x1b9)]);return!![];}async[_0x176999(0x216)](_0x70b27b,_0x62be1d){const _0xe0a0b2=_0x176999;try{const {prompt:_0x5232ea,status:_0x182a30,isCarryParams:_0x1bd575,imageUrl:_0x373f49,title:_0xf81951,order:_0x4758a6,id:_0x1d20b0,aspect:_0x35e3ff}=_0x62be1d;return _0x1d20b0?await this['mjPromptsEntity']['update']({'id':_0x1d20b0},{'prompt':_0x5232ea,'imageUrl':_0x373f49,'status':_0x182a30,'isCarryParams':_0x1bd575,'order':_0x4758a6,'aspect':_0x35e3ff})[_0xe0a0b2(0x229)](_0x4dc3e2=>!!_0x4dc3e2):await this[_0xe0a0b2(0x1bc)][_0xe0a0b2(0x1f1)]({'prompt':_0x5232ea,'status':_0x182a30,'imageUrl':_0x373f49,'isCarryParams':_0x1bd575,'title':_0xf81951,'order':_0x4758a6,'aspect':_0x35e3ff})['then'](_0x41cad7=>!!_0x41cad7);}catch(_0x2e1ed8){console[_0xe0a0b2(0x260)](_0xe0a0b2(0x20f),_0x2e1ed8);}}async['delPrompt'](_0x39c28a,_0x16eba8){const _0x224831=_0x176999,{id:_0xeab225}=_0x16eba8;if(!_0xeab225)throw new common_1[(_0x224831(0x2f7))](_0x224831(0x247),common_1[_0x224831(0x348)][_0x224831(0x1b9)]);return await this[_0x224831(0x1bc)][_0x224831(0x225)]({'id':_0xeab225});}async['queryAllPrompt'](){const _0x58a2e1=_0x176999;return await this[_0x58a2e1(0x1bc)][_0x58a2e1(0x34c)]({'order':{'order':'DESC'}})[_0x58a2e1(0x229)](_0x4c05ee=>_0x4c05ee||[])[_0x58a2e1(0x2b8)](_0x43c521=>{const _0x141ae8=_0x58a2e1;common_1[_0x141ae8(0x150)][_0x141ae8(0x278)](_0x43c521);});}async[_0x176999(0x162)](_0x41357f){const _0xc92ae5=_0x176999,{size:_0x587c94,page:_0x47a529}=_0x41357f;return await this['mjPromptsEntity']['find']({'order':{'order':_0xc92ae5(0x1e2)},'take':_0x587c94,'skip':(_0x47a529-0x1)*_0x587c94})['catch'](_0xc5cda1=>{const _0x4be6e3=_0xc92ae5;console[_0x4be6e3(0x260)](_0xc5cda1);});}async[_0x176999(0x318)](_0x135ca7){const {mode:_0x1d9510}=_0x135ca7;}async[_0x176999(0x13a)](_0x242642){const _0x76a29e=_0x176999;try{const {name:_0x42ba8e,value:_0x1e122b}=_0x242642,_0x6285ae=await this[_0x76a29e(0x322)][_0x76a29e(0x1d1)]({'name':_0x42ba8e});if(_0x6285ae)throw new common_1['HttpException'](_0x76a29e(0x21f),common_1['HttpStatus'][_0x76a29e(0x1b9)]);return await this['mjInspireClassifyEntity'][_0x76a29e(0x1f1)]({'name':_0x42ba8e,'value':_0x1e122b})[_0x76a29e(0x229)](_0x2b36cd=>!!_0x2b36cd)[_0x76a29e(0x2b8)](_0x6ccbba=>{const _0x25cbfb=_0x76a29e;console[_0x25cbfb(0x260)](_0x6ccbba);throw new common_1[(_0x25cbfb(0x2f7))](_0x6ccbba,common_1['HttpStatus']['BAD_REQUEST']);});}catch(_0x16380f){return![];}}async[_0x176999(0x185)](_0x1e9039){const _0x12afbe=_0x176999,{id:_0x4c634e,name:_0x5df7fa,value:_0x2d7bca}=_0x1e9039;return await this['mjInspireClassifyEntity'][_0x12afbe(0x28f)](_0x4c634e,{'name':_0x5df7fa,'value':_0x2d7bca})[_0x12afbe(0x229)](_0x4a2fe4=>!!_0x4a2fe4);}async[_0x176999(0x256)](_0x2d8c0d){const _0x3c4396=_0x176999,{id:_0x2ac0fa}=_0x2d8c0d;return await this['mjInspireClassifyEntity'][_0x3c4396(0x225)]({'id':_0x2ac0fa})[_0x3c4396(0x2b8)](_0x12642e=>{const _0x588539=_0x3c4396;throw new common_1['HttpException'](_0x12642e,common_1[_0x588539(0x348)][_0x588539(0x1b9)]);});}async[_0x176999(0x328)](_0x14d5bc){const _0xe3a6d2=_0x176999,{size:_0x1117f2,page:_0x260c61}=_0x14d5bc,_0x4d4ec5=await this[_0xe3a6d2(0x322)]['findAndCount']({'order':{'createdAt':_0xe3a6d2(0x1e2)},'take':_0x1117f2,'skip':(_0x260c61-0x1)*_0x1117f2})[_0xe3a6d2(0x2b8)](_0x1bca22=>{const _0x141ca7=_0xe3a6d2;throw new common_1[(_0x141ca7(0x2f7))](_0x1bca22,common_1[_0x141ca7(0x348)][_0x141ca7(0x1b9)]);});if(!_0x4d4ec5)throw new common_1['HttpException'](_0xe3a6d2(0x160),common_1[_0xe3a6d2(0x348)][_0xe3a6d2(0x1b9)]);const [_0x25afec,_0x1fdcde]=_0x4d4ec5;return{'rows':_0x25afec,'count':_0x1fdcde};}async['getMjInspireClassify'](_0x2c1faf){const _0x49790b=_0x176999,{id:_0x1df24d}=_0x2c1faf;return await this[_0x49790b(0x322)][_0x49790b(0x30c)]({'where':{'id':_0x1df24d}});}async[_0x176999(0x2d2)](_0x20d890){const _0x3ed2f7=_0x176999;try{const {classifyName:_0x27b211,level:_0x77023f,type:_0x3fe831,pid:pid=0x0}=_0x20d890;return await this['mjIncantationClassifyEntity'][_0x3ed2f7(0x1f1)]({'classifyName':_0x27b211,'level':_0x77023f,'type':_0x3fe831,'pid':pid})[_0x3ed2f7(0x229)](_0x5c6889=>!!_0x5c6889)[_0x3ed2f7(0x2b8)](_0x53671f=>{const _0xe36d0=_0x3ed2f7;console['log'](_0x53671f);throw new common_1[(_0xe36d0(0x2f7))](_0x53671f,common_1[_0xe36d0(0x348)]['BAD_REQUEST']);});}catch(_0x2bbf6c){return![];}}async[_0x176999(0x21b)](_0x38a2db){const _0x2439dd=_0x176999,{id:_0x10536d,classifyName:_0x11bd1,level:_0xaf7228,type:_0x28e9aa,pid:_0x42932e}=_0x38a2db;return this['connection'][_0x2439dd(0x206)](async()=>{const _0x184a0a=_0x2439dd,_0x1c0a8a=await this['mjIncantationClassifyEntity'][_0x184a0a(0x30c)]({'where':{'id':_0x10536d}});_0x1c0a8a[_0x184a0a(0x226)]!==_0x28e9aa&&await this[_0x184a0a(0x333)][_0x184a0a(0x28f)]({'pid':_0x10536d},{'type':_0x28e9aa}),await this[_0x184a0a(0x333)][_0x184a0a(0x28f)](_0x10536d,{'classifyName':_0x11bd1,'level':_0xaf7228,'type':_0x28e9aa,'pid':_0x42932e});}),!![];}async[_0x176999(0x17b)](_0x19f651){const _0x5d143c=_0x176999,{id:_0x2be4ab}=_0x19f651;return await this[_0x5d143c(0x333)][_0x5d143c(0x225)]({'id':_0x2be4ab})['then'](_0x287120=>_0x287120['affected']>0x0);}async[_0x176999(0x287)](_0x57d21b){const _0x25aec5=_0x176999,{id:_0xbdac50}=_0x57d21b;return await this['mjIncantationClassifyEntity'][_0x25aec5(0x30c)]({'where':{'id':_0xbdac50}});}async[_0x176999(0x27a)](){const _0x1ffd61=_0x176999;return this[_0x1ffd61(0x333)]['find']({'where':{'level':0x1}});}async[_0x176999(0x2d5)](_0x2f9339){const _0x4fc0a0=_0x176999,{size:_0x2b61a8,page:_0x5dfeac,type:_0x4c9220,keyword:_0x3b2d94,level:_0x387d32}=_0x2f9339;let _0x582878={};_0x387d32>0x0&&(_0x582878[_0x4fc0a0(0x2be)]=_0x387d32);_0x4c9220&&(_0x582878[_0x4fc0a0(0x226)]=_0x4c9220);_0x3b2d94&&(_0x582878[_0x4fc0a0(0x2c2)]=(0x0,typeorm_2[_0x4fc0a0(0x30e)])('%'+_0x3b2d94+'%'));const _0x175079=await this['mjIncantationClassifyEntity'][_0x4fc0a0(0x164)]({'order':{'createdAt':_0x4fc0a0(0x1e2)},'where':_0x582878,'take':_0x2b61a8,'skip':(_0x5dfeac-0x1)*_0x2b61a8})['catch'](_0x503c58=>{const _0x35cd1c=_0x4fc0a0;console[_0x35cd1c(0x260)](_0x503c58);});if(!_0x175079)throw new common_1[(_0x4fc0a0(0x2f7))]('查询咒语分类失败',common_1['HttpStatus'][_0x4fc0a0(0x1b9)]);const [_0x4b8140,_0x42e879]=_0x175079;return{'rows':_0x4b8140,'count':_0x42e879};}async['queryMjIncantationClassifyAllByLevel'](_0x2efbb0){const _0x3f7f2a=_0x176999,{level:_0xabe227,type:_0x3e96ed}=_0x2efbb0,_0xa5dbfb={};_0xabe227===0x0?_0xa5dbfb[_0x3f7f2a(0x2be)]=(0x0,typeorm_2[_0x3f7f2a(0x2b3)])(_0xabe227):_0xa5dbfb[_0x3f7f2a(0x2be)]=_0xabe227;_0x3e96ed&&(_0xa5dbfb[_0x3f7f2a(0x226)]=_0x3e96ed);const _0x1b44e6=await this[_0x3f7f2a(0x333)][_0x3f7f2a(0x33a)](_0xa5dbfb)[_0x3f7f2a(0x2b8)](_0x531283=>{const _0x2880a1=_0x3f7f2a;console[_0x2880a1(0x260)](_0x531283);});if(!_0x1b44e6)throw new common_1['HttpException'](_0x3f7f2a(0x31a),common_1[_0x3f7f2a(0x348)][_0x3f7f2a(0x1b9)]);if(_0xabe227===0x0)return{'level1':_0x1b44e6[_0x3f7f2a(0x1e1)](_0x507c11=>_0x507c11['level']===0x1),'level2':_0x1b44e6['filter'](_0x8d5d31=>_0x8d5d31[_0x3f7f2a(0x2be)]===0x2)};return _0x1b44e6;}async['addMjIncantation'](_0x124b01){const _0x253baa=_0x176999;try{const {incantationEn:_0x228487,incantationCn:_0x550f50,img:_0x2a9f3e,pid:_0x2cd129}=_0x124b01;return await this['mjIncantationEntity'][_0x253baa(0x1f1)]({'incantationEn':_0x228487,'incantationCn':_0x550f50,'img':_0x2a9f3e,'pid':_0x2cd129})['then'](_0x99f365=>!!_0x99f365)[_0x253baa(0x2b8)](_0xc4a118=>{throw _0xc4a118;});}catch(_0x4501f6){return console[_0x253baa(0x260)](_0x4501f6),![];}}async[_0x176999(0x23d)](_0x2ba1dc){const _0x249588=_0x176999,{id:_0x28071c,incantationEn:_0x2473fe,incantationCn:_0x4cd1d7,img:_0x547dd6,pid:_0x5e46fe}=_0x2ba1dc;return await this['mjIncantationEntity'][_0x249588(0x28f)](_0x28071c,{'incantationCn':_0x4cd1d7,'incantationEn':_0x2473fe,'img':_0x547dd6,'pid':_0x5e46fe});}async[_0x176999(0x1cb)](_0xc34f8a){const _0x5a161d=_0x176999,{id:_0x47a30c}=_0xc34f8a;return await this[_0x5a161d(0x177)][_0x5a161d(0x225)]({'id':_0x47a30c})[_0x5a161d(0x229)](_0x142c47=>_0x142c47[_0x5a161d(0x16e)]>0x0);}async[_0x176999(0x306)](_0x5aec26){const _0x5463bc=_0x176999,{id:_0x3e0f10}=_0x5aec26;return await this['mjIncantationEntity'][_0x5463bc(0x30c)]({'where':{'id':_0x3e0f10}});}async['queryMjIncantation'](_0x341688){const _0x277b4a=_0x176999,{size:_0x43bb6a,page:_0x1bcfa4,keyword:_0x35586c,pid:_0x1c1f63}=_0x341688;let _0x348c67={};_0x1c1f63>0x0&&(_0x348c67[_0x277b4a(0x1d8)]=_0x1c1f63);_0x35586c&&(_0x348c67[_0x277b4a(0x1b2)]=(0x0,typeorm_2[_0x277b4a(0x30e)])('%'+_0x35586c+'%'));const _0x14eb74=await this['mjIncantationEntity'][_0x277b4a(0x164)]({'order':{'createdAt':_0x277b4a(0x1e2)},'where':_0x348c67,'take':_0x43bb6a,'skip':(_0x1bcfa4-0x1)*_0x43bb6a})['catch'](_0x1ba7bd=>{const _0x39a1f3=_0x277b4a;console[_0x39a1f3(0x260)](_0x1ba7bd);});if(!_0x14eb74)throw new common_1[(_0x277b4a(0x2f7))](_0x277b4a(0x34f),common_1['HttpStatus'][_0x277b4a(0x1b9)]);const [_0x5b0a3e,_0x47ef30]=_0x14eb74;return{'rows':_0x5b0a3e,'count':_0x47ef30};}async['queryMjIncantationByClassify'](_0x3ec19e){const _0x410423=_0x176999,{id:_0x3a4394}=_0x3ec19e,_0x315633=await this['mjIncantationClassifyEntity'][_0x410423(0x30c)]({'where':{'level':0x1,'id':_0x3a4394}})['catch'](_0x4f1048=>{const _0x5ce567=_0x410423;common_1[_0x5ce567(0x150)]['error'](_0x4f1048);});if(!_0x315633)throw new common_1[(_0x410423(0x2f7))](_0x410423(0x34b),common_1[_0x410423(0x348)][_0x410423(0x1b9)]);const _0x55f3b3=await this[_0x410423(0x333)][_0x410423(0x34c)]({'where':{'level':0x2,'pid':_0x315633['id']}})['catch'](_0x15677f=>{const _0x5134f7=_0x410423;common_1[_0x5134f7(0x150)][_0x5134f7(0x278)](_0x15677f);});if(!_0x55f3b3||_0x55f3b3[_0x410423(0x1f6)]===0x0)return{'rows':[]};const _0x5bba71=_0x55f3b3[_0x410423(0x288)](_0x289df7=>_0x289df7['id']),_0x3e103a=await this[_0x410423(0x177)][_0x410423(0x34c)]({'where':{'pid':(0x0,typeorm_2['In'])(_0x5bba71)}})[_0x410423(0x2b8)](_0x3dde24=>{const _0xdc09f0=_0x410423;common_1[_0xdc09f0(0x150)][_0xdc09f0(0x278)](_0x3dde24);});if(!_0x3e103a)throw new common_1[(_0x410423(0x2f7))](_0x410423(0x34f),common_1[_0x410423(0x348)][_0x410423(0x1b9)]);const _0x74c969=_0x55f3b3[_0x410423(0x288)](_0x2bbfbc=>{return{'children':_0x3e103a['filter'](_0x16e74c=>_0x16e74c['pid']===_0x2bbfbc['id'])||[],..._0x2bbfbc};});return{'rows':_0x74c969};}async[_0x176999(0x29d)](){const _0x2554c8=_0x176999,_0x418969=await this[_0x2554c8(0x177)][_0x2554c8(0x34c)]({'order':{'createdAt':_0x2554c8(0x1e2)}})[_0x2554c8(0x2b8)](_0x1ed887=>{const _0x5b0e6a=_0x2554c8;console[_0x5b0e6a(0x260)](_0x1ed887);});if(!_0x418969)throw new common_1[(_0x2554c8(0x2f7))](_0x2554c8(0x34f),common_1[_0x2554c8(0x348)][_0x2554c8(0x1b9)]);return _0x418969;}async['saveSuggestWords'](_0xfdeab3){const _0x381bee=_0x176999,{id:_0x513f2a,suggestCn:_0x1eb90d,suggestEn:_0xb67057,order:_0x22074a,image:_0x7138c0}=_0xfdeab3,_0x31feb1=await this['mjSuggestWordEntity']['exist']({'where':{'suggestCn':_0x1eb90d}});if(_0x31feb1)throw new common_1['HttpException'](_0x381bee(0x15a),common_1[_0x381bee(0x348)]['BAD_REQUEST']);const _0x5a97d8=await this[_0x381bee(0x145)][_0x381bee(0x1f1)]({'id':_0x513f2a,'suggestCn':_0x1eb90d,'suggestEn':_0xb67057,'order':_0x22074a||0x64,'image':_0x7138c0||''})[_0x381bee(0x229)](_0xc1c788=>!!_0xc1c788['id'])[_0x381bee(0x2b8)](_0x50d11c=>{const _0x57adae=_0x381bee;console[_0x57adae(0x260)](_0x50d11c);});if(!_0x5a97d8)throw new common_1['HttpException'](_0x381bee(0x269),common_1[_0x381bee(0x348)][_0x381bee(0x1b9)]);return _0x5a97d8;}async[_0x176999(0x1f4)](_0x3b912c){const _0x36fc39=_0x176999,{id:_0x530c9b}=_0x3b912c,_0x23c291=await this[_0x36fc39(0x145)]['exist']({'where':{'id':_0x530c9b}});if(!_0x23c291)throw new common_1[(_0x36fc39(0x2f7))](_0x36fc39(0x276),common_1['HttpStatus']['BAD_REQUEST']);const _0x5b6ec9=await this[_0x36fc39(0x145)][_0x36fc39(0x225)](_0x530c9b)[_0x36fc39(0x229)](_0x24d436=>_0x24d436[_0x36fc39(0x16e)]>0x0)[_0x36fc39(0x2b8)](_0x3a638c=>{console['log'](_0x3a638c);});if(!_0x5b6ec9)throw new common_1[(_0x36fc39(0x2f7))]('删除推荐关键词失败',common_1[_0x36fc39(0x348)][_0x36fc39(0x1b9)]);return _0x5b6ec9;}async[_0x176999(0x1d7)](_0x2bbf81){const _0x152b3b=_0x176999;let _0x25d14c={};const {page:_0x283520,size:_0x414de4}=_0x2bbf81,_0x4cacee=await this['mjSuggestWordEntity']['findAndCount']({'where':_0x25d14c,'take':_0x414de4,'skip':(_0x283520-0x1)*_0x414de4,'order':{'order':_0x152b3b(0x1e2)}})[_0x152b3b(0x229)](([_0x254b92,_0x2996ae])=>({'rows':_0x254b92,'count':_0x2996ae}))[_0x152b3b(0x2b8)](_0x2e4b47=>{const _0x4f363d=_0x152b3b;console[_0x4f363d(0x260)](_0x2e4b47);});if(!_0x4cacee)throw new common_1[(_0x152b3b(0x2f7))](_0x152b3b(0x18b),common_1['HttpStatus'][_0x152b3b(0x1b9)]);return _0x4cacee;}async['handleUpdateMjSetting'](_0x464dbb){const _0x47b7a2=_0x176999,{accountId:_0x300714,customId:_0x3e8b76,flags:_0x4eae3b,messageId:_0x37972d,mode:_0x5dba28}=_0x464dbb,_0x3c6b07=await this['mjParamEntity'][_0x47b7a2(0x340)]({'where':{'id':_0x300714}});if(!_0x3c6b07)throw new common_1[(_0x47b7a2(0x2f7))](_0x47b7a2(0x21e),common_1[_0x47b7a2(0x348)][_0x47b7a2(0x1b9)]);const {guild_id:_0xc2cea7,channel_id:_0x1dd32d,authorization:_0x2b2681,mjProxyUrl:_0x43e11b,mjProxy:_0x5810cc}=await this['getMjDefaultParams'](_0x5dba28)[_0x47b7a2(0x2b8)](_0x377741=>{const _0x1843ba=_0x47b7a2;return Promise[_0x1843ba(0x16a)](_0x377741);});console['log'](_0x5810cc==0x1?_0x47b7a2(0x29b):_0x47b7a2(0x2df));if(_0x5810cc==0x0){const _0x34b27f=await this[_0x47b7a2(0x13f)](_0x464dbb),{msg:_0x2aeb55,type:_0xb67cf7}=_0x34b27f;if(_0xb67cf7==='MESSAGE_UPDATE')return await this['mjParamEntity']['update']({'id':_0x300714},{'setting':JSON[_0x47b7a2(0x20d)](_0x2aeb55)})['then'](_0x1e7f52=>_0x1e7f52['affected']>0x0)['catch'](_0x388b9c=>{const _0x533df8=_0x47b7a2;common_1[_0x533df8(0x150)][_0x533df8(0x278)](_0x388b9c);throw new common_1[(_0x533df8(0x2f7))](_0x388b9c,common_1[_0x533df8(0x348)]['BAD_REQUEST']);});return!![];}else{const _0x4f5ff3=await this['updateSettingByProxy']({'customId':_0x3e8b76,'messageId':_0x37972d,'flags':_0x4eae3b,'guildId':_0xc2cea7,'channelId':_0x1dd32d,'token':_0x2b2681,'mjProxyUrl':_0x43e11b});return console[_0x47b7a2(0x260)](_0x47b7a2(0x2db),_0x4f5ff3),await this[_0x47b7a2(0x33b)][_0x47b7a2(0x28f)]({'id':_0x300714},{'setting':JSON[_0x47b7a2(0x20d)](_0x4f5ff3)})[_0x47b7a2(0x229)](_0x449157=>_0x449157[_0x47b7a2(0x16e)]>0x0)[_0x47b7a2(0x2b8)](_0x53ef31=>{const _0x36c294=_0x47b7a2;common_1['Logger'][_0x36c294(0x278)](_0x53ef31);throw new common_1[(_0x36c294(0x2f7))](_0x53ef31,common_1['HttpStatus']['BAD_REQUEST']);});}}async[_0x176999(0x332)](_0x439876){const _0x7336cc=_0x176999,{channelId:_0x232a63,token:_0x10072e,guildId:_0xe88161,flags:_0x5c397b,mjProxyUrl:_0x3c44c5,customId:_0x5298e5,messageId:_0x1c33ba}=_0x439876;return axios_1[_0x7336cc(0x15f)][_0x7336cc(0x138)](_0x3c44c5+_0x7336cc(0x1e3),{'custom_id':_0x5298e5,'flags':_0x5c397b,'message_id':_0x1c33ba,'token':_0x10072e,'channel_id':_0x232a63,'guild_id':_0xe88161})[_0x7336cc(0x229)](_0x2b6b23=>_0x2b6b23[_0x7336cc(0x32f)])['catch'](_0x5e64c7=>Promise[_0x7336cc(0x16a)](_0x5e64c7));}async['handleGetMjSetting'](_0x41ddfd){const _0x5d237f=_0x176999,{accountId:_0xe1e216}=_0x41ddfd,_0x50d99a=await this['mjParamEntity']['findOne']({'where':{'id':_0xe1e216}});if(!_0x50d99a)throw new common_1[(_0x5d237f(0x2f7))]('账户不存在',common_1[_0x5d237f(0x348)][_0x5d237f(0x1b9)]);const {setting:_0x13b3b2}=_0x50d99a,_0x589c50=_0x13b3b2?JSON[_0x5d237f(0x28d)](_0x13b3b2):'';if(!_0x589c50)return await this[_0x5d237f(0x309)](_0x50d99a,!![])['catch'](_0x3943a9=>{console['log'](_0x3943a9);});else{const _0x564291=_0x589c50['components'];return _0x564291[_0x5d237f(0x1f6)]>=0x2?_0x564291[0x1][_0x5d237f(0x1de)][0x1][_0x5d237f(0x169)]===0x3:await this[_0x5d237f(0x309)](_0x50d99a,!![])[_0x5d237f(0x2b8)](_0x4bf2f9=>{const _0xf94778=_0x5d237f;console[_0xf94778(0x260)](_0x4bf2f9);});}}async[_0x176999(0x13f)](_0xae333f){const _0xfe83da=_0x176999,{messageId:_0x589900,customId:_0x2c859f,flags:_0x3a6e66,mode:_0x8ae82f,accountId:_0x57bfea}=_0xae333f,{guild_id:_0x12cbc8,channel_id:_0x906d19,authorization:_0x3930be}=await this[_0xfe83da(0x2a6)](_0x8ae82f)[_0xfe83da(0x2b8)](_0x1ece13=>{const _0x20cf4f=_0xfe83da;return Promise[_0x20cf4f(0x16a)](_0x1ece13);}),_0x3fa9b3=this[_0xfe83da(0x325)],_0x41d707=this[_0xfe83da(0x259)];return!this[_0xfe83da(0x2fc)][_0x8ae82f]&&await this['initMidJourney']({'channel_id':_0x906d19,'guild_id':_0x12cbc8,'token':_0x3930be,'wsBaseUrl':_0x3fa9b3,'apiBaseUrl':_0x41d707},_0x8ae82f),new Promise(async(_0x4f471a,_0x2f1a8f)=>{const _0x45b11f=_0xfe83da;return await this['midJourney'][_0x8ae82f]['api'][_0x45b11f(0x209)](_0x589900,_0x2c859f,_0x3a6e66,(_0xdde714,_0x38dbc1)=>{const _0x237ac8=_0x45b11f;console[_0x237ac8(0x260)]('type',_0xdde714,_0x237ac8(0x283),_0x38dbc1),_0x4f471a({'type':_0xdde714,'msg':_0x38dbc1});});});}[_0x176999(0x349)](_0x241656){const _0x26ab25=_0x176999;if(!_0x241656)return _0x26ab25(0x244);if(_0x241656===midjourney_constant_1['DrawSpeed'][_0x26ab25(0x244)])return _0x26ab25(0x244);if(_0x241656===midjourney_constant_1[_0x26ab25(0x163)][_0x26ab25(0x2cc)])return'relax';if(_0x241656===midjourney_constant_1['DrawSpeed'][_0x26ab25(0x1a3)])return'turbo';return _0x26ab25(0x244);}async[_0x176999(0x33c)](_0x432a66){const _0xa043c6=_0x176999,_0x7edb35=await this[_0xa043c6(0x1a8)][_0xa043c6(0x13d)]({'data':{'ids':[_0x432a66]}});common_1['Logger']['log'](_0xa043c6(0x232)),this[_0xa043c6(0x2fe)](_0x7edb35[0x0]);}async['notify'](_0x469bf2){const _0x36834d=_0x176999;common_1['Logger'][_0x36834d(0x260)](_0x469bf2,_0x36834d(0x2b1));try{let _0x49900f=[];const _0xfa9dfb=midjourney_constant_1['MjpStateMap'][_0x36834d(0x1d4)](_0x469bf2['status']),_0x163bd9=_0x469bf2[_0x36834d(0x219)]?parseFloat(_0x469bf2[_0x36834d(0x219)]):null;let _0x429a55=await this[_0x36834d(0x161)][_0x36834d(0x30c)]({'where':{'mjpTaskId':_0x469bf2['id']}});if(_0x469bf2[_0x36834d(0x25e)]===_0x36834d(0x2c0)&&_0x429a55['messageFlags']){common_1[_0x36834d(0x150)][_0x36834d(0x260)](_0x36834d(0x21d),_0x36834d(0x1f9));return;}_0x469bf2[_0x36834d(0x25a)]&&(_0x49900f=_0x469bf2[_0x36834d(0x25a)][_0x36834d(0x1e1)](_0x425630=>_0x425630[_0x36834d(0x1fa)]!=='Custom\x20Zoom'&&_0x425630['label']!==_0x36834d(0x180)&&_0x425630['emoji']!=='❤️'));MjConfig_1['default']['mjProxyImgUrl']&&_0x469bf2['imageUrl']&&(_0x469bf2['imageUrl']=_0x469bf2[_0x36834d(0x2e6)]['replace'](_0x36834d(0x2b2),MjConfig_1['default'][_0x36834d(0x205)]));const _0x321285={'id':_0x429a55['id'],'status':_0xfa9dfb,'progress':_0x163bd9,'durationSpent':null,'imageUrl':_0x469bf2[_0x36834d(0x2e6)],'failReason':_0x469bf2['failReason'],'buttons':JSON[_0x36834d(0x20d)](_0x49900f)};return(_0x469bf2[_0x36834d(0x209)]=_0x36834d(0x2fa))&&(_0x321285[_0x36834d(0x267)]=_0x469bf2['prompt']||_0x321285[_0x36834d(0x267)]||''),_0x469bf2[_0x36834d(0x2ca)]&&_0x469bf2['startTime']&&(_0x321285[_0x36834d(0x16f)]=(_0x469bf2[_0x36834d(0x2ca)]-_0x469bf2['startTime'])/0x3e8),_0x429a55=await this['midjourneyEntity'][_0x36834d(0x1f1)](_0x321285),_0x469bf2[_0x36834d(0x25e)]===_0x36834d(0x208)&&_0x469bf2[_0x36834d(0x2e6)]&&this[_0x36834d(0x23e)][_0x36834d(0x20b)](_0x429a55['id'],_0x429a55[_0x36834d(0x2e6)]),null;}catch(_0x353033){common_1['Logger'][_0x36834d(0x278)](_0x36834d(0x301),_0x353033);}}async['syncMjpTask'](){const _0x5e1693=_0x176999;try{const _0x3dd7c2=await this[_0x5e1693(0x161)]['find']({'where':{'status':(0x0,typeorm_2['In'])([0x1,0x2,0x6])}});if(_0x3dd7c2[_0x5e1693(0x1f6)])for(let _0x1bca08=0x0;_0x1bca08<_0x3dd7c2[_0x5e1693(0x1f6)];_0x1bca08++){const _0x108755=redisKey_constant_1[_0x5e1693(0x190)]+_0x3dd7c2[_0x1bca08][_0x5e1693(0x184)],_0x36f730=await this[_0x5e1693(0x210)][_0x5e1693(0x1d4)]({'key':_0x108755});if(_0x36f730)continue;else this[_0x5e1693(0x210)][_0x5e1693(0x137)]({'key':_0x108755,'val':_0x5e1693(0x23a)}),this[_0x5e1693(0x1a8)][_0x5e1693(0x13d)]({'data':{'ids':[_0x3dd7c2[_0x1bca08]['mjpTaskId']]}})[_0x5e1693(0x229)](async _0x289b3d=>{const _0x5ae2ae=_0x5e1693,_0x3c0b95=_0x289b3d[0x0],_0x563771=_0x3dd7c2[_0x1bca08],_0x192246=midjourney_constant_1[_0x5ae2ae(0x268)][_0x5ae2ae(0x1d4)](_0x3c0b95[_0x5ae2ae(0x25e)]),_0xc2b131=_0x3c0b95['progress']?parseFloat(_0x3c0b95[_0x5ae2ae(0x219)]):null;if(_0x563771['progress']===_0xc2b131&&_0x563771['status']===_0x192246){}else{const _0xabd633=_0x3c0b95['buttons']['filter'](_0x35f811=>_0x35f811[_0x5ae2ae(0x1fa)]!=='Custom\x20Zoom'&&_0x35f811[_0x5ae2ae(0x1fa)]!=='Imagine\x20all'&&_0x35f811[_0x5ae2ae(0x19a)]!=='❤️'),_0xf1945={'id':_0x563771['id'],'mjpTaskId':_0x3c0b95['id'],'status':_0x192246,'progress':_0xc2b131,'durationSpent':null,'imageUrl':_0x3c0b95[_0x5ae2ae(0x2e6)],'failReason':_0x3c0b95['failReason'],'buttons':JSON['stringify'](_0xabd633)};(_0x3c0b95[_0x5ae2ae(0x209)]=_0x5ae2ae(0x2fa))&&(_0xf1945[_0x5ae2ae(0x267)]=_0x3c0b95['prompt']||_0xf1945[_0x5ae2ae(0x267)]||''),_0x3c0b95['finishTime']&&_0x3c0b95['startTime']&&(_0xf1945[_0x5ae2ae(0x16f)]=(_0x3c0b95[_0x5ae2ae(0x2ca)]-_0x3c0b95[_0x5ae2ae(0x179)])/0x3e8),await this[_0x5ae2ae(0x161)]['save'](_0xf1945);}})[_0x5e1693(0x2b8)](_0x3663bd=>{const _0x1f408b=_0x5e1693;common_1[_0x1f408b(0x150)][_0x1f408b(0x278)](_0x1f408b(0x2e9),_0x3663bd);})[_0x5e1693(0x1d9)](()=>{const _0x5323cc=_0x5e1693;this['redisCacheService'][_0x5323cc(0x152)]({'key':_0x108755});});}}catch(_0x1e53e4){}}async['syncMjImg'](){const _0x12ff7d=_0x176999;if(MjConfig_1[_0x12ff7d(0x15f)][_0x12ff7d(0x1ff)])return;try{const _0x57b0d9=await this[_0x12ff7d(0x161)][_0x12ff7d(0x34c)]({'where':{'status':0x3,'imageUrl':(0x0,typeorm_2[_0x12ff7d(0x30e)])(_0x12ff7d(0x1fd))}});if(_0x57b0d9[_0x12ff7d(0x1f6)])for(let _0x3cd35b=0x0;_0x3cd35b<_0x57b0d9[_0x12ff7d(0x1f6)];_0x3cd35b++){let {id:_0x15508f,imageUrl:_0x5d7888}=_0x57b0d9[_0x3cd35b];this[_0x12ff7d(0x23e)]['transferImg'](_0x15508f,_0x5d7888);}}catch(_0x5a23ff){common_1[_0x12ff7d(0x150)][_0x12ff7d(0x278)](_0x5a23ff);}}};function _0x3a13(_0x10e8f9,_0x35220b){const _0x26dad8=_0x26da();return _0x3a13=function(_0x3a13c,_0x32c0cf){_0x3a13c=_0x3a13c-0x136;let _0x5293b7=_0x26dad8[_0x3a13c];return _0x5293b7;},_0x3a13(_0x10e8f9,_0x35220b);}MidjourneyService=__decorate([(0x0,common_1[_0x176999(0x197)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x176999(0x277)])),__param(0x1,(0x0,typeorm_1[_0x176999(0x23b)])(user_entity_1[_0x176999(0x182)])),__param(0x2,(0x0,typeorm_1[_0x176999(0x23b)])(mjPrompts_entity_1[_0x176999(0x24a)])),__param(0x3,(0x0,typeorm_1[_0x176999(0x23b)])(mjParam_entity_1[_0x176999(0x2f0)])),__param(0x4,(0x0,typeorm_1[_0x176999(0x23b)])(mjIncantationClassify_entity_1[_0x176999(0x1be)])),__param(0x5,(0x0,typeorm_1[_0x176999(0x23b)])(mjInspireClassify_entity_1[_0x176999(0x2af)])),__param(0x6,(0x0,typeorm_1[_0x176999(0x23b)])(mjSuggestWord_entity_1[_0x176999(0x1a0)])),__param(0x7,(0x0,typeorm_1[_0x176999(0x23b)])(mjIncantation_entity_1[_0x176999(0x22c)])),__metadata(_0x176999(0x315),[typeorm_2[_0x176999(0x266)],typeorm_2[_0x176999(0x266)],typeorm_2[_0x176999(0x266)],typeorm_2[_0x176999(0x266)],typeorm_2[_0x176999(0x266)],typeorm_2['Repository'],typeorm_2[_0x176999(0x266)],typeorm_2[_0x176999(0x266)],globalConfig_service_1['GlobalConfigService'],upload_service_1['UploadService'],badwords_service_1[_0x176999(0x236)],userBalance_service_1['UserBalanceService'],fanyi_service_1[_0x176999(0x2e8)],user_service_1[_0x176999(0x1ed)],redisCache_service_1[_0x176999(0x26c)],mjpAccount_service_1[_0x176999(0x14b)],mjpTask_service_1[_0x176999(0x230)],aiLog_service_1[_0x176999(0x2a2)],typeorm_2[_0x176999(0x2ae)]])],MidjourneyService),exports[_0x176999(0x1e6)]=MidjourneyService;