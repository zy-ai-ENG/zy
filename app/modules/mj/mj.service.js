'use strict';const _0x3c83be=_0x3500;(function(_0x1c0342,_0x45d084){const _0x55d9cf=_0x3500,_0x3a9701=_0x1c0342();while(!![]){try{const _0x494aa4=-parseInt(_0x55d9cf(0x144))/0x1*(-parseInt(_0x55d9cf(0x155))/0x2)+-parseInt(_0x55d9cf(0xeb))/0x3*(parseInt(_0x55d9cf(0x104))/0x4)+parseInt(_0x55d9cf(0xb3))/0x5+-parseInt(_0x55d9cf(0x109))/0x6+-parseInt(_0x55d9cf(0x128))/0x7+-parseInt(_0x55d9cf(0xde))/0x8*(parseInt(_0x55d9cf(0xd5))/0x9)+-parseInt(_0x55d9cf(0x105))/0xa*(-parseInt(_0x55d9cf(0x12e))/0xb);if(_0x494aa4===_0x45d084)break;else _0x3a9701['push'](_0x3a9701['shift']());}catch(_0x5c48c9){_0x3a9701['push'](_0x3a9701['shift']());}}}(_0x2bdc,0x1935d));var __decorate=this&&this[_0x3c83be(0xe4)]||function(_0x4641bd,_0x29ec17,_0x419819,_0x4a802e){const _0x4f4e48=_0x3c83be;var _0x4cc285=arguments['length'],_0x16667b=_0x4cc285<0x3?_0x29ec17:_0x4a802e===null?_0x4a802e=Object['getOwnPropertyDescriptor'](_0x29ec17,_0x419819):_0x4a802e,_0x308d33;if(typeof Reflect===_0x4f4e48(0x148)&&typeof Reflect[_0x4f4e48(0x167)]===_0x4f4e48(0x135))_0x16667b=Reflect['decorate'](_0x4641bd,_0x29ec17,_0x419819,_0x4a802e);else{for(var _0x3e9e43=_0x4641bd[_0x4f4e48(0xb6)]-0x1;_0x3e9e43>=0x0;_0x3e9e43--)if(_0x308d33=_0x4641bd[_0x3e9e43])_0x16667b=(_0x4cc285<0x3?_0x308d33(_0x16667b):_0x4cc285>0x3?_0x308d33(_0x29ec17,_0x419819,_0x16667b):_0x308d33(_0x29ec17,_0x419819))||_0x16667b;}return _0x4cc285>0x3&&_0x16667b&&Object[_0x4f4e48(0x10d)](_0x29ec17,_0x419819,_0x16667b),_0x16667b;},__metadata=this&&this[_0x3c83be(0x10b)]||function(_0x43a95c,_0x211459){const _0x18c288=_0x3c83be;if(typeof Reflect===_0x18c288(0x148)&&typeof Reflect[_0x18c288(0x156)]==='function')return Reflect[_0x18c288(0x156)](_0x43a95c,_0x211459);},__param=this&&this[_0x3c83be(0x100)]||function(_0x369dad,_0x58de46){return function(_0x415175,_0x569a0b){_0x58de46(_0x415175,_0x569a0b,_0x369dad);};};function _0x3500(_0x22d1fb,_0x1e3859){const _0x2bdc6d=_0x2bdc();return _0x3500=function(_0x350049,_0x16aebd){_0x350049=_0x350049-0xb3;let _0xb533f2=_0x2bdc6d[_0x350049];return _0xb533f2;},_0x3500(_0x22d1fb,_0x1e3859);}function _0x2bdc(){const _0x2ff29a=['checkBadWords','now','网络连接失败，请稍后再试！','balance\x20-\x201','rateLimits','decorate','axios','Repository','当前提示词已经在任务队列中了、请勿重复提交。。。','axios\x20get:\x20','\x20次开始查询[变换图片]','@nestjs/common','451835OUkAxc','pollForResult','balanceEntity','length','replace','查询绘制结果失败...','开始请求变换图片\x20队列+1:\x20','deductBalance','badwordsService','test','imagine','mjRateLimit','globalConfigService','发送放大指令成功','getClientIp','HttpStatus','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','admin','checkRateLimit','findCurrentEnlargeImgResult','components','发送绘画指令结果:\x20','../userBalance/balance.entity','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','../chatLog/chatLog.service','pollForVariationResult','sleep','convertToEnglish','变换当前图片失败','sendSmInteractions','post','user','error:\x20','findCurrentPromptResult','259821bXaqxO','BadwordsService','当前图片没有绘画信息、无法放大!','match','开始请求用户','where','baiduFanyiSecret','filter','design:paramtypes','24kJZYHk','当前用户','放大当前图片失败','ChatLogService','../../common/constants/balance.constant','uploadFileFromUrl','__decorate','error','当前用户\x20','本次绘图耗时:\x20','https://discord.com/api/v9/interactions','map','本次比对的随机ID:\x20','63HGTEkB','execute','../fanyi/fanyi.service','draw','https://discord.com/api/v9/channels/','data','../badwords/badwords.service','历史中存在当前图片、直接获取！','UploadService','baiduFanyiAppId','开始查询绘画结果轮询','ChatLogEntity','balance','uploadService','\x20队列+1:\x20','当前图片已经放大过了、请勿重复放大!','PAINT_TYPE','../../common/utils','\x20次开始查询\x20=>\x20当前查询结果：','max','queueCount','__param','prompt','历史这些id已经被获取过了\x20不能拿了:\x20','sendDrawInteractions','1492ZEPNJG','10uGmrlE','axios:\x20','get','chatLogEntity','858528VvyzAS','update','__metadata','createQueryBuilder','defineProperty','orderId','HttpException','绘制图片任务结束\x20队列-1:\x20','mjId','parse','onModuleInit','MjService','\x20次开始查询','./../globalConfig/globalConfig.service','BAD_REQUEST','有历史信息之间返回:\x20','存入图片完成:\x20','历史记录中不存在当前图片、请确认您放大的图片是否存在','mjNotSaveImg','set','findCurrentVariationImgResult','mjProxy','findOne','BalanceEntity','放大单张图片请求失败...','Injectable','mjAuthorization','prompt\x20','enlargeWorking','mjVersion','fanyiService','1214423ieDNVn','mjSessionId','mjGuildId','开始请求放大图片\x20队列+1:\x20','Not','http://172.247.48.137:8000/mj/list?channel_id=','4403377RpqXFM','freeQueueUsers','绘画失败','url','变换图片任务结束\x20队列-1:\x20','chatLogService','秒请求一次、请合理使用！','function','extractContent','catch','http://172.247.48.137:8000/mj/draw','find','/messages?limit=50','使用的次数：','floor','放大custom_id:\x20','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','InjectRepository','./../upload/upload.service','randomId:\x20','variationSingleImg','checkAuth','23604pHIEqO','getMjDefaultParams','log','getConfigs','object','userId\x20=\x20:userId','typeorm','queryMessageList','enlarge','default','saveChatLog','DeductionKey','removeEmoji','super','includes','开始轮询单张变换图片结果','查询期间出现错误：','2PzuZYc','metadata','drawWorking','message_id','GlobalConfigService','mjApplicationId','mjChannelId','response','stringify','../chatLog/chatLog.entity','Like','message','pollForUpscaleResult'];_0x2bdc=function(){return _0x2ff29a;};return _0x2bdc();}Object[_0x3c83be(0x10d)](exports,'__esModule',{'value':!![]}),exports['MjService']=void 0x0;const globalConfig_service_1=require(_0x3c83be(0x116)),upload_service_1=require(_0x3c83be(0x140)),common_1=require(_0x3c83be(0x16d)),axios_1=require(_0x3c83be(0x168)),chatLog_service_1=require(_0x3c83be(0xcb)),balance_constant_1=require(_0x3c83be(0xe2)),utils_1=require(_0x3c83be(0xfc)),chatLog_entity_1=require(_0x3c83be(0x15e)),typeorm_1=require(_0x3c83be(0x14a)),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x3c83be(0xc9)),fanyi_service_1=require(_0x3c83be(0xed)),badwords_service_1=require(_0x3c83be(0xf1));let MjService=class MjService{constructor(_0x22d03f,_0x1998d6,_0x11df99,_0x5bc828,_0x42fe9c,_0x594764,_0x151ae){const _0x45a77a=_0x3c83be;this[_0x45a77a(0x108)]=_0x22d03f,this[_0x45a77a(0xb5)]=_0x1998d6,this[_0x45a77a(0xf8)]=_0x11df99,this['chatLogService']=_0x5bc828,this[_0x45a77a(0xbf)]=_0x42fe9c,this[_0x45a77a(0x127)]=_0x594764,this[_0x45a77a(0xbb)]=_0x151ae,this[_0x45a77a(0x166)]={},this['drawWorking']=[],this[_0x45a77a(0x125)]=[],this['queueCount']=0x0,this[_0x45a77a(0x12f)]={};}async[_0x3c83be(0x113)](){}['handleDrawTest'](_0x346c65,_0x2a4a35){}async[_0x3c83be(0xee)](_0x108c16,_0x36e723){const _0x37a525=_0x3c83be;await this[_0x37a525(0x143)](_0x36e723),await this['badwordsService'][_0x37a525(0x162)](_0x108c16[_0x37a525(0x101)],_0x36e723['user']['id']);const _0x218210=_0x108c16['prompt'];let _0x147adb=_0x108c16[_0x37a525(0x101)];const {baiduFanyiAppId:_0x27d621,baiduFanyiSecret:_0xc50a31}=await this[_0x37a525(0xbf)]['getConfigs']([_0x37a525(0xf4),_0x37a525(0xdb)]);_0x27d621&&_0xc50a31&&(_0x147adb=await this[_0x37a525(0x127)][_0x37a525(0xce)](_0x218210));const _0x432f38='['+(0x0,utils_1['createRandomUid'])()+']',_0x48bcf4=_0x432f38+'\x20'+_0x147adb;console[_0x37a525(0x146)](_0x37a525(0x141),_0x432f38),console[_0x37a525(0x146)](_0x37a525(0x124),_0x48bcf4);const _0x1ba6f6=this[_0x37a525(0x157)][_0x37a525(0x139)](_0x39e1c2=>_0x39e1c2[_0x37a525(0x152)](_0x108c16[_0x37a525(0x101)]));if(_0x1ba6f6)throw new common_1[(_0x37a525(0x10f))](_0x37a525(0x16a),common_1[_0x37a525(0xc2)][_0x37a525(0x117)]);if(this['queueCount']>=0x3)throw new common_1['HttpException'](_0x37a525(0x13e),common_1[_0x37a525(0xc2)][_0x37a525(0x117)]);await this['checkRateLimit'](_0x36e723),this[_0x37a525(0xff)]++,console[_0x37a525(0x146)](_0x37a525(0xd9)+_0x36e723[_0x37a525(0xd2)]['id']+_0x37a525(0xf9),this[_0x37a525(0xff)]);try{const _0x1e048d=await this['chatLogEntity'][_0x37a525(0x139)]({'where':{'prompt':(0x0,typeorm_1[_0x37a525(0x15f)])('%'+_0x48bcf4+'%')}}),_0xb7097f=_0x1e048d[_0x37a525(0xe9)](_0xa9f58f=>_0xa9f58f['message_id']);this['drawWorking']['push'](_0x48bcf4);let _0x836db8;const _0x464e74=await this[_0x37a525(0x103)](_0x48bcf4,_0xb7097f,_0x432f38);_0x464e74?(console[_0x37a525(0x146)](_0x37a525(0xf2)),_0x836db8=_0x464e74):_0x836db8=await this[_0x37a525(0xb4)](_0x48bcf4,_0xb7097f,_0x432f38);console['log'](_0x836db8),this[_0x37a525(0xff)]--,this[_0x37a525(0xff)]<0x0&&(this[_0x37a525(0xff)]=0x0),console[_0x37a525(0x146)](_0x37a525(0x110),this[_0x37a525(0xff)]);const {id:_0x5ee774,content:_0x1949c2,channel_id:_0x36ec19,attachments:attachments=[],timestamp:_0x513f36}=_0x836db8;if(!attachments['length']||!attachments[0x0][_0x37a525(0x131)])throw new common_1[(_0x37a525(0x10f))](_0x37a525(0x130),common_1['HttpStatus'][_0x37a525(0x117)]);const {filename:_0x583a28,url:_0x90ab1b,width:_0x213edf,height:_0x56327b,size:_0x56d080}=attachments[0x0];console[_0x37a525(0x146)]('拿到了远程地址:\x20',_0x90ab1b);const _0x2a3543=this[_0x37a525(0xbf)][_0x37a525(0x147)]([_0x37a525(0x11b)]);let _0x2a27b7='';(!Number(_0x2a3543)||Number(_0x2a3543)===0x0)&&(_0x2a27b7=await this['uploadService'][_0x37a525(0xe3)]({'filename':_0x583a28,'url':_0x90ab1b}),console[_0x37a525(0x146)](_0x37a525(0x119),_0x2a27b7));const _0x4be698={'mode':0x1,'curIp':(0x0,utils_1[_0x37a525(0xc1)])(_0x36e723),'userId':_0x36e723[_0x37a525(0xd2)]['id'],'type':balance_constant_1[_0x37a525(0x14f)]['PAINT_TYPE'],'prompt':_0x48bcf4,'answer':_0x2a27b7,'model':'mj','extend':this[_0x37a525(0x150)](JSON[_0x37a525(0x15d)](_0x836db8)),'message_id':_0x5ee774,'variationId':_0x5ee774,'upscaleId':_0x5ee774,'group':0x1,'isSaveImg':!Number(_0x2a3543)||Number(_0x2a3543)===0x0,'fileInfo':JSON[_0x37a525(0x15d)]({'width':_0x213edf,'height':_0x56327b,'size':_0x56d080,'filename':_0x583a28,'cosUrl':_0x2a27b7})};return await this[_0x37a525(0x133)][_0x37a525(0x14e)](_0x4be698),await this[_0x37a525(0xba)](_0x36e723),this[_0x37a525(0x157)]=this['drawWorking'][_0x37a525(0xdc)](_0x4c0c12=>_0x4c0c12!==_0x108c16[_0x37a525(0x101)]),_0x2a27b7;}catch(_0x1f9c06){this[_0x37a525(0xff)]--,this['queueCount']<0x0&&(this[_0x37a525(0xff)]=0x0),console[_0x37a525(0x146)]('绘制图片任务异常中断\x20队列-1:\x20',this['queueCount']),this['drawWorking']=this[_0x37a525(0x157)][_0x37a525(0xdc)](_0x22197e=>_0x22197e!==_0x108c16['prompt']);throw new common_1[(_0x37a525(0x10f))](_0x1f9c06[_0x37a525(0x15c)],common_1[_0x37a525(0xc2)]['BAD_REQUEST']);}}async['upscaleSingleImg'](_0x5a2029,_0x4ab366){const _0x1739c5=_0x3c83be;if(this['queueCount']>=0x3)throw new common_1[(_0x1739c5(0x10f))](_0x1739c5(0x13e),common_1[_0x1739c5(0xc2)][_0x1739c5(0x117)]);this[_0x1739c5(0xff)]++,console['log']('用户'+_0x4ab366[_0x1739c5(0xd2)]['id']+_0x1739c5(0x12b),this[_0x1739c5(0xff)]);const {message_id:_0x4fc78e,orderId:_0x6bbf30}=_0x5a2029;try{const _0x5a3ab2=await this[_0x1739c5(0x108)]['findOne']({'where':{'message_id':_0x4fc78e}});if(!_0x5a3ab2)throw new common_1[(_0x1739c5(0x10f))](_0x1739c5(0x11a),common_1[_0x1739c5(0xc2)]['BAD_REQUEST']);const _0x49aed3=await this[_0x1739c5(0x108)]['findOne']({'where':{'upscaleId':_0x4fc78e,'action':_0x1739c5(0x14c),'orderId':_0x6bbf30}});if(_0x49aed3)throw new common_1[(_0x1739c5(0x10f))](_0x1739c5(0xfa),common_1['HttpStatus'][_0x1739c5(0x117)]);const {prompt:_0x3c97cf,extend:_0x201420}=_0x5a3ab2,_0x3d852c=JSON[_0x1739c5(0x112)](_0x201420),{components:components=[]}=_0x3d852c;if(!components[_0x1739c5(0xb6)])throw new common_1[(_0x1739c5(0x10f))](_0x1739c5(0xd7),common_1[_0x1739c5(0xc2)]['BAD_REQUEST']);const _0x1167e6=components[0x0]['components'][_0x6bbf30-0x1],{custom_id:_0x2b9460}=_0x1167e6;console[_0x1739c5(0x146)](_0x1739c5(0x13d),_0x2b9460);const _0x26ff9b={'message_id':_0x4fc78e,'custom_id':_0x2b9460,'prompt':_0x3c97cf,'orderId':_0x6bbf30};await this[_0x1739c5(0xd0)](_0x26ff9b),console[_0x1739c5(0x146)](_0x1739c5(0xc0));const _0x2d5272=await this[_0x1739c5(0x108)][_0x1739c5(0x139)]({'where':{'prompt':(0x0,typeorm_1[_0x1739c5(0x15f)])('%'+_0x3c97cf+'%')}}),_0x3c340d=_0x2d5272[_0x1739c5(0xe9)](_0x2a5221=>_0x2a5221[_0x1739c5(0x158)]);console[_0x1739c5(0x146)](_0x1739c5(0x102),_0x3c340d);const _0x48365a=await this[_0x1739c5(0x161)](_0x26ff9b,_0x3c340d);this[_0x1739c5(0xff)]--,this[_0x1739c5(0xff)]<0x0&&(this[_0x1739c5(0xff)]=0x0),console['log']('放大图片任务结束\x20队列-1:\x20',this[_0x1739c5(0xff)]);const {id:_0x2faa64,content:_0x32f1b4,channel_id:_0x95d3bc,attachments:attachments=[],timestamp:_0x47e363}=_0x48365a;if(!attachments[_0x1739c5(0xb6)]||!attachments[0x0][_0x1739c5(0x131)])throw new common_1['HttpException'](_0x1739c5(0xe0),common_1[_0x1739c5(0xc2)][_0x1739c5(0x117)]);const {filename:_0x13f454,url:_0x4bd284,width:_0x41ae96,height:_0x4ab71a,size:_0xbdaf8d}=attachments[0x0],_0x1ca644=this[_0x1739c5(0xbf)][_0x1739c5(0x147)]([_0x1739c5(0x11b)]);let _0x32b7c3='';(!Number(_0x1ca644)||Number(_0x1ca644)===0x0)&&(_0x32b7c3=await this[_0x1739c5(0xf8)][_0x1739c5(0xe3)]({'filename':_0x13f454,'url':_0x4bd284}),console[_0x1739c5(0x146)]('存入图片完成:\x20',_0x32b7c3));const _0x4b1edb={'curIp':(0x0,utils_1[_0x1739c5(0xc1)])(_0x4ab366),'userId':_0x4ab366[_0x1739c5(0xd2)]['id'],'type':balance_constant_1[_0x1739c5(0x14f)][_0x1739c5(0xfb)],'prompt':_0x3c97cf,'answer':_0x32b7c3,'model':'mj','extend':this[_0x1739c5(0x150)](JSON[_0x1739c5(0x15d)](_0x48365a)),'message_id':_0x4fc78e,'upscaleId':_0x2faa64,'variationId':_0x2faa64,'action':_0x1739c5(0x14c),'orderId':_0x26ff9b[_0x1739c5(0x10e)],'isSaveImg':!Number(_0x1ca644)||Number(_0x1ca644)===0x0,'fileInfo':JSON[_0x1739c5(0x15d)]({'width':_0x41ae96,'height':_0x4ab71a,'size':_0xbdaf8d,'filename':_0x13f454,'cosUrl':_0x32b7c3})};return await this['chatLogService'][_0x1739c5(0x14e)](_0x4b1edb),_0x32b7c3;}catch(_0x50bac7){console['log'](_0x1739c5(0xd3),_0x50bac7),this['queueCount']--,this[_0x1739c5(0xff)]<0x0&&(this[_0x1739c5(0xff)]=0x0),console[_0x1739c5(0x146)]('放大图片任务异常中断\x20队列-1:\x20',this['queueCount']);throw new common_1['HttpException'](_0x50bac7[_0x1739c5(0x15c)],common_1[_0x1739c5(0xc2)][_0x1739c5(0x117)]);}}async[_0x3c83be(0x142)](_0x439e45,_0x336e16){const _0x4f8961=_0x3c83be;if(this[_0x4f8961(0xff)]>=0x3)throw new common_1['HttpException'](_0x4f8961(0x13e),common_1[_0x4f8961(0xc2)][_0x4f8961(0x117)]);await this['checkAuth'](_0x336e16),await this[_0x4f8961(0xc5)](_0x336e16),this[_0x4f8961(0xff)]++,console[_0x4f8961(0x146)]('用户'+_0x336e16[_0x4f8961(0xd2)]['id']+_0x4f8961(0xb9),this['queueCount']);const {message_id:_0x384201,orderId:_0x53abfd}=_0x439e45;try{const _0x5a13c5=await this['chatLogEntity']['findOne']({'where':{'message_id':_0x384201}});if(!_0x5a13c5)throw new common_1[(_0x4f8961(0x10f))](_0x4f8961(0xc3),common_1['HttpStatus'][_0x4f8961(0x117)]);const {prompt:_0x4f8ad7,extend:_0x2bf80b}=_0x5a13c5,_0x459048=JSON['parse'](_0x2bf80b),{components:components=[]}=_0x459048;if(!components[_0x4f8961(0xb6)])throw new common_1[(_0x4f8961(0x10f))]('当前图片没有绘画信息、无法变体!',common_1[_0x4f8961(0xc2)][_0x4f8961(0x117)]);const _0x2cd4da=components[0x1][_0x4f8961(0xc7)][_0x53abfd-0x1],{custom_id:_0x509509}=_0x2cd4da,_0x4841cd=await this[_0x4f8961(0x108)]['find']({'where':{'variationId':(0x0,typeorm_1[_0x4f8961(0x12c)])((0x0,typeorm_1['IsNull'])()),'prompt':(0x0,typeorm_1['Like'])('%'+_0x4f8ad7+'%')}}),_0x2d7441=_0x4841cd['map'](_0x49e00f=>_0x49e00f['variationId']),_0x57452e={'message_id':_0x384201,'custom_id':_0x509509,'prompt':_0x4f8ad7,'orderId':_0x53abfd};await this[_0x4f8961(0xd0)](_0x57452e);const _0x5c36a9=await this['pollForVariationResult'](_0x57452e,_0x2d7441);this[_0x4f8961(0xff)]--,this['queueCount']<0x0&&(this[_0x4f8961(0xff)]=0x0),console['log'](_0x4f8961(0x132),this[_0x4f8961(0xff)]);const {id:_0x2a25c0,content:_0x28b3ae,channel_id:_0x18e979,attachments:attachments=[],timestamp:_0x46f0e2}=_0x5c36a9;if(!attachments[_0x4f8961(0xb6)]||!attachments[0x0]['url'])throw new common_1[(_0x4f8961(0x10f))](_0x4f8961(0xcf),common_1[_0x4f8961(0xc2)]['BAD_REQUEST']);const {filename:_0x236f1a,url:_0x9dfde7,width:_0x598ca7,height:_0x4e1bfe,size:_0x50ac71}=attachments[0x0],_0x1180a8=this[_0x4f8961(0xbf)][_0x4f8961(0x147)]([_0x4f8961(0x11b)]);let _0x3729c4='';(!Number(_0x1180a8)||Number(_0x1180a8)===0x0)&&(_0x3729c4=await this['uploadService'][_0x4f8961(0xe3)]({'filename':_0x236f1a,'url':_0x9dfde7}),console[_0x4f8961(0x146)](_0x4f8961(0x119),_0x3729c4));const _0x5befe5={'curIp':(0x0,utils_1[_0x4f8961(0xc1)])(_0x336e16),'userId':_0x336e16[_0x4f8961(0xd2)]['id'],'type':balance_constant_1[_0x4f8961(0x14f)][_0x4f8961(0xfb)],'prompt':_0x4f8ad7,'answer':_0x3729c4,'model':'mj','group':0x1,'extend':this[_0x4f8961(0x150)](JSON[_0x4f8961(0x15d)](_0x5c36a9)),'message_id':_0x2a25c0,'upscaleId':_0x2a25c0,'variationId':_0x2a25c0,'action':_0x4f8961(0x14c),'orderId':_0x57452e[_0x4f8961(0x10e)],'isSaveImg':!Number(_0x1180a8)||Number(_0x1180a8)===0x0,'fileInfo':JSON[_0x4f8961(0x15d)]({'width':_0x598ca7,'height':_0x4e1bfe,'size':_0x50ac71,'filename':_0x236f1a,'cosUrl':_0x3729c4})};return await this[_0x4f8961(0x133)][_0x4f8961(0x14e)](_0x5befe5),_0x3729c4;}catch(_0x5e92f9){console[_0x4f8961(0x146)]('error:\x20',_0x5e92f9),this['queueCount']--,this[_0x4f8961(0xff)]<0x0&&(this[_0x4f8961(0xff)]=0x0),console[_0x4f8961(0x146)]('变化图片任务异常中断\x20队列-1:\x20',this[_0x4f8961(0xff)]);throw new common_1['HttpException'](_0x5e92f9[_0x4f8961(0x15c)],common_1[_0x4f8961(0xc2)][_0x4f8961(0x117)]);}}async[_0x3c83be(0xd0)](_0x4a1ea6){const _0x78a9ed=_0x3c83be,{message_id:_0x28eb7a,custom_id:_0x230111}=_0x4a1ea6,{application_id:_0x300a13,guild_id:_0x3896a2,channel_id:_0x34435c,session_id:_0x4baeb9,version:_0x6e94ea,id:_0x354de0,authorization:_0x42d9bb,mjProxy:_0x547ca2}=await this[_0x78a9ed(0x145)](),_0x2f1f30=_0x547ca2==0x1?_0x78a9ed(0x138):_0x78a9ed(0xe8),_0xcd3f7e={'authorization':_0x42d9bb},_0x485ab2={'type':0x3,'guild_id':_0x3896a2,'channel_id':_0x34435c,'message_flags':0x0,'message_id':_0x28eb7a,'application_id':_0x300a13,'session_id':_0x4baeb9,'data':{'component_type':0x2,'custom_id':_0x230111}};try{await axios_1[_0x78a9ed(0x14d)]['post'](_0x2f1f30,_0x485ab2,{'headers':_0xcd3f7e}),console[_0x78a9ed(0x146)]('绘图指令完成');}catch(_0x16e933){console[_0x78a9ed(0x146)](_0x78a9ed(0xd3),_0x16e933);throw new common_1[(_0x78a9ed(0x10f))](_0x78a9ed(0x121),common_1[_0x78a9ed(0xc2)][_0x78a9ed(0x117)]);}}async[_0x3c83be(0x161)](_0x38f43f,_0x244973){const _0x29eac1=_0x3c83be,{message_id:_0x3e1a11,custom_id:_0x5172fb,prompt:_0x597091,orderId:_0x18cf30}=_0x38f43f;let _0x5f348c=null,_0x428048=0x0;while(!_0x5f348c&&_0x428048<0xa){try{const _0x5195b3=Date[_0x29eac1(0x163)](),_0xc276eb=await this[_0x29eac1(0x14b)]();console['log']('第\x20'+(_0x428048+0x1)+_0x29eac1(0xfd)+_0xc276eb[_0x29eac1(0xb6)]);_0xc276eb&&_0xc276eb[_0x29eac1(0xb6)]&&(_0x5f348c=await this[_0x29eac1(0xc6)](_0xc276eb,_0x38f43f,_0x244973));const _0x1d1f58=Date[_0x29eac1(0x163)]()-_0x5195b3,_0x264712=0xbb8;await this['sleep'](Math[_0x29eac1(0xfe)](_0x264712-_0x1d1f58,0x0)),_0x428048++;}catch(_0x430800){console[_0x29eac1(0xe5)](_0x29eac1(0x154)+_0x430800['message']);}}return _0x5f348c;}async[_0x3c83be(0xcc)](_0x4a3cf4,_0x341b9f){const _0x363531=_0x3c83be,{message_id:_0x212a46,custom_id:_0x1a3114,prompt:_0x269c6b,orderId:_0x274f09}=_0x4a3cf4;console[_0x363531(0x146)](_0x363531(0x153));let _0x2f151=null,_0x2e9673=0x0;while(!_0x2f151&&_0x2e9673<0xa){try{console[_0x363531(0x146)]('第\x20'+(_0x2e9673+0x1)+_0x363531(0x16c));const _0x4feb61=Date[_0x363531(0x163)](),_0x1f8554=await this[_0x363531(0x14b)]();_0x1f8554&&_0x1f8554[_0x363531(0xb6)]&&(_0x2f151=await this[_0x363531(0x11d)](_0x1f8554,_0x4a3cf4,_0x341b9f));const _0x131574=Date[_0x363531(0x163)]()-_0x4feb61,_0x59eba9=0x1f40;await this['sleep'](Math[_0x363531(0xfe)](_0x59eba9-_0x131574,0x0)),_0x2e9673++;}catch(_0x485c98){console[_0x363531(0xe5)](_0x363531(0x154)+_0x485c98[_0x363531(0x160)]);}}if(!_0x2f151)throw new common_1['HttpException']('变换当前图片超时！',common_1[_0x363531(0xc2)]['BAD_REQUEST']);return _0x2f151;}async['findCurrentEnlargeImgResult'](_0x4f8a22,_0x4364c8,_0x1a8bf1){const _0xb52d36=_0x3c83be,{message_id:_0x33ee97,custom_id:_0xc68f36,prompt:_0x142867,orderId:_0x45efaf}=_0x4364c8,_0x8d8e9a=_0x142867['substring'](0x0,0xc);console[_0xb52d36(0x146)]('本次放大图片的id:\x20',_0x8d8e9a);const _0x34c123=_0x4f8a22[_0xb52d36(0x139)](_0x1d9bfa=>{const _0x344ef2=_0xb52d36,{content:_0x51f4a6}=_0x1d9bfa;if(!this[_0x344ef2(0x136)](_0x51f4a6))return![];const {prompt:_0x5140ce,order:_0x643575}=this[_0x344ef2(0x136)](_0x51f4a6);return _0x5140ce[_0x344ef2(0x152)](_0x8d8e9a)&&_0x4364c8[_0x344ef2(0x10e)]===_0x643575&&!_0x1a8bf1[_0x344ef2(0x152)](_0x1d9bfa['id']);});return _0x34c123;}async[_0x3c83be(0x11d)](_0x4aa6ff,_0x20fce9,_0xac9ac3){const _0x3bb559=_0x3c83be,{message_id:_0x1cd4a4,custom_id:_0x234c4b,prompt:_0x414df1,orderId:_0x1ab971}=_0x20fce9,_0xb82f77=_0x414df1['substring'](0x0,0xc),_0x4970f7=_0x4aa6ff[_0x3bb559(0x139)](_0x2bda02=>{const _0x143c6a=_0x3bb559,{content:_0x1886ac}=_0x2bda02,_0xe725d2=_0x1886ac['match'](/\*\*(.+?)\*\*/),_0x151a9a=_0xe725d2?_0xe725d2[0x1]:'';if(!_0x151a9a)return![];return _0x151a9a[_0x143c6a(0x152)](_0xb82f77)&&!_0xac9ac3['includes'](_0x2bda02['id']);});return _0x4970f7;}async[_0x3c83be(0x103)](_0x445146,_0x1fec27,_0x4e055c){const _0x2d2e29=_0x3c83be,_0x287cf0=await this['queryMessageList'](),_0x1aeb02=await this[_0x2d2e29(0xd4)](_0x287cf0,_0x4e055c,_0x1fec27);if(_0x1aeb02)return console[_0x2d2e29(0x146)](_0x2d2e29(0x118),_0x1aeb02),_0x1aeb02;const {application_id:_0x4de077,guild_id:_0x3ecd93,channel_id:_0x12f0ab,session_id:_0x13f6c5,version:_0x49685c,id:_0x110655,authorization:_0x40ddb3,mjProxy:_0x3943db}=await this[_0x2d2e29(0x145)](),_0x164fc2={'type':0x2,'application_id':_0x4de077,'guild_id':_0x3ecd93,'channel_id':_0x12f0ab,'session_id':_0x13f6c5,'data':{'version':_0x49685c,'id':_0x110655,'name':_0x2d2e29(0xbd),'type':0x1,'options':[{'type':0x3,'name':_0x2d2e29(0x101),'value':_0x445146}],'attachments':[]}};try{const _0x6d7d70=_0x3943db==0x1?'http://172.247.48.137:8000/mj/draw':_0x2d2e29(0xe8),_0x18c0ed={'authorization':_0x40ddb3},_0x2a2084=await axios_1[_0x2d2e29(0x14d)][_0x2d2e29(0xd1)](_0x6d7d70,_0x164fc2,{'headers':_0x18c0ed});return console[_0x2d2e29(0x146)](_0x2d2e29(0xc8),_0x2a2084[_0x2d2e29(0xf0)]),![];}catch(_0xf0a058){console['log'](_0x2d2e29(0x106),_0xf0a058);throw new common_1[(_0x2d2e29(0x10f))](_0x2d2e29(0xca),common_1[_0x2d2e29(0xc2)][_0x2d2e29(0x117)]);}}async[_0x3c83be(0xb4)](_0x35fea9,_0x36d10a,_0x3c1aa6){const _0x5e8384=_0x3c83be;console[_0x5e8384(0x146)](_0x5e8384(0xf5));const _0x6e3221=Date[_0x5e8384(0x163)]();try{const _0x2b7551=0xd,_0x3b1b98=0x2ee0,_0x5de50d=0x1388,_0xbc0af4=0x3c*0x3e8;let _0xbf6806=0x0,_0x17a62a=![],_0x3f5d9e=null;while(!_0x3f5d9e&&_0xbf6806<_0x2b7551){console[_0x5e8384(0x146)]('第\x20'+(_0xbf6806+0x1)+_0x5e8384(0x115));Date[_0x5e8384(0x163)]()-_0x6e3221>=_0xbc0af4&&(_0x17a62a=!![]);await this[_0x5e8384(0xcd)](_0x17a62a?_0x5de50d:_0x3b1b98);const _0x1a45bf=await this[_0x5e8384(0x14b)]();_0x3f5d9e=await this[_0x5e8384(0xd4)](_0x1a45bf,_0x3c1aa6,_0x36d10a),_0xbf6806++;}if(!_0x3f5d9e)throw new common_1[(_0x5e8384(0x10f))]('绘画超时，请稍后再试！',common_1[_0x5e8384(0xc2)]['BAD_REQUEST']);const _0x21885a=Date[_0x5e8384(0x163)]();return console['log'](_0x5e8384(0xe7)+Math[_0x5e8384(0x13c)]((_0x21885a-_0x6e3221)/0x3e8)+'\x20S'),_0x3f5d9e;}catch(_0x3a3cd0){console[_0x5e8384(0xe5)](_0x3a3cd0['message']);throw new common_1['HttpException'](_0x5e8384(0x164),common_1[_0x5e8384(0xc2)]['INTERNAL_SERVER_ERROR']);}}async[_0x3c83be(0xd4)](_0x49f5a5,_0x27f6c3,_0x47984e){const _0x33974c=_0x3c83be;if(!_0x49f5a5||!_0x49f5a5[_0x33974c(0xb6)])return;console[_0x33974c(0x146)](_0x33974c(0xea),_0x27f6c3);const _0x1b1622=_0x49f5a5['find'](_0x5520f8=>{const _0x4833de=_0x33974c,{attachments:attachments=[],content:_0x22bc6a,edited_timestamp:_0x17eac8}=_0x5520f8;return _0x22bc6a[_0x4833de(0x152)](_0x27f6c3)&&attachments[_0x4833de(0xb6)]>0x0&&!_0x17eac8&&!_0x47984e[_0x4833de(0x152)](_0x5520f8['id']);});return _0x1b1622||null;}async['queryMessageList'](){const _0xf45532=_0x3c83be;try{const {application_id:_0x909220,guild_id:_0x2ad3f9,channel_id:_0x1b7ce8,session_id:_0x2cc74f,version:_0x34d30f,id:_0x4e51cb,authorization:_0x31ace4,mjProxy:_0x5beaa0}=await this[_0xf45532(0x145)](),_0x1cc9ad=_0x5beaa0==0x1?_0xf45532(0x12d)+_0x1b7ce8:_0xf45532(0xef)+_0x1b7ce8+_0xf45532(0x13a),_0x1cddff={'authorization':_0x31ace4},_0x142f25=await axios_1[_0xf45532(0x14d)][_0xf45532(0x107)](_0x1cc9ad,{'headers':_0x1cddff});return _0x142f25['data'];}catch(_0x580056){console[_0xf45532(0x146)](_0xf45532(0x16b),_0x580056);throw new common_1[(_0xf45532(0x10f))](_0xf45532(0xb8),common_1['HttpStatus'][_0xf45532(0x117)]);}}async[_0x3c83be(0xcd)](_0x1e1c2b){return new Promise(_0x1da586=>setTimeout(_0x1da586,_0x1e1c2b));}[_0x3c83be(0x136)](_0x1173fc){const _0x5a9b46=_0x3c83be,_0x28c1a7=_0x1173fc[_0x5a9b46(0xd8)](/\*\*(.+?)\*\*/),_0x38ee70=_0x1173fc['match'](/- Image #(\d+)/);if(!_0x28c1a7||!_0x38ee70)return null;const _0x535267=_0x28c1a7[0x1],_0x20f8f8=parseInt(_0x38ee70[0x1]);return{'prompt':_0x535267,'order':_0x20f8f8};}async['getMjDefaultParams'](){const _0x48c3eb=_0x3c83be,_0x5a052d=await this[_0x48c3eb(0xbf)]['getConfigs']([_0x48c3eb(0x111),_0x48c3eb(0x15a),_0x48c3eb(0x12a),'mjChannelId',_0x48c3eb(0x129),_0x48c3eb(0x126),_0x48c3eb(0x123),_0x48c3eb(0xbe),_0x48c3eb(0x11e)]),_0x4bfb4b={'application_id':_0x5a052d['mjApplicationId'],'guild_id':_0x5a052d[_0x48c3eb(0x12a)],'channel_id':_0x5a052d[_0x48c3eb(0x15b)],'session_id':_0x5a052d[_0x48c3eb(0x129)],'version':_0x5a052d[_0x48c3eb(0x126)],'id':_0x5a052d[_0x48c3eb(0x111)],'authorization':_0x5a052d[_0x48c3eb(0x123)],'mjRateLimit':_0x5a052d['mjRateLimit'],'mjProxy':_0x5a052d[_0x48c3eb(0x11e)]||0x0};return _0x4bfb4b;}[_0x3c83be(0x150)](_0x206e3d){const _0x17932b=_0x3c83be,_0x22c657=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x206e3d[_0x17932b(0xb7)](_0x22c657,'');}async[_0x3c83be(0x143)](_0x686903){const _0x2bc5f6=_0x3c83be,_0x524934=await this['balanceEntity'][_0x2bc5f6(0x11f)]({'where':{'userId':_0x686903[_0x2bc5f6(0xd2)]['id']}})[_0x2bc5f6(0x137)](_0x1c0c8b=>{const _0x76d8fd=_0x2bc5f6;common_1['Logger'][_0x76d8fd(0xe5)](_0x1c0c8b);});console[_0x2bc5f6(0x146)](_0x524934);if(!_0x524934)return![];const {id:_0x3c2839,balance:_0x4dbc7d}=_0x524934;if(!_0x4dbc7d||_0x524934?.[_0x2bc5f6(0xf7)]<0x1)throw new common_1[(_0x2bc5f6(0x10f))]('您当前暂无MJ绘画余额！！！',common_1[_0x2bc5f6(0xc2)][_0x2bc5f6(0x117)]);return!![];}async['checkFree'](_0x176b6d){const _0x1c55ba=_0x3c83be,{id:_0xda59a2,role:_0x48fcbc}=_0x176b6d[_0x1c55ba(0xd2)];!this[_0x1c55ba(0x12f)][_0xda59a2]?this[_0x1c55ba(0x12f)][_0xda59a2]=0x1:this[_0x1c55ba(0x12f)][_0xda59a2]=this[_0x1c55ba(0x12f)][_0xda59a2]+0x1,console[_0x1c55ba(0x146)](_0x1c55ba(0xdf)+_0xda59a2+_0x1c55ba(0x13b),this[_0x1c55ba(0x12f)][_0xda59a2]);}async['checkRateLimit'](_0x55536d){const _0x326b54=_0x3c83be,{id:_0xb3b38c,role:_0x21c360}=_0x55536d[_0x326b54(0xd2)];if([_0x326b54(0xc4),_0x326b54(0x151)][_0x326b54(0x152)](_0x21c360))return!![];const {mjRateLimit:_0x27f2fb}=await this[_0x326b54(0x145)]();if(this['rateLimits'][_0xb3b38c]){const _0x5e9604=this[_0x326b54(0x166)][_0xb3b38c];if(_0x5e9604>Date['now']()){console[_0x326b54(0x146)](_0x326b54(0xe6)+_0xb3b38c+'\x20请求过于频繁！');throw new common_1[(_0x326b54(0x10f))]('由于速率限制、当前普通用户限制为'+_0x27f2fb+_0x326b54(0x134),common_1[_0x326b54(0xc2)][_0x326b54(0x117)]);}else this[_0x326b54(0x166)][_0xb3b38c]=Date[_0x326b54(0x163)]()+Number(_0x27f2fb)*0x3e8;}else{const _0x3a0e6e=Date[_0x326b54(0x163)]();this[_0x326b54(0x166)][_0xb3b38c]=_0x3a0e6e+0x3e8*Number(_0x27f2fb);}}async[_0x3c83be(0xba)](_0x66e329){const _0x147c81=_0x3c83be;await this['balanceEntity'][_0x147c81(0x10c)]()[_0x147c81(0x10a)](balance_entity_1[_0x147c81(0x120)])[_0x147c81(0x11c)]({'balance':()=>_0x147c81(0x165)})[_0x147c81(0xda)](_0x147c81(0x149),{'userId':_0x66e329['user']['id']})[_0x147c81(0xec)]();}async[_0x3c83be(0xbc)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x3c83be(0x122)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1[_0x3c83be(0xf6)])),__param(0x1,(0x0,typeorm_2[_0x3c83be(0x13f)])(balance_entity_1[_0x3c83be(0x120)])),__metadata(_0x3c83be(0xdd),[typeorm_1[_0x3c83be(0x169)],typeorm_1[_0x3c83be(0x169)],upload_service_1[_0x3c83be(0xf3)],chatLog_service_1[_0x3c83be(0xe1)],globalConfig_service_1[_0x3c83be(0x159)],fanyi_service_1['FanyiService'],badwords_service_1[_0x3c83be(0xd6)]])],MjService),exports[_0x3c83be(0x114)]=MjService;