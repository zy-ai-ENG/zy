'use strict';const _0x5c3a76=_0x50d9;function _0x50d9(_0x2221e4,_0x45e805){const _0x363d11=_0x363d();return _0x50d9=function(_0x50d93c,_0x496815){_0x50d93c=_0x50d93c-0x191;let _0x11349a=_0x363d11[_0x50d93c];return _0x11349a;},_0x50d9(_0x2221e4,_0x45e805);}(function(_0x41e930,_0x16a097){const _0xbcd95f=_0x50d9,_0x6a8082=_0x41e930();while(!![]){try{const _0x40b7c4=parseInt(_0xbcd95f(0x198))/0x1*(parseInt(_0xbcd95f(0x1ed))/0x2)+parseInt(_0xbcd95f(0x1f2))/0x3+-parseInt(_0xbcd95f(0x1dc))/0x4*(-parseInt(_0xbcd95f(0x1bd))/0x5)+parseInt(_0xbcd95f(0x1a6))/0x6+parseInt(_0xbcd95f(0x1d3))/0x7+parseInt(_0xbcd95f(0x1c3))/0x8+parseInt(_0xbcd95f(0x1fa))/0x9*(-parseInt(_0xbcd95f(0x1d4))/0xa);if(_0x40b7c4===_0x16a097)break;else _0x6a8082['push'](_0x6a8082['shift']());}catch(_0x318875){_0x6a8082['push'](_0x6a8082['shift']());}}}(_0x363d,0x9fcd7));var __decorate=this&&this[_0x5c3a76(0x1df)]||function(_0x4cabfa,_0x9eadec,_0x57d155,_0x5cef66){const _0x2f1c19=_0x5c3a76;var _0x19eb62=arguments[_0x2f1c19(0x1c0)],_0xebcc96=_0x19eb62<0x3?_0x9eadec:_0x5cef66===null?_0x5cef66=Object['getOwnPropertyDescriptor'](_0x9eadec,_0x57d155):_0x5cef66,_0x539dfe;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0xebcc96=Reflect['decorate'](_0x4cabfa,_0x9eadec,_0x57d155,_0x5cef66);else{for(var _0x2d8e9b=_0x4cabfa['length']-0x1;_0x2d8e9b>=0x0;_0x2d8e9b--)if(_0x539dfe=_0x4cabfa[_0x2d8e9b])_0xebcc96=(_0x19eb62<0x3?_0x539dfe(_0xebcc96):_0x19eb62>0x3?_0x539dfe(_0x9eadec,_0x57d155,_0xebcc96):_0x539dfe(_0x9eadec,_0x57d155))||_0xebcc96;}return _0x19eb62>0x3&&_0xebcc96&&Object[_0x2f1c19(0x201)](_0x9eadec,_0x57d155,_0xebcc96),_0xebcc96;},__metadata=this&&this[_0x5c3a76(0x195)]||function(_0x2f99ee,_0x441bcf){const _0x128cc8=_0x5c3a76;if(typeof Reflect===_0x128cc8(0x1cd)&&typeof Reflect['metadata']==='function')return Reflect['metadata'](_0x2f99ee,_0x441bcf);},__param=this&&this[_0x5c3a76(0x1cf)]||function(_0x10dd6c,_0x2e3cdf){return function(_0x1eae82,_0x31da07){_0x2e3cdf(_0x1eae82,_0x31da07,_0x10dd6c);};};Object[_0x5c3a76(0x201)](exports,'__esModule',{'value':!![]}),exports['OrderService']=void 0x0;function _0x363d(){const _0x12fd2b=['9333312VLxiEK','TRADE_FINISHED','map','do\x20','HttpException','alipay','../redisCache/redisCache.service','@nestjs/common','userEntity','OrderEntity','object','./../user/user.entity','__param','queryAllOrder','AliPayStatus','PayService','1188530tbhnah','10UDAuAm','DESC','../../common/utils','REVOKED','BAD_REQUEST','message','syncOrder','design:paramtypes','630892zTqpaq','del','total_price','__decorate','total','PAYERROR','count','../crami/cramiPackage.entity','syncAliOrder','./dto/WxPayStatus.emun','channel','createOrderId','payService','订单不存在!','name','UserBalanceService','orderEntity','1006RgZngy','queryByOrderId','order','des','queryAliPay','2344848gCBxUy','CLOSED','InjectRepository','transaction','syncWeixinOrder','redisCacheService','where','userBalanceService','31643433JVRABX','CramiPackageEntity','Repository','findAndCount','pay','status','deleteOrder','defineProperty','orderId','GlobalConfigService','create','email','userId','RedisCacheService','PAY_UPDATE_ORDER','__metadata','wechat','payPlatform','1892CBapvF','SUM(order.price)','findOne','user','set','套餐不存在!','typeorm','log','SUCCESS','goodsId','getRawOne','addBalanceToOrder','find','cancel','5658114yGyRed','../pay/pay.service','@nestjs/typeorm','buyInMini','save','../globalConfig/globalConfig.service','buy','购买失败!','Connection','createQueryBuilder','UserEntity','get','../userBalance/userBalance.service','coverImg','connection','UNAUTHORIZED','price','goodsInfo','HttpStatus','globalConfigService','lock','WxPayStatus','请先注册账号后购买商品！','5QBFTcE','Injectable','queryPayType','length','OrderService','cramiPackageEntity'];_0x363d=function(){return _0x12fd2b;};return _0x363d();}const user_entity_1=require(_0x5c3a76(0x1ce)),typeorm_1=require(_0x5c3a76(0x1a8)),common_1=require(_0x5c3a76(0x1ca)),typeorm_2=require(_0x5c3a76(0x19e)),order_entity_1=require('./order.entity'),cramiPackage_entity_1=require(_0x5c3a76(0x1e3)),utils_1=require(_0x5c3a76(0x1d6)),pay_service_1=require(_0x5c3a76(0x1a7)),globalConfig_service_1=require(_0x5c3a76(0x1ab)),WxPayStatus_emun_1=require(_0x5c3a76(0x1e5)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),redisCache_service_1=require(_0x5c3a76(0x1c9)),userBalance_service_1=require(_0x5c3a76(0x1b2));let OrderService=class OrderService{constructor(_0x24c69b,_0x7fab00,_0x38aade,_0x408af1,_0x319218,_0x549868,_0x27387f,_0x12ac41){const _0x139843=_0x5c3a76;this[_0x139843(0x1ec)]=_0x24c69b,this[_0x139843(0x1c2)]=_0x7fab00,this[_0x139843(0x1cb)]=_0x38aade,this['payService']=_0x408af1,this['globalConfigService']=_0x319218,this[_0x139843(0x1f7)]=_0x549868,this[_0x139843(0x1f9)]=_0x27387f,this[_0x139843(0x1b4)]=_0x12ac41;}async[_0x5c3a76(0x1ac)](_0x29b189,_0x3063c4){const _0x4f1717=_0x5c3a76;try{const _0x2485df=_0x3063c4[_0x4f1717(0x19b)]['id'],{goodsId:_0x10c690,count:count=0x1,payType:_0x4a8f87,payPlatform:_0x1bc0ff}=_0x29b189;if(_0x2485df>0xf4240)throw new common_1[(_0x4f1717(0x1c7))](_0x4f1717(0x1bc),common_1[_0x4f1717(0x1b8)][_0x4f1717(0x1b5)]);const _0x2561a3=await this[_0x4f1717(0x204)](_0x2485df,_0x10c690,count,_0x4a8f87,_0x1bc0ff),_0x46bca3=await this['payService'][_0x4f1717(0x1fe)](_0x2485df,_0x2561a3[_0x4f1717(0x202)],_0x4a8f87);return{..._0x46bca3,'total':_0x2561a3['total'],'orderId':_0x2561a3[_0x4f1717(0x202)],'platform':_0x2561a3[_0x4f1717(0x197)]};}catch(_0x50223e){if(_0x50223e[_0x4f1717(0x1ff)]===0x191)throw new common_1[(_0x4f1717(0x1c7))](_0x50223e['message'],common_1[_0x4f1717(0x1b8)][_0x4f1717(0x1b5)]);throw new common_1[(_0x4f1717(0x1c7))](_0x50223e[_0x4f1717(0x1d9)]||_0x4f1717(0x1ad),common_1[_0x4f1717(0x1b8)][_0x4f1717(0x1d8)]);}}async[_0x5c3a76(0x1a9)](_0x3f77c4){const _0xe9a63d=_0x5c3a76;try{const {userId:_0x5d2851,goodsId:_0x40786d,count:count=0x1,payType:_0x5ad393,payPlatform:_0x2e5f5d}=_0x3f77c4,_0x1a0c0d=await this[_0xe9a63d(0x204)](_0x5d2851,_0x40786d,count,_0x5ad393,_0x2e5f5d),_0x305f50=await this['payService'][_0xe9a63d(0x1fe)](_0x5d2851,_0x1a0c0d[_0xe9a63d(0x202)],_0x5ad393);return{..._0x305f50,'orderId':_0x1a0c0d[_0xe9a63d(0x202)]};}catch(_0x539208){throw new common_1[(_0xe9a63d(0x1c7))](_0x539208[_0xe9a63d(0x1d9)],common_1[_0xe9a63d(0x1b8)][_0xe9a63d(0x1d8)]);}}async[_0x5c3a76(0x1ee)](_0x421609,_0x172a46){const _0x54dca3=_0x5c3a76,{id:_0x4ef1c0}=_0x421609['user'],{orderId:_0x2233d0}=_0x172a46;let _0x28caf4='',_0x1ec607=await this[_0x54dca3(0x1ec)][_0x54dca3(0x19a)]({'where':{'userId':_0x4ef1c0,'orderId':_0x2233d0}});if(_0x1ec607[_0x54dca3(0x1ff)]===0x0){await this[_0x54dca3(0x1da)](_0x1ec607),_0x1ec607=await this[_0x54dca3(0x1ec)][_0x54dca3(0x19a)]({'where':{'userId':_0x4ef1c0,'orderId':_0x2233d0}});const _0x3383bf=await this['cramiPackageEntity'][_0x54dca3(0x19a)]({'where':{'id':_0x1ec607[_0x54dca3(0x1a1)]}});_0x28caf4=_0x3383bf[_0x54dca3(0x1ea)];}if(!_0x1ec607)throw new common_1['HttpException'](_0x54dca3(0x1e9),common_1['HttpStatus']['BAD_REQUEST']);return{..._0x1ec607,'goodsName':_0x28caf4};}async[_0x5c3a76(0x204)](_0x18c904,_0x3a2c99,_0x34841e,_0x38b421,_0x56d02d){const _0x28387a=_0x5c3a76,_0xd65fed=await this[_0x28387a(0x1b9)][_0x28387a(0x1bf)](_0x56d02d),_0x20943d=await this[_0x28387a(0x1c2)][_0x28387a(0x19a)]({'where':{'id':_0x3a2c99}});if(!_0x20943d)throw new common_1['HttpException'](_0x28387a(0x19d),common_1[_0x28387a(0x1b8)]['BAD_REQUEST']);const _0x11c9a3={};_0x11c9a3['orderId']=(0x0,utils_1[_0x28387a(0x1e7)])(),console[_0x28387a(0x19f)](_0x28387a(0x1c6),_0x11c9a3['orderId']),_0x11c9a3['userId']=_0x18c904,_0x11c9a3['goodsId']=_0x3a2c99,_0x11c9a3[_0x28387a(0x1b6)]=Number(_0x20943d[_0x28387a(0x1b6)]),_0x11c9a3[_0x28387a(0x1e2)]=_0x34841e,_0x11c9a3[_0x28387a(0x1e0)]=Number(_0x20943d['price'])*_0x34841e,_0x11c9a3[_0x28387a(0x197)]=_0xd65fed,_0x11c9a3['channel']=_0x38b421;const _0x443629=await this[_0x28387a(0x1ec)]['save'](_0x11c9a3);return _0x443629;}async[_0x5c3a76(0x1a5)](_0x15b6e4){const _0x23ef39=_0x5c3a76;try{const _0x5bae86=await this['orderEntity'][_0x23ef39(0x19a)]({'where':{'orderId':_0x15b6e4}});if(!_0x5bae86)throw new Error('订单不存在！');await this[_0x23ef39(0x1e8)]['cancel'](_0x5bae86);}catch(_0x5eb942){throw new common_1['HttpException'](_0x5eb942[_0x23ef39(0x1d9)],common_1['HttpStatus']['BAD_REQUEST']);}}async['query'](_0x24d39c,_0x19f117,_0x2d29e5){const _0x342884=_0x5c3a76;return await this[_0x342884(0x1ec)][_0x342884(0x1fd)]({'where':{'userId':_0x24d39c},'order':{'id':_0x342884(0x1d5)},'skip':(_0x19f117-0x1)*_0x2d29e5,'take':_0x2d29e5});}async[_0x5c3a76(0x1d0)](_0x54e419){const _0x16d898=_0x5c3a76,{page:_0x28d005,size:_0x34ef17,userId:_0x24be77,platform:_0x115ea3,status:_0x1551ea}=_0x54e419,_0x3ae928={};if(_0x24be77)_0x3ae928['userId']=_0x24be77;if(_0x115ea3)_0x3ae928[_0x16d898(0x197)]=_0x115ea3;if(_0x1551ea)_0x3ae928['status']=_0x1551ea;const [_0x4d085b,_0x46b673]=await this[_0x16d898(0x1ec)][_0x16d898(0x1fd)]({'order':{'id':_0x16d898(0x1d5)},'where':_0x3ae928,'skip':(_0x28d005-0x1)*_0x34ef17,'take':_0x34ef17}),_0x1c1b43=_0x4d085b[_0x16d898(0x1c5)](_0x155071=>_0x155071['userId']),_0x4f58b3=_0x4d085b[_0x16d898(0x1c5)](_0x3b99dc=>_0x3b99dc['goodsId']),_0x5ce64a=await this[_0x16d898(0x1cb)][_0x16d898(0x1a4)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1c1b43)},'select':['id','username',_0x16d898(0x191)]}),_0x13b495=await this['cramiPackageEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x4f58b3)},'select':['id',_0x16d898(0x1ea),_0x16d898(0x1b3),_0x16d898(0x1f0)]});_0x4d085b['forEach'](_0xc5c32d=>{const _0x8040d7=_0x16d898;_0xc5c32d['userInfo']=_0x5ce64a[_0x8040d7(0x1a4)](_0x16c0c4=>_0x16c0c4['id']===_0xc5c32d[_0x8040d7(0x192)]),_0xc5c32d[_0x8040d7(0x1b7)]=_0x13b495['find'](_0x39e7be=>_0x39e7be['id']===_0xc5c32d['goodsId']);});const _0x1c7676=await this[_0x16d898(0x1ec)][_0x16d898(0x1af)](_0x16d898(0x1ef))['select'](_0x16d898(0x199),_0x16d898(0x1de))[_0x16d898(0x1f8)]('status\x20=\x201')[_0x16d898(0x1a2)]();return{'rows':_0x4d085b,'count':_0x46b673,..._0x1c7676};}['page4self'](_0x5e30e9,_0x2b9288){const _0xa1e6aa=_0x5c3a76,{id:_0x4219a9}=_0x2b9288['user'];return this[_0xa1e6aa(0x1d0)]({..._0x5e30e9,'userId':_0x4219a9});}async[_0x5c3a76(0x200)](_0x57ba79){const _0xbb2794=_0x5c3a76,{orderId:_0x14a224}=_0x57ba79,_0x16d45a=await this['orderEntity'][_0xbb2794(0x19a)]({'where':{'orderId':_0x14a224}});if(!_0x16d45a)throw new common_1['HttpException'](_0xbb2794(0x1e9),common_1[_0xbb2794(0x1b8)][_0xbb2794(0x1d8)]);return await this[_0xbb2794(0x1ec)]['delete']({'orderId':_0x14a224});}async['deleteNotPay'](){const _0x9d0ef3=_0x5c3a76;return await this[_0x9d0ef3(0x1ec)]['delete']({'status':0x0});}async[_0x5c3a76(0x1da)](_0x36d6e2){const _0x3764ad=_0x5c3a76;if(_0x36d6e2[_0x3764ad(0x197)]===_0x3764ad(0x1c8))return this[_0x3764ad(0x1e4)](_0x36d6e2);if(_0x36d6e2[_0x3764ad(0x197)]===_0x3764ad(0x196))return this[_0x3764ad(0x1f6)](_0x36d6e2);}async['syncAliOrder'](_0x862528){const _0x2181d2=_0x5c3a76,_0x1193be=redisKey_constant_1[_0x2181d2(0x194)]+_0x862528[_0x2181d2(0x202)],_0x6c72=await this['redisCacheService']['get']({'key':_0x1193be});if(_0x6c72)return;this[_0x2181d2(0x1f7)]['set']({'key':_0x1193be,'val':_0x2181d2(0x1ba)});const _0x4c0177=_0x862528[_0x2181d2(0x1e6)],_0x3d0116=await this[_0x2181d2(0x1e8)][_0x2181d2(0x1f1)](_0x862528[_0x2181d2(0x202)],_0x4c0177);switch(_0x3d0116['tradeStatus']){case WxPayStatus_emun_1['AliPayStatus']['TRADE_SUCCESS']:case WxPayStatus_emun_1[_0x2181d2(0x1d1)][_0x2181d2(0x1c4)]:{_0x862528['status']=0x1,await this[_0x2181d2(0x1b4)][_0x2181d2(0x1f5)](async _0x2edff8=>{const _0x2b638b=_0x2181d2;await this[_0x2b638b(0x1ec)][_0x2b638b(0x1aa)](_0x862528),await this[_0x2b638b(0x1f9)][_0x2b638b(0x1a3)](_0x862528);});break;}case WxPayStatus_emun_1['AliPayStatus']['TRADE_CLOSED']:{_0x862528[_0x2181d2(0x1ff)]=0x2,await this[_0x2181d2(0x1ec)][_0x2181d2(0x1aa)](_0x862528);break;}default:{}}return this[_0x2181d2(0x1f7)][_0x2181d2(0x1dd)]({'key':_0x1193be}),_0x862528;}async[_0x5c3a76(0x1f6)](_0x4ee427){const _0x310cd2=_0x5c3a76,_0xfdd58a=redisKey_constant_1[_0x310cd2(0x194)]+_0x4ee427[_0x310cd2(0x202)],_0x49d94f=await this['redisCacheService'][_0x310cd2(0x1b1)]({'key':_0xfdd58a});if(_0x49d94f)return;this[_0x310cd2(0x1f7)][_0x310cd2(0x19c)]({'key':_0xfdd58a,'val':_0x310cd2(0x1ba)});const _0x571884=_0x4ee427['channel'],_0xc5c953=await this[_0x310cd2(0x1e8)]['queryWeChat'](_0x4ee427['orderId'],_0x571884);switch(_0xc5c953['trade_state']){case WxPayStatus_emun_1[_0x310cd2(0x1bb)][_0x310cd2(0x1a0)]:{_0x4ee427[_0x310cd2(0x1ff)]=0x1,await this[_0x310cd2(0x1b4)][_0x310cd2(0x1f5)](async _0x25755b=>{const _0x4e999c=_0x310cd2;await this[_0x4e999c(0x1ec)][_0x4e999c(0x1aa)](_0x4ee427),await this[_0x4e999c(0x1f9)][_0x4e999c(0x1a3)](_0x4ee427);});break;}case WxPayStatus_emun_1[_0x310cd2(0x1bb)][_0x310cd2(0x1f3)]:case WxPayStatus_emun_1[_0x310cd2(0x1bb)][_0x310cd2(0x1d7)]:case WxPayStatus_emun_1[_0x310cd2(0x1bb)][_0x310cd2(0x1e1)]:{_0x4ee427[_0x310cd2(0x1ff)]=0x2,await this[_0x310cd2(0x1ec)][_0x310cd2(0x1aa)](_0x4ee427);break;}default:{}}return this[_0x310cd2(0x1f7)][_0x310cd2(0x1dd)]({'key':_0xfdd58a}),_0x4ee427;}};OrderService=__decorate([(0x0,common_1[_0x5c3a76(0x1be)])(),__param(0x0,(0x0,typeorm_1[_0x5c3a76(0x1f4)])(order_entity_1[_0x5c3a76(0x1cc)])),__param(0x1,(0x0,typeorm_1[_0x5c3a76(0x1f4)])(cramiPackage_entity_1[_0x5c3a76(0x1fb)])),__param(0x2,(0x0,typeorm_1[_0x5c3a76(0x1f4)])(user_entity_1[_0x5c3a76(0x1b0)])),__metadata(_0x5c3a76(0x1db),[typeorm_2[_0x5c3a76(0x1fc)],typeorm_2[_0x5c3a76(0x1fc)],typeorm_2[_0x5c3a76(0x1fc)],pay_service_1[_0x5c3a76(0x1d2)],globalConfig_service_1[_0x5c3a76(0x203)],redisCache_service_1[_0x5c3a76(0x193)],userBalance_service_1[_0x5c3a76(0x1eb)],typeorm_2[_0x5c3a76(0x1ae)]])],OrderService),exports[_0x5c3a76(0x1c1)]=OrderService;