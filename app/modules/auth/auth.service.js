'use strict';const _0x5e8933=_0xb433;(function(_0x3f4016,_0x25bdd8){const _0x51e3aa=_0xb433,_0x5a9e67=_0x3f4016();while(!![]){try{const _0x3c8733=parseInt(_0x51e3aa(0x1d7))/0x1+-parseInt(_0x51e3aa(0x166))/0x2*(-parseInt(_0x51e3aa(0x16c))/0x3)+-parseInt(_0x51e3aa(0x1fe))/0x4*(-parseInt(_0x51e3aa(0x1c0))/0x5)+parseInt(_0x51e3aa(0x1fd))/0x6*(parseInt(_0x51e3aa(0x1b1))/0x7)+-parseInt(_0x51e3aa(0x1d8))/0x8+-parseInt(_0x51e3aa(0x126))/0x9+-parseInt(_0x51e3aa(0x137))/0xa;if(_0x3c8733===_0x25bdd8)break;else _0x5a9e67['push'](_0x5a9e67['shift']());}catch(_0x409af5){_0x5a9e67['push'](_0x5a9e67['shift']());}}}(_0x55db,0x293ab));var __decorate=this&&this['__decorate']||function(_0x33675d,_0x2d4f42,_0x1e45da,_0x1e7342){const _0x41a198=_0xb433;var _0x167a41=arguments['length'],_0x344a9f=_0x167a41<0x3?_0x2d4f42:_0x1e7342===null?_0x1e7342=Object[_0x41a198(0x19c)](_0x2d4f42,_0x1e45da):_0x1e7342,_0x2c9c9e;if(typeof Reflect===_0x41a198(0x110)&&typeof Reflect[_0x41a198(0x170)]===_0x41a198(0x1f7))_0x344a9f=Reflect['decorate'](_0x33675d,_0x2d4f42,_0x1e45da,_0x1e7342);else{for(var _0x21049c=_0x33675d[_0x41a198(0x12c)]-0x1;_0x21049c>=0x0;_0x21049c--)if(_0x2c9c9e=_0x33675d[_0x21049c])_0x344a9f=(_0x167a41<0x3?_0x2c9c9e(_0x344a9f):_0x167a41>0x3?_0x2c9c9e(_0x2d4f42,_0x1e45da,_0x344a9f):_0x2c9c9e(_0x2d4f42,_0x1e45da))||_0x344a9f;}return _0x167a41>0x3&&_0x344a9f&&Object[_0x41a198(0x12a)](_0x2d4f42,_0x1e45da,_0x344a9f),_0x344a9f;},__metadata=this&&this[_0x5e8933(0x125)]||function(_0x268c55,_0x1c4f79){const _0x3de32f=_0x5e8933;if(typeof Reflect==='object'&&typeof Reflect[_0x3de32f(0x1fa)]==='function')return Reflect['metadata'](_0x268c55,_0x1c4f79);},__param=this&&this[_0x5e8933(0x1ad)]||function(_0x9e10a9,_0x1cd4ed){return function(_0x53919d,_0x3cc3d4){_0x1cd4ed(_0x53919d,_0x3cc3d4,_0x9e10a9);};};function _0xb433(_0x57e6b6,_0x4248b1){const _0x55dbf5=_0x55db();return _0xb433=function(_0xb43360,_0x23b8e1){_0xb43360=_0xb43360-0x10a;let _0x2e59f2=_0x55dbf5[_0xb43360];return _0x2e59f2;},_0xb433(_0x57e6b6,_0x4248b1);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x5e8933(0x180)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),access_service_1=require('../access/access.service'),verification_constant_1=require(_0x5e8933(0x130)),verification_service_1=require(_0x5e8933(0x123)),user_entity_1=require(_0x5e8933(0x162)),common_1=require(_0x5e8933(0x1c1)),jwt_1=require('@nestjs/jwt'),user_service_1=require(_0x5e8933(0x141)),mailer_service_1=require(_0x5e8933(0x1e6)),user_constant_1=require(_0x5e8933(0x11c)),userBalance_service_1=require(_0x5e8933(0x1b8)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require(_0x5e8933(0x10a)),typeorm_2=require('@nestjs/typeorm'),utils_1=require(_0x5e8933(0x1d1)),os=require('os'),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require(_0x5e8933(0x1ff)),bcrypt=require(_0x5e8933(0x1f5)),status_constant_1=require(_0x5e8933(0x151)),WechatConfig_1=require(_0x5e8933(0x14a)),axios_1=require(_0x5e8933(0x1ef)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),Login_vo_1=require('./vo/Login.vo'),WeAppLogin_vo_1=require(_0x5e8933(0x14f));function _0x55db(){const _0x3f858e=['sendMail','kaifa.qumao518.vip','验证码已过期、请重新发送！','@gomaxai.com','getUserInfo','无权此操作、请联系管理员！','&username=','status','verifyCode','loginWithWechatApp:\x20','accessToken','register','sendPhoneCode','email','captcha','__param','client','getUserStatus','authToken','861CJeXjn','password','get','admin',':PHONECODE:','verifyUserRegisterByPhone','openId、miniOpenId、weAppOpenId中必须存在一个','../userBalance/userBalance.service','verifyUserCredentials','configEntity','验证码发送成功、请填写验证码完成注册！','updateUserPassword','createVerification','access_token','userService','5PDLdmw','@nestjs/common','errcode','密码修改成功','createUser','秒内不得重复发送短信！','小程序openid不能为空！','mailerService','createRandomUid','captchaId','set','ceshi.qumao518.vip','VerificationEnum','&code=','@nine.com','当前用户已注册，请勿重复注册！','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','../../common/utils','ACTIVE','activateAccount','BAD_REQUEST','WE_MiNI_APPID','VerificationService','143972fCeNno','1303456LCwCbP','createRandomCode','Registration','RedisCacheService','JwtService','UserEntity','getClientIp','非法操作、请联系管理员！','data','HttpException','sendEmailCode','&registerSuccessEmaileAppend=','InjectRepository','用户名或密码错误！','../mailer/mailer.service','role','env','GOMAXAI_HOST','find','family','authorization_code','用户名不可修改',':CAPTCHA:','axios','redirect','HttpStatus','loginByAdmin','Logger','del','bcryptjs','verificationService','function','phone','wechat\x20获取access_token\x20失败：','metadata','getOne','decrypt','1830LAFaBE','1082476ZGOqFj','svg-captcha','openId','&registerSuccessEmailTeamName=','https://api.weixin.qq.com/sns/jscode2session','getJwtToken','default','address','log','phoneCode','registerBaseUrl','sign','typeorm','账户已被激活过','loginV4','&registerSuccessEmailTitle=','的邮箱验证','#fff','object','WE_APP_APPID','save','userEntity','savaLoginIp','userId','&grant_type=authorization_code','loginWithWechatApp','getInfo','invitationRewards','response','127.0.0.1','../../common/constants/user.constant','test','Injectable','/api/auth/changeEmailSuccess?id=','/api/auth/registerSuccess?id=','networkInterfaces','NrcdywNdP7UbvQptuW1D3w==','./../verification/verification.service','Repository','__metadata','140346LwJPGS','visitor','configVal','error','defineProperty','addBalanceToNewUser','length','&registerFailEmailTeamName=','registerFailEmailTitle','registeInMini','../../common/constants/verification.constant','forEach','管理员账号已停用','的注册验证','hasOwnProperty','getSuper','HttpStatusCode','2850520FWoztO','saveToken','redisCacheService','getIp','&registerFailEmailTitle=','client_credential','registerVerifyExpir','registerSuccessEmailTitle','registeV3','loginByOpenId','../user/user.service','WE_APP_TEMP_USER','registerVerifyEmailTitle','login','toString','userBalanceService','openid','queryUserInfoById','该邮箱已注册！','../../config/WechatConfig','userDefautlAvatar','UserBalanceService','updatePassword','UserStatusEnum','./vo/WeAppLogin.vo','WE_APP_APPSECRET','../../common/constants/status.constant','jwtService','errmsg','/api/auth/registerError?message=','validatePhoneCode','user','unionid','nickname','bindPhone','loginInMinigin:\x20','text','phone_info','https://gomaxai.qumao518.vip/api/official/getAccessToken?type=mini','managerStatus','error:\x20','onModuleInit','compareSync','./../user/user.entity','getPhoneStatus','count','loginByPhone','360694XGlIXU','reduce','accessService','账号密码或密码错误','registerVerifyEmailFrom','UserStatusErrMsg','3KHIjeO','comparePassword','&email=','WE_MINI_ACCESS_KEY','decorate','internal','账号注册时密码不能为空！','https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=','avatar','邮箱格式错误！','参数错误！','globalConfigService','configKey','verifyCaptcha','registerSuccessEmailTeamName','updateEmail','账户不存在，请联系管理员或注册','updateUserStatus','username','registerFailEmailTeamName','AuthService','getConfigs','renewMiniAccessToken','000000','WE_MINI_TEMP_USER','changeEmail','purePhoneNumber','getNamespace','weAppOpenId','getPhoneInMini','padStart','loginByPhoneV3','miniOpenId','用户名格式错误！','UserService','updatePassByOther','ChangeEmail','WE_MINI_APPSECRET','hashSync','emailVerify','GlobalConfigService','验证码类型错误','findOne','registerSuccessEmaileAppend','qureyUserInfoByInviteCode','createTokenFromFingerprint','invitedBy','旧密码错误、请检查提交','getOwnPropertyDescriptor','message'];_0x55db=function(){return _0x3f858e;};return _0x55db();}let AuthService=class AuthService{constructor(_0x24fcdd,_0x36b2e8,_0x3cf7c3,_0x3e30e5,_0x9e9403,_0x3298e3,_0x4fae82,_0x49ad37,_0x1dc111,_0x4d5e20){const _0x239aec=_0x5e8933;this[_0x239aec(0x113)]=_0x24fcdd,this[_0x239aec(0x1ba)]=_0x36b2e8,this[_0x239aec(0x1bf)]=_0x3cf7c3,this[_0x239aec(0x152)]=_0x3e30e5,this[_0x239aec(0x1c7)]=_0x9e9403,this['verificationService']=_0x3298e3,this['userBalanceService']=_0x4fae82,this['redisCacheService']=_0x49ad37,this['globalConfigService']=_0x1dc111,this[_0x239aec(0x168)]=_0x4d5e20;}async[_0x5e8933(0x160)](){const _0x520d00=_0x5e8933;this[_0x520d00(0x13a)]();}async[_0x5e8933(0x1a9)](_0x425e37,_0x2c2ee5){const _0x4b5582=_0x5e8933;await this[_0x4b5582(0x1f6)][_0x4b5582(0x179)](_0x425e37);const _0x479fc6=await this[_0x4b5582(0x1bf)]['createUserAndVerifycation'](_0x425e37,_0x2c2ee5),{username:_0x250b32,email:_0x5ad4f2,client:_0x1a22d8,id:_0x14cbd3}=_0x479fc6,_0x262244={'username':_0x250b32,'email':_0x5ad4f2,'id':_0x14cbd3};return _0x1a22d8&&(_0x262244[_0x4b5582(0x1ae)]=_0x1a22d8),_0x262244;}async['registerByPhone'](_0x4ebcb2,_0x249d39){const _0x9bb3e0=_0x5e8933;return this[_0x9bb3e0(0x1c4)](_0x4ebcb2);}async[_0x5e8933(0x144)](_0xb9eb25,_0x1ed63e){const _0x433885=_0x5e8933,_0x1a8531=await this['userService'][_0x433885(0x1b9)](_0xb9eb25),{username:_0x3136df,id:_0xbce739,email:_0x371bae,role:_0x2ab6bb,openId:_0x25a7c7,client:_0x54b9d3}=_0x1a8531,_0x29a582=(0x0,utils_1[_0x433885(0x1de)])(_0x1ed63e);await this[_0x433885(0x1bf)][_0x433885(0x114)](_0xbce739,_0x29a582);const _0x464f4f=this[_0x433885(0x152)]['sign']({'username':_0x3136df,'id':_0xbce739,'email':_0x371bae,'role':_0x2ab6bb,'openId':_0x25a7c7,'client':_0x54b9d3});return await this[_0x433885(0x139)][_0x433885(0x138)](_0xbce739,_0x464f4f),_0x464f4f;}async[_0x5e8933(0x10c)](_0x18c20d,_0x3e5829){const _0x545e07=_0x5e8933;try{const _0x1f4951=await this[_0x545e07(0x113)]['findOne']({'where':[{'username':_0x18c20d[_0x545e07(0x17e)]},{'email':_0x18c20d[_0x545e07(0x17e)]},{'phone':_0x18c20d[_0x545e07(0x17e)]}]});if(!_0x1f4951)throw new Error(_0x545e07(0x1e5));if(!_0x1f4951['password'])throw new Error(_0x545e07(0x1e5));if(!bcrypt[_0x545e07(0x161)](_0x18c20d[_0x545e07(0x1b2)],_0x1f4951[_0x545e07(0x1b2)]))throw new Error(_0x545e07(0x1e5));const _0x1afc3d=(0x0,utils_1['getClientIp'])(_0x3e5829);await this[_0x545e07(0x1bf)][_0x545e07(0x114)](_0x1f4951['id'],_0x1afc3d);const _0x1715a5=this[_0x545e07(0x152)][_0x545e07(0x209)]({'id':_0x1f4951['id'],'role':_0x1f4951[_0x545e07(0x1e7)],'email':_0x1f4951[_0x545e07(0x1ab)],'openId':_0x1f4951['openId'],'client':_0x1f4951[_0x545e07(0x1ae)],'username':_0x1f4951['username']});return await this[_0x545e07(0x139)][_0x545e07(0x138)](_0x1f4951['id'],_0x1715a5),_0x1715a5;}catch(_0x5234ae){throw new common_1['HttpException'](_0x5234ae[_0x545e07(0x19d)],common_1['HttpStatus'][_0x545e07(0x1d4)]);}}async[_0x5e8933(0x1f2)](_0x5f683e){const _0x14bc59=_0x5e8933,{username:_0x37bdeb,password:_0xa36a80}=_0x5f683e;if(!_0x37bdeb||!_0xa36a80)throw new common_1['HttpException'](_0x14bc59(0x169),common_1['HttpStatus'][_0x14bc59(0x1d4)]);const _0x1200a0=await this[_0x14bc59(0x1bf)]['getOne'](_0x37bdeb);if(!_0x1200a0)throw new common_1[(_0x14bc59(0x1e1))](_0x14bc59(0x17c),common_1['HttpStatus']['BAD_REQUEST']);if((0x0,utils_1[_0x14bc59(0x16d)])(_0xa36a80,_0x1200a0['password']))throw new common_1[(_0x14bc59(0x1e1))]('用户名或密码错误',common_1['HttpStatus'][_0x14bc59(0x1d4)]);if(_0x37bdeb===(0x0,utils_1[_0x14bc59(0x1fc)])(_0x14bc59(0x122))){const _0x4bac20=await this[_0x14bc59(0x1bf)][_0x14bc59(0x135)](),{username:_0x224276,id:_0x51aa07,email:_0x3aa299,role:_0x30919b,openId:_0x3f1beb,client:_0x10fae0}=_0x4bac20;return this[_0x14bc59(0x152)][_0x14bc59(0x209)]({'username':_0x224276,'id':_0x51aa07,'email':_0x3aa299,'role':_0x30919b,'openId':_0x3f1beb,'client':_0x10fae0});}else{const _0x31798e=await this[_0x14bc59(0x168)][_0x14bc59(0x1fb)](_0x1200a0['id']);if(_0x31798e[_0x14bc59(0x15e)]===status_constant_1['UserStatus']['stop'])throw new common_1[(_0x14bc59(0x1e1))](_0x14bc59(0x132),common_1['HttpStatus'][_0x14bc59(0x1d4)]);const {email:_0x5e3434,id:_0x16d866,role:_0x377082,openId:_0x2a3d45,client:_0x5b752b}=_0x1200a0;return this[_0x14bc59(0x152)][_0x14bc59(0x209)]({'username':_0x37bdeb,'openId':_0x2a3d45,'id':_0x16d866,'email':_0x5e3434,'role':_0x377082,'client':_0x5b752b});}}async[_0x5e8933(0x165)](_0x380acf,_0x14b37b){const _0x2328eb=_0x5e8933,_0xf3ca1c=await this[_0x2328eb(0x1bf)][_0x2328eb(0x1b9)](_0x380acf),{username:_0x1e780a,id:_0x9cf24f,email:_0x25f27d,role:_0x1adcd9,openId:_0x5895a1,client:_0x4b8363}=_0xf3ca1c,_0xf21e73=(0x0,utils_1['getClientIp'])(_0x14b37b);await this[_0x2328eb(0x1bf)][_0x2328eb(0x114)](_0x9cf24f,_0xf21e73);const {phone:_0xdd0fd9}=_0x380acf,_0x17a4e4=await this['jwtService'][_0x2328eb(0x209)]({'username':_0x1e780a,'id':_0x9cf24f,'email':_0x25f27d,'role':_0x1adcd9,'openId':_0x5895a1,'client':_0x4b8363,'phone':_0xdd0fd9});return await this[_0x2328eb(0x139)][_0x2328eb(0x138)](_0x9cf24f,_0x17a4e4),_0x17a4e4;}async[_0x5e8933(0x18b)](_0x4a26bd,_0x5667f9){const _0x566592=_0x5e8933;await this[_0x566592(0x155)](_0x4a26bd[_0x566592(0x1f8)],_0x4a26bd['phoneCode']);let _0x707a0a=await this[_0x566592(0x113)][_0x566592(0x196)]({'where':{'phone':_0x4a26bd['phone']}});if(!_0x707a0a){const _0x2a424=new user_entity_1['UserEntity']();_0x2a424[_0x566592(0x1f8)]=_0x4a26bd['phone'],_0x2a424[_0x566592(0x158)]=_0x4a26bd['phone'],_0x2a424['status']=user_constant_1[_0x566592(0x14e)]['ACTIVE'],_0x2a424[_0x566592(0x174)]=await this[_0x566592(0x177)][_0x566592(0x181)]([_0x566592(0x14b)]),_0x707a0a=await this[_0x566592(0x1bf)][_0x566592(0x1c4)](_0x2a424),this['invitationRewards'](_0x707a0a['id'],_0x4a26bd['invitedBy']);}const _0x6bb6b0=(0x0,utils_1[_0x566592(0x1de)])(_0x5667f9);await this[_0x566592(0x1bf)][_0x566592(0x114)](_0x707a0a['id'],_0x6bb6b0);const {id:_0x272511,role:_0x52fcb7,email:_0x40cf5a,client:_0x2712b9,openId:_0x3baf6d,username:_0x53a58c}=_0x707a0a,_0x2b5ddf=this[_0x566592(0x152)][_0x566592(0x209)]({'id':_0x272511,'role':_0x52fcb7,'email':_0x40cf5a,'client':_0x2712b9,'openId':_0x3baf6d,'username':_0x53a58c});return await this[_0x566592(0x139)]['saveToken'](_0x272511,_0x2b5ddf),_0x2b5ddf;}async[_0x5e8933(0x203)](_0xc98856,_0x30f22f){const _0xbe9ed=_0x5e8933,{status:_0x42e5f5}=_0xc98856;if(_0x42e5f5!==user_constant_1[_0xbe9ed(0x14e)][_0xbe9ed(0x1d2)])throw new common_1['HttpException'](user_constant_1[_0xbe9ed(0x16b)][_0x42e5f5],common_1[_0xbe9ed(0x1f1)][_0xbe9ed(0x1d4)]);const {username:_0x35a150,id:_0x5748a3,email:_0x29e6b0,role:_0x4dd07a,openId:_0x33687f,client:_0x9b9e87}=_0xc98856,_0x1663b5=(0x0,utils_1[_0xbe9ed(0x1de)])(_0x30f22f);await this['userService']['savaLoginIp'](_0x5748a3,_0x1663b5);const _0x3964c9=await this[_0xbe9ed(0x152)]['sign']({'username':_0x35a150,'id':_0x5748a3,'email':_0x29e6b0,'role':_0x4dd07a,'openId':_0x33687f,'client':_0x9b9e87});return await this[_0xbe9ed(0x139)]['saveToken'](_0x5748a3,_0x3964c9),_0x3964c9;}async[_0x5e8933(0x140)](_0x494b7d,_0x141e93){const _0x3ee3a2=_0x5e8933,{status:_0x2109fa}=_0x494b7d;if(_0x2109fa!==user_constant_1['UserStatusEnum']['ACTIVE'])throw new common_1[(_0x3ee3a2(0x1e1))](user_constant_1[_0x3ee3a2(0x16b)][_0x2109fa],common_1[_0x3ee3a2(0x1f1)][_0x3ee3a2(0x1d4)]);const {username:_0x359caf,id:_0x281690,email:_0x5a873a,role:_0x12ba97,openId:_0x2805ff,client:_0x2d7789}=_0x494b7d,_0xcc8848=(0x0,utils_1[_0x3ee3a2(0x1de)])(_0x141e93);await this[_0x3ee3a2(0x1bf)][_0x3ee3a2(0x114)](_0x281690,_0xcc8848);const _0x3b5a76=await this[_0x3ee3a2(0x152)][_0x3ee3a2(0x209)]({'username':_0x359caf,'id':_0x281690,'email':_0x5a873a,'role':_0x12ba97,'openId':_0x2805ff,'client':_0x2d7789});return await this[_0x3ee3a2(0x139)][_0x3ee3a2(0x138)](_0x281690,_0x3b5a76),_0x3b5a76;}async[_0x5e8933(0x118)](_0x3a986a){const _0x2eb4e8=_0x5e8933,{id:_0x5cf709}=_0x3a986a[_0x2eb4e8(0x156)];return await this['userService'][_0x2eb4e8(0x1a2)](_0x5cf709);}async[_0x5e8933(0x1d3)](_0x32bd94,_0x63b670){const _0x396a68=_0x5e8933,_0x3f24d0=await this['configEntity'][_0x396a68(0x1ea)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x396a68(0x13e),'registerSuccessEmailTeamName','registerSuccessEmaileAppend','registerFailEmailTitle',_0x396a68(0x17f)])}}),_0x2dad5d=_0x3f24d0['reduce']((_0x3f3425,_0x263775)=>{return _0x3f3425[_0x263775['configKey']]=_0x263775['configVal'],_0x3f3425;},{});try{const _0x2b97da=await this[_0x396a68(0x1f6)][_0x396a68(0x1a6)](_0x32bd94,verification_constant_1[_0x396a68(0x1cc)][_0x396a68(0x1da)]),{type:_0x5e0c21,userId:_0x246e6b}=_0x2b97da;if(_0x5e0c21!==verification_constant_1['VerificationEnum']['Registration'])throw new common_1[(_0x396a68(0x1e1))](_0x396a68(0x195),common_1[_0x396a68(0x1f1)][_0x396a68(0x1d4)]);const _0x4b39ae=await this[_0x396a68(0x1bf)][_0x396a68(0x1af)](_0x246e6b);if(_0x4b39ae===user_constant_1[_0x396a68(0x14e)]['ACTIVE'])throw new common_1[(_0x396a68(0x1e1))](_0x396a68(0x10b),common_1[_0x396a68(0x1f1)][_0x396a68(0x1d4)]);await this[_0x396a68(0x1bf)][_0x396a68(0x17d)](_0x2b97da[_0x396a68(0x115)],user_constant_1['UserStatusEnum'][_0x396a68(0x1d2)]);const _0x3527be=await this[_0x396a68(0x1bf)][_0x396a68(0x148)](_0x2b97da[_0x396a68(0x115)]),{username:_0x34bb2c,email:_0x36fecb,id:_0x572bbf,invitedBy:_0x163da2}=_0x3527be;let _0x13485b;_0x163da2&&(_0x13485b=await this['userService'][_0x396a68(0x198)](_0x163da2)),await this[_0x396a68(0x146)]['addBalanceToNewUser'](_0x572bbf,_0x13485b?.['id']),_0x63b670[_0x396a68(0x1f0)](_0x396a68(0x120)+_0x572bbf[_0x396a68(0x145)]()[_0x396a68(0x18a)](0x4,'0')+_0x396a68(0x1a4)+_0x34bb2c+_0x396a68(0x16e)+_0x36fecb+_0x396a68(0x10d)+_0x2dad5d[_0x396a68(0x13e)]+_0x396a68(0x201)+_0x2dad5d[_0x396a68(0x17a)]+'&registerSuccessEmaileAppend='+_0x2dad5d[_0x396a68(0x197)]);}catch(_0x5ecd68){console[_0x396a68(0x206)](_0x396a68(0x15f),_0x5ecd68);const _0x52979=_0x5ecd68[_0x396a68(0x11a)];_0x63b670['redirect'](_0x396a68(0x154)+_0x52979+_0x396a68(0x13b)+_0x2dad5d[_0x396a68(0x12e)]+'&registerFailEmailTeamName='+_0x2dad5d[_0x396a68(0x17f)]);}}async['changeEmail'](_0x5d3455,_0x5970fd){const _0x48ce66=_0x5e8933,_0x3b6322=await this[_0x48ce66(0x1ba)]['find']({'where':{'configKey':(0x0,typeorm_1['In'])(['registerSuccessEmailTitle',_0x48ce66(0x17a),'registerSuccessEmaileAppend',_0x48ce66(0x12e),_0x48ce66(0x17f)])}}),_0x485719=_0x3b6322[_0x48ce66(0x167)]((_0x8d289d,_0x3df49a)=>{const _0x4529ea=_0x48ce66;return _0x8d289d[_0x3df49a[_0x4529ea(0x178)]]=_0x3df49a[_0x4529ea(0x128)],_0x8d289d;},{});try{const _0x53a31c=await this[_0x48ce66(0x1f6)]['verifyCode'](_0x5d3455,verification_constant_1[_0x48ce66(0x1cc)][_0x48ce66(0x190)]),{type:_0x129e99,userId:_0x4e0a0c}=_0x53a31c;if(_0x129e99!==verification_constant_1[_0x48ce66(0x1cc)][_0x48ce66(0x190)])throw new common_1['HttpException'](_0x48ce66(0x195),common_1[_0x48ce66(0x1f1)][_0x48ce66(0x1d4)]);let _0x18ae05=await this[_0x48ce66(0x113)]['findOne']({'where':{'id':_0x4e0a0c}});_0x18ae05[_0x48ce66(0x1ab)]=_0x5d3455['email'],_0x18ae05=await this[_0x48ce66(0x113)][_0x48ce66(0x112)](_0x18ae05);const {id:_0x5884ca,username:_0xe85c89,email:_0x2d4c18}=_0x18ae05;_0x5970fd[_0x48ce66(0x1f0)](_0x48ce66(0x11f)+_0x5884ca[_0x48ce66(0x145)]()[_0x48ce66(0x18a)](0x4,'0')+_0x48ce66(0x1a4)+_0xe85c89+_0x48ce66(0x16e)+_0x2d4c18+_0x48ce66(0x10d)+_0x485719['registerSuccessEmailTitle']+_0x48ce66(0x201)+_0x485719[_0x48ce66(0x17a)]+_0x48ce66(0x1e3)+_0x485719[_0x48ce66(0x197)]);}catch(_0x22ed50){const _0x40e80e=_0x22ed50['response'];_0x5970fd[_0x48ce66(0x1f0)]('/api/auth/registerError?message='+_0x40e80e+'&registerFailEmailTitle='+_0x485719[_0x48ce66(0x12e)]+_0x48ce66(0x12d)+_0x485719['registerFailEmailTeamName']);}}async[_0x5e8933(0x14d)](_0x5866ca,_0x785130){const _0x2f08ab=_0x5e8933,{id:_0x57cec2,client:_0x31c613,role:_0x49b1b4}=_0x5866ca[_0x2f08ab(0x156)];if(_0x31c613&&Number(_0x31c613)>0x0)throw new common_1['HttpException'](_0x2f08ab(0x1a3),common_1['HttpStatus'][_0x2f08ab(0x1d4)]);if(_0x49b1b4===_0x2f08ab(0x1b4))throw new common_1[(_0x2f08ab(0x1e1))](_0x2f08ab(0x1df),common_1[_0x2f08ab(0x1f1)]['BAD_REQUEST']);const {username:_0x6f14d5,oldPassword:_0x1ab319,password:_0x1ae899}=_0x785130,_0x1af59a=await this[_0x2f08ab(0x113)]['findOne']({'where':{'id':_0x57cec2}});if(_0x1af59a[_0x2f08ab(0x17e)]&&_0x6f14d5)throw new common_1[(_0x2f08ab(0x1e1))](_0x2f08ab(0x1ed),common_1['HttpStatus']['BAD_REQUEST']);if(_0x1af59a['password']){if(!_0x1ab319)throw new common_1[(_0x2f08ab(0x1e1))]('原密码不可为空',common_1[_0x2f08ab(0x1f1)][_0x2f08ab(0x1d4)]);const _0x20ab7f=bcrypt[_0x2f08ab(0x161)](_0x1ab319,_0x1af59a[_0x2f08ab(0x1b2)]);if(!_0x20ab7f)throw new common_1[(_0x2f08ab(0x1e1))](_0x2f08ab(0x19b),common_1[_0x2f08ab(0x1f1)][_0x2f08ab(0x1d4)]);}return _0x1af59a['username']=_0x1af59a['username']??_0x6f14d5,_0x1af59a['password']=bcrypt[_0x2f08ab(0x192)](_0x1ae899,0xa),await this[_0x2f08ab(0x113)]['save'](_0x1af59a),_0x2f08ab(0x1c3);}async[_0x5e8933(0x17b)](_0x44b43b,_0x530b61){const _0x59f163=_0x5e8933,_0x456693=_0x44b43b[_0x59f163(0x156)]['id'],_0x447499=await this[_0x59f163(0x113)][_0x59f163(0x196)]({'where':{'email':_0x530b61[_0x59f163(0x1ab)]}});if(_0x447499)throw new common_1[(_0x59f163(0x1e1))]('邮箱已被其他用户使用',axios_1[_0x59f163(0x136)]['BadRequest']);const _0xcc7d1e=await this[_0x59f163(0x113)][_0x59f163(0x196)]({'where':{'id':_0x456693}}),_0xb9feb7=await this[_0x59f163(0x1ba)][_0x59f163(0x1ea)]({'where':{'configKey':(0x0,typeorm_1['In'])(['isVerifyEmail',_0x59f163(0x208),_0x59f163(0x143),'registerVerifyEmailDesc',_0x59f163(0x16a),'registerVerifyExpir'])}}),_0x5e3462=_0xb9feb7[_0x59f163(0x167)]((_0x371119,_0x98d4a1)=>{const _0x33749a=_0x59f163;return _0x371119[_0x98d4a1['configKey']]=_0x98d4a1[_0x33749a(0x128)],_0x371119;},{});_0xcc7d1e['email']=_0x530b61[_0x59f163(0x1ab)];const _0x2724fb=_0x5e3462[_0x59f163(0x13d)]?Number(_0x5e3462['registerVerifyExpir']):0x1e*0x3c,_0x5edf9d=await this[_0x59f163(0x1f6)][_0x59f163(0x1bd)](_0xcc7d1e,verification_constant_1['VerificationEnum'][_0x59f163(0x190)],_0x2724fb),{code:_0x2e17a5,email:_0x4fe83d,id:_0x479705}=_0x5edf9d,{registerVerifyEmailFrom:_0x233935}=_0x5e3462;await this[_0x59f163(0x1c7)]['sendMail']({'to':_0x4fe83d,'template':_0x59f163(0x185),'subject':'来自'+_0x233935+_0x59f163(0x10e),'context':{'id':_0x479705,'code':_0x2e17a5,'email':_0x4fe83d,..._0x5e3462,'baseUrl':_0x5e3462[_0x59f163(0x208)]}});}async[_0x5e8933(0x18f)](_0x13d276,_0x276fc3){const _0x31ce4a=_0x5e8933,{id:_0x25cae8,client:_0x248ffe}=_0x13d276[_0x31ce4a(0x156)];if(!_0x248ffe)throw new common_1['HttpException']('无权此操作！',common_1['HttpStatus'][_0x31ce4a(0x1d4)]);return this[_0x31ce4a(0x1bf)][_0x31ce4a(0x1bc)](_0x25cae8,_0x276fc3[_0x31ce4a(0x1b2)]),_0x31ce4a(0x1c3);}[_0x5e8933(0x13a)](){const _0x4e7c66=_0x5e8933;let _0x21bb60;const _0x180fd1=os[_0x4e7c66(0x121)]();Object['keys'](_0x180fd1)[_0x4e7c66(0x131)](_0x34e757=>{const _0x2b8929=_0x4e7c66,_0x4fc161=_0x180fd1[_0x34e757];for(let _0x4069b2=0x0;_0x4069b2<_0x4fc161['length'];_0x4069b2++){const _0x265a06=_0x4fc161[_0x4069b2];if(_0x265a06[_0x2b8929(0x1eb)]==='IPv4'&&_0x265a06[_0x2b8929(0x205)]!==_0x2b8929(0x11b)&&!_0x265a06[_0x2b8929(0x171)]){_0x21bb60=_0x265a06[_0x2b8929(0x205)];break;}}}),this['ipAddress']=_0x21bb60;}async[_0x5e8933(0x1ac)](_0x4569c8){const _0x559fda=_0x5e8933,_0x5b0208=await this[_0x559fda(0x177)][_0x559fda(0x187)](),{color:color=_0x559fda(0x10f)}=_0x4569c8,_0x3b535f=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x5bbac0=_0x3b535f['text'],_0x3e82d5=(0x0,utils_1[_0x559fda(0x1c8)])(),_0x3958a4=_0x5b0208+_0x559fda(0x1ee)+_0x3e82d5;return await this[_0x559fda(0x139)][_0x559fda(0x1ca)]({'key':_0x3958a4,'val':_0x3b535f[_0x559fda(0x15b)]},0x5*0x3c),{'svgCode':_0x3b535f[_0x559fda(0x1e0)],'code':_0x3e82d5};}async[_0x5e8933(0x1aa)](_0x20dc0e){const _0x1ffad9=_0x5e8933;_0x20dc0e[_0x1ffad9(0x1c9)]&&await this['verificationService'][_0x1ffad9(0x179)](_0x20dc0e);const {phone:_0x599265}=_0x20dc0e,_0x1cd8a4=await this[_0x1ffad9(0x177)][_0x1ffad9(0x187)](),_0x4134bc=_0x1cd8a4+_0x1ffad9(0x1b5)+_0x599265,_0x4f0d36=await this[_0x1ffad9(0x139)]['ttl'](_0x4134bc);if(_0x4f0d36&&_0x4f0d36>0x0)throw new common_1['HttpException'](_0x4f0d36+_0x1ffad9(0x1c5),common_1[_0x1ffad9(0x1f1)][_0x1ffad9(0x1d4)]);const _0x33c96e=(0x0,utils_1[_0x1ffad9(0x1d9)])(),_0x123702={'phone':_0x599265,'code':_0x33c96e};return await this['verificationService']['sendPhoneCode'](_0x123702),await this[_0x1ffad9(0x139)]['set']({'key':_0x4134bc,'val':_0x33c96e},0x1*0x3c),_0x1ffad9(0x1bb);}async[_0x5e8933(0x1e2)](_0xd356de){const _0x20128b=_0x5e8933;try{var _0x4dd8a4=/^[a-zA-Z0-9]+([_.w-]+[a-zA-Z0-9]+)*@[a-zA-Z0-9]+([-.w-]+[a-zA-Z0-9]+)*.[a-zA-Z0-9]+$/;if(!_0x4dd8a4[_0x20128b(0x11d)](_0xd356de))throw new Error(_0x20128b(0x175));const _0x5435e1=await this['userEntity'][_0x20128b(0x196)]({'where':{'email':_0xd356de}});if(_0x5435e1)throw new Error(_0x20128b(0x149));const _0x7b0b36=await this[_0x20128b(0x1ba)][_0x20128b(0x1ea)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x20128b(0x208),_0x20128b(0x143),'registerVerifyEmailDesc',_0x20128b(0x16a),_0x20128b(0x13d)])}}),_0x467c6b=_0x7b0b36[_0x20128b(0x167)]((_0x58eae2,_0xa5ea02)=>{const _0x34a1f1=_0x20128b;return _0x58eae2[_0xa5ea02[_0x34a1f1(0x178)]]=_0xa5ea02[_0x34a1f1(0x128)],_0x58eae2;},{}),_0x89ef4e=(0x0,utils_1[_0x20128b(0x1d9)])(),_0x5d1eea=_0x467c6b[_0x20128b(0x13d)]?Number(_0x467c6b[_0x20128b(0x13d)]):0x1e*0x3c;await this[_0x20128b(0x139)][_0x20128b(0x1ca)]({'key':redisKey_constant_1['EMAIL_REGISTE']+_0xd356de,'val':_0x89ef4e},_0x5d1eea*0x3c),await this[_0x20128b(0x1c7)][_0x20128b(0x19e)]({'to':_0xd356de,'template':_0x20128b(0x193),'subject':'来自'+_0x467c6b[_0x20128b(0x16a)]+_0x20128b(0x133),'context':{'baseUrl':_0x467c6b['registerBaseUrl'],'code':_0x89ef4e,..._0x467c6b}});}catch(_0x106f2d){throw new common_1['HttpException'](_0x106f2d[_0x20128b(0x19d)],common_1[_0x20128b(0x1f1)]['BAD_REQUEST']);}}[_0x5e8933(0x199)](_0x1cbea6){const _0x5d36fb=_0x5e8933,_0x4822a7=this['jwtService'][_0x5d36fb(0x209)]({'username':'游客'+_0x1cbea6,'id':_0x1cbea6,'email':_0x1cbea6+_0x5d36fb(0x1ce),'role':_0x5d36fb(0x127),'openId':null,'client':null});return _0x4822a7;}async[_0x5e8933(0x155)](_0x1dba46,_0x53bf25){const _0x67f626=_0x5e8933,_0x6972d0=await this['globalConfigService'][_0x67f626(0x187)](),_0x32e8d4=_0x6972d0+_0x67f626(0x1b5)+_0x1dba46;if(_0x53bf25===_0x67f626(0x183))return;const _0x5d78ae=await this[_0x67f626(0x139)][_0x67f626(0x1b3)]({'key':_0x32e8d4});if(!_0x5d78ae)throw new common_1['HttpException'](_0x67f626(0x1a0),common_1['HttpStatus']['BAD_REQUEST']);if(_0x53bf25!==_0x5d78ae)throw new common_1[(_0x67f626(0x1e1))]('验证码填写错误、请重新输入！',common_1['HttpStatus'][_0x67f626(0x1d4)]);}async['validateRegiste'](_0x250011){const _0x330a85=_0x5e8933;await this['userService'][_0x330a85(0x1b6)](_0x250011),await this[_0x330a85(0x155)](_0x250011[_0x330a85(0x1f8)],_0x250011[_0x330a85(0x207)]);}async[_0x5e8933(0x119)](_0x3cb0cf,_0x2d5b09){const _0x3ea597=_0x5e8933;let _0x474c2b;_0x2d5b09&&(_0x474c2b=await this[_0x3ea597(0x1bf)][_0x3ea597(0x198)](_0x2d5b09)),await this['userBalanceService'][_0x3ea597(0x12b)](_0x3cb0cf,_0x474c2b?.['id']);}async['createUser'](_0x29a917){const _0x39068f=_0x5e8933;try{let _0x370695;await this['validateRegiste'](_0x29a917);const _0x21d083=(0x0,utils_1[_0x39068f(0x1c8)])()+_0x39068f(0x1a1),_0x58f1c4=new user_entity_1['UserEntity']();_0x58f1c4['username']=_0x29a917[_0x39068f(0x17e)],_0x58f1c4[_0x39068f(0x1b2)]=_0x29a917[_0x39068f(0x1b2)],_0x58f1c4[_0x39068f(0x1f8)]=_0x29a917[_0x39068f(0x1f8)],_0x58f1c4[_0x39068f(0x1ab)]=_0x21d083,_0x58f1c4[_0x39068f(0x1a5)]=user_constant_1['UserStatusEnum'][_0x39068f(0x1d2)],_0x58f1c4[_0x39068f(0x1b2)]=bcrypt[_0x39068f(0x192)](_0x29a917[_0x39068f(0x1b2)],0xa);if(_0x29a917[_0x39068f(0x134)]('miniOpenId')){const _0x350ccb=_0x29a917;_0x58f1c4[_0x39068f(0x174)]=_0x350ccb[_0x39068f(0x174)],_0x58f1c4[_0x39068f(0x158)]=_0x350ccb[_0x39068f(0x158)],_0x58f1c4['miniOpenId']=_0x350ccb[_0x39068f(0x18c)],_0x370695=redisKey_constant_1[_0x39068f(0x184)]+_0x350ccb[_0x39068f(0x18c)],_0x58f1c4[_0x39068f(0x157)]=await this[_0x39068f(0x139)][_0x39068f(0x1b3)]({'key':_0x370695});}else _0x58f1c4[_0x39068f(0x174)]=await this[_0x39068f(0x177)]['getConfigs']([_0x39068f(0x14b)]);const _0x19f074=await this[_0x39068f(0x1bf)]['createUser'](_0x58f1c4);this[_0x39068f(0x119)](_0x19f074['id'],_0x29a917[_0x39068f(0x19a)]);const {username:_0x365d92,openId:_0x227727,id:_0x22fffb,role:_0x2a94ca,client:_0x28004b}=_0x19f074,_0x2fa82c=this[_0x39068f(0x152)][_0x39068f(0x209)]({'username':_0x365d92,'openId':_0x227727,'id':_0x22fffb,'email':_0x21d083,'role':_0x2a94ca,'client':_0x28004b});return this['redisCacheService'][_0x39068f(0x1f4)]({'key':_0x370695}),_0x2fa82c;}catch(_0x25b7ca){throw new common_1[(_0x39068f(0x1e1))](_0x25b7ca['message'],common_1['HttpStatus'][_0x39068f(0x1d4)]);}}async[_0x5e8933(0x182)](){const _0x54bcda=_0x5e8933;try{const _0x374d06=process[_0x54bcda(0x1e8)][_0x54bcda(0x1e9)];if(_0x374d06===_0x54bcda(0x19f)||_0x374d06===_0x54bcda(0x1cb)){const _0x20c30c=await axios_1[_0x54bcda(0x204)]['get'](_0x54bcda(0x15d));await this[_0x54bcda(0x139)][_0x54bcda(0x1ca)]({'key':redisKey_constant_1['WE_MINI_ACCESS_KEY'],'val':_0x20c30c[_0x54bcda(0x1e0)][_0x54bcda(0x1e0)]});}else{const _0x431f34=await axios_1[_0x54bcda(0x204)]['post']('https://api.weixin.qq.com/cgi-bin/stable_token',{'grant_type':_0x54bcda(0x13c),'appid':WechatConfig_1[_0x54bcda(0x204)][_0x54bcda(0x1d5)],'secret':WechatConfig_1[_0x54bcda(0x204)][_0x54bcda(0x191)],'force_refresh':![]});await this[_0x54bcda(0x139)][_0x54bcda(0x1ca)]({'key':redisKey_constant_1[_0x54bcda(0x16f)],'val':_0x431f34['data'][_0x54bcda(0x1be)]});}}catch(_0x272a59){common_1[_0x54bcda(0x1f3)]['error'](_0x54bcda(0x1f9),_0x272a59);}}async['loginInMinigin'](_0x3cd04f){const _0xcca302=_0x5e8933;try{const _0x10b01a=new Login_vo_1[(_0xcca302(0x204))](),_0x2c7115=await axios_1[_0xcca302(0x204)][_0xcca302(0x1b3)](_0xcca302(0x202),{'params':{'appid':WechatConfig_1['default'][_0xcca302(0x1d5)],'secret':WechatConfig_1['default']['WE_MINI_APPSECRET'],'js_code':_0x3cd04f,'grant_type':_0xcca302(0x1ec)}}),_0x39b567=_0x2c7115[_0xcca302(0x1e0)];if(_0x39b567['errcode'])throw new Error(_0x39b567[_0xcca302(0x153)]);const _0x1c10a5=await this[_0xcca302(0x113)][_0xcca302(0x196)]({'where':{'miniOpenId':_0x39b567['openid']}});if(!_0x1c10a5)this['redisCacheService'][_0xcca302(0x1ca)]({'key':redisKey_constant_1[_0xcca302(0x184)]+_0x39b567[_0xcca302(0x147)],'val':_0x39b567[_0xcca302(0x157)]||null});else{const {username:_0x57e211,id:_0x5dfb99,email:_0xfeb43c,role:_0x4b92fa,openId:_0xfa77d7,client:_0x32c82c}=_0x1c10a5;_0x10b01a['authToken']=this[_0xcca302(0x152)][_0xcca302(0x209)]({'username':_0x57e211,'id':_0x5dfb99,'email':_0xfeb43c,'role':_0x4b92fa,'openId':_0xfa77d7,'client':_0x32c82c}),await this[_0xcca302(0x139)][_0xcca302(0x138)](_0x5dfb99,_0x10b01a[_0xcca302(0x1b0)]);}return _0x10b01a['openid']=_0x39b567['openid'],_0x10b01a;}catch(_0x46a515){common_1[_0xcca302(0x1f3)][_0xcca302(0x129)](_0xcca302(0x15a),_0x46a515);throw new common_1['HttpException'](_0x46a515[_0xcca302(0x19d)],common_1[_0xcca302(0x1f1)]['BAD_REQUEST']);}}async[_0x5e8933(0x189)](_0x3786b5){const _0x3ed58a=_0x5e8933;try{const _0x3d55d5=await this[_0x3ed58a(0x139)][_0x3ed58a(0x1b3)]({'key':redisKey_constant_1[_0x3ed58a(0x16f)]}),_0x2560e4=await axios_1[_0x3ed58a(0x204)]['post'](_0x3ed58a(0x173)+_0x3d55d5,{'code':_0x3786b5});if(_0x2560e4['data'][_0x3ed58a(0x1c2)])throw new Error(_0x2560e4[_0x3ed58a(0x1e0)][_0x3ed58a(0x153)]);return _0x2560e4['data'][_0x3ed58a(0x15c)][_0x3ed58a(0x186)];}catch(_0x27c968){common_1['Logger']['error']('getPhoneInMini:\x20',_0x27c968);throw new common_1[(_0x3ed58a(0x1e1))](_0x27c968['message'],common_1[_0x3ed58a(0x1f1)][_0x3ed58a(0x1d4)]);}}[_0x5e8933(0x12f)](_0x5482df){const _0x546b00=_0x5e8933;if(!_0x5482df[_0x546b00(0x18c)])throw new common_1['HttpException'](_0x546b00(0x1c6),common_1['HttpStatus'][_0x546b00(0x1d4)]);return this[_0x546b00(0x1c4)](_0x5482df);}async[_0x5e8933(0x117)](_0xa70cc4){const _0x3a4c49=_0x5e8933,_0x522c73=new WeAppLogin_vo_1['WeAppLoginVO']();try{const _0x308a7f=await axios_1[_0x3a4c49(0x204)][_0x3a4c49(0x1b3)](_0x3a4c49(0x1d0)+WechatConfig_1[_0x3a4c49(0x204)][_0x3a4c49(0x111)]+'&secret='+WechatConfig_1['default'][_0x3a4c49(0x150)]+_0x3a4c49(0x1cd)+_0xa70cc4+_0x3a4c49(0x116));if(_0x308a7f[_0x3a4c49(0x1e0)]['errcode'])throw new Error(_0x308a7f[_0x3a4c49(0x1e0)][_0x3a4c49(0x153)]);const _0x32c676=_0x308a7f[_0x3a4c49(0x1e0)],_0x5a534e=await this[_0x3a4c49(0x113)][_0x3a4c49(0x196)]({'where':{'weAppOpenId':_0x32c676[_0x3a4c49(0x147)]}});if(!_0x5a534e)this['redisCacheService'][_0x3a4c49(0x1ca)]({'key':redisKey_constant_1[_0x3a4c49(0x142)]+_0x32c676[_0x3a4c49(0x147)],'val':_0x32c676[_0x3a4c49(0x157)]||null});else{const {username:_0xa6a478,id:_0x3ea265,email:_0x18477a,role:_0x289f1d,openId:_0x543e17,client:_0x507d8e}=_0x5a534e;_0x522c73[_0x3a4c49(0x1b0)]=this['jwtService'][_0x3a4c49(0x209)]({'username':_0xa6a478,'id':_0x3ea265,'email':_0x18477a,'role':_0x289f1d,'openId':_0x543e17,'client':_0x507d8e}),await this[_0x3a4c49(0x139)][_0x3a4c49(0x138)](_0x3ea265,_0x522c73[_0x3a4c49(0x1b0)]);}return _0x522c73[_0x3a4c49(0x147)]=_0x32c676[_0x3a4c49(0x147)],_0x522c73[_0x3a4c49(0x1a8)]=_0x32c676[_0x3a4c49(0x1be)],_0x522c73;}catch(_0x3f2b96){common_1['Logger']['error'](_0x3a4c49(0x1a7),_0x3f2b96);throw new common_1['HttpException'](_0x3f2b96['message'],common_1[_0x3a4c49(0x1f1)]['BAD_REQUEST']);}}async['phoneWithOpenId4regist'](_0x213aa2){const _0x4dfc5a=_0x5e8933;try{if(!_0x213aa2[_0x4dfc5a(0x200)]&&!_0x213aa2[_0x4dfc5a(0x18c)]&&!_0x213aa2[_0x4dfc5a(0x188)])throw new Error(_0x4dfc5a(0x1b7));let _0x51fa1f=_0x4dfc5a(0x200),_0x42fe4a={};if(_0x213aa2[_0x4dfc5a(0x200)])_0x51fa1f=_0x4dfc5a(0x200);else _0x213aa2[_0x4dfc5a(0x18c)]?_0x51fa1f=_0x4dfc5a(0x18c):_0x51fa1f='weAppOpenId';_0x42fe4a[_0x51fa1f]=_0x213aa2[_0x51fa1f];const _0xcbb6dd=await this[_0x4dfc5a(0x113)]['findOne']({'where':_0x42fe4a});if(_0xcbb6dd&&_0xcbb6dd[_0x4dfc5a(0x1f8)])return![];const _0x2f8bfe=await this[_0x4dfc5a(0x113)][_0x4dfc5a(0x196)]({'where':{'phone':_0x213aa2[_0x4dfc5a(0x1f8)]}});if(_0x2f8bfe)return!_0x2f8bfe[_0x51fa1f];return!![];}catch(_0x27ea4f){throw new common_1[(_0x4dfc5a(0x1e1))](_0x27ea4f['message'],common_1[_0x4dfc5a(0x1f1)][_0x4dfc5a(0x1d4)]);}}async[_0x5e8933(0x13f)](_0x30dd16,_0x39de07){const _0x75d7dc=_0x5e8933;try{if(_0x30dd16['username']){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/[_0x75d7dc(0x11d)](_0x30dd16['username']))throw new Error(_0x75d7dc(0x18d));if(!_0x30dd16['password'])throw new Error(_0x75d7dc(0x172));}else{if(!_0x30dd16['openId']&&!_0x30dd16['miniOpenId']&&!_0x30dd16[_0x75d7dc(0x188)])throw new Error(_0x75d7dc(0x176));}if(_0x30dd16['phone']&&!_0x30dd16[_0x75d7dc(0x207)])throw new Error('验证码不能为空！');let _0x55190c=null;if(_0x30dd16[_0x75d7dc(0x1f8)])await this[_0x75d7dc(0x155)](_0x30dd16[_0x75d7dc(0x1f8)],_0x30dd16[_0x75d7dc(0x207)]),_0x55190c=await this[_0x75d7dc(0x113)][_0x75d7dc(0x196)]({'where':{'phone':_0x30dd16[_0x75d7dc(0x1f8)]}});else{if(_0x30dd16['openId']||_0x30dd16[_0x75d7dc(0x18c)]||_0x30dd16[_0x75d7dc(0x188)]){let _0x5b3f13=_0x75d7dc(0x200),_0x3172f5={};if(_0x30dd16[_0x75d7dc(0x200)])_0x5b3f13=_0x75d7dc(0x200);else _0x30dd16[_0x75d7dc(0x18c)]?_0x5b3f13=_0x75d7dc(0x18c):_0x5b3f13=_0x75d7dc(0x188);_0x3172f5[_0x5b3f13]=_0x30dd16[_0x5b3f13],_0x55190c=await this[_0x75d7dc(0x113)][_0x75d7dc(0x196)]({'where':_0x3172f5});if(_0x55190c)throw new Error('当前用户已注册，请勿重复注册！');}else{_0x55190c=await this['userEntity'][_0x75d7dc(0x196)]({'where':{'username':_0x30dd16[_0x75d7dc(0x17e)]}});if(_0x55190c)throw new Error(_0x75d7dc(0x1cf));}}const _0x5e7e54=new user_entity_1[(_0x75d7dc(0x1dd))]();for(let _0x1e9e3b in _0x30dd16){_0x30dd16[_0x1e9e3b]&&(_0x5e7e54[_0x1e9e3b]=_0x30dd16[_0x1e9e3b]);}_0x55190c?_0x5e7e54['id']=_0x55190c['id']:(_0x5e7e54['password']&&(_0x5e7e54['password']=bcrypt['hashSync'](_0x30dd16[_0x75d7dc(0x1b2)],0xa)),_0x5e7e54[_0x75d7dc(0x1a5)]=user_constant_1['UserStatusEnum'][_0x75d7dc(0x1d2)],!_0x5e7e54[_0x75d7dc(0x158)]&&(_0x5e7e54[_0x75d7dc(0x158)]=_0x5e7e54['nickname']||'小智'),!_0x5e7e54[_0x75d7dc(0x174)]&&(_0x5e7e54[_0x75d7dc(0x174)]=await this['globalConfigService'][_0x75d7dc(0x181)]([_0x75d7dc(0x14b)])));const _0x1f98d3=await this[_0x75d7dc(0x1bf)][_0x75d7dc(0x1c4)](_0x5e7e54);!_0x55190c&&this['invitationRewards'](_0x1f98d3['id'],_0x30dd16[_0x75d7dc(0x19a)]);const _0x4696fd=(0x0,utils_1['getClientIp'])(_0x39de07);await this[_0x75d7dc(0x1bf)][_0x75d7dc(0x114)](_0x1f98d3['id'],_0x4696fd);const {id:_0x182ae9,role:_0x53604b,email:_0x234585,client:_0x2c3eff,openId:_0xb1be58,username:_0x480f17}=_0x1f98d3,_0x2eba0e=this[_0x75d7dc(0x152)][_0x75d7dc(0x209)]({'id':_0x182ae9,'role':_0x53604b,'email':_0x234585,'client':_0x2c3eff,'openId':_0xb1be58,'username':_0x480f17});return await this[_0x75d7dc(0x139)][_0x75d7dc(0x138)](_0x182ae9,_0x2eba0e),_0x2eba0e;}catch(_0x659946){if(_0x659946 instanceof common_1[_0x75d7dc(0x1e1)])throw _0x659946;else throw new common_1['HttpException'](_0x659946[_0x75d7dc(0x19d)],common_1[_0x75d7dc(0x1f1)]['BAD_REQUEST']);}}async[_0x5e8933(0x163)](_0x5f3763){const _0x1fac6e=_0x5e8933,_0x387273=await this[_0x1fac6e(0x113)][_0x1fac6e(0x164)]({'where':{'phone':_0x5f3763}});return _0x387273>0x0;}async[_0x5e8933(0x159)](_0x133051){const _0x37212c=_0x5e8933;return await this[_0x37212c(0x155)](_0x133051[_0x37212c(0x1f8)],_0x133051[_0x37212c(0x207)]),await this[_0x37212c(0x113)][_0x37212c(0x112)]({'id':_0x133051['userId'],'phone':_0x133051[_0x37212c(0x1f8)]}),!![];}};AuthService=__decorate([(0x0,common_1[_0x5e8933(0x11e)])(),__param(0x0,(0x0,typeorm_2[_0x5e8933(0x1e4)])(user_entity_1[_0x5e8933(0x1dd)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(config_entity_1['ConfigEntity'])),__metadata('design:paramtypes',[typeorm_1[_0x5e8933(0x124)],typeorm_1[_0x5e8933(0x124)],user_service_1[_0x5e8933(0x18e)],jwt_1[_0x5e8933(0x1dc)],mailer_service_1['MailerService'],verification_service_1[_0x5e8933(0x1d6)],userBalance_service_1[_0x5e8933(0x14c)],redisCache_service_1[_0x5e8933(0x1db)],globalConfig_service_1[_0x5e8933(0x194)],access_service_1['AccessService']])],AuthService),exports[_0x5e8933(0x180)]=AuthService;