'use strict';const _0x11d1b6=_0x5354;(function(_0x3584a5,_0x98788c){const _0x1862d3=_0x5354,_0x288294=_0x3584a5();while(!![]){try{const _0x4c6e59=-parseInt(_0x1862d3(0x1d3))/0x1*(-parseInt(_0x1862d3(0x17d))/0x2)+parseInt(_0x1862d3(0x16f))/0x3+-parseInt(_0x1862d3(0x1b4))/0x4*(parseInt(_0x1862d3(0x15f))/0x5)+-parseInt(_0x1862d3(0x14c))/0x6+parseInt(_0x1862d3(0x13c))/0x7*(-parseInt(_0x1862d3(0x1af))/0x8)+-parseInt(_0x1862d3(0x158))/0x9+parseInt(_0x1862d3(0x1bc))/0xa*(parseInt(_0x1862d3(0x15c))/0xb);if(_0x4c6e59===_0x98788c)break;else _0x288294['push'](_0x288294['shift']());}catch(_0x2956b7){_0x288294['push'](_0x288294['shift']());}}}(_0x4755,0xa06d6));function _0x5354(_0x417012,_0x3a0996){const _0x475569=_0x4755();return _0x5354=function(_0x5354f4,_0x5ed384){_0x5354f4=_0x5354f4-0x138;let _0x34423b=_0x475569[_0x5354f4];return _0x34423b;},_0x5354(_0x417012,_0x3a0996);}var __decorate=this&&this[_0x11d1b6(0x176)]||function(_0x16b0a9,_0x14e1d6,_0x23db9b,_0x566e1a){const _0x383cb0=_0x11d1b6;var _0x317692=arguments[_0x383cb0(0x14b)],_0xbf359c=_0x317692<0x3?_0x14e1d6:_0x566e1a===null?_0x566e1a=Object['getOwnPropertyDescriptor'](_0x14e1d6,_0x23db9b):_0x566e1a,_0x10d824;if(typeof Reflect==='object'&&typeof Reflect[_0x383cb0(0x1b8)]==='function')_0xbf359c=Reflect['decorate'](_0x16b0a9,_0x14e1d6,_0x23db9b,_0x566e1a);else{for(var _0x3bfd7e=_0x16b0a9[_0x383cb0(0x14b)]-0x1;_0x3bfd7e>=0x0;_0x3bfd7e--)if(_0x10d824=_0x16b0a9[_0x3bfd7e])_0xbf359c=(_0x317692<0x3?_0x10d824(_0xbf359c):_0x317692>0x3?_0x10d824(_0x14e1d6,_0x23db9b,_0xbf359c):_0x10d824(_0x14e1d6,_0x23db9b))||_0xbf359c;}return _0x317692>0x3&&_0xbf359c&&Object['defineProperty'](_0x14e1d6,_0x23db9b,_0xbf359c),_0xbf359c;},__metadata=this&&this[_0x11d1b6(0x1a9)]||function(_0x7ace73,_0x367fff){const _0xf76271=_0x11d1b6;if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect[_0xf76271(0x187)](_0x7ace73,_0x367fff);},__param=this&&this[_0x11d1b6(0x1f9)]||function(_0x5a06f8,_0x498d29){return function(_0x2f6704,_0x3397c2){_0x498d29(_0x2f6704,_0x3397c2,_0x5a06f8);};};Object[_0x11d1b6(0x157)](exports,_0x11d1b6(0x1de),{'value':!![]}),exports[_0x11d1b6(0x15b)]=void 0x0;const typeorm_1=require(_0x11d1b6(0x1a4)),typeorm_2=require(_0x11d1b6(0x1f2)),common_1=require(_0x11d1b6(0x171)),crypto=require(_0x11d1b6(0x14f)),axios_1=require('axios'),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_service_1=require(_0x11d1b6(0x16c)),globalConfig_service_1=require(_0x11d1b6(0x1cb)),utils_1=require('../../common/utils'),user_service_1=require('../user/user.service'),redisCache_service_1=require('../redisCache/redisCache.service'),redisKey_constant_1=require(_0x11d1b6(0x166)),WxPay=require(_0x11d1b6(0x141)),AlipaySdk=require('alipay-sdk');let PayService=class PayService{constructor(_0x2e6fb5,_0x2fd3ee,_0x791946,_0x599060,_0x1ddb59,_0x13e467,_0x463679){const _0x3c2753=_0x11d1b6;this['cramiPackageEntity']=_0x2e6fb5,this['orderEntity']=_0x2fd3ee,this['userBalanceService']=_0x791946,this[_0x3c2753(0x172)]=_0x599060,this['userService']=_0x1ddb59,this['redisCacheService']=_0x13e467,this['connection']=_0x463679;}async[_0x11d1b6(0x1d9)](){}async['notify'](_0x385b7b){const _0x2897af=_0x11d1b6;if(_0x385b7b[_0x2897af(0x17b)]=='epay')return this['notifyEpay'](_0x385b7b);if(_0x385b7b['attach']=='hupi')return this[_0x2897af(0x13b)](_0x385b7b);if(typeof _0x385b7b[_0x2897af(0x1da)]==_0x2897af(0x1c4))return this[_0x2897af(0x147)](_0x385b7b);return this['notifyMpay'](_0x385b7b);}async[_0x11d1b6(0x13d)](_0x438b87,_0x5d0fc5,_0x194b9a=_0x11d1b6(0x1bf)){const _0x4b3e71=_0x11d1b6,_0x1f3888=await this[_0x4b3e71(0x1ce)]['findOne']({'where':{'userId':_0x438b87,'orderId':_0x5d0fc5}});if(!_0x1f3888)throw new common_1['HttpException']('订单不存在!',common_1[_0x4b3e71(0x1e9)][_0x4b3e71(0x1fe)]);const _0x26900b=await this['cramiPackageEntity'][_0x4b3e71(0x169)]({'where':{'id':_0x1f3888[_0x4b3e71(0x181)]}});if(!_0x26900b)throw new common_1['HttpException'](_0x4b3e71(0x200),common_1[_0x4b3e71(0x1e9)][_0x4b3e71(0x1fe)]);console[_0x4b3e71(0x153)](_0x4b3e71(0x1f5),_0x1f3888['payPlatform']);try{if(_0x1f3888['payPlatform']==_0x4b3e71(0x1cd))return this[_0x4b3e71(0x150)](_0x438b87,_0x5d0fc5,_0x194b9a);if(_0x1f3888[_0x4b3e71(0x177)]=='wechat')return this[_0x4b3e71(0x146)](_0x438b87,_0x5d0fc5,_0x194b9a);if(_0x1f3888[_0x4b3e71(0x177)]==_0x4b3e71(0x13a))return this['payEpay'](_0x438b87,_0x5d0fc5,_0x194b9a);if(_0x1f3888[_0x4b3e71(0x177)]==_0x4b3e71(0x1e1))return this['payMpay'](_0x438b87,_0x5d0fc5,_0x194b9a);if(_0x1f3888[_0x4b3e71(0x177)]==_0x4b3e71(0x192))return this[_0x4b3e71(0x1c1)](_0x438b87,_0x5d0fc5,_0x194b9a);}catch(_0x18434b){console[_0x4b3e71(0x153)]('支付请求失败:\x20',_0x18434b);throw new common_1['HttpException'](_0x4b3e71(0x170),common_1[_0x4b3e71(0x1e9)][_0x4b3e71(0x1fe)]);}}async[_0x11d1b6(0x1a3)](_0x1882e8){const _0x10c3d2=_0x11d1b6,_0x19969e=await this['orderEntity']['findOne']({'where':{'orderId':_0x1882e8}});if(!_0x19969e)throw new common_1[(_0x10c3d2(0x1cc))](_0x10c3d2(0x151),common_1[_0x10c3d2(0x1e9)][_0x10c3d2(0x1fe)]);return _0x19969e;}async[_0x11d1b6(0x13b)](_0x26dfcc){const _0x37c6e1=_0x11d1b6,_0x42799a=await this[_0x37c6e1(0x172)][_0x37c6e1(0x190)]([_0x37c6e1(0x1eb)]),_0x562765=_0x26dfcc[_0x37c6e1(0x163)];delete _0x26dfcc[_0x37c6e1(0x163)];if(this['sign'](_0x26dfcc,_0x42799a)!=_0x562765)return _0x37c6e1(0x179);const _0x4a0d20=await this[_0x37c6e1(0x1ce)]['findOne']({'where':{'orderId':_0x26dfcc['trade_order_id'],'status':0x0}});if(!_0x4a0d20)return'failed';await this[_0x37c6e1(0x14d)]['addBalanceToOrder'](_0x4a0d20);const _0x38c807=await this['orderEntity'][_0x37c6e1(0x1d2)]({'orderId':_0x26dfcc[_0x37c6e1(0x15e)]},{'status':0x1,'paydAt':new Date()});if(_0x38c807[_0x37c6e1(0x1e8)]!=0x1)return _0x37c6e1(0x179);return _0x37c6e1(0x1a6);}async[_0x11d1b6(0x1c1)](_0x1a685f,_0x4e931f,_0x2e3c30=_0x11d1b6(0x1bf)){const _0x5ebfe0=_0x11d1b6,_0x5b2af0=await this['orderEntity'][_0x5ebfe0(0x169)]({'where':{'userId':_0x1a685f,'orderId':_0x4e931f}});if(!_0x5b2af0)throw new common_1['HttpException'](_0x5ebfe0(0x151),common_1['HttpStatus'][_0x5ebfe0(0x1fe)]);const _0x29b8a8=await this[_0x5ebfe0(0x13e)]['findOne']({'where':{'id':_0x5b2af0[_0x5ebfe0(0x181)]}});if(!_0x29b8a8)throw new common_1[(_0x5ebfe0(0x1cc))](_0x5ebfe0(0x200),common_1[_0x5ebfe0(0x1e9)][_0x5ebfe0(0x1fe)]);const {payHupiAppId:_0x2b6286,payHupiSecret:_0x4172a9,payHupiNotifyUrl:_0x56edb8,payHupiReturnUrl:_0x50ea08,payHupiGatewayUrl:_0x10358e}=await this[_0x5ebfe0(0x172)][_0x5ebfe0(0x190)]([_0x5ebfe0(0x1e2),_0x5ebfe0(0x1eb),_0x5ebfe0(0x1c3),_0x5ebfe0(0x188),_0x5ebfe0(0x159)]),_0x591550={};_0x591550[_0x5ebfe0(0x18b)]='1.1',_0x591550['appid']=_0x2b6286,_0x591550[_0x5ebfe0(0x194)]=(Date[_0x5ebfe0(0x152)]()/0x3e8)['toFixed'](0x0),_0x591550['nonce_str']=(0x0,utils_1[_0x5ebfe0(0x186)])(0x20),_0x591550['trade_order_id']=_0x4e931f,_0x591550[_0x5ebfe0(0x199)]=_0x29b8a8[_0x5ebfe0(0x1e7)],_0x591550[_0x5ebfe0(0x1f4)]=_0x5b2af0[_0x5ebfe0(0x1ff)],_0x591550[_0x5ebfe0(0x1ac)]=_0x56edb8,_0x591550['return_url']=_0x50ea08,_0x591550[_0x5ebfe0(0x182)]=_0x5ebfe0(0x192),_0x591550[_0x5ebfe0(0x163)]=this['sign'](_0x591550,_0x4172a9);const {data:{errcode:_0x481309,errmsg:_0x301a0d,url_qrcode:_0x7c61fa,url:_0x25b6de}}=await axios_1[_0x5ebfe0(0x19b)][_0x5ebfe0(0x1ba)](_0x10358e||_0x5ebfe0(0x1c9),_0x591550);if(_0x481309!=0x0)throw new common_1[(_0x5ebfe0(0x1cc))](_0x301a0d,common_1['HttpStatus'][_0x5ebfe0(0x1fe)]);return{'url_qrcode':_0x7c61fa,'url':_0x25b6de};}async['queryHupi'](_0x51e085){const _0x4a69ac=_0x11d1b6,{payHupiAppId:_0x3c676a,payHupiSecret:_0x312300}=await this[_0x4a69ac(0x172)][_0x4a69ac(0x190)](['payHupiAppId',_0x4a69ac(0x1eb)]),_0x2133d7={};_0x2133d7[_0x4a69ac(0x18b)]=_0x4a69ac(0x1d7),_0x2133d7['appid']=_0x3c676a,_0x2133d7['time']=(Date[_0x4a69ac(0x152)]()/0x3e8)[_0x4a69ac(0x1ee)](0x0),_0x2133d7[_0x4a69ac(0x1ad)]=(0x0,utils_1[_0x4a69ac(0x186)])(0x20),_0x2133d7[_0x4a69ac(0x185)]=_0x51e085,_0x2133d7[_0x4a69ac(0x163)]=this[_0x4a69ac(0x1e5)](_0x2133d7,_0x312300);const {data:{errcode:_0x87781d,errmsg:_0x4b94d8,data:_0x35e214}}=await axios_1[_0x4a69ac(0x19b)][_0x4a69ac(0x1ba)](_0x4a69ac(0x15d),_0x2133d7);if(_0x87781d!=0x0)throw new common_1[(_0x4a69ac(0x1cc))](_0x4b94d8,common_1[_0x4a69ac(0x1e9)][_0x4a69ac(0x1fe)]);return _0x35e214;}async['notifyEpay'](_0x26026e){const _0x257eff=_0x11d1b6,_0x267b26=_0x26026e[_0x257eff(0x1e5)];delete _0x26026e['sign'],delete _0x26026e[_0x257eff(0x1d1)];const _0x34243a=await this[_0x257eff(0x172)][_0x257eff(0x190)](['payEpaySecret']);if(this[_0x257eff(0x1e5)](_0x26026e,_0x34243a)!=_0x267b26)return _0x257eff(0x179);console[_0x257eff(0x153)](_0x257eff(0x1db));const _0x302fc3=await this[_0x257eff(0x1ce)][_0x257eff(0x169)]({'where':{'orderId':_0x26026e[_0x257eff(0x140)],'status':0x0}});if(!_0x302fc3)return _0x257eff(0x179);const _0x2efc6e=_0x26026e[_0x257eff(0x148)]==_0x257eff(0x1d5)?0x1:0x2,_0x4d94fc=await this[_0x257eff(0x1ce)][_0x257eff(0x1d2)]({'orderId':_0x26026e['out_trade_no']},{'status':_0x2efc6e,'paydAt':new Date()});_0x2efc6e===0x1&&await this[_0x257eff(0x14d)][_0x257eff(0x1b7)](_0x302fc3);if(_0x4d94fc[_0x257eff(0x1e8)]!=0x1)return _0x257eff(0x179);return _0x257eff(0x1a6);}async[_0x11d1b6(0x1e3)](_0x4f1826,_0x5c9724,_0x285e8b=_0x11d1b6(0x1cd)){const _0x443627=_0x11d1b6,_0x408299=await this['orderEntity']['findOne']({'where':{'userId':_0x4f1826,'orderId':_0x5c9724}});if(!_0x408299)throw new common_1[(_0x443627(0x1cc))]('订单不存在!',common_1['HttpStatus'][_0x443627(0x1fe)]);const _0xbab7de=await this[_0x443627(0x13e)][_0x443627(0x169)]({'where':{'id':_0x408299[_0x443627(0x181)]}});if(!_0xbab7de)throw new common_1[(_0x443627(0x1cc))](_0x443627(0x200),common_1[_0x443627(0x1e9)][_0x443627(0x1fe)]);const {payEpayPid:_0x36d866,payEpaySecret:_0x3dd0a0,payEpayNotifyUrl:_0x411714,payEpayReturnUrl:_0x2ad819,payEpayApiPayUrl:_0x4379e7}=await this[_0x443627(0x172)][_0x443627(0x190)]([_0x443627(0x1a0),_0x443627(0x196),_0x443627(0x14e),_0x443627(0x1ea),_0x443627(0x1f0)]);let _0x33f71b;_0x36d866[_0x443627(0x14b)]<=0x10?_0x33f71b=Number(_0x36d866):_0x33f71b=BigInt(_0x36d866);const _0x576f70={};_0x576f70[_0x443627(0x164)]=_0x33f71b,_0x576f70[_0x443627(0x14a)]=_0x285e8b,_0x576f70[_0x443627(0x140)]=_0x5c9724,_0x576f70[_0x443627(0x1e7)]=_0xbab7de[_0x443627(0x1e7)],_0x576f70[_0x443627(0x142)]=_0x408299[_0x443627(0x1ff)],_0x576f70['clientip']=_0x443627(0x1f1),_0x576f70[_0x443627(0x193)]='pc',_0x576f70['notify_url']=_0x411714,_0x576f70[_0x443627(0x197)]=_0x2ad819,_0x576f70['param']=_0x443627(0x13a),_0x576f70[_0x443627(0x1e5)]=this[_0x443627(0x1e5)](_0x576f70,_0x3dd0a0),_0x576f70[_0x443627(0x1d1)]=_0x443627(0x160);const _0xc4e7be=new URLSearchParams(_0x576f70)[_0x443627(0x168)](),_0x3f8e7a=_0x4379e7+'?'+_0xc4e7be;if(_0x4379e7[_0x443627(0x202)](_0x443627(0x1b2)))return{'url_qrcode':null,'redirectUrl':_0x3f8e7a,'channel':_0x285e8b,'isRedirect':!![]};else{const _0x5959bc=await axios_1['default']['get'](_0x4379e7,{'params':_0x576f70});console[_0x443627(0x153)](_0x443627(0x1b9),_0x5959bc['data']);const {data:{code:_0x1d830a,msg:_0x509d62,qrcode:_0x2a48c2}}=_0x5959bc;if(_0x1d830a!=0x1)throw new common_1[(_0x443627(0x1cc))](_0x509d62,common_1[_0x443627(0x1e9)][_0x443627(0x1fe)]);return{'url_qrcode':_0x2a48c2,'redirectUrl':null,'channel':_0x285e8b,'isRedirect':![]};}}async[_0x11d1b6(0x1ec)](_0x4109d0){const _0x1c2ef8=_0x11d1b6,{payEpayPid:_0x25954a,payEpaySecret:_0x46dea6,payEpayApiQueryUrl:_0x5010ae}=await this[_0x1c2ef8(0x172)][_0x1c2ef8(0x190)](['payEpayPid',_0x1c2ef8(0x196),'payEpayApiQueryUrl']),_0x51ded5={};_0x51ded5[_0x1c2ef8(0x1c6)]=_0x1c2ef8(0x17f),_0x51ded5[_0x1c2ef8(0x140)]=_0x4109d0,_0x51ded5[_0x1c2ef8(0x164)]=_0x25954a,_0x51ded5[_0x1c2ef8(0x144)]=_0x46dea6;const {data:{code:_0x2af9f8,msg:_0x1addc6,data:_0x2f750e}}=await axios_1[_0x1c2ef8(0x19b)][_0x1c2ef8(0x1c7)](_0x5010ae,{'params':_0x51ded5});if(_0x2af9f8!=0x1)throw new common_1[(_0x1c2ef8(0x1cc))](_0x1addc6,common_1['HttpStatus'][_0x1c2ef8(0x1fe)]);return _0x2f750e;}async[_0x11d1b6(0x1c2)](_0x1ca30c){const _0x502af2=_0x11d1b6,_0x334aa3=_0x1ca30c['sign'];delete _0x1ca30c[_0x502af2(0x1e5)],delete _0x1ca30c[_0x502af2(0x1d1)];const _0x3924b9=await this[_0x502af2(0x172)][_0x502af2(0x190)]([_0x502af2(0x155)]);console[_0x502af2(0x153)]('校验签名');if(this[_0x502af2(0x1e5)](_0x1ca30c,_0x3924b9)!=_0x334aa3)return'failed';console[_0x502af2(0x153)](_0x502af2(0x1db));const _0x4e2eb9=await this[_0x502af2(0x1ce)][_0x502af2(0x169)]({'where':{'orderId':_0x1ca30c[_0x502af2(0x140)],'status':0x0}});if(!_0x4e2eb9)return'failed';const _0x385b3c=_0x1ca30c[_0x502af2(0x148)]==_0x502af2(0x1d5)?0x1:0x2;console['log'](_0x502af2(0x1ca),_0x385b3c);const _0x1f465c=await this[_0x502af2(0x1ce)][_0x502af2(0x1d2)]({'orderId':_0x1ca30c[_0x502af2(0x140)]},{'status':_0x385b3c,'paydAt':new Date()});_0x385b3c===0x1&&await this['userBalanceService'][_0x502af2(0x1b7)](_0x4e2eb9);if(_0x1f465c[_0x502af2(0x1e8)]!=0x1)return _0x502af2(0x179);return _0x502af2(0x1a6);}async[_0x11d1b6(0x178)](_0x75f0a0,_0x1ac80a,_0x5e4c7f=_0x11d1b6(0x1bf)){const _0x4ed927=_0x11d1b6,_0x31bef6=await this[_0x4ed927(0x1ce)][_0x4ed927(0x169)]({'where':{'userId':_0x75f0a0,'orderId':_0x1ac80a}});if(!_0x31bef6)throw new common_1[(_0x4ed927(0x1cc))](_0x4ed927(0x151),common_1['HttpStatus'][_0x4ed927(0x1fe)]);const _0x4badf0=await this[_0x4ed927(0x13e)][_0x4ed927(0x169)]({'where':{'id':_0x31bef6[_0x4ed927(0x181)]}});if(!_0x4badf0)throw new common_1['HttpException'](_0x4ed927(0x200),common_1[_0x4ed927(0x1e9)][_0x4ed927(0x1fe)]);const {payMpayPid:_0x5c9d55,payMpaySecret:_0x143662,payMpayNotifyUrl:_0x4202ff,payMpayReturnUrl:_0x17a603,payMpayApiPayUrl:_0x1baf81}=await this[_0x4ed927(0x172)][_0x4ed927(0x190)]([_0x4ed927(0x154),_0x4ed927(0x155),'payMpayNotifyUrl',_0x4ed927(0x204),_0x4ed927(0x1c0)]),_0x278f9f={};_0x278f9f[_0x4ed927(0x164)]=Number(_0x5c9d55),_0x278f9f['type']=_0x5e4c7f,_0x278f9f[_0x4ed927(0x140)]=_0x1ac80a,_0x278f9f[_0x4ed927(0x1e7)]=_0x4badf0['name'],_0x278f9f['money']=_0x31bef6[_0x4ed927(0x1ff)],_0x278f9f[_0x4ed927(0x1ac)]=_0x4202ff,_0x278f9f['return_url']=_0x17a603,_0x278f9f[_0x4ed927(0x1e5)]=this[_0x4ed927(0x1e5)](_0x278f9f,_0x143662),_0x278f9f[_0x4ed927(0x1d1)]=_0x4ed927(0x160);const _0x3fd0cf=new URLSearchParams(_0x278f9f)[_0x4ed927(0x168)](),_0x8981cb=_0x1baf81+'?'+_0x3fd0cf;return{'url_qrcode':null,'redirectUrl':_0x8981cb,'channel':_0x5e4c7f,'isRedirect':!![]};}async[_0x11d1b6(0x1f6)](_0x212762){const _0x24b16c=_0x11d1b6,{payMpayApiQueryUrl:_0x5495ce}=await this[_0x24b16c(0x172)][_0x24b16c(0x190)]([_0x24b16c(0x154),_0x24b16c(0x155),'payMpayApiQueryUrl']),_0x20bca9={};_0x20bca9[_0x24b16c(0x14a)]=0x2,_0x20bca9[_0x24b16c(0x1fd)]=_0x212762;const {data:{code:_0x2a53ea,msg:_0x33ac1a,data:_0x49e25e}}=await axios_1[_0x24b16c(0x19b)][_0x24b16c(0x1c7)](_0x5495ce,{'params':_0x20bca9});if(_0x2a53ea!=0x1)throw new common_1[(_0x24b16c(0x1cc))](_0x33ac1a,common_1[_0x24b16c(0x1e9)][_0x24b16c(0x1fe)]);return _0x49e25e;}async['notifyWeChat'](_0x277023){const _0x2946a7=_0x11d1b6;console[_0x2946a7(0x153)](_0x2946a7(0x149),_0x277023);const {payWeChatAppId:_0x4b1320,payWeChatMchId:_0x1ca748,payWeChatSecret:_0x18e378,payWeChatPublicKey:_0x774b07,payWeChatPrivateKey:_0x10055c}=await this[_0x2946a7(0x172)][_0x2946a7(0x190)]([_0x2946a7(0x139),_0x2946a7(0x16d),'payWeChatSecret',_0x2946a7(0x1a5),_0x2946a7(0x175)]),_0x49d3f1=new WxPay({'appid':_0x4b1320,'mchid':_0x1ca748,'publicKey':_0x774b07,'privateKey':_0x10055c});let _0x20c339;try{if(_0x277023[_0x2946a7(0x183)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x3bc5ff,associated_data:_0x14385c,nonce:_0x3e5479}=_0x277023['resource'],_0x233552=_0x49d3f1['decipher_gcm'](_0x3bc5ff,_0x14385c,_0x3e5479,_0x18e378),_0x562536=_0x233552[_0x2946a7(0x140)];_0x20c339=redisKey_constant_1[_0x2946a7(0x1b6)]+_0x562536,await this[_0x2946a7(0x1aa)]['set']({'key':_0x20c339,'val':'lock'});const _0x15a124=await this[_0x2946a7(0x1ce)][_0x2946a7(0x169)]({'where':{'orderId':_0x562536,'status':0x0}});if(!_0x15a124)return'failed';if([0x1,0x2,0x3][_0x2946a7(0x202)](_0x15a124[_0x2946a7(0x167)]))return _0x2946a7(0x1a6);const _0x4e1d12=await this[_0x2946a7(0x16a)][_0x2946a7(0x18d)](async _0x2497b3=>{const _0x2bc39b=_0x2946a7,_0x3e1d58=_0x233552[_0x2bc39b(0x19f)]==_0x2bc39b(0x1fc)?0x1:0x2,_0x3de35a=await this[_0x2bc39b(0x1ce)][_0x2bc39b(0x1d2)]({'orderId':_0x562536},{'status':_0x3e1d58,'paydAt':new Date(),'tradeId':_0x233552[_0x2bc39b(0x174)]});return _0x3e1d58===0x1&&await this['userBalanceService'][_0x2bc39b(0x1b7)](_0x15a124),_0x3de35a;});if(_0x4e1d12[_0x2946a7(0x1e8)]!=0x1)return _0x2946a7(0x179);}return _0x2946a7(0x1a6);}catch(_0x4fdfdf){return console[_0x2946a7(0x153)](_0x2946a7(0x189),_0x4fdfdf),console['log'](_0x2946a7(0x1bb),_0x4fdfdf),_0x2946a7(0x179);}finally{_0x20c339&&await this[_0x2946a7(0x1aa)][_0x2946a7(0x19e)]({'key':_0x20c339});}}async[_0x11d1b6(0x150)](_0x2fdb4f,_0x5d2dda,_0x30da3c){const _0xd6d69b=_0x11d1b6,_0xfff886=await this[_0xd6d69b(0x1ce)][_0xd6d69b(0x169)]({'where':{'userId':_0x2fdb4f,'orderId':_0x5d2dda}});if(!_0xfff886)throw new common_1[(_0xd6d69b(0x1cc))](_0xd6d69b(0x151),common_1[_0xd6d69b(0x1e9)][_0xd6d69b(0x1fe)]);const _0x40cfaf=await this[_0xd6d69b(0x13e)][_0xd6d69b(0x169)]({'where':{'id':_0xfff886[_0xd6d69b(0x181)]}});if(!_0x40cfaf)throw new common_1[(_0xd6d69b(0x1cc))](_0xd6d69b(0x200),common_1[_0xd6d69b(0x1e9)][_0xd6d69b(0x1fe)]);const _0x409567={'bizContent':{'out_trade_no':_0x5d2dda,'total_amount':_0xfff886['total'],'subject':_0x40cfaf['name']}};let _0x484ed4,_0x43b762,_0x2b2180,_0x15faa8,_0x22797a;const {payAliPublicSecret:_0x41ca08,payAliWebAppId:_0x52a060,payAliWebSecret:_0x207aef,payAliAppAppId:_0x582e56,payAliAppSecret:_0x2d6e95,payWeChatNotifyUrl:_0x2518f1}=await this[_0xd6d69b(0x172)][_0xd6d69b(0x190)](['payAliPublicSecret','payAliWebAppId',_0xd6d69b(0x156),_0xd6d69b(0x1df),_0xd6d69b(0x17e),_0xd6d69b(0x184)]);_0x30da3c===_0xd6d69b(0x143)&&(_0x409567[_0xd6d69b(0x1e4)]=_0xd6d69b(0x19d),_0x484ed4=_0x52a060,_0x2b2180=_0xd6d69b(0x16e),_0x43b762=_0x207aef,_0x15faa8=_0xd6d69b(0x145),_0x22797a='FAST_INSTANT_TRADE_PAY');_0x30da3c==='app'&&(_0x2b2180=_0xd6d69b(0x1bd),_0x484ed4=_0x582e56,_0x43b762=_0x2d6e95,_0x15faa8='alipay.trade.app.pay',_0x22797a=_0xd6d69b(0x1b5));const _0x15e18e=new AlipaySdk({'appId':_0x484ed4,'keyType':'PKCS1','privateKey':_0x43b762,'alipayPublicKey':_0x41ca08});_0x409567['setNotifyUrl']=_0x2518f1,_0x409567[_0xd6d69b(0x191)][_0xd6d69b(0x1f8)]=_0x22797a;const _0x2019e6=await _0x15e18e[_0x2b2180](_0x15faa8,_0x409567);return console['log']('alipay\x20result:\x20',_0x2019e6),_0x30da3c===_0xd6d69b(0x143)?{'form':_0x2019e6}:{'data':_0x2019e6};}async[_0x11d1b6(0x1b0)](_0x20d5f7,_0x2a7019){const _0x1933cf=_0x11d1b6;let _0x5d4be8,_0x3e2093;const {payAliPublicSecret:_0x384eec,payAliWebAppId:_0x4a4178,payAliWebSecret:_0x4084d0,payAliAppAppId:_0x327bfa,payAliAppSecret:_0x33bbf4,payWeChatNotifyUrl:_0x288db8}=await this[_0x1933cf(0x172)][_0x1933cf(0x190)](['payAliPublicSecret',_0x1933cf(0x18f),_0x1933cf(0x156),_0x1933cf(0x1df),_0x1933cf(0x17e),'payWeChatNotifyUrl']);_0x2a7019===_0x1933cf(0x143)&&(_0x5d4be8=_0x4a4178,_0x3e2093=_0x4084d0);_0x2a7019===_0x1933cf(0x1d8)&&(_0x5d4be8=_0x327bfa,_0x3e2093=_0x33bbf4);const _0x45c90e=new AlipaySdk({'appId':_0x5d4be8,'keyType':_0x1933cf(0x1c8),'privateKey':_0x3e2093,'alipayPublicKey':_0x384eec}),_0x3935a3=await _0x45c90e[_0x1933cf(0x16b)](_0x1933cf(0x1a8),{'bizContent':{'out_trade_no':_0x20d5f7}});return console['log'](_0x3935a3),_0x3935a3;}async[_0x11d1b6(0x146)](_0x354a72,_0x152006,_0x51ae61=_0x11d1b6(0x143)){const _0x3269b0=_0x11d1b6;console[_0x3269b0(0x153)](_0x3269b0(0x1dd),_0x51ae61);const _0x1a85c7=await this[_0x3269b0(0x1ce)][_0x3269b0(0x169)]({'where':{'userId':_0x354a72,'orderId':_0x152006}});if(!_0x1a85c7)throw new common_1[(_0x3269b0(0x1cc))](_0x3269b0(0x151),common_1[_0x3269b0(0x1e9)][_0x3269b0(0x1fe)]);const _0x1b73f3=await this[_0x3269b0(0x13e)][_0x3269b0(0x169)]({'where':{'id':_0x1a85c7['goodsId']}});if(!_0x1b73f3)throw new common_1[(_0x3269b0(0x1cc))](_0x3269b0(0x200),common_1[_0x3269b0(0x1e9)][_0x3269b0(0x1fe)]);const {payWeChatAppId:_0x56d49c,payWeMiniAppId:_0x33881e,payWeChatMchId:_0x2a7d17,payWeChatPublicKey:_0x246f90,payWeChatPrivateKey:_0x51d25a,payWeChatNotifyUrl:_0x304be4,payWeChatH5Name:_0xd062d,payWeChatH5Url:_0x4d08fc,WE_APP_APPID:_0x55cf42,WE_APP_APPSECRET:_0x4e4690}=await this['globalConfigService'][_0x3269b0(0x190)]([_0x3269b0(0x139),'payWeMiniAppId',_0x3269b0(0x16d),_0x3269b0(0x1a5),_0x3269b0(0x175),_0x3269b0(0x184),'payWeChatH5Name',_0x3269b0(0x1dc),_0x3269b0(0x1ae)]),_0x134e2e=new WxPay({'appid':_0x51ae61===_0x3269b0(0x195)?_0x33881e:_0x56d49c,'mchid':_0x2a7d17,'publicKey':_0x246f90,'privateKey':_0x51d25a}),_0x43416e={'appid':_0x51ae61==='mini'?_0x33881e:_0x56d49c,'mchid':_0x2a7d17,'description':_0x1b73f3[_0x3269b0(0x1e7)],'out_trade_no':_0x152006,'notify_url':_0x304be4,'amount':{'total':Number(_0x1a85c7[_0x3269b0(0x1ff)]*0x64)},'scene_info':{'payer_client_ip':_0x3269b0(0x1f1)}};console[_0x3269b0(0x153)]('wechat-pay:\x20',_0x43416e);if(_0x51ae61=='h5'){_0x43416e[_0x3269b0(0x1e6)][_0x3269b0(0x198)]={'type':'Wap','app_name':_0xd062d,'app_url':_0x4d08fc};const _0x2cadc4=await _0x134e2e[_0x3269b0(0x203)](_0x43416e);if(_0x2cadc4[_0x3269b0(0x167)]===0x193){const _0x302824=_0x2cadc4?.[_0x3269b0(0x138)]?.['response']?.[_0x3269b0(0x1d0)]?.[_0x3269b0(0x1ed)];throw new common_1['HttpException'](_0x2cadc4?.[_0x3269b0(0x1ed)]||'微信H5支付失败！',common_1[_0x3269b0(0x1e9)][_0x3269b0(0x1fe)]);}const {h5_url:_0x3d4c44}=_0x2cadc4;return{'url':_0x3d4c44};}if(_0x51ae61===_0x3269b0(0x1d8)){_0x43416e[_0x3269b0(0x18a)]=_0x55cf42;const _0x66caca=await _0x134e2e[_0x3269b0(0x1d6)](_0x43416e);return console['log']('App支付结果返回值:\x20',_0x66caca),_0x66caca;}if(_0x51ae61=='mini'){const _0x1b39bd=await this[_0x3269b0(0x19a)][_0x3269b0(0x1cf)](_0x354a72);_0x43416e[_0x3269b0(0x173)]={'openid':_0x1b39bd};const _0x756dbc=await _0x134e2e[_0x3269b0(0x13f)](_0x43416e);return console['log']('jsapi支付结果返回值:\x20',_0x756dbc),_0x756dbc;}if(_0x51ae61=='jsapi'){const _0x336c70=await this[_0x3269b0(0x19a)]['getOpenIdByUserId'](_0x354a72);console[_0x3269b0(0x153)](_0x3269b0(0x15a),_0x336c70),_0x43416e['payer']={'openid':_0x336c70};const _0x3c54d=await _0x134e2e[_0x3269b0(0x13f)](_0x43416e);return console['log']('jsapi支付结果返回值:\x20',_0x3c54d),_0x3c54d;}if(_0x51ae61=='native'){const _0x53d8e2=await _0x134e2e[_0x3269b0(0x165)](_0x43416e),{code_url:_0x363f60}=_0x53d8e2;return!_0x363f60&&console[_0x3269b0(0x153)](_0x3269b0(0x201),_0x53d8e2),{'url_qrcode':_0x363f60,'isRedirect':![]};}throw new common_1[(_0x3269b0(0x1cc))](_0x3269b0(0x1c5),common_1['HttpStatus'][_0x3269b0(0x1fe)]);}async[_0x11d1b6(0x19c)](_0x1a6ae7,_0x4d23aa){const _0xb8a45b=_0x11d1b6,{payWeChatAppId:_0x1cd509,payWeMiniAppId:_0x34c0ea,payWeChatMchId:_0x39c4a6,payWeChatPublicKey:_0x1bd890,payWeChatPrivateKey:_0x1ede90}=await this[_0xb8a45b(0x172)]['getConfigs'](['payWeChatAppId','payWeMiniAppId',_0xb8a45b(0x16d),_0xb8a45b(0x1a5),'payWeChatPrivateKey']),_0x40302f=new WxPay({'appid':_0x4d23aa===_0xb8a45b(0x195)?_0x34c0ea:_0x1cd509,'mchid':_0x39c4a6,'publicKey':_0x1bd890,'privateKey':_0x1ede90}),_0x1a328f=await _0x40302f['query']({'out_trade_no':_0x1a6ae7});return _0x1a328f;}async[_0x11d1b6(0x1b1)](_0x3fd141){const _0x34ef73=_0x11d1b6;_0x3fd141['payPlatform']===_0x34ef73(0x1b3)&&await this[_0x34ef73(0x17c)](_0x3fd141);}async[_0x11d1b6(0x17c)](_0x4cecd0){const _0x40ba0=_0x11d1b6,{payWeChatAppId:_0x52103f,payWeMiniAppId:_0x321071,payWeChatMchId:_0x5f1f0a,payWeChatPublicKey:_0x383412,payWeChatPrivateKey:_0x48aca7}=await this[_0x40ba0(0x172)][_0x40ba0(0x190)]([_0x40ba0(0x139),_0x40ba0(0x1ab),'payWeChatMchId',_0x40ba0(0x1a5),_0x40ba0(0x175),_0x40ba0(0x184),'payWeChatH5Name',_0x40ba0(0x1dc)]),_0x2584fc=new WxPay({'appid':_0x4cecd0['channel']==='mini'?_0x321071:_0x52103f,'mchid':_0x5f1f0a,'publicKey':_0x383412,'privateKey':_0x48aca7});await _0x2584fc[_0x40ba0(0x161)](_0x4cecd0[_0x40ba0(0x1f3)]);}[_0x11d1b6(0x1e5)](_0x2c75ae,_0x1caade){const _0x8c9b96=_0x11d1b6,_0x5bb306=Object[_0x8c9b96(0x180)](_0x2c75ae)['sort']()[_0x8c9b96(0x1a1)](_0x3505a9=>_0x3505a9+'='+_0x2c75ae[_0x3505a9])[_0x8c9b96(0x1a7)]('&')+_0x1caade;return crypto[_0x8c9b96(0x1e0)](_0x8c9b96(0x162))[_0x8c9b96(0x1d2)](_0x5bb306)['digest']('hex');}};function _0x4755(){const _0x1902d6=['__decorate','payPlatform','payMpay','failed','UserBalanceService','param','cancelWxOrder','4MCpLIr','payAliAppSecret','order','keys','goodsId','attach','event_type','payWeChatNotifyUrl','out_trade_order','createRandomNonceStr','metadata','payHupiReturnUrl','error:\x20','appid','version','GlobalConfigService','transaction','design:paramtypes','payAliWebAppId','getConfigs','bizContent','hupi','device','time','mini','payEpaySecret','return_url','h5_info','title','userService','default','queryWeChat','POST','del','trade_state','payEpayPid','map','InjectRepository','query','@nestjs/typeorm','payWeChatPublicKey','success','join','alipay.trade.query','__metadata','redisCacheService','payWeMiniAppId','notify_url','nonce_str','WE_APP_APPID','8SeiZOE','queryAliPay','cancel','submit.php','wechat','4PtIycw','QUICK_MSECURITY_PAY','PAY_UPDATE_ORDER','addBalanceToOrder','decorate','epay\x20--->\x20res:\x20','post','支付通知验证失败:\x20','120ocGImL','sdkExec','Repository','wxpay','payMpayApiPayUrl','payHupi','notifyMpay','payHupiNotifyUrl','object','unsupported\x20pay\x20type','act','get','PKCS1','https://api.xunhupay.com/payment/do.html','status:\x20','../globalConfig/globalConfig.service','HttpException','alipay','orderEntity','getMiniOpenIdByUserId','text','sign_type','update','412733RpkTOp','CramiPackageEntity','TRADE_SUCCESS','transactions_app','1.1','app','onModuleInit','resource','校验签名通过','payWeChatH5Url','payType:\x20','__esModule','payAliAppAppId','createHash','mpay','payHupiAppId','payEpay','method','sign','scene_info','name','affected','HttpStatus','payEpayReturnUrl','payHupiSecret','queryEpay','message','toFixed','RedisCacheService','payEpayApiPayUrl','192.168.1.100','typeorm','orderId','total_fee','本次支付类型:\x20','queryMpay','UserService','product_code','__param','Injectable','Connection','SUCCESS','order_no','BAD_REQUEST','total','套餐不存在!','wx-native','includes','transactions_h5','payMpayReturnUrl','errRaw','payWeChatAppId','epay','notifyHupi','2883265VUKHBW','pay','cramiPackageEntity','transactions_jsapi','out_trade_no','wechatpay-node-v3','money','native','key','alipay.trade.page.pay','payWeChat','notifyWeChat','trade_status','微信支付通知params:\x20','type','length','434364jElBIN','userBalanceService','payEpayNotifyUrl','crypto','payAli','订单不存在!','now','log','payMpayPid','payMpaySecret','payAliWebSecret','defineProperty','10851345vXhqMr','payHupiGatewayUrl','用户openId:\x20','PayService','2175052iZflbK','https://api.xunhupay.com/payment/query.html','trade_order_id','4473400LNrrFg','MD5','close','md5','hash','pid','transactions_native','../../common/constants/redisKey.constant','status','toString','findOne','connection','exec','../userBalance/userBalance.service','payWeChatMchId','pageExec','130602kVQRXc','支付请求失败!','@nestjs/common','globalConfigService','payer','transaction_id','payWeChatPrivateKey'];_0x4755=function(){return _0x1902d6;};return _0x4755();}PayService=__decorate([(0x0,common_1[_0x11d1b6(0x1fa)])(),__param(0x0,(0x0,typeorm_1[_0x11d1b6(0x1a2)])(cramiPackage_entity_1[_0x11d1b6(0x1d4)])),__param(0x1,(0x0,typeorm_1[_0x11d1b6(0x1a2)])(order_entity_1['OrderEntity'])),__metadata(_0x11d1b6(0x18e),[typeorm_2[_0x11d1b6(0x1be)],typeorm_2[_0x11d1b6(0x1be)],userBalance_service_1[_0x11d1b6(0x17a)],globalConfig_service_1[_0x11d1b6(0x18c)],user_service_1[_0x11d1b6(0x1f7)],redisCache_service_1[_0x11d1b6(0x1ef)],typeorm_2[_0x11d1b6(0x1fb)]])],PayService),exports[_0x11d1b6(0x15b)]=PayService;