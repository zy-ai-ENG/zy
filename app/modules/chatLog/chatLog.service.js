'use strict';const _0x40c6ba=_0x174b;(function(_0x2ed267,_0x2e603a){const _0x535bb2=_0x174b,_0x53af1c=_0x2ed267();while(!![]){try{const _0x32e1e8=parseInt(_0x535bb2(0x1d0))/0x1*(-parseInt(_0x535bb2(0x21a))/0x2)+parseInt(_0x535bb2(0x206))/0x3+-parseInt(_0x535bb2(0x1de))/0x4+parseInt(_0x535bb2(0x201))/0x5*(parseInt(_0x535bb2(0x21e))/0x6)+-parseInt(_0x535bb2(0x1cb))/0x7*(-parseInt(_0x535bb2(0x22f))/0x8)+-parseInt(_0x535bb2(0x1e6))/0x9+parseInt(_0x535bb2(0x1e8))/0xa;if(_0x32e1e8===_0x2e603a)break;else _0x53af1c['push'](_0x53af1c['shift']());}catch(_0x581d85){_0x53af1c['push'](_0x53af1c['shift']());}}}(_0x27f2,0x8914a));var __decorate=this&&this[_0x40c6ba(0x228)]||function(_0x5d832e,_0x42458d,_0x1b6ff6,_0x5f31bc){const _0x1c9c6c=_0x40c6ba;var _0x368970=arguments[_0x1c9c6c(0x24c)],_0x12cd24=_0x368970<0x3?_0x42458d:_0x5f31bc===null?_0x5f31bc=Object['getOwnPropertyDescriptor'](_0x42458d,_0x1b6ff6):_0x5f31bc,_0x5beab7;if(typeof Reflect==='object'&&typeof Reflect[_0x1c9c6c(0x251)]===_0x1c9c6c(0x1e2))_0x12cd24=Reflect[_0x1c9c6c(0x251)](_0x5d832e,_0x42458d,_0x1b6ff6,_0x5f31bc);else{for(var _0x3fbf37=_0x5d832e[_0x1c9c6c(0x24c)]-0x1;_0x3fbf37>=0x0;_0x3fbf37--)if(_0x5beab7=_0x5d832e[_0x3fbf37])_0x12cd24=(_0x368970<0x3?_0x5beab7(_0x12cd24):_0x368970>0x3?_0x5beab7(_0x42458d,_0x1b6ff6,_0x12cd24):_0x5beab7(_0x42458d,_0x1b6ff6))||_0x12cd24;}return _0x368970>0x3&&_0x12cd24&&Object[_0x1c9c6c(0x223)](_0x42458d,_0x1b6ff6,_0x12cd24),_0x12cd24;},__metadata=this&&this[_0x40c6ba(0x1da)]||function(_0x29369e,_0x478762){const _0x4791ab=_0x40c6ba;if(typeof Reflect===_0x4791ab(0x1f0)&&typeof Reflect[_0x4791ab(0x1d5)]===_0x4791ab(0x1e2))return Reflect[_0x4791ab(0x1d5)](_0x29369e,_0x478762);},__param=this&&this[_0x40c6ba(0x214)]||function(_0x268150,_0x3be5b9){return function(_0x5f46d2,_0xc6ce52){_0x3be5b9(_0x5f46d2,_0xc6ce52,_0x268150);};};function _0x174b(_0x56a9ee,_0x7e35a4){const _0x27f299=_0x27f2();return _0x174b=function(_0x174baa,_0x4d03ab){_0x174baa=_0x174baa-0x1c4;let _0x5e0e28=_0x27f299[_0x174baa];return _0x5e0e28;},_0x174b(_0x56a9ee,_0x7e35a4);}Object[_0x40c6ba(0x223)](exports,_0x40c6ba(0x21c),{'value':!![]}),exports[_0x40c6ba(0x1c7)]=void 0x0;function _0x27f2(){const _0x331a8=['1197162tgfABC','HttpException','466340tijCbp','isGroup','syncMusic','gpts','parse','relateId','querAllDrawLog','PAINT_TYPE','object','setHeader','extend','username','thumbImg','substring','DESC','../chatGroup/chatGroup.entity','lock','Injectable','map','Logger','用户邮箱','save','../../common/utils','get','IsNull','7310CJoPjM','exceljs','uploadService','Workbook','type','1859193OmDjLe','transferFile','musicLog','BAD_REQUEST','answer','redisCacheService','prompt','你删除的对话记录不存在、请检查！','Content-Type','assign','ChatLogEntity','end','chatlog','Like','__param','page','columns','提问时间','cos','components','4dyccvK','message_id','__esModule','CHAT_TYPE','1392SAnMEF','size','model','findOne','/q/55','defineProperty','@nestjs/typeorm','chatLogEntity','ChatGroupEntity','HttpStatus','__decorate','slice','addRow','deleteChatLog','Repository','all','../redisCache/redisCache.service','19472CfHwvC','delByGroupId','byAppId','Connection','catch','super','prototype','用户名','./chatLog.entity','xlsx','@nestjs/common','delete','group','你操作的图片不存在、请检查！','write','connection','saveChatLog','userEntity','paintCount','回答答案','modelType','ali','exportExcel','InjectRepository','findAndCount','affected','user','当前页面已经没有东西可以删除了！','AiAgreeLogEntity','length','find','UploadService','%filesystem.site%','formatDate','decorate','default','addWorksheet','图片成功！','你推荐的图片不存在、请检查！','提问问题','includes','createdAt','ChatLogService','Not','DeductionKey','@nine.com','217hFamFu','rec','aiAgreeLogEntity','../../common/constants/redisKey.constant','../user/user.entity','177201RttvsZ','update','set','removeLogsBatch','?x-oss-process=image/resize,w_','metadata','replace','email','design:paramtypes','取消推荐','__metadata','forEach','chatGroupEntity','role','128404oTyWNQ','userId','music','error','function','?imageView2/1/w/','MUSIC_TRANSFER','tencent'];_0x27f2=function(){return _0x331a8;};return _0x27f2();}const common_1=require(_0x40c6ba(0x239)),typeorm_1=require(_0x40c6ba(0x224)),chatLog_entity_1=require(_0x40c6ba(0x237)),typeorm_2=require('typeorm'),balance_constant_1=require('../../common/constants/balance.constant'),user_entity_1=require(_0x40c6ba(0x1cf)),utils_1=require(_0x40c6ba(0x1fe)),exceljs_1=require(_0x40c6ba(0x202)),chatGroup_entity_1=require(_0x40c6ba(0x1f7)),upload_service_1=require('../upload/upload.service'),redisCache_service_1=require(_0x40c6ba(0x22e)),redisKey_constant_1=require(_0x40c6ba(0x1ce)),aiAgreeLog_entity_1=require('../aiLog/aiAgreeLog.entity');let ChatLogService=class ChatLogService{constructor(_0x29a8ac,_0xf82fc3,_0x569eee,_0x2fd25d,_0x264b91,_0x1005dd,_0xf02891){const _0xbeb158=_0x40c6ba;this[_0xbeb158(0x225)]=_0x29a8ac,this[_0xbeb158(0x240)]=_0xf82fc3,this[_0xbeb158(0x1dc)]=_0x569eee,this[_0xbeb158(0x1cd)]=_0x2fd25d,this[_0xbeb158(0x23e)]=_0x264b91,this[_0xbeb158(0x203)]=_0x1005dd,this['redisCacheService']=_0xf02891;}async[_0x40c6ba(0x23f)](_0x3dc15b){const _0x4c4b59=_0x40c6ba;return await this['chatLogEntity'][_0x4c4b59(0x1fd)](_0x3dc15b);}async['querDrawLog'](_0x6a08fe,_0x37894f){const _0x52a3e8=_0x40c6ba,{id:_0xccdd4}=_0x6a08fe['user'],{model:_0x4ff1db}=_0x37894f,_0x37a2bd={'userId':_0xccdd4,'type':balance_constant_1[_0x52a3e8(0x1c9)]['PAINT_TYPE']};_0x4ff1db&&(_0x37a2bd[_0x52a3e8(0x220)]=_0x4ff1db);const _0xa2d902=await this[_0x52a3e8(0x225)][_0x52a3e8(0x24d)]({'where':_0x37a2bd,'order':{'id':_0x52a3e8(0x1f6)},'select':['id',_0x52a3e8(0x20a),_0x52a3e8(0x20c),_0x52a3e8(0x21b),_0x52a3e8(0x23b),'model',_0x52a3e8(0x1f2),_0x52a3e8(0x205)]});return _0xa2d902[_0x52a3e8(0x1db)](_0x51d857=>{const _0x29fe24=_0x52a3e8;if(_0x51d857[_0x29fe24(0x205)]===_0x29fe24(0x241)){const _0x500409=_0x51d857['model']==='mj'?0x136:0xa0,_0x18079c=_0x51d857[_0x29fe24(0x20a)][_0x29fe24(0x1c5)](_0x29fe24(0x218))?_0x29fe24(0x1e5):'ali',_0x3a06ff=_0x18079c===_0x29fe24(0x1e5)?_0x29fe24(0x1e3)+_0x500409+_0x29fe24(0x222):'?x-oss-process=image/resize,w_'+_0x500409;_0x51d857[_0x29fe24(0x1f4)]=_0x51d857[_0x29fe24(0x20a)]+_0x3a06ff;const _0x29194b=_0x51d857[_0x29fe24(0x1f2)]?JSON['parse'](_0x51d857[_0x29fe24(0x1f2)]):null;_0x29194b&&(_0x29194b?_0x51d857['isGroup']=_0x29194b?.[_0x29fe24(0x219)][0x0]?.['components'][_0x29fe24(0x24c)]===0x5:_0x51d857[_0x29fe24(0x1e9)]=![]);}}),_0xa2d902;}async[_0x40c6ba(0x1ee)](_0x56444e){const _0xdd18d5=_0x40c6ba,{page:page=0x1,size:size=0x14,rec:_0x5143d6,userId:_0x1f6849,model:_0x450aa2}=_0x56444e,_0x549770={'type':balance_constant_1[_0xdd18d5(0x1c9)][_0xdd18d5(0x1ef)],'prompt':(0x0,typeorm_2[_0xdd18d5(0x1c8)])(''),'answer':(0x0,typeorm_2[_0xdd18d5(0x1c8)])('')};_0x5143d6&&Object['assign'](_0x549770,{'rec':_0x5143d6}),_0x1f6849&&Object[_0xdd18d5(0x20f)](_0x549770,{'userId':_0x1f6849}),_0x450aa2&&Object[_0xdd18d5(0x20f)](_0x549770,{'model':_0x450aa2});const [_0x2efcd6,_0x58ad9b]=await this[_0xdd18d5(0x225)][_0xdd18d5(0x247)]({'order':{'id':_0xdd18d5(0x1f6)},'skip':(page-0x1)*size,'take':size,'where':_0x549770});return _0x2efcd6['forEach'](_0x4e8e0a=>{const _0x48edb3=_0xdd18d5;if(_0x4e8e0a[_0x48edb3(0x205)]===_0x48edb3(0x241)){const _0x4c4524=_0x4e8e0a[_0x48edb3(0x220)]==='mj'?0x136:0xa0,_0x47be5b=_0x4e8e0a[_0x48edb3(0x20a)][_0x48edb3(0x1c5)](_0x48edb3(0x218))?_0x48edb3(0x1e5):_0x48edb3(0x244),_0x21d127=_0x47be5b===_0x48edb3(0x1e5)?_0x48edb3(0x1e3)+_0x4c4524+'/q/55':_0x48edb3(0x1d4)+_0x4c4524;_0x4e8e0a[_0x48edb3(0x1f4)]=_0x4e8e0a['answer']+_0x21d127;const _0x6a6037=_0x4e8e0a['extend']?JSON['parse'](_0x4e8e0a['extend']):null;_0x6a6037&&(_0x6a6037?_0x4e8e0a[_0x48edb3(0x1e9)]=_0x6a6037?.[_0x48edb3(0x219)][0x0]?.[_0x48edb3(0x219)][_0x48edb3(0x24c)]===0x5:_0x4e8e0a['isGroup']=![]);}}),{'rows':_0x2efcd6,'count':_0x58ad9b};}async['recDrawImg'](_0x209b94){const _0x10fad8=_0x40c6ba,{id:_0x5b83ad}=_0x209b94,_0x38d7a1=await this[_0x10fad8(0x225)]['findOne']({'where':{'id':_0x5b83ad,'type':balance_constant_1['DeductionKey'][_0x10fad8(0x1ef)]}});if(!_0x38d7a1)throw new common_1['HttpException'](_0x10fad8(0x255),common_1[_0x10fad8(0x227)]['BAD_REQUEST']);const _0x4f2720=_0x38d7a1[_0x10fad8(0x1cc)]===0x1?0x0:0x1,_0x2bae23=await this[_0x10fad8(0x225)][_0x10fad8(0x1d1)]({'id':_0x5b83ad},{'rec':_0x4f2720});if(_0x2bae23['affected']>0x0)return(_0x4f2720?'推荐':_0x10fad8(0x1d9))+_0x10fad8(0x254);throw new common_1[(_0x10fad8(0x1e7))](_0x10fad8(0x23c),common_1[_0x10fad8(0x227)][_0x10fad8(0x209)]);}async[_0x40c6ba(0x245)](_0x384019,_0x1cbb47){const _0x37a393=_0x40c6ba,_0x467a10={'type':balance_constant_1[_0x37a393(0x1c9)][_0x37a393(0x21d)]},{page:page=0x1,size:size=0x1e,prompt:_0x5ebe34,email:_0x1f3124}=_0x384019;_0x5ebe34&&Object[_0x37a393(0x20f)](_0x467a10,{'prompt':(0x0,typeorm_2[_0x37a393(0x213)])('%'+_0x5ebe34+'%')});if(_0x1f3124){const _0x2c70ef=await this[_0x37a393(0x240)][_0x37a393(0x221)]({'where':{'email':_0x1f3124}});_0x2c70ef?.['id']&&Object[_0x37a393(0x20f)](_0x467a10,{'userId':_0x2c70ef['id']});}const [_0xa56c07,_0x3e6bcc]=await this[_0x37a393(0x225)][_0x37a393(0x247)]({'order':{'id':_0x37a393(0x1f6)},'skip':(page-0x1)*size,'take':size,'where':_0x467a10}),_0x105bbc=_0xa56c07['map'](_0x3dadbf=>_0x3dadbf[_0x37a393(0x1df)]),_0xdd884b=await this[_0x37a393(0x240)][_0x37a393(0x24d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x105bbc)}}),_0x445377=_0xa56c07[_0x37a393(0x1fa)](_0x555d84=>{const _0x4963fd=_0x37a393,_0x7330c3=_0xdd884b[_0x4963fd(0x24d)](_0x5acda7=>_0x5acda7['id']===_0x555d84[_0x4963fd(0x1df)]);return{'username':_0x7330c3?_0x7330c3[_0x4963fd(0x1f3)]:'','email':_0x7330c3?_0x7330c3[_0x4963fd(0x1d7)]:'','prompt':_0x555d84[_0x4963fd(0x20c)],'answer':_0x555d84['answer'],'createdAt':(0x0,utils_1['formatDate'])(_0x555d84[_0x4963fd(0x1c6)])};}),_0x528b0a=new exceljs_1[(_0x37a393(0x252))][(_0x37a393(0x204))](),_0xcf80dc=_0x528b0a[_0x37a393(0x253)](_0x37a393(0x212));_0xcf80dc[_0x37a393(0x216)]=[{'header':_0x37a393(0x236),'key':'username','width':0x14},{'header':_0x37a393(0x1fc),'key':_0x37a393(0x1d7),'width':0x14},{'header':_0x37a393(0x217),'key':_0x37a393(0x1c6),'width':0x14},{'header':_0x37a393(0x1c4),'key':_0x37a393(0x20c),'width':0x50},{'header':_0x37a393(0x242),'key':_0x37a393(0x20a),'width':0x96}],_0x445377['forEach'](_0x42151b=>_0xcf80dc[_0x37a393(0x22a)](_0x42151b)),_0x1cbb47[_0x37a393(0x1f1)](_0x37a393(0x20e),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x1cbb47['setHeader']('Content-Disposition','attachment;\x20filename='+'chat.xlsx'),await _0x528b0a[_0x37a393(0x238)][_0x37a393(0x23d)](_0x1cbb47),_0x1cbb47[_0x37a393(0x211)]();}async['querAllChatLog'](_0x539ea4,_0x2f2d3b){const _0x1ee2b7=_0x40c6ba,{page:page=0x1,size:size=0x14,userId:_0x1a5c4e,prompt:_0x405915,modelType:_0x3847d4}=_0x539ea4,_0x47330e={'type':balance_constant_1['DeductionKey'][_0x1ee2b7(0x21d)],'prompt':(0x0,typeorm_2[_0x1ee2b7(0x1c8)])('')};_0x1a5c4e&&Object[_0x1ee2b7(0x20f)](_0x47330e,{'userId':_0x1a5c4e}),_0x405915&&Object['assign'](_0x47330e,{'prompt':(0x0,typeorm_2[_0x1ee2b7(0x213)])('%'+_0x405915+'%')});_0x3847d4?_0x47330e[_0x1ee2b7(0x243)]=_0x3847d4:_0x47330e['modelType']=(0x0,typeorm_2[_0x1ee2b7(0x200)])();const [_0x2c176e,_0xc9b39f]=await this[_0x1ee2b7(0x225)][_0x1ee2b7(0x247)]({'order':{'id':_0x1ee2b7(0x1f6)},'skip':(page-0x1)*size,'take':size,'where':_0x47330e}),_0x1bc2bd=_0x2c176e[_0x1ee2b7(0x1fa)](_0x1b5c22=>_0x1b5c22['userId']),_0x4d0be0=await this[_0x1ee2b7(0x240)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x1bc2bd)},'select':['id','username',_0x1ee2b7(0x1d7)]});return _0x2c176e['forEach'](_0x425c9b=>{const _0x6df694=_0x1ee2b7,{username:_0x35603d,email:_0x21e57a}=_0x4d0be0[_0x6df694(0x24d)](_0x29982a=>_0x29982a['id']===_0x425c9b[_0x6df694(0x1df)])||{};_0x425c9b[_0x6df694(0x1f3)]=_0x35603d,_0x425c9b[_0x6df694(0x1d7)]=_0x21e57a;}),_0x2f2d3b[_0x1ee2b7(0x249)][_0x1ee2b7(0x1dd)]!==_0x1ee2b7(0x234)&&_0x2c176e[_0x1ee2b7(0x1db)](_0x1cb5b3=>_0x1cb5b3['email']=(0x0,utils_1['maskEmail'])(_0x1cb5b3['email'])),_0x2c176e[_0x1ee2b7(0x1db)](_0x23ca6c=>{const _0xd5de82=_0x1ee2b7;!_0x23ca6c['email']&&(_0x23ca6c[_0xd5de82(0x1d7)]=_0x23ca6c?.[_0xd5de82(0x1df)]+_0xd5de82(0x1ca)),!_0x23ca6c[_0xd5de82(0x1f3)]&&(_0x23ca6c[_0xd5de82(0x1f3)]='游客'+_0x23ca6c?.['userId']);}),{'rows':_0x2c176e,'count':_0xc9b39f};}async['chatList'](_0x4881ca,_0x32b60b){const _0x4e899a=_0x40c6ba,{id:_0xc4c386}=_0x4881ca[_0x4e899a(0x249)],{groupId:_0x5682c7,logType:_0x44c70c}=_0x32b60b,_0x15c8ff={'userId':_0xc4c386,'isDelete':![]};_0x5682c7&&Object[_0x4e899a(0x20f)](_0x15c8ff,{'groupId':_0x5682c7}),_0x44c70c&&Object[_0x4e899a(0x20f)](_0x15c8ff,{'logType':_0x44c70c}),_0x15c8ff[_0x4e899a(0x243)]=(0x0,typeorm_2[_0x4e899a(0x200)])();const _0x47bd4d=await this['chatLogEntity'][_0x4e899a(0x24d)]({'where':_0x15c8ff})[_0x4e899a(0x233)](_0x424e0b=>{const _0x4ddcf3=_0x4e899a;common_1[_0x4ddcf3(0x1fb)][_0x4ddcf3(0x1e1)](_0x424e0b);});if(!_0x47bd4d||_0x47bd4d[_0x4e899a(0x24c)]===0x0)return[];return _0x47bd4d['map'](_0x3ba5d2=>{const _0x4b08a6=_0x4e899a,{prompt:_0x37b349,role:_0x4ed127,answer:_0x161a9f,createdAt:_0x3b0550,model:_0x10c69d,conversationOptions:_0x557f84,requestOptions:_0x4dd5b2,id:_0x167c5b}=_0x3ba5d2;return{'chatId':_0x167c5b,'dateTime':(0x0,utils_1['formatDate'])(_0x3b0550),'text':_0x4ed127==='user'?_0x37b349:_0x161a9f,'inversion':_0x4ed127==='user','error':![],'conversationOptions':_0x557f84?JSON[_0x4b08a6(0x1ec)](_0x557f84):null,'requestOptions':_0x4dd5b2?JSON['parse'](_0x4dd5b2):null};});}async[_0x40c6ba(0x208)](_0xd0dcbf,_0x5df61c){const _0x41ec5f=_0x40c6ba;try{const _0x3ebb33={'isDelete':![],'answer':(0x0,typeorm_2['Not'])((0x0,typeorm_2[_0x41ec5f(0x200)])()),'modelType':_0x41ec5f(0x1e0),'userId':_0xd0dcbf[_0x41ec5f(0x249)]['id']},[_0x24ae35,_0x3556e0]=await this[_0x41ec5f(0x225)][_0x41ec5f(0x247)]({'where':_0x3ebb33,'take':_0x5df61c[_0x41ec5f(0x21f)],'skip':(_0x5df61c[_0x41ec5f(0x215)]-0x1)*_0x5df61c[_0x41ec5f(0x21f)],'order':{'createdAt':'DESC'}}),_0xe4fe67=_0x24ae35['map'](_0x31344e=>_0x31344e['id']),_0x475e8a=new Map();if(_0xe4fe67['length']){const _0x3399cf=await this[_0x41ec5f(0x1cd)][_0x41ec5f(0x24d)]({'where':{'relateId':(0x0,typeorm_2['In'])(_0xe4fe67),'userId':_0xd0dcbf[_0x41ec5f(0x249)]['id']}});_0x3399cf[_0x41ec5f(0x1db)](_0x36d27e=>{const _0x5e62a9=_0x41ec5f;_0x475e8a[_0x5e62a9(0x1d2)](_0x36d27e[_0x5e62a9(0x1ed)],_0x36d27e['action']);});}const _0x3e834e=_0x24ae35[_0x41ec5f(0x1fa)](_0x2e9c8c=>{const _0x126a59=_0x41ec5f,{prompt:_0x4c5432,role:_0x38197c,answer:_0x46884a,createdAt:_0x2e9196,model:_0x32ca2a,conversationOptions:_0x7ba8dd,requestOptions:_0x6690e8,id:_0x506916}=_0x2e9c8c;return{'chatId':_0x506916,'error':![],'inversion':_0x38197c===_0x126a59(0x249),'agree':_0x475e8a[_0x126a59(0x1ff)](_0x506916)||null,'dateTime':(0x0,utils_1[_0x126a59(0x250)])(_0x2e9196),'text':_0x38197c===_0x126a59(0x249)?_0x4c5432:_0x46884a,'requestOptions':_0x6690e8?JSON[_0x126a59(0x1ec)](_0x6690e8):null,'conversationOptions':_0x7ba8dd?JSON[_0x126a59(0x1ec)](_0x7ba8dd):null};});return{'count':_0x3556e0,'records':_0x3e834e};}catch(_0x5be152){throw new common_1[(_0x41ec5f(0x1e7))](_0x5be152['message'],common_1['HttpStatus'][_0x41ec5f(0x209)]);}}async['chatGptsList'](_0x5cd447,_0x306942){const _0x47f405=_0x40c6ba,{id:_0x1a0944}=_0x5cd447[_0x47f405(0x249)],{groupId:_0x5f09ad}=_0x306942,_0x236693={'userId':_0x1a0944,'isDelete':![]};_0x5f09ad&&Object[_0x47f405(0x20f)](_0x236693,{'groupId':_0x5f09ad});const _0x4e86db=await this['chatLogEntity'][_0x47f405(0x24d)]({'where':_0x236693});return _0x4e86db[_0x47f405(0x1fa)](_0x112578=>{const _0x2029d4=_0x47f405,{prompt:_0x4c21bb,role:_0xb14212,answer:_0x446dc5,createdAt:_0x1c042a,model:_0xcd0023,conversationOptions:_0x1f1784,requestOptions:_0x1671bd,id:_0x4d5968}=_0x112578;return{'chatId':_0x4d5968,'dateTime':(0x0,utils_1[_0x2029d4(0x250)])(_0x1c042a),'text':_0xb14212==='user'?_0x4c21bb:_0x446dc5,'inversion':_0xb14212===_0x2029d4(0x249),'error':![],'conversationOptions':_0x1f1784?JSON['parse'](_0x1f1784):null,'requestOptions':_0x1671bd?JSON[_0x2029d4(0x1ec)](_0x1671bd):null};});}async[_0x40c6ba(0x22b)](_0x11ea03,_0x2326a8){const _0x5ab39f=_0x40c6ba,{id:_0x27a62d}=_0x11ea03[_0x5ab39f(0x249)],{id:_0x57a04e}=_0x2326a8,_0x4889c7=await this[_0x5ab39f(0x225)][_0x5ab39f(0x221)]({'where':{'id':_0x57a04e,'userId':_0x27a62d}});if(!_0x4889c7)throw new common_1[(_0x5ab39f(0x1e7))]('你删除的对话记录不存在、请检查！',common_1[_0x5ab39f(0x227)][_0x5ab39f(0x209)]);const _0x1551b0=await this[_0x5ab39f(0x225)]['update']({'id':_0x57a04e},{'isDelete':!![]});if(_0x1551b0[_0x5ab39f(0x248)]>0x0)return'删除对话记录成功！';else throw new common_1[(_0x5ab39f(0x1e7))](_0x5ab39f(0x20d),common_1['HttpStatus'][_0x5ab39f(0x209)]);}async[_0x40c6ba(0x230)](_0x450d06,_0x55709d){const _0x40340a=_0x40c6ba,{groupId:_0x4b3842,type:_0x2ca0f2}=_0x55709d,{id:_0x1baf64}=_0x450d06[_0x40340a(0x249)],_0x136e86=_0x2ca0f2&&_0x2ca0f2===_0x40340a(0x1eb)?{'groupId':_0x4b3842,'userId':_0x1baf64}:{'groupId':_0x4b3842,'userId':_0x1baf64},_0xf3b561=await this['chatLogEntity']['delete'](_0x136e86);if(_0xf3b561[_0x40340a(0x248)]>0x0)return!![];if(_0xf3b561['affected']===0x0)throw new common_1[(_0x40340a(0x1e7))](_0x40340a(0x24a),common_1[_0x40340a(0x227)][_0x40340a(0x209)]);}async[_0x40c6ba(0x1d3)](_0x7c70c){const _0x2ffa6f=_0x40c6ba,{ids:_0x103356,userId:_0x34a206}=_0x7c70c;return await this[_0x2ffa6f(0x225)][_0x2ffa6f(0x23a)]({'groupId':(0x0,typeorm_2['In'])(_0x103356),'userId':_0x34a206});}async[_0x40c6ba(0x231)](_0x34d716,_0x3a7936){const _0x3d914b=_0x40c6ba,{id:_0x2795ae}=_0x34d716['user'],{appId:_0x14b6ab,page:page=0x1,size:size=0xa}=_0x3a7936,[_0x22f047,_0x5cb086]=await this['chatLogEntity']['findAndCount']({'where':{'userId':_0x2795ae,'appId':_0x14b6ab,'role':'assistant'},'order':{'id':_0x3d914b(0x1f6)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x22f047,'count':_0x5cb086};}async[_0x40c6ba(0x1ea)](){const _0x2cb59b=_0x40c6ba,_0x2be0ce=await this['chatLogEntity'][_0x2cb59b(0x24d)]({'where':{'modelType':'music','answer':(0x0,typeorm_2[_0x2cb59b(0x213)])(_0x2cb59b(0x24f))}});for(let _0x2cc5f3=0x0;_0x2cc5f3<_0x2be0ce[_0x2cb59b(0x24c)];_0x2cc5f3++){const _0x4e1fc7=_0x2be0ce[_0x2cc5f3];if(!_0x4e1fc7['answer'])continue;const _0x16fc35=redisKey_constant_1[_0x2cb59b(0x1e4)]+_0x4e1fc7['id'];try{const _0xffbbc=await this[_0x2cb59b(0x20b)][_0x2cb59b(0x1ff)]({'key':_0x16fc35});if(_0xffbbc)continue;await this['redisCacheService'][_0x2cb59b(0x1d2)]({'key':_0x16fc35,'val':_0x2cb59b(0x1f8)});const _0x5ad8e6=_0x4e1fc7[_0x2cb59b(0x20a)]['match'](/https:\/\/filesystem.site\/cdn(.+)\)/g);if(!_0x5ad8e6)continue;const _0x45a95f=Array[_0x2cb59b(0x235)][_0x2cb59b(0x229)]['call'](_0x5ad8e6)[_0x2cb59b(0x1fa)](_0x5a7977=>_0x5a7977[_0x2cb59b(0x1f5)](0x0,_0x5a7977['length']-0x1));try{const _0x29bfaf=await Promise[_0x2cb59b(0x22d)](_0x45a95f[_0x2cb59b(0x1fa)](_0xf25392=>this[_0x2cb59b(0x203)][_0x2cb59b(0x207)](_0xf25392)));for(let _0x24d1e2=0x0;_0x24d1e2<_0x29bfaf[_0x2cb59b(0x24c)];_0x24d1e2++){_0x29bfaf[_0x24d1e2]&&(_0x4e1fc7['answer']=_0x4e1fc7[_0x2cb59b(0x20a)][_0x2cb59b(0x1d6)](_0x45a95f[_0x24d1e2],_0x29bfaf[_0x24d1e2]));}await this['chatLogEntity'][_0x2cb59b(0x1fd)](_0x4e1fc7);}catch(_0x3a785b){common_1[_0x2cb59b(0x1fb)][_0x2cb59b(0x1e1)](_0x3a785b);}}finally{await this[_0x2cb59b(0x20b)]['del']({'key':_0x16fc35});}}}};ChatLogService=__decorate([(0x0,common_1[_0x40c6ba(0x1f9)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x40c6ba(0x210)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x40c6ba(0x246)])(chatGroup_entity_1[_0x40c6ba(0x226)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(aiAgreeLog_entity_1[_0x40c6ba(0x24b)])),__metadata(_0x40c6ba(0x1d8),[typeorm_2[_0x40c6ba(0x22c)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x40c6ba(0x232)],upload_service_1[_0x40c6ba(0x24e)],redisCache_service_1['RedisCacheService']])],ChatLogService),exports['ChatLogService']=ChatLogService;