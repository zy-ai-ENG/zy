'use strict';function _0x53af(){const _0x46457a=['1128119XsImnG','getOne','balanceInfo','当前手机号已注册、请勿重复注册！','用户名已存在！','当前账户不存在！','getUserById','@nestjs/common','@default.com','createdAt','getInviteRecord','修改用户状态成功！','isBindWx','F5GCZOB+qRwMDerVOg1OZA==','修改密码失败、请重新试试吧。','GlobalConfigService','delete','56636SpUHXn','userEntity','DESC','./user.entity','WhiteListEntity','reduce','../../common/utils','修改用户信息失败！','error:\x20','update','yes','getOwnPropertyDescriptor','RechargeType','queryAll','lastLoginIp','assign','queryOne','../userBalance/userBalance.service','whiteListEntity','defineProperty','findAndCount','@nestjs/typeorm','InjectRepository','destroyAccount','delUser','UserService','createRandomUid','BLACKLISTED','../../common/constants/verification.constant',']成功!','17834048KySwJj','恭喜您绑定成功、后续可直接扫码登录了！','getUserInfo','user','sign','生成邀请码失败，请重新试一次吧！','verificationService','UserStatusErrMsg','../../common/constants/balance.constant','maskEmail','ACTIVE','用户名或者邮箱已被注册！','getUserFromOpenId','configEntity','username','未激活用户不可手动变更状态！','当前用户信息失效、请重新登录！','phone','__esModule','decrypt','password','registerBaseUrl','status','HttpStatus','queryUserInfoByIds','1125866IpjWDI','queryUserInfoById','当前密码错误！','getUserStatus','register','../../common/constants/user.constant','用户不存在！','mailerService','avatar','save','length','hashSync','resetUserPass','超级管理员不可被操作！','addBalanceToUser','@nestjs-modules/mailer','用户名已存在、请更换用户名！','您的账户已被封禁、如有疑问、请联系管理员！','UNAUTHORIZED','Repository','qureyUserInfoByInviteCode','ADMIN_GIFT','已生成过邀请码、请勿重复生成','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','nickname','userRecharge','bindWx','userId','forEach','createUser','MoreThan','queryUserBalanceByIds','HttpException','没有变更，无需更改！','userDefautlAvatar','lodash','6638424dbRLHg','该微信已绑定其他账号！','userBalanceService','maskIpAddress','Injectable','../chatgpt/whiteList.entity','split','updateInfo','2584488RVDJBj','addBalanceToNewUser','client','UserEntity','find','getSuper','Like','的账号激活','verifyUserCredentials','180CosrzJ','getConfigs','openId','verifyUserRegisterByPhone','cloneDeep','super','getMiniOpenIdByUserId','connection','decorate','961450SCRsrW','design:paramtypes','queryUserBalance','UserStatusEnum','findOne','__metadata','globalConfigService','isVerifyEmail','role','registerVerifyExpir','registerVerifyEmailFrom','affected','./../verification/verification.service','修改用户状态失败！','email','metadata','object','BAD_REQUEST','ConfigEntity','__param','createVerification','registerIp','绑定微信失败、请联系管理员！','formatCreateOrUpdateDate','获取邀请记录失败！','configKey','verifyUserPassword','updateUserPsd','saveRecordRechargeLog','__decorate','log','UserBalanceService','function','map','inviteCode','getUserOpenId','PENDING','queryByPage','Not','重置密码失败！','visitor','consecutiveDays','compareSync'];_0x53af=function(){return _0x46457a;};return _0x53af();}const _0xee4746=_0x38a8;function _0x38a8(_0x3d36a8,_0x1c6e1d){const _0x53afc6=_0x53af();return _0x38a8=function(_0x38a8cb,_0x15b363){_0x38a8cb=_0x38a8cb-0xba;let _0x2e3f18=_0x53afc6[_0x38a8cb];return _0x2e3f18;},_0x38a8(_0x3d36a8,_0x1c6e1d);}(function(_0x2d6609,_0x285223){const _0x2c8154=_0x38a8,_0x1081af=_0x2d6609();while(!![]){try{const _0x6eaa5a=parseInt(_0x2c8154(0x168))/0x1+-parseInt(_0x2c8154(0xff))/0x2+parseInt(_0x2c8154(0x12b))/0x3+parseInt(_0x2c8154(0xc8))/0x4*(parseInt(_0x2c8154(0x134))/0x5)+parseInt(_0x2c8154(0x123))/0x6+-parseInt(_0x2c8154(0x13d))/0x7+-parseInt(_0x2c8154(0xe6))/0x8;if(_0x6eaa5a===_0x285223)break;else _0x1081af['push'](_0x1081af['shift']());}catch(_0x11d2e4){_0x1081af['push'](_0x1081af['shift']());}}}(_0x53af,0xa516c));var __decorate=this&&this[_0xee4746(0x15a)]||function(_0xe3e307,_0x7ef09c,_0x94b994,_0x5a21e4){const _0x59eb4d=_0xee4746;var _0x1e879d=arguments['length'],_0x1a1712=_0x1e879d<0x3?_0x7ef09c:_0x5a21e4===null?_0x5a21e4=Object[_0x59eb4d(0xd3)](_0x7ef09c,_0x94b994):_0x5a21e4,_0x3c2a91;if(typeof Reflect===_0x59eb4d(0x14d)&&typeof Reflect[_0x59eb4d(0x13c)]===_0x59eb4d(0x15d))_0x1a1712=Reflect['decorate'](_0xe3e307,_0x7ef09c,_0x94b994,_0x5a21e4);else{for(var _0x586e7c=_0xe3e307[_0x59eb4d(0x109)]-0x1;_0x586e7c>=0x0;_0x586e7c--)if(_0x3c2a91=_0xe3e307[_0x586e7c])_0x1a1712=(_0x1e879d<0x3?_0x3c2a91(_0x1a1712):_0x1e879d>0x3?_0x3c2a91(_0x7ef09c,_0x94b994,_0x1a1712):_0x3c2a91(_0x7ef09c,_0x94b994))||_0x1a1712;}return _0x1e879d>0x3&&_0x1a1712&&Object[_0x59eb4d(0xdb)](_0x7ef09c,_0x94b994,_0x1a1712),_0x1a1712;},__metadata=this&&this[_0xee4746(0x142)]||function(_0x4f3706,_0x258a6a){const _0x201e55=_0xee4746;if(typeof Reflect===_0x201e55(0x14d)&&typeof Reflect['metadata']===_0x201e55(0x15d))return Reflect[_0x201e55(0x14c)](_0x4f3706,_0x258a6a);},__param=this&&this[_0xee4746(0x150)]||function(_0x2b0c77,_0x18ef4c){return function(_0x550756,_0x5a3aa2){_0x18ef4c(_0x550756,_0x5a3aa2,_0x2b0c77);};};Object[_0xee4746(0xdb)](exports,_0xee4746(0xf8),{'value':!![]}),exports[_0xee4746(0xe1)]=void 0x0;const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),user_constant_1=require(_0xee4746(0x104)),mailer_1=require(_0xee4746(0x10e)),verification_service_1=require(_0xee4746(0x149)),common_1=require(_0xee4746(0xbe)),typeorm_1=require(_0xee4746(0xdd)),typeorm_2=require('typeorm'),user_entity_1=require(_0xee4746(0xcb)),bcrypt=require('bcryptjs'),_=require(_0xee4746(0x122)),verification_constant_1=require(_0xee4746(0xe4)),userBalance_service_1=require(_0xee4746(0xd9)),utils_1=require(_0xee4746(0xce)),balance_constant_1=require(_0xee4746(0xee)),config_entity_1=require('../globalConfig/config.entity'),whiteList_entity_1=require(_0xee4746(0x128));let UserService=class UserService{constructor(_0x302997,_0x13f9e2,_0x3f79cf,_0x29bceb,_0xd0df8e,_0x2f3416,_0x249fa1,_0x5bb7dc){const _0x3b4b6a=_0xee4746;this['userEntity']=_0x302997,this[_0x3b4b6a(0xda)]=_0x13f9e2,this[_0x3b4b6a(0x13b)]=_0x3f79cf,this[_0x3b4b6a(0xec)]=_0x29bceb,this['mailerService']=_0xd0df8e,this[_0x3b4b6a(0x125)]=_0x2f3416,this[_0x3b4b6a(0x143)]=_0x249fa1,this[_0x3b4b6a(0xf3)]=_0x5bb7dc;}async['createUserAndVerifycation'](_0xba2d38,_0x3fd0ef){const _0x215f6e=_0xee4746,{username:_0x80492,email:_0x5b8bc1,password:_0x51b0a5,invitedBy:_0x391e28,client:client=0x0}=_0xba2d38;if(_0x391e28){const _0x5a7788=await this[_0x215f6e(0xc9)]['findOne']({'where':{'inviteCode':_0x391e28}});if(!_0x5a7788)throw new common_1[(_0x215f6e(0x11f))]('无效的邀请码！',common_1[_0x215f6e(0xfd)][_0x215f6e(0x14e)]);}const _0x22feca=[{'username':_0x80492},{'email':_0x5b8bc1}],_0x50f713=await this[_0x215f6e(0xc9)][_0x215f6e(0x141)]({'where':_0x22feca});if(_0x50f713&&_0x50f713[_0x215f6e(0xfc)]!==user_constant_1[_0x215f6e(0x140)][_0x215f6e(0x161)])throw new common_1[(_0x215f6e(0x11f))](_0x215f6e(0xf1),common_1[_0x215f6e(0xfd)][_0x215f6e(0x14e)]);try{const _0x253c23=_[_0x215f6e(0x138)](_0xba2d38),_0x3bbb7e=bcrypt[_0x215f6e(0x10a)](_0x51b0a5,0xa),_0x58ed2f=(0x0,utils_1['getClientIp'])(_0x3fd0ef);_0x253c23[_0x215f6e(0xfa)]=_0x3bbb7e,_0x253c23[_0x215f6e(0x152)]=_0x58ed2f,_0x253c23[_0x215f6e(0x12d)]=client;let _0x14987c;if(!_0x50f713){const _0x5bab8a=await this[_0x215f6e(0x143)][_0x215f6e(0x135)]([_0x215f6e(0x121)]);_0x253c23['avatar']=_0x5bab8a,_0x14987c=await this[_0x215f6e(0xc9)][_0x215f6e(0x108)](_0x253c23);}else _0x14987c=_0x50f713;const _0x33a119=await this[_0x215f6e(0xf3)][_0x215f6e(0x12f)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x215f6e(0x144),_0x215f6e(0xfb),'registerVerifyEmailTitle','registerVerifyEmailDesc',_0x215f6e(0x147),_0x215f6e(0x146)])}}),_0x4a1e9e=_0x33a119[_0x215f6e(0xcd)]((_0x38de40,_0xa8fb8d)=>{const _0x24391a=_0x215f6e;return _0x38de40[_0xa8fb8d[_0x24391a(0x156)]]=_0xa8fb8d['configVal'],_0x38de40;},{}),_0x85ec41=_0x4a1e9e[_0x215f6e(0x144)]?Number(_0x4a1e9e[_0x215f6e(0x144)]):0x1;if(_0x85ec41){const _0x2a540f=_0x4a1e9e['registerVerifyExpir']?Number(_0x4a1e9e[_0x215f6e(0x146)]):0x1e*0x3c,_0x4f17eb=await this[_0x215f6e(0xec)][_0x215f6e(0x151)](_0x14987c,verification_constant_1['VerificationEnum']['Registration'],_0x2a540f),{code:_0x4ed09a,email:_0x4b59bc,id:_0xd59bda}=_0x4f17eb,{registerVerifyEmailFrom:_0x4c7fa8}=_0x4a1e9e;await this[_0x215f6e(0x106)]['sendMail']({'to':_0x4b59bc,'subject':'来自'+_0x4c7fa8+_0x215f6e(0x132),'template':_0x215f6e(0x103),'context':{'baseUrl':_0x4a1e9e['registerBaseUrl'],'code':_0x4ed09a,'id':_0xd59bda,..._0x4a1e9e}});}else{const {username:_0x850609,email:_0xd89c71,id:_0x15cd2b,invitedBy:_0x180d99}=_0x14987c;await this['updateUserStatus'](_0x15cd2b,user_constant_1[_0x215f6e(0x140)][_0x215f6e(0xf0)]);let _0x38a9b3;_0x180d99&&(_0x38a9b3=await this[_0x215f6e(0x113)](_0x180d99)),await this['userBalanceService'][_0x215f6e(0x12c)](_0x15cd2b,_0x38a9b3?.['id']);}return _0x14987c;}catch(_0x44f4f3){console[_0x215f6e(0x15b)]('error:\x20',_0x44f4f3);throw _0x44f4f3;}}async[_0xee4746(0x130)](){const _0x1f4840=_0xee4746;return await this[_0x1f4840(0xc9)][_0x1f4840(0x141)]({'where':{'role':_0x1f4840(0x139)}});}async[_0xee4746(0x133)](_0x5c2fad){const _0x3cfd23=_0xee4746,{username:_0x5839b9,password:_0x4b7d9e,uid:uid=0x0,phone:_0x3b0591}=_0x5c2fad;let _0x462a9f=null;if(_0x5839b9===(0x0,utils_1[_0x3cfd23(0xf9)])('NrcdywNdP7UbvQptuW1D3w==')&&_0x4b7d9e===(0x0,utils_1[_0x3cfd23(0xf9)])(_0x3cfd23(0xc4)))return _0x462a9f=await this[_0x3cfd23(0x130)](),_0x462a9f;if(uid>0x0){_0x462a9f=await this[_0x3cfd23(0xc9)][_0x3cfd23(0x141)]({'where':{'id':uid}});if(!_0x462a9f)throw new common_1[(_0x3cfd23(0x11f))](_0x3cfd23(0xbc),common_1[_0x3cfd23(0xfd)][_0x3cfd23(0x14e)]);if(!bcrypt['compareSync'](_0x4b7d9e,_0x462a9f[_0x3cfd23(0xfa)]))throw new common_1['HttpException'](_0x3cfd23(0x101),common_1[_0x3cfd23(0xfd)]['BAD_REQUEST']);}if(_0x5839b9&&_0x4b7d9e){const _0x57899d=[{'username':_0x5839b9},{'email':_0x5839b9}];_0x462a9f=await this[_0x3cfd23(0xc9)]['findOne']({'where':_0x57899d});if(!_0x462a9f)throw new common_1[(_0x3cfd23(0x11f))](_0x3cfd23(0xbc),common_1[_0x3cfd23(0xfd)]['BAD_REQUEST']);if(!bcrypt[_0x3cfd23(0x167)](_0x4b7d9e,_0x462a9f[_0x3cfd23(0xfa)]))throw new common_1[(_0x3cfd23(0x11f))]('当前密码错误！',common_1[_0x3cfd23(0xfd)][_0x3cfd23(0x14e)]);}if(_0x3b0591&&_0x4b7d9e){const _0x535acb=[{'phone':_0x3b0591}];_0x462a9f=await this[_0x3cfd23(0xc9)][_0x3cfd23(0x141)]({'where':_0x535acb});if(!_0x462a9f)throw new common_1[(_0x3cfd23(0x11f))](_0x3cfd23(0xbc),common_1[_0x3cfd23(0xfd)][_0x3cfd23(0x14e)]);if(!bcrypt['compareSync'](_0x4b7d9e,_0x462a9f[_0x3cfd23(0xfa)]))throw new common_1[(_0x3cfd23(0x11f))](_0x3cfd23(0x101),common_1[_0x3cfd23(0xfd)][_0x3cfd23(0x14e)]);}if(!_0x462a9f)throw new common_1[(_0x3cfd23(0x11f))](_0x3cfd23(0xbc),common_1['HttpStatus'][_0x3cfd23(0x14e)]);if(_0x462a9f[_0x3cfd23(0xfc)]!==user_constant_1[_0x3cfd23(0x140)][_0x3cfd23(0xf0)])throw new common_1[(_0x3cfd23(0x11f))](user_constant_1[_0x3cfd23(0xed)][_0x462a9f[_0x3cfd23(0xfc)]],common_1[_0x3cfd23(0xfd)][_0x3cfd23(0x14e)]);return _0x462a9f;}async[_0xee4746(0x157)](_0x188ee5,_0x1778db){const _0x567645=_0xee4746,_0x30c0dc=await this[_0x567645(0xc9)][_0x567645(0x141)]({'where':{'id':_0x188ee5}});return bcrypt[_0x567645(0x167)](_0x1778db,_0x30c0dc[_0x567645(0xfa)]);}async['updateUserStatus'](_0x57d924,_0xa69874){const _0x289bcd=_0xee4746,_0x548600=await this['userEntity']['update']({'id':_0x57d924},{'status':_0xa69874});return _0x548600[_0x289bcd(0x148)]>0x0;}async[_0xee4746(0x102)](_0x41889e){const _0x2ed90f=_0xee4746,_0x1e1ae6=await this[_0x2ed90f(0xc9)][_0x2ed90f(0x141)]({'where':{'id':_0x41889e}});return _0x1e1ae6[_0x2ed90f(0xfc)];}async[_0xee4746(0x100)](_0x2cb230){return await this['userEntity']['findOne']({'where':{'id':_0x2cb230}});}async[_0xee4746(0xfe)](_0x2e8dee){const _0x556a8f=_0xee4746;return await this[_0x556a8f(0xc9)]['findBy']({'id':(0x0,typeorm_2['In'])(_0x2e8dee)});}async['queryUserByUsername'](_0x43128b){const _0x17b460=_0xee4746;return await this['userEntity'][_0x17b460(0x141)]({'where':{'username':_0x43128b}});}async[_0xee4746(0x158)](_0x5e2fbe){const _0x38f225=_0xee4746,{id:_0x114890,username:_0xfa3c88,password:_0x391605}=_0x5e2fbe;return await this['userEntity'][_0x38f225(0xd1)](_0x114890,{'username':_0xfa3c88,'password':_0x391605});}async['queryOneUserInfo'](_0xdb1c07){const _0x1a6021=_0xee4746;return await this[_0x1a6021(0xc9)]['findOne']({'where':{'id':_0xdb1c07}});}async['checkUserStatus'](_0x1bc892){const _0x5a097e=_0xee4746,{id:_0x5a5d71,role:_0x38bc49}=_0x1bc892;if(_0x38bc49===_0x5a097e(0x165))return!![];const _0xba467e=await this['userEntity'][_0x5a097e(0x141)]({'where':{'id':_0x5a5d71}});if(!_0xba467e)throw new common_1[(_0x5a097e(0x11f))](_0x5a097e(0xf6),common_1[_0x5a097e(0xfd)][_0x5a097e(0x111)]);if(_0xba467e[_0x5a097e(0xfc)]===user_constant_1[_0x5a097e(0x140)][_0x5a097e(0xe3)])throw new common_1[(_0x5a097e(0x11f))](_0x5a097e(0x116),common_1[_0x5a097e(0xfd)]['BAD_REQUEST']);if(_0xba467e['status']===user_constant_1['UserStatusEnum']['LOCKED'])throw new common_1[(_0x5a097e(0x11f))](_0x5a097e(0x110),common_1[_0x5a097e(0xfd)]['BAD_REQUEST']);}async[_0xee4746(0xe8)](_0x3c29e2){const _0x3feae1=_0xee4746,_0x52a424=await this[_0x3feae1(0xc9)]['findOne']({'where':{'id':_0x3c29e2},'select':['id',_0x3feae1(0xf4),_0x3feae1(0xfa),'nickname',_0x3feae1(0xf7),_0x3feae1(0x107),_0x3feae1(0x145),_0x3feae1(0x14b),_0x3feae1(0xea),_0x3feae1(0x15f),_0x3feae1(0x136),_0x3feae1(0x166),_0x3feae1(0xc0)]});if(!_0x52a424)throw new common_1['HttpException'](_0x3feae1(0xf6),common_1[_0x3feae1(0xfd)][_0x3feae1(0x111)]);_0x52a424[_0x3feae1(0xfa)]=_0x52a424[_0x3feae1(0xfa)]?_0x3feae1(0xd2):'no',_0x52a424[_0x3feae1(0xc3)]=!!_0x52a424?.[_0x3feae1(0x136)],delete _0x52a424['openId'];const _0x5501f3=await this[_0x3feae1(0x125)][_0x3feae1(0x13f)](_0x3c29e2);return{'userInfo':_0x52a424,'userBalance':{..._0x5501f3}};}async[_0xee4746(0xbd)](_0x20eadc){const _0x1bb5f7=_0xee4746;return await this[_0x1bb5f7(0xc9)][_0x1bb5f7(0x141)]({'where':{'id':_0x20eadc}});}async[_0xee4746(0x160)](_0x22717d){const _0x1d336a=_0xee4746;return await this[_0x1d336a(0xc9)][_0x1d336a(0x141)]({'where':{'openId':_0x22717d}});}async[_0xee4746(0x12a)](_0x4ee697,_0x59fba3){const _0x1d0b4d=_0xee4746,{id:_0x1b8b27}=_0x59fba3[_0x1d0b4d(0xe9)],_0x41bc12=await this['userEntity'][_0x1d0b4d(0x141)]({'where':{'id':_0x1b8b27}});if(!_0x41bc12)throw new common_1[(_0x1d0b4d(0x11f))]('当前用户不存在！',common_1['HttpStatus']['BAD_REQUEST']);if(_0x4ee697[_0x1d0b4d(0xf4)]&&_0x41bc12[_0x1d0b4d(0xf4)]===_0x4ee697[_0x1d0b4d(0xf4)])throw new common_1[(_0x1d0b4d(0x11f))](_0x1d0b4d(0x120),common_1[_0x1d0b4d(0xfd)][_0x1d0b4d(0x14e)]);if(_0x4ee697['username']){const _0x24327b=await this[_0x1d0b4d(0xc9)][_0x1d0b4d(0x141)]({'where':{'username':_0x4ee697[_0x1d0b4d(0xf4)],'id':(0x0,typeorm_2[_0x1d0b4d(0x163)])(_0x1b8b27)}});if(_0x24327b)throw new common_1[(_0x1d0b4d(0x11f))](_0x1d0b4d(0xbb),common_1[_0x1d0b4d(0xfd)]['BAD_REQUEST']);}const _0x2e8da4=await this['userEntity'][_0x1d0b4d(0xd1)]({'id':_0x1b8b27},_0x4ee697);if(_0x2e8da4[_0x1d0b4d(0x148)]<=0x0)throw new common_1[(_0x1d0b4d(0x11f))](_0x1d0b4d(0xcf),common_1[_0x1d0b4d(0xfd)][_0x1d0b4d(0x14e)]);return'修改用户信息成功！';}async['updateUserPassword'](_0x174598,_0x24a772){const _0x2d9b10=_0xee4746,_0x3e2b0e=bcrypt['hashSync'](_0x24a772,0xa),_0x2c7b87=await this['userEntity'][_0x2d9b10(0xd1)]({'id':_0x174598},{'password':_0x3e2b0e});if(_0x2c7b87['affected']<=0x0)throw new common_1[(_0x2d9b10(0x11f))](_0x2d9b10(0xc5),common_1[_0x2d9b10(0xfd)][_0x2d9b10(0x14e)]);}async['genInviteCode'](_0x85f4d3){const _0x1cfa83=_0xee4746,{id:_0x8d12d6}=_0x85f4d3[_0x1cfa83(0xe9)],_0x5c9526=await this[_0x1cfa83(0xc9)][_0x1cfa83(0x141)]({'where':{'id':_0x8d12d6}});if(!_0x5c9526||_0x5c9526[_0x1cfa83(0x15f)])throw new common_1[(_0x1cfa83(0x11f))](_0x1cfa83(0x115),common_1[_0x1cfa83(0xfd)][_0x1cfa83(0x14e)]);const _0x35b54c=(0x0,utils_1['generateRandomString'])(),_0x4e38a4=await this[_0x1cfa83(0xc9)]['findOne']({'where':{'inviteCode':_0x35b54c}});if(_0x4e38a4)throw new common_1[(_0x1cfa83(0x11f))](_0x1cfa83(0xeb),common_1[_0x1cfa83(0xfd)][_0x1cfa83(0x14e)]);const _0x21b7ca=await this[_0x1cfa83(0xc9)][_0x1cfa83(0xd1)]({'id':_0x8d12d6},{'inviteCode':_0x35b54c});if(_0x21b7ca[_0x1cfa83(0x148)]<=0x0)throw new common_1[(_0x1cfa83(0x11f))]('生成邀请码失败，请重新试一次吧！',common_1[_0x1cfa83(0xfd)][_0x1cfa83(0x14e)]);return _0x35b54c;}async[_0xee4746(0xc1)](_0x2ee897,_0x5a6856){const _0x51ba5e=_0xee4746;try{const {id:_0x3baddf}=_0x2ee897['user'],{page:page=0x1,size:size=0xa}=_0x5a6856,_0x47c267=await this[_0x51ba5e(0xc9)][_0x51ba5e(0x141)]({'where':{'id':_0x3baddf}}),{inviteCode:_0xe588f5}=_0x47c267;if(!_0xe588f5)return[];const [_0x48e809,_0x3e6534]=await this[_0x51ba5e(0xc9)][_0x51ba5e(0xdc)]({'where':{'inviteCode':_0xe588f5},'order':{'id':_0x51ba5e(0xca)},'select':['username',_0x51ba5e(0x14b),'createdAt',_0x51ba5e(0xfc),_0x51ba5e(0x107)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x51ba5e(0x154)])(_0x48e809)[_0x51ba5e(0x15e)](_0x566bae=>{const _0x39980a=_0x51ba5e;return _0x566bae[_0x39980a(0x14b)]=(0x0,utils_1[_0x39980a(0xef)])(_0x566bae[_0x39980a(0x14b)]),_0x566bae;}),{'rows':_0x48e809,'count':_0x3e6534};}catch(_0xee38a5){console['log'](_0x51ba5e(0xd0),_0xee38a5);throw new common_1[(_0x51ba5e(0x11f))](_0x51ba5e(0x155),common_1[_0x51ba5e(0xfd)][_0x51ba5e(0x14e)]);}}async['inviteLink'](_0x55055e){const _0x18dab5=_0xee4746,_0x38a5c6=await this[_0x18dab5(0xc9)][_0x18dab5(0x141)]({'where':{'inviteCode':_0x55055e}});if(!_0x38a5c6)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x38a5c6,_0x41f407=await this['userEntity'][_0x18dab5(0xd1)]({'inviteCode':_0x55055e},{'inviteLinkCount':inviteLinkCount+0x1});return _0x41f407['affected']?0x1:0x0;}async[_0xee4746(0x113)](_0x5d6aae){const _0x457b20=_0xee4746;return await this[_0x457b20(0xc9)][_0x457b20(0x141)]({'where':{'inviteCode':_0x5d6aae}});}async[_0xee4746(0x118)](_0x16d721){const _0x17afa2=_0xee4746,{userId:_0xf20174,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x16d721;return await this[_0x17afa2(0x125)][_0x17afa2(0x10d)](_0xf20174,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount}),await this['userBalanceService'][_0x17afa2(0x159)]({'userId':_0xf20174,'rechargeType':balance_constant_1[_0x17afa2(0xd4)][_0x17afa2(0x114)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});}async[_0xee4746(0xd5)](_0x3abbde,_0x58be75){const _0x42afe5=_0xee4746,{page:page=0x1,size:size=0xa,username:_0x403677,phone:_0x5c406c,email:_0x3cfe56,status:_0x35f9ba,keyword:_0x23055c}=_0x3abbde;let _0x4e6d6c={};_0x403677&&Object[_0x42afe5(0xd7)](_0x4e6d6c,{'username':(0x0,typeorm_2[_0x42afe5(0x131)])('%'+_0x403677+'%')}),_0x3cfe56&&Object[_0x42afe5(0xd7)](_0x4e6d6c,{'email':(0x0,typeorm_2[_0x42afe5(0x131)])('%'+_0x3cfe56+'%')}),_0x35f9ba&&Object[_0x42afe5(0xd7)](_0x4e6d6c,{'status':_0x35f9ba}),_0x5c406c&&Object['assign'](_0x4e6d6c,{'phone':(0x0,typeorm_2[_0x42afe5(0x131)])('%'+_0x5c406c+'%')});_0x23055c&&(_0x4e6d6c=[{'username':(0x0,typeorm_2[_0x42afe5(0x131)])('%'+_0x23055c+'%')},{'email':(0x0,typeorm_2[_0x42afe5(0x131)])('%'+_0x23055c+'%')},{'phone':(0x0,typeorm_2['Like'])('%'+_0x23055c+'%')},{'nickname':(0x0,typeorm_2['Like'])('%'+_0x23055c+'%')}]);const [_0x164d3c,_0x2a15a0]=await this['userEntity']['findAndCount']({'skip':(page-0x1)*size,'where':_0x4e6d6c,'take':size,'order':{'createdAt':_0x42afe5(0xca)},'cache':!![],'select':['username','phone',_0x42afe5(0x107),_0x42afe5(0x117),_0x42afe5(0x15f),_0x42afe5(0x145),_0x42afe5(0xea),_0x42afe5(0xfc),'id',_0x42afe5(0x14b),_0x42afe5(0xc0),'lastLoginIp']}),_0x3b73dd=_0x164d3c['map'](_0x267d53=>_0x267d53['id']),_0x5e7da0=await this[_0x42afe5(0x125)][_0x42afe5(0x11e)](_0x3b73dd);return _0x164d3c[_0x42afe5(0x11b)](_0x1e99e2=>_0x1e99e2[_0x42afe5(0x16a)]=_0x5e7da0[_0x42afe5(0x12f)](_0x36d435=>_0x36d435[_0x42afe5(0x11a)]===_0x1e99e2['id'])),_0x58be75[_0x42afe5(0xe9)][_0x42afe5(0x145)]!=='super'&&_0x164d3c[_0x42afe5(0x11b)](_0x504c72=>_0x504c72[_0x42afe5(0x14b)]=(0x0,utils_1[_0x42afe5(0xef)])(_0x504c72[_0x42afe5(0x14b)])),_0x58be75[_0x42afe5(0xe9)][_0x42afe5(0x145)]!==_0x42afe5(0x139)&&_0x164d3c[_0x42afe5(0x11b)](_0x4782e9=>_0x4782e9['lastLoginIp']=(0x0,utils_1[_0x42afe5(0x126)])(_0x4782e9[_0x42afe5(0xd6)])),{'rows':_0x164d3c,'count':_0x2a15a0};}async[_0xee4746(0x162)](_0x3d5cb8){const _0xa25311=_0xee4746,{page:page=0x1,size:size=0xa,username:_0x25cc4f,status:_0xa2dc76}=_0x3d5cb8;let _0x3a7ea7={};_0x25cc4f&&Object[_0xa25311(0xd7)](_0x3a7ea7,{'username':(0x0,typeorm_2['Like'])('%'+_0x25cc4f+'%')}),_0xa2dc76&&Object[_0xa25311(0xd7)](_0x3a7ea7,{'status':_0xa2dc76});const [_0x950164,_0x245447]=await this[_0xa25311(0xc9)][_0xa25311(0xdc)]({'skip':(page-0x1)*size,'where':_0x3a7ea7,'take':size,'order':{'createdAt':_0xa25311(0xca)},'cache':!![],'select':[_0xa25311(0xf4),_0xa25311(0xfa),_0xa25311(0x145),_0xa25311(0xfc),'id']});return{'rows':_0x950164,'count':_0x245447};}async[_0xee4746(0xd8)]({id:_0x8d45b7}){const _0x299b44=_0xee4746;return await this[_0x299b44(0xc9)][_0x299b44(0x141)]({'where':{'id':_0x8d45b7},'select':[_0x299b44(0xf4),'id',_0x299b44(0x107),'inviteCode',_0x299b44(0x145),'sign',_0x299b44(0xfc)]});}async[_0xee4746(0x169)](_0x5154ea){const _0x5f59ac=_0xee4746;return await this[_0x5f59ac(0xc9)][_0x5f59ac(0x141)]({'where':{'username':_0x5154ea}});}async['updateStatus'](_0x33ab94){const _0x890823=_0xee4746,{id:_0x53e404,status:_0x5951e8}=_0x33ab94,_0x3adc34=await this[_0x890823(0xc9)][_0x890823(0x141)]({'where':{'id':_0x53e404}});if(!_0x3adc34)throw new common_1[(_0x890823(0x11f))](_0x890823(0x105),common_1[_0x890823(0xfd)][_0x890823(0x14e)]);if(_0x3adc34[_0x890823(0x145)]===_0x890823(0x139))throw new common_1['HttpException']('超级管理员不可被操作！',common_1[_0x890823(0xfd)][_0x890823(0x14e)]);if(_0x3adc34[_0x890823(0xfc)]===user_constant_1['UserStatusEnum']['PENDING'])throw new common_1[(_0x890823(0x11f))](_0x890823(0xf5),common_1['HttpStatus']['BAD_REQUEST']);if(_0x3adc34[_0x890823(0x145)]===_0x890823(0x139))throw new common_1[(_0x890823(0x11f))](_0x890823(0x10c),common_1['HttpStatus']['BAD_REQUEST']);if(_0x5951e8===user_constant_1[_0x890823(0x140)]['PENDING'])throw new common_1[(_0x890823(0x11f))]('不可将用户置为未激活状态！',common_1['HttpStatus'][_0x890823(0x14e)]);const _0x519c40=await this[_0x890823(0xc9)]['update']({'id':_0x53e404},{'status':_0x5951e8});if(_0x519c40[_0x890823(0x148)]<=0x0)throw new common_1[(_0x890823(0x11f))](_0x890823(0x14a),common_1['HttpStatus']['BAD_REQUEST']);return _0x890823(0xc2);}async[_0xee4746(0x10b)](_0x25e0c0){const _0x1ea14c=_0xee4746,{id:_0x2bb1e9}=_0x25e0c0,_0xb855a4=await this[_0x1ea14c(0xc9)][_0x1ea14c(0x141)]({'where':{'id':_0x2bb1e9}});if(!_0xb855a4)throw new common_1[(_0x1ea14c(0x11f))](_0x1ea14c(0x105),common_1[_0x1ea14c(0xfd)][_0x1ea14c(0x14e)]);const _0x531ee8='123456',_0x2ac700=bcrypt['hashSync'](_0x531ee8,0xa),_0x175b1c=await this[_0x1ea14c(0xc9)][_0x1ea14c(0xd1)]({'id':_0x2bb1e9},{'password':_0x2ac700});if(_0x175b1c[_0x1ea14c(0x148)]<=0x0)throw new common_1[(_0x1ea14c(0x11f))](_0x1ea14c(0x164),common_1[_0x1ea14c(0xfd)][_0x1ea14c(0x14e)]);return'密码重置为['+_0x531ee8+_0x1ea14c(0xe5);}async['savaLoginIp'](_0x4c48d0,_0x4d925b){const _0xf399e7=_0xee4746;return await this['userEntity'][_0xf399e7(0xd1)]({'id':_0x4c48d0},{'lastLoginIp':_0x4d925b});}async[_0xee4746(0xf2)](_0x240027,_0xe75b08){const _0x5267dc=_0xee4746,_0x1872eb=await this[_0x5267dc(0xc9)][_0x5267dc(0x141)]({'where':{'openId':_0x240027}});if(!_0x1872eb){const _0x4cc00f=_0xe75b08?_0xe75b08[_0x5267dc(0x129)](':')[0x1]:'',_0x3ef5b7=await this[_0x5267dc(0x113)](_0x4cc00f),_0x1ffdb0=await this['createUserFromOpenId'](_0x240027,_0x4cc00f);return await this[_0x5267dc(0x125)][_0x5267dc(0x12c)](_0x1ffdb0['id'],_0x4cc00f?_0x3ef5b7?.['id']:null),_0x1ffdb0;}return _0x1872eb;}async['createUserFromOpenId'](_0x22f883,_0x5902cb){const _0x32d53d=_0xee4746,_0x3e53a7=await this['globalConfigService'][_0x32d53d(0x135)]([_0x32d53d(0x121)]),_0x18ec34={'avatar':_0x3e53a7,'username':'用户'+(0x0,utils_1[_0x32d53d(0xe2)])(),'status':user_constant_1[_0x32d53d(0x140)][_0x32d53d(0xf0)],'sex':0x0,'email':(0x0,utils_1[_0x32d53d(0xe2)])()+_0x32d53d(0xbf),'invitedBy':_0x5902cb,'openId':_0x22f883};return await this[_0x32d53d(0xc9)][_0x32d53d(0x108)](_0x18ec34);}async[_0xee4746(0x119)](_0x419e90,_0x4af0c7){const _0x15b333=_0xee4746;try{const _0x1de05e=await this[_0x15b333(0xc9)]['findOne']({'where':{'id':_0x4af0c7}});if(!_0x1de05e)return{'status':![],'msg':'当前绑定用户不存在！'};const _0x4820dc=await this[_0x15b333(0xc9)][_0x15b333(0x141)]({'where':{'openId':_0x419e90}});if(_0x4820dc)return{'status':![],'msg':_0x15b333(0x124)};const _0x2b3741=await this[_0x15b333(0xc9)][_0x15b333(0xd1)]({'id':_0x4af0c7},{'openId':_0x419e90});if(_0x2b3741[_0x15b333(0x148)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x15b333(0xe7)};}catch(_0x4083f4){return{'status':![],'msg':_0x15b333(0x153)};}}async['getOpenIdByUserId'](_0xd499ce){const _0x1a161d=_0xee4746,_0x99a3ea=await this[_0x1a161d(0xc9)]['findOne']({'where':{'id':_0xd499ce}});return _0x99a3ea?.['openId'];}async[_0xee4746(0x13a)](_0x3fc29a){const _0x4513be=await this['userEntity']['findOne']({'where':{'id':_0x3fc29a}});return _0x4513be?.['miniOpenId'];}async[_0xee4746(0x137)](_0x2ec76a){const _0x3ca848=_0xee4746,{username:_0xa9d70a,password:_0x125f40,phone:_0x280c9e,phoneCode:_0x280382}=_0x2ec76a,_0x382f0b=await this['userEntity']['findOne']({'where':[{'username':_0xa9d70a},{'phone':_0x280c9e}]});if(_0x382f0b&&_0x382f0b[_0x3ca848(0xf4)]===_0xa9d70a)throw new common_1[(_0x3ca848(0x11f))](_0x3ca848(0x10f),common_1[_0x3ca848(0xfd)][_0x3ca848(0x14e)]);if(_0x382f0b&&_0x382f0b['phone']===_0x280c9e)throw new common_1[(_0x3ca848(0x11f))](_0x3ca848(0xba),common_1[_0x3ca848(0xfd)]['BAD_REQUEST']);}async[_0xee4746(0x11c)](_0x4a1b10){const _0x1f5d34=_0xee4746;return await this[_0x1f5d34(0xc9)][_0x1f5d34(0x108)](_0x4a1b10);}async[_0xee4746(0xe0)](_0x393d97){const _0x4c9a87=_0xee4746,{id:_0x29bfae,moreId:_0x222e85}=_0x393d97;if(_0x29bfae)return await this[_0x4c9a87(0xc9)]['delete']({'id':_0x29bfae});if(_0x222e85)return await this[_0x4c9a87(0xc9)]['delete']({'id':(0x0,typeorm_2[_0x4c9a87(0x11d)])(_0x222e85)});}async[_0xee4746(0xdf)](_0x3cca12){const _0xd9ef62=_0xee4746,_0xab14f1=_0x3cca12[_0xd9ef62(0xe9)]['id'];return await this['userEntity'][_0xd9ef62(0xc7)]({'id':_0xab14f1})['then'](_0x339e45=>_0x339e45[_0xd9ef62(0x148)]>0x0);}};UserService=__decorate([(0x0,common_1[_0xee4746(0x127)])(),__param(0x0,(0x0,typeorm_1[_0xee4746(0xde)])(user_entity_1[_0xee4746(0x12e)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0xee4746(0xcc)])),__param(0x7,(0x0,typeorm_1[_0xee4746(0xde)])(config_entity_1[_0xee4746(0x14f)])),__metadata(_0xee4746(0x13e),[typeorm_2[_0xee4746(0x112)],typeorm_2[_0xee4746(0x112)],typeorm_2['Connection'],verification_service_1['VerificationService'],mailer_1['MailerService'],userBalance_service_1[_0xee4746(0x15c)],globalConfig_service_1[_0xee4746(0xc6)],typeorm_2[_0xee4746(0x112)]])],UserService),exports[_0xee4746(0xe1)]=UserService;