'use strict';const _0xe6b409=_0x236d;(function(_0x38a3b7,_0x46f703){const _0x14a2e4=_0x236d,_0x36c7c3=_0x38a3b7();while(!![]){try{const _0xb25e17=-parseInt(_0x14a2e4(0x11f))/0x1+parseInt(_0x14a2e4(0x13f))/0x2*(-parseInt(_0x14a2e4(0x148))/0x3)+-parseInt(_0x14a2e4(0x14e))/0x4*(-parseInt(_0x14a2e4(0x12d))/0x5)+-parseInt(_0x14a2e4(0xe9))/0x6*(-parseInt(_0x14a2e4(0x143))/0x7)+parseInt(_0x14a2e4(0x11d))/0x8*(-parseInt(_0x14a2e4(0xfc))/0x9)+parseInt(_0x14a2e4(0x152))/0xa+parseInt(_0x14a2e4(0x10f))/0xb*(-parseInt(_0x14a2e4(0xe6))/0xc);if(_0xb25e17===_0x46f703)break;else _0x36c7c3['push'](_0x36c7c3['shift']());}catch(_0x5f303b){_0x36c7c3['push'](_0x36c7c3['shift']());}}}(_0x4cc5,0xce2bc));var __decorate=this&&this[_0xe6b409(0x109)]||function(_0x685eaf,_0x1068ef,_0x16a84a,_0x24d60e){const _0x1f53b0=_0xe6b409;var _0x4ac48b=arguments[_0x1f53b0(0x154)],_0x242393=_0x4ac48b<0x3?_0x1068ef:_0x24d60e===null?_0x24d60e=Object[_0x1f53b0(0x10e)](_0x1068ef,_0x16a84a):_0x24d60e,_0x2a481d;if(typeof Reflect===_0x1f53b0(0x14f)&&typeof Reflect[_0x1f53b0(0xf4)]===_0x1f53b0(0x10c))_0x242393=Reflect[_0x1f53b0(0xf4)](_0x685eaf,_0x1068ef,_0x16a84a,_0x24d60e);else{for(var _0x15c1f5=_0x685eaf[_0x1f53b0(0x154)]-0x1;_0x15c1f5>=0x0;_0x15c1f5--)if(_0x2a481d=_0x685eaf[_0x15c1f5])_0x242393=(_0x4ac48b<0x3?_0x2a481d(_0x242393):_0x4ac48b>0x3?_0x2a481d(_0x1068ef,_0x16a84a,_0x242393):_0x2a481d(_0x1068ef,_0x16a84a))||_0x242393;}return _0x4ac48b>0x3&&_0x242393&&Object[_0x1f53b0(0x145)](_0x1068ef,_0x16a84a,_0x242393),_0x242393;},__metadata=this&&this[_0xe6b409(0x114)]||function(_0x2709a6,_0x1d70ea){const _0x3fd963=_0xe6b409;if(typeof Reflect===_0x3fd963(0x14f)&&typeof Reflect[_0x3fd963(0xf6)]===_0x3fd963(0x10c))return Reflect[_0x3fd963(0xf6)](_0x2709a6,_0x1d70ea);},__param=this&&this[_0xe6b409(0xe7)]||function(_0x4ae796,_0x4e16fd){return function(_0x1fa09f,_0x5dac45){_0x4e16fd(_0x1fa09f,_0x5dac45,_0x4ae796);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0xe6b409(0x105)]=void 0x0;function _0x236d(_0x560e3b,_0x5a121d){const _0x4cc547=_0x4cc5();return _0x236d=function(_0x236da8,_0x15663f){_0x236da8=_0x236da8-0xe6;let _0x400c12=_0x4cc547[_0x236da8];return _0x400c12;},_0x236d(_0x560e3b,_0x5a121d);}const common_1=require(_0xe6b409(0x15a)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0xe6b409(0x15c)),models_entity_1=require(_0xe6b409(0x117)),status_constant_1=require(_0xe6b409(0x107)),baidu_1=require(_0xe6b409(0x13a)),utils_1=require(_0xe6b409(0x141)),model_constant_1=require(_0xe6b409(0x102)),jwt=require('jsonwebtoken');let ModelsService=class ModelsService{constructor(_0x4c013b){const _0x41d762=_0xe6b409;this[_0x41d762(0x116)]=_0x4c013b,this[_0x41d762(0x142)]=[],this[_0x41d762(0x146)]={},this[_0x41d762(0xf9)]={},this['keyPoolMap']={},this['keyPoolIndexMap']={};}async['onModuleInit'](){const _0xc24cee=_0xe6b409;await this[_0xc24cee(0x131)](),await this[_0xc24cee(0x12f)]();}async[_0xe6b409(0xf0)](){const _0xeb5c0f=_0xe6b409,_0x43ab8e=_0xeb5c0f(0x14c),_0x48a8d2=_0x43ab8e+_0xeb5c0f(0xf8);return await fetch(_0x48a8d2,{'method':'get','headers':{'Authorization':'Bearer\x20sk-bSm3FROxNJ1oIkmd5dDc9b582d3d48E09d12E86eF7FfC0C4'}})[_0xeb5c0f(0x127)](async _0x53a664=>{const _0xaf54b0=_0xeb5c0f,_0x558cbc=await _0x53a664[_0xaf54b0(0x132)]();return _0x558cbc[_0xaf54b0(0x106)];});}async['initCalcKey'](){const _0x141f88=_0xe6b409;this[_0x141f88(0x11e)]={},this[_0x141f88(0x128)]={},this[_0x141f88(0xf9)]={},this[_0x141f88(0x146)]={},this[_0x141f88(0x142)]=[];const _0x136f2b=await this[_0x141f88(0x116)][_0x141f88(0x115)]({'where':{'status':!![]}}),_0x1882bf=_0x136f2b[_0x141f88(0x10a)]((_0x1b04da,_0x39f40b)=>{const _0x4938c0=_0x141f88;return!_0x1b04da[_0x39f40b['keyType']]?_0x1b04da[_0x39f40b[_0x4938c0(0x100)]]=[_0x39f40b]:_0x1b04da[_0x39f40b[_0x4938c0(0x100)]]['push'](_0x39f40b),_0x1b04da;},{});this['modelTypes']=Object[_0x141f88(0x13e)](_0x1882bf)[_0x141f88(0x136)](_0x3e6814=>{const _0x2bba2b=_0x141f88;return{'label':status_constant_1[_0x2bba2b(0x15b)][_0x3e6814],'val':_0x3e6814};}),this[_0x141f88(0x146)]=_0x1882bf,this[_0x141f88(0xf9)]={},_0x136f2b[_0x141f88(0x13c)](_0x45d961=>{const _0x584773=_0x141f88,{keyType:_0x5d36e1,model:_0x583155,keyWeight:_0x3fca88}=_0x45d961;if(!this[_0x584773(0x11e)][_0x583155])this[_0x584773(0x11e)][_0x583155]=[];for(let _0x2286fe=0x0;_0x2286fe<_0x3fca88;_0x2286fe++){this[_0x584773(0x11e)][_0x583155][_0x584773(0x119)](_0x45d961);}if(!this[_0x584773(0x128)][_0x583155])this[_0x584773(0x128)][_0x583155]=0x0;if(!this[_0x584773(0xf9)][_0x5d36e1])this[_0x584773(0xf9)][_0x5d36e1]={};if(!this['keyList'][_0x5d36e1][_0x583155])this[_0x584773(0xf9)][_0x5d36e1][_0x583155]=[];this[_0x584773(0xf9)][_0x5d36e1][_0x583155][_0x584773(0x119)](_0x45d961);});}async[_0xe6b409(0x137)](_0x573407,_0x1a4d25,_0xda3c4c=-0x1){const _0x976608=_0xe6b409,_0x3a97d9=await this[_0x976608(0x116)][_0x976608(0x11c)]({'id':_0x573407},{'status':![],'keyStatus':_0xda3c4c,'remark':_0x1a4d25});common_1[_0x976608(0x123)][_0x976608(0x104)](_0x976608(0x147)+_0x573407+'\x20欠费或被官方封禁导致不可用，已被系统自动锁定'),await this[_0x976608(0x131)]();}async[_0xe6b409(0x125)](_0x17af78){const _0x146206=_0xe6b409;return this[_0x146206(0x116)][_0x146206(0xf7)]({'where':{'modelName':_0x17af78}});}async[_0xe6b409(0x103)](_0x19c507){const _0xe6069f=_0xe6b409;if(!this['keyPoolMap'][_0x19c507])throw new common_1['HttpException'](_0xe6069f(0xf1),common_1[_0xe6069f(0x112)]['BAD_REQUEST']);this['keyPoolIndexMap'][_0x19c507]++;const _0x5678f6=this[_0xe6069f(0x128)][_0x19c507];if(_0x5678f6>=this[_0xe6069f(0x11e)][_0x19c507][_0xe6069f(0x154)])this[_0xe6069f(0x128)][_0x19c507]=0x0;return this[_0xe6069f(0x11e)][_0x19c507][this[_0xe6069f(0x128)][_0x19c507]];}async[_0xe6b409(0xea)](_0x22db8d,_0x2d2bfa){const _0x594020=_0xe6b409,_0x259224={'modelType':_0x22db8d,'status':!![],'keyStatus':0x1};_0x2d2bfa&&(_0x259224[_0x594020(0xff)]=_0x2d2bfa);const _0xb6c62e=await this[_0x594020(0x116)][_0x594020(0x115)]({'where':_0x259224,'order':{'keyWeight':'DESC'}});if(!_0xb6c62e['length'])throw new Error('暂未配置相关模型，请联系管理员！');const _0x23883c=_0xb6c62e[0x0],_0x146ff1=this['modelTypes'][_0x594020(0x115)](_0x2fafb2=>Number(_0x2fafb2[_0x594020(0x110)])===_0x23883c[_0x594020(0x100)]);return{'modelTypeInfo':_0x146ff1,'modelInfo':{..._0x23883c,'topN':0.8,'systemMessage':'','rounds':0x8}};}async[_0xe6b409(0xf5)](_0x5b919e){const _0x18443d=_0xe6b409;try{const {id:_0x24a43f}=_0x5b919e;_0x5b919e[_0x18443d(0x11a)]&&(_0x5b919e['keyStatus']=0x1);if(_0x24a43f){const _0x55b3fc=await this['modelsEntity'][_0x18443d(0x11c)]({'id':_0x24a43f},_0x5b919e);return await this['initCalcKey'](),_0x55b3fc[_0x18443d(0x153)]>0x0;}else{const _0x449ffd=await this[_0x18443d(0x116)][_0x18443d(0xf7)]({'where':{'modelName':_0x5b919e['modelName']}});if(_0x449ffd)throw new Error(_0x18443d(0x10d));const {keyType:_0x1b0ab2,key:_0xd0312f}=_0x5b919e;if(Number(_0x1b0ab2!==0x1)){const _0x181666=await this[_0x18443d(0x116)][_0x18443d(0x129)](_0x5b919e);return await this[_0x18443d(0x131)](),_0x1b0ab2===0x2&&this[_0x18443d(0x12f)](),_0x181666;}else{const _0xc769b2=_0xd0312f[_0x18443d(0x136)](_0x592c19=>{const _0x40ec2d=_0x18443d,_0x501f6d=JSON[_0x40ec2d(0x14a)](JSON[_0x40ec2d(0x140)](_0x5b919e));return _0x501f6d[_0x40ec2d(0xed)]=_0x592c19,_0x501f6d;}),_0x5beef4=await this[_0x18443d(0x116)][_0x18443d(0x129)](_0xc769b2);return await this[_0x18443d(0x131)](),_0x5beef4;}}}catch(_0x1e5e97){console[_0x18443d(0xf3)]('error:\x20',_0x1e5e97);throw new common_1[(_0x18443d(0xfd))](_0x1e5e97['message'],common_1['HttpStatus'][_0x18443d(0x14b)]);}}async['delModel']({id:_0x47725e}){const _0x14b5be=_0xe6b409;if(!_0x47725e)throw new common_1[(_0x14b5be(0xfd))]('缺失必要参数！',common_1['HttpStatus'][_0x14b5be(0x14b)]);const _0x3989e5=await this['modelsEntity'][_0x14b5be(0xf7)]({'where':{'id':_0x47725e}});if(!_0x3989e5)throw new common_1['HttpException'](_0x14b5be(0x158),common_1[_0x14b5be(0x112)][_0x14b5be(0x14b)]);const _0x3334fa=await this['modelsEntity'][_0x14b5be(0x118)]({'id':_0x47725e});return await this['initCalcKey'](),_0x3334fa;}async[_0xe6b409(0x133)](_0x76198b,_0x4bd14c){const _0x6e78e=_0xe6b409;let _0x439503=_0x6e78e(0x157);if(_0x76198b['headers'][_0x6e78e(0x156)]){const _0x1c7d43=_0x76198b[_0x6e78e(0x14d)][_0x6e78e(0x156)][_0x6e78e(0x12c)]('\x20'),_0x27dd84=jwt[_0x6e78e(0xfb)](_0x1c7d43[0x1],process[_0x6e78e(0x135)][_0x6e78e(0x149)]);_0x439503=_0x27dd84['role'];}const {keyType:_0xe1d5c6,key:_0x1af9a4,status:_0x43a374,model:_0xd8a54b,modelType:_0x4e28a9,page:page=0x1,size:size=0xa}=_0x4bd14c;let _0xd7b102={};_0xd8a54b&&(_0xd7b102[_0x6e78e(0xff)]=_0xd8a54b),_0xe1d5c6&&(_0xd7b102['keyType']=_0xe1d5c6),_0x1af9a4&&(_0xd7b102[_0x6e78e(0xed)]=(0x0,typeorm_2[_0x6e78e(0xec)])('%'+_0x1af9a4+'%')),_0x4e28a9&&(_0xd7b102[_0x6e78e(0x121)]=_0x4e28a9),_0x43a374&&(_0xd7b102[_0x6e78e(0x11a)]=Number(_0x43a374)===0x1?!![]:![]);const [_0x230d8b,_0x53fbb9]=await this[_0x6e78e(0x116)][_0x6e78e(0x12e)]({'where':_0xd7b102,'skip':(page-0x1)*size,'take':size,'order':{'displaySort':'DESC','createdAt':'DESC'}});return _0x439503!==_0x6e78e(0x159)&&_0x230d8b[_0x6e78e(0x13c)](_0x29612e=>{const _0x2a3411=_0x6e78e;_0x29612e[_0x2a3411(0xed)]&&(_0x29612e[_0x2a3411(0xed)]=(0x0,utils_1[_0x2a3411(0x151)])(_0x29612e[_0x2a3411(0xed)])),_0x29612e['secret']&&(_0x29612e[_0x2a3411(0x144)]=(0x0,utils_1[_0x2a3411(0x151)])(_0x29612e[_0x2a3411(0x144)]));}),{'rows':_0x230d8b,'count':_0x53fbb9};}async[_0xe6b409(0xee)](_0x59365f=0x0){const _0x1d95bc=_0xe6b409,_0x25825c=(0x0,utils_1[_0x1d95bc(0x10b)])(this[_0x1d95bc(0x146)]);return Object[_0x1d95bc(0x13e)](_0x25825c)[_0x1d95bc(0x13c)](_0x2720b5=>{const _0xcb9d50=_0x1d95bc;let _0xf22369=_0x25825c[_0x2720b5];if(_0x59365f===0x0)_0xf22369=_0xf22369[_0xcb9d50(0x111)](_0x1eee88=>Boolean(_0x1eee88[_0xcb9d50(0xeb)]))[_0xcb9d50(0x126)]((_0x5f4bb1,_0x17553c)=>_0x17553c[_0xcb9d50(0xf2)]-_0x5f4bb1[_0xcb9d50(0xf2)]);else _0x59365f===0x2&&(_0xf22369=_0xf22369[_0xcb9d50(0x111)](_0x59c7d0=>!Boolean(_0x59c7d0[_0xcb9d50(0xeb)]))[_0xcb9d50(0x126)]((_0x143184,_0xb05e97)=>_0xb05e97[_0xcb9d50(0xf2)]-_0x143184[_0xcb9d50(0xf2)]));_0x25825c[_0x2720b5]=_0xf22369[_0xcb9d50(0x136)](_0x25747f=>Object['assign']({},_0x25747f));}),{'modelTypeList':this['modelTypes'],'modelMaps':_0x25825c};}async[_0xe6b409(0xfe)](_0x4f96e5,_0x17fa58){const _0x38fe97=_0xe6b409;await this[_0x38fe97(0x116)]['createQueryBuilder']()[_0x38fe97(0x11c)](models_entity_1['ModelsEntity'])['set']({'useCount':()=>'useCount\x20+\x201','useToken':()=>'useToken\x20+\x20'+_0x17fa58})[_0x38fe97(0x13b)](_0x38fe97(0x11b),{'id':_0x4f96e5})[_0x38fe97(0xfa)]();}async[_0xe6b409(0x12f)](){const _0x1988fe=_0xe6b409,_0x14cd96=await this[_0x1988fe(0x116)][_0x1988fe(0x115)]({'where':{'keyType':0x2}}),_0x5486fc={};_0x14cd96['forEach'](_0x1e57ad=>{const _0x2bf060=_0x1988fe,{key:_0x4a95b1,secret:_0x36f4ae}=_0x1e57ad;!_0x5486fc[_0x2bf060(0xed)]?_0x5486fc[_0x4a95b1]=[{'keyInfo':_0x1e57ad}]:_0x5486fc[_0x4a95b1][_0x2bf060(0x119)](_0x1e57ad);}),Object[_0x1988fe(0x13e)](_0x5486fc)['forEach'](async _0x5780b5=>{const _0xdaf2bc=_0x1988fe,{secret:_0x195d66,id:_0x510939}=_0x5486fc[_0x5780b5][0x0][_0xdaf2bc(0x130)],_0x28c25c=await(0x0,baidu_1[_0xdaf2bc(0x150)])(_0x5780b5,_0x195d66);await this[_0xdaf2bc(0x116)][_0xdaf2bc(0x11c)]({'key':_0x5780b5},{'accessToken':_0x28c25c});}),setTimeout(()=>{const _0x514885=_0x1988fe;this[_0x514885(0x131)]();},0x3e8);}async[_0xe6b409(0x120)](_0x559dea){const _0x54ed05=_0xe6b409,_0x38de62=await this['modelsEntity']['find']({'where':{'status':!![],'keyStatus':0x1,'modelType':_0x559dea}});if(!_0x38de62[_0x54ed05(0x154)])throw new common_1[(_0x54ed05(0xfd))](_0x54ed05(0x113),common_1[_0x54ed05(0x112)]['BAD_REQUEST']);return(0x0,utils_1['getRandomItemFromArray'])(_0x38de62);}async[_0xe6b409(0x124)](){const _0x171b90=_0xe6b409,_0x3019e3=await this[_0x171b90(0x116)][_0x171b90(0x115)]({'where':{'status':!![],'canAudio':!![]}});if(!_0x3019e3[_0x171b90(0x154)])throw new common_1[(_0x171b90(0xfd))](_0x171b90(0x12b),common_1['HttpStatus']['BAD_REQUEST']);return(0x0,utils_1[_0x171b90(0xef)])(_0x3019e3);}async[_0xe6b409(0x134)](){const _0x1aa415=_0xe6b409;return await this[_0x1aa415(0x116)]['find']();}async['getMusicModel'](){const _0x5a5fe1=_0xe6b409;try{const _0x10f97f=await this['modelsEntity'][_0x5a5fe1(0x115)]({'where':{'status':!![],'keyStatus':0x1,'modelType':model_constant_1['EModelType'][_0x5a5fe1(0x101)]}});if(_0x10f97f['length']===0x0)throw new Error(_0x5a5fe1(0x12a));return _0x10f97f[Math[_0x5a5fe1(0x108)](Math['random']()*_0x10f97f['length'])];}catch(_0xedee34){throw new common_1[(_0x5a5fe1(0xfd))](_0xedee34[_0x5a5fe1(0x13d)],common_1[_0x5a5fe1(0x112)]['BAD_REQUEST']);}}};function _0x4cc5(){const _0x1f5a59=['key:\x20','5661irgYwk','JWT_SECRET','parse','BAD_REQUEST','https://apiv.chatgpt-3.vip','headers','1142072yARNNQ','object','getAccessToken','hideString','14072080bRjqdg','affected','length','Injectable','authorization','visitor','当前账号不存在！','super','@nestjs/common','ModelsMapCn','typeorm','96XFYlYg','__param','ModelsEntity','15672CEviRi','getModelByType','front','Like','key','modelsList','getRandomItemFromArray','getOfficialModels','当前调用模型已经被移除、请重新选择模型！','displaySort','log','decorate','setModel','metadata','findOne','/v1/models','keyList','execute','verify','18AAUhgb','HttpException','saveUseLog','model','keyType','MUSIC','../../common/constants/model.constant','getCurrentModelKeyInfo','error','ModelsService','data','../../common/constants/status.constant','floor','__decorate','reduce','deepClone','function','模型名称已存在，请修改模型名称','getOwnPropertyDescriptor','809182SRAWwx','val','filter','HttpStatus','当前未指定特殊模型KEY、前往后台设置！','__metadata','find','modelsEntity','./models.entity','delete','push','status','id\x20=\x20:id','update','4906632sqEqse','keyPoolMap','45191vHvTlh','getRandomKey','modelType','InjectRepository','Logger','getRandomAudioKey','getModelByName','sort','then','keyPoolIndexMap','save','暂未配置音乐模型，请联系管理员','当前未指定语音对话模型KEY、前往后台设置把！','split','25EROdaz','findAndCount','refreshBaiduAccesstoken','keyInfo','initCalcKey','json','queryModels','getAllKey','env','map','lockKey','Repository','design:paramtypes','../chatgpt/baidu','where','forEach','message','keys','1414rZPNBQ','stringify','../../common/utils','modelTypes','3227bQHhdL','secret','defineProperty','modelMaps'];_0x4cc5=function(){return _0x1f5a59;};return _0x4cc5();}ModelsService=__decorate([(0x0,common_1[_0xe6b409(0x155)])(),__param(0x0,(0x0,typeorm_1[_0xe6b409(0x122)])(models_entity_1[_0xe6b409(0xe8)])),__metadata(_0xe6b409(0x139),[typeorm_2[_0xe6b409(0x138)]])],ModelsService),exports[_0xe6b409(0x105)]=ModelsService;