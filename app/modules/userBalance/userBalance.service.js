'use strict';const _0x2ca97f=_0x1e1a;(function(_0x30d84e,_0x3417b7){const _0x4f4671=_0x1e1a,_0x2fa7b3=_0x30d84e();while(!![]){try{const _0x4ce852=-parseInt(_0x4f4671(0x288))/0x1+parseInt(_0x4f4671(0x20a))/0x2*(parseInt(_0x4f4671(0x240))/0x3)+-parseInt(_0x4f4671(0x20b))/0x4+parseInt(_0x4f4671(0x25f))/0x5+-parseInt(_0x4f4671(0x255))/0x6+-parseInt(_0x4f4671(0x27f))/0x7+-parseInt(_0x4f4671(0x207))/0x8*(-parseInt(_0x4f4671(0x244))/0x9);if(_0x4ce852===_0x3417b7)break;else _0x2fa7b3['push'](_0x2fa7b3['shift']());}catch(_0x3de273){_0x2fa7b3['push'](_0x2fa7b3['shift']());}}}(_0x1579,0xe78ba));var __decorate=this&&this[_0x2ca97f(0x232)]||function(_0x4bc44f,_0x4ad52d,_0x5c59ee,_0x493191){const _0x345f86=_0x2ca97f;var _0x2a30b1=arguments[_0x345f86(0x251)],_0x529102=_0x2a30b1<0x3?_0x4ad52d:_0x493191===null?_0x493191=Object['getOwnPropertyDescriptor'](_0x4ad52d,_0x5c59ee):_0x493191,_0x4caf0f;if(typeof Reflect===_0x345f86(0x209)&&typeof Reflect[_0x345f86(0x1f0)]===_0x345f86(0x22b))_0x529102=Reflect[_0x345f86(0x1f0)](_0x4bc44f,_0x4ad52d,_0x5c59ee,_0x493191);else{for(var _0x53393a=_0x4bc44f[_0x345f86(0x251)]-0x1;_0x53393a>=0x0;_0x53393a--)if(_0x4caf0f=_0x4bc44f[_0x53393a])_0x529102=(_0x2a30b1<0x3?_0x4caf0f(_0x529102):_0x2a30b1>0x3?_0x4caf0f(_0x4ad52d,_0x5c59ee,_0x529102):_0x4caf0f(_0x4ad52d,_0x5c59ee))||_0x529102;}return _0x2a30b1>0x3&&_0x529102&&Object[_0x345f86(0x25d)](_0x4ad52d,_0x5c59ee,_0x529102),_0x529102;},__metadata=this&&this['__metadata']||function(_0x33487f,_0x5e4b09){const _0x3c0644=_0x2ca97f;if(typeof Reflect==='object'&&typeof Reflect[_0x3c0644(0x21f)]===_0x3c0644(0x22b))return Reflect[_0x3c0644(0x21f)](_0x33487f,_0x5e4b09);},__param=this&&this[_0x2ca97f(0x1db)]||function(_0x1cc691,_0x382abf){return function(_0x3a7431,_0xecfdd1){_0x382abf(_0x3a7431,_0xecfdd1,_0x1cc691);};};Object[_0x2ca97f(0x25d)](exports,_0x2ca97f(0x260),{'value':!![]}),exports['UserBalanceService']=void 0x0;function _0x1e1a(_0x57eba2,_0x3b8c63){const _0x15791f=_0x1579();return _0x1e1a=function(_0x1e1af1,_0x4748f0){_0x1e1af1=_0x1e1af1-0x1c2;let _0xf2383a=_0x15791f[_0x1e1af1];return _0xf2383a;},_0x1e1a(_0x57eba2,_0x3b8c63);}const globalConfig_service_1=require(_0x2ca97f(0x283)),typeorm_1=require(_0x2ca97f(0x1de)),balance_entity_1=require(_0x2ca97f(0x270)),common_1=require('@nestjs/common'),typeorm_2=require(_0x2ca97f(0x1e7)),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require(_0x2ca97f(0x262)),utils_1=require('../../common/utils'),config_entity_1=require(_0x2ca97f(0x1c9)),cramiPackage_entity_1=require(_0x2ca97f(0x200)),userBalance_entity_1=require(_0x2ca97f(0x1e6)),date_1=require('../../common/utils/date'),user_entity_1=require(_0x2ca97f(0x289)),salesUsers_entity_1=require(_0x2ca97f(0x1d2)),sales_service_1=require(_0x2ca97f(0x20f)),whiteList_entity_1=require(_0x2ca97f(0x214)),fingerprint_entity_1=require(_0x2ca97f(0x274)),chatLog_entity_1=require(_0x2ca97f(0x27d)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),midjourney_entity_1=require('../midjourney/midjourney.entity');function _0x1579(){const _0x4bb0e3=['decorate','total','inviteGiveSendModel4Count','充值失败','validateVisitorBalance','充值失败！','memberDrawMjCount','configVal','updatedAt','model4','当前用户不存在,记录充值日志异常','debug','status','upgradeStatus','vxNumber','查询用户账户信息失败！','../crami/cramiPackage.entity','Injectable','visitor','当前用户无需创建账户信息！','firstRegisterSendStatus','packageId','invitedGuestSendModel3Count','1572040VTiALf','getVisitorCount','object','3808qDxCye','6583244ULpEmi','salesUsersEntity','forEach','days','../sales/sales.service','model4Count','SalesUsersEntity','MjCount','odel4','../chatgpt/whiteList.entity','firstRregisterSendModel3Count','getFullYear','---','COST','avatar','getMonth','odel3','userEntity','缺失当前用户账户记录！','model3Dis','metadata','ChatGroupEntity','HttpStatus','headers','FingerprintLogEntity','memberModel3Count','sumModel3Count','RechargeType','visitorModel3Num','username','count','useModel3Count','function','当前套餐不存在！','fingerprintLogEntity','balanceEntity','sumModel4Count','registerSendModel4Count','then','__decorate','账户信息已经存在、迁移无效','inviteGiveSendModel3Count','YYYY-MM-DD','registerSendModel3Count','useCount','addBalanceToUser','getAccountLog','>\x20或购买专属套餐\x20！','addBalanceToOrder','refundMjBalance','day','map','ConfigEntity','2049XifaHf','UserBalanceService','mjDraw','affected','279UdNWLB','accountLogEntity','查询当前用户余额失败！','visitorModel4Num','SCAN_PAY','email','model4Dis','getDate','DESC','salesService','createSalesRecords','drawMjCount','InjectRepository','length','memberModel4Count','saveRecordRechargeLog','isUpdatedToday','8681556nNovmV','useModel4Token','PAYMENT_REQUIRED','useModel3Token','super','default','Repository','model3','defineProperty','chatGroupEntity','302315NxoQWH','__esModule','查询用户账户失败！','./accountLog.entity','find','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','upgradeBalance','useModel4Count','update','旧账户信息迁移失败','error:\x20','user','format','firstRregisterSendModel4Count','saveCommissionAmount','phone','AccountLogEntity','./balance.entity','userBalanceEntity','REG_GIFT','formatCreateOrUpdateDate','./fingerprint.entity','add','充值的工单信息:','YYYY-MM-DD\x20HH:mm:ss','getConfigs','configKey','expireDateCn','configEntity','reduce','../chatLog/chatLog.entity','cramiPackageEntity','10940622kPHhQt','createRandomUid','用户充值失败！','expirationTime','./../globalConfig/globalConfig.service','log','useDrawMjToken','weight','firstRregisterSendDrawMjCount','1848457MJMSaZ','../user/user.entity','deductFromBalance','commissionAmount','firstRegisterSendRank','chatLogEntity','sumDrawMjCount','invitedGuestSendDrawMjCount','Logger','注册赠送失败,请联系管理员！','../globalConfig/config.entity','BalanceService','invitedGuestSendModel4Count','globalConfigService','save','消费余额失败！','rechargeType','includes','LessThan','../sales/salesUsers.entity','queryUserBalanceByIds','toFixed','HttpException','ChatLogEntity','hideString','uid','catch','BAD_REQUEST','__param','addBalanceToNewUser','goodsId','@nestjs/typeorm','findOne','BalanceEntity','userId','缺失当前套餐ID、充值失败！','inviteGiveSendDrawMjCount','midjourneyEntity','error','./userBalance.entity','typeorm','registerSendStatus','inviteSendStatus','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','createBaseUserBalance','findAndCount','REFER_GIFT','model3Count','WhiteListEntity'];_0x1579=function(){return _0x4bb0e3;};return _0x1579();}let UserBalanceService=class UserBalanceService{constructor(_0x2514c2,_0x13e76e,_0x52b768,_0xc015af,_0x58cde1,_0x3b1a6a,_0xd709dc,_0xa01549,_0xa620ab,_0x412b1a,_0x4d7256,_0x46333d,_0xee0e98,_0x4da6dd){const _0x1c958a=_0x2ca97f;this[_0x1c958a(0x22e)]=_0x2514c2,this[_0x1c958a(0x271)]=_0x13e76e,this['accountLogEntity']=_0x52b768,this[_0x1c958a(0x27e)]=_0xc015af,this[_0x1c958a(0x27b)]=_0x58cde1,this[_0x1c958a(0x21c)]=_0x3b1a6a,this[_0x1c958a(0x20c)]=_0xd709dc,this['whiteListEntity']=_0xa01549,this['fingerprintLogEntity']=_0xa620ab,this[_0x1c958a(0x25e)]=_0x412b1a,this[_0x1c958a(0x1c4)]=_0x4d7256,this[_0x1c958a(0x1e4)]=_0x46333d,this[_0x1c958a(0x24d)]=_0xee0e98,this[_0x1c958a(0x1cc)]=_0x4da6dd;}async[_0x2ca97f(0x1dc)](_0x54bc4b,_0x44fa42){const _0x4a18e3=_0x2ca97f;try{const _0x35a8e0=await this[_0x4a18e3(0x27b)][_0x4a18e3(0x263)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x4a18e3(0x1e8),_0x4a18e3(0x236),_0x4a18e3(0x230),'registerSendDrawMjCount',_0x4a18e3(0x204),_0x4a18e3(0x1c3),'firstRregisterSendModel3Count',_0x4a18e3(0x26c),_0x4a18e3(0x287),_0x4a18e3(0x1e9),'inviteGiveSendModel3Count',_0x4a18e3(0x1f2),_0x4a18e3(0x1e3),_0x4a18e3(0x206),_0x4a18e3(0x1c6),'invitedGuestSendModel4Count'])}}),_0x25bd4f=_0x35a8e0[_0x4a18e3(0x27c)]((_0x48aac3,_0xcf4b84)=>{const _0xf8fae1=_0x4a18e3,_0x189b82=Number(_0xcf4b84[_0xf8fae1(0x1f7)]),_0x289b48=Number['isInteger'](_0x189b82)&&_0x189b82>0x0?_0x189b82:0x0;return _0x48aac3[_0xcf4b84[_0xf8fae1(0x279)]]=_0x289b48,_0x48aac3;},{});let _0x2ea0b8=0x0,_0x45f477=0x0,_0x172bed=0x0;_0x25bd4f[_0x4a18e3(0x1e8)]===0x1&&(_0x2ea0b8=_0x2ea0b8+_0x25bd4f['registerSendModel3Count'],_0x45f477=_0x45f477+_0x25bd4f[_0x4a18e3(0x230)],_0x172bed=_0x172bed+_0x25bd4f['registerSendDrawMjCount']),_0x25bd4f[_0x4a18e3(0x1e8)]===0x1&&_0x25bd4f['firstRegisterSendStatus']===0x1&&_0x54bc4b<=_0x25bd4f[_0x4a18e3(0x1c3)]&&(_0x2ea0b8=_0x2ea0b8+_0x25bd4f[_0x4a18e3(0x215)],_0x45f477=_0x45f477+_0x25bd4f[_0x4a18e3(0x26c)],_0x172bed=_0x172bed+_0x25bd4f[_0x4a18e3(0x287)]),await this[_0x4a18e3(0x253)]({'userId':_0x54bc4b,'rechargeType':balance_constant_1[_0x4a18e3(0x226)][_0x4a18e3(0x272)],'model3Count':_0x2ea0b8,'drawMjCount':_0x172bed,'model4Count':_0x45f477}),_0x44fa42&&(Number(_0x25bd4f[_0x4a18e3(0x1e9)])===0x1&&(_0x2ea0b8=_0x2ea0b8+Number(_0x25bd4f[_0x4a18e3(0x206)]),_0x45f477=_0x45f477+Number(_0x25bd4f[_0x4a18e3(0x1cb)]),_0x172bed=_0x172bed+Number(_0x25bd4f['invitedGuestSendDrawMjCount']),await this[_0x4a18e3(0x253)]({'userId':_0x54bc4b,'rechargeType':balance_constant_1['RechargeType']['INVITE_GIFT'],'model3Count':_0x25bd4f['invitedGuestSendModel3Count'],'model4Count':_0x25bd4f['invitedGuestSendModel4Count'],'drawMjCount':_0x25bd4f[_0x4a18e3(0x1c6)]}),await this['addBalanceToUser'](_0x44fa42,{'model3Count':_0x25bd4f[_0x4a18e3(0x234)],'model4Count':_0x25bd4f[_0x4a18e3(0x1f2)],'drawMjCount':_0x25bd4f[_0x4a18e3(0x1e3)]}),await this[_0x4a18e3(0x253)]({'userId':_0x44fa42,'rechargeType':balance_constant_1[_0x4a18e3(0x226)][_0x4a18e3(0x1ed)],'model3Count':_0x25bd4f[_0x4a18e3(0x234)],'model4Count':_0x25bd4f[_0x4a18e3(0x1f2)],'drawMjCount':_0x25bd4f[_0x4a18e3(0x1e3)]}))),await this[_0x4a18e3(0x271)]['save']({'userId':_0x54bc4b,'model3Count':_0x2ea0b8,'model4Count':_0x45f477,'drawMjCount':_0x172bed,'useTokens':0x0});}catch(_0x2f1749){console['log']('error:\x20',_0x2f1749);throw new common_1[(_0x4a18e3(0x1d5))](_0x4a18e3(0x1c8),common_1[_0x4a18e3(0x221)][_0x4a18e3(0x1da)]);}}async['validateBalance'](_0x1e2f0b,_0xb2ea0b,_0x52479d){const _0x3108d6=_0x2ca97f,{id:_0x3e8169,role:_0x40d521}=_0x1e2f0b['user'];let _0x10c29c=await this[_0x3108d6(0x271)][_0x3108d6(0x1df)]({'where':{'userId':_0x3e8169}})[_0x3108d6(0x1d9)](_0x6084ec=>{const _0x312feb=_0x3108d6;common_1[_0x312feb(0x1c7)][_0x312feb(0x1e5)](_0x6084ec);});!_0x10c29c&&(_0x10c29c=await this[_0x3108d6(0x1eb)](_0x3e8169)[_0x3108d6(0x1d9)](_0x5580b4=>{const _0x330f44=_0x3108d6;common_1[_0x330f44(0x1c7)]['error'](_0x5580b4);}));if(_0x40d521===_0x3108d6(0x202))return this['validateVisitorBalance'](_0x1e2f0b,_0xb2ea0b,_0x52479d)['catch'](_0x4fe355=>{const _0x692417=_0x3108d6;common_1[_0x692417(0x1c7)]['error'](_0x4fe355);});const _0x32e592=await this[_0x3108d6(0x27b)]['findOne']({'where':{'configKey':_0x3108d6(0x1fe)}})['catch'](_0x34132=>{const _0x3c167b=_0x3108d6;common_1[_0x3c167b(0x1c7)][_0x3c167b(0x1e5)](_0x34132);}),_0x4c26b2=_0x32e592?_0x32e592['configVal']:_0x3108d6(0x217),_0x39d4b1=_0xb2ea0b===_0x3108d6(0x25c)?_0x3108d6(0x224):_0xb2ea0b===_0x3108d6(0x1f9)?'memberModel4Count':_0xb2ea0b===_0x3108d6(0x242)?_0x3108d6(0x1f6):null,_0x53d6af=_0xb2ea0b===_0x3108d6(0x25c)?_0x3108d6(0x1ee):_0xb2ea0b===_0x3108d6(0x1f9)?_0x3108d6(0x210):_0xb2ea0b===_0x3108d6(0x242)?_0x3108d6(0x24f):null;if(!_0x10c29c)throw new common_1['HttpException'](_0x3108d6(0x264)+_0x4c26b2+_0x3108d6(0x23a),common_1[_0x3108d6(0x221)][_0x3108d6(0x257)]);if(_0x10c29c['packageId']&&_0x10c29c[_0x39d4b1]<_0x52479d){if(_0x10c29c[_0x53d6af]<_0x52479d)throw new common_1[(_0x3108d6(0x1d5))](_0x3108d6(0x264)+_0x4c26b2+_0x3108d6(0x23a),common_1[_0x3108d6(0x221)][_0x3108d6(0x257)]);}if(!_0x10c29c[_0x3108d6(0x205)]&&_0x10c29c[_0x53d6af]<_0x52479d)throw new common_1[(_0x3108d6(0x1d5))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x4c26b2+_0x3108d6(0x23a),common_1[_0x3108d6(0x221)]['PAYMENT_REQUIRED']);return _0x10c29c;}async[_0x2ca97f(0x1f4)](_0x395d07,_0x1637f1,_0x24d76b){const _0x2f5920=_0x2ca97f,{id:_0x412e82}=_0x395d07['user'],_0x1613c3=_0x1637f1===_0x2f5920(0x25c)?_0x2f5920(0x1ee):_0x1637f1===_0x2f5920(0x1f9)?_0x2f5920(0x210):_0x1637f1===_0x2f5920(0x242)?_0x2f5920(0x24f):null,_0x421cfe=await this[_0x2f5920(0x22d)][_0x2f5920(0x1df)]({'where':{'fingerprint':_0x412e82+''}}),{visitorModel3Num:_0x1978f8,visitorModel4Num:_0x3a6aa3,visitorMJNum:_0x478681}=await this[_0x2f5920(0x1cc)][_0x2f5920(0x278)]([_0x2f5920(0x227),_0x2f5920(0x247),'visitorMJNum']),_0x48b21b={'model3Count':_0x1978f8?Number(_0x1978f8):0x0,'model4Count':_0x3a6aa3?Number(_0x3a6aa3):0x0,'drawMjCount':_0x478681?Number(_0x478681):0x0};if(!_0x421cfe){let _0x2a900e={'fingerprint':_0x412e82,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x2a900e[_0x1613c3]=_0x2a900e[_0x1613c3]+_0x24d76b;if(_0x2a900e[_0x1613c3]>_0x48b21b[_0x1613c3])throw new common_1[(_0x2f5920(0x1d5))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0x2f5920(0x221)][_0x2f5920(0x257)]);else return await this[_0x2f5920(0x22d)][_0x2f5920(0x1cd)](_0x2a900e),!![];}else{const {model3Count:_0x1bf024,model4Count:_0x21711f,drawMjCount:_0x2063d3}=_0x421cfe;let _0x261aae={'model3Count':_0x1bf024,'model4Count':_0x21711f,'drawMjCount':_0x2063d3};const _0x3d2993=Number(new Date(_0x421cfe[_0x2f5920(0x1f8)])),_0x5805dd=this[_0x2f5920(0x254)](_0x3d2993);_0x5805dd?_0x261aae[_0x1613c3]=_0x261aae[_0x1613c3]+_0x24d76b:(_0x261aae={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x261aae[_0x1613c3]=_0x261aae[_0x1613c3]+_0x24d76b);if(_0x261aae[_0x1613c3]>_0x48b21b[_0x1613c3])throw new common_1[(_0x2f5920(0x1d5))](_0x2f5920(0x1ea),common_1['HttpStatus'][_0x2f5920(0x257)]);else return await this[_0x2f5920(0x22d)]['update']({'fingerprint':_0x412e82+''},_0x261aae),!![];}}[_0x2ca97f(0x254)](_0x3d27d1){const _0x2ebe0a=_0x2ca97f,_0x2ffe16=new Date(),_0x40faea=new Date(_0x2ffe16[_0x2ebe0a(0x216)](),_0x2ffe16[_0x2ebe0a(0x21a)](),_0x2ffe16[_0x2ebe0a(0x24b)]());return _0x3d27d1>=_0x40faea;}async[_0x2ca97f(0x28a)](_0x20adb7,_0xa08d7a,_0x5b430c,_0x34a0ed=0x0){const _0x419e07=_0x2ca97f,_0x56bd8b=await this[_0x419e07(0x271)][_0x419e07(0x1df)]({'where':{'userId':_0x20adb7}});if(!_0x56bd8b)throw new common_1[(_0x419e07(0x1d5))](_0x419e07(0x21d),common_1['HttpStatus'][_0x419e07(0x1da)]);const _0x55c5f8=_0xa08d7a===_0x419e07(0x25c)?_0x419e07(0x224):_0xa08d7a==='model4'?'memberModel4Count':_0xa08d7a===_0x419e07(0x242)?_0x419e07(0x1f6):null,_0x325afb=_0xa08d7a===_0x419e07(0x25c)?'model3Count':_0xa08d7a===_0x419e07(0x1f9)?'model4Count':_0xa08d7a===_0x419e07(0x242)?'drawMjCount':null,_0x570530=_0x56bd8b['packageId']&&_0x56bd8b[_0x55c5f8]<_0x5b430c?_0x325afb:_0x56bd8b['packageId']?_0x55c5f8:_0x325afb;let _0x2e2f30=null;_0x570530[_0x419e07(0x1d0)](_0x419e07(0x21b))&&(_0x2e2f30=_0x419e07(0x258));_0x570530[_0x419e07(0x1d0)](_0x419e07(0x213))&&(_0x2e2f30='useModel4Token');_0x570530[_0x419e07(0x1d0)](_0x419e07(0x212))&&(_0x2e2f30=_0x419e07(0x285));const _0x48a0f8={[_0x570530]:_0x56bd8b[_0x570530]-_0x5b430c<0x0?0x0:_0x56bd8b[_0x570530]-_0x5b430c,[_0x2e2f30]:_0x56bd8b[_0x2e2f30]+_0x34a0ed};_0x2e2f30===_0x419e07(0x258)&&(_0x48a0f8[_0x419e07(0x22a)]=_0x56bd8b['useModel3Count']+0x1),_0x2e2f30===_0x419e07(0x256)&&(_0x48a0f8[_0x419e07(0x266)]=_0x56bd8b[_0x419e07(0x266)]+0x1);const _0x57ae75=await this[_0x419e07(0x271)][_0x419e07(0x1df)]({'where':{'userId':_0x20adb7}}),_0x484172=await this[_0x419e07(0x271)][_0x419e07(0x267)]({'userId':_0x20adb7},_0x48a0f8),_0x5cd61=await this[_0x419e07(0x271)][_0x419e07(0x1df)]({'where':{'userId':_0x20adb7}}),_0x455e89=await this[_0x419e07(0x245)][_0x419e07(0x1df)]({'where':{'userId':_0x20adb7},'order':{'createdAt':_0x419e07(0x24c)}});if(_0x455e89){const _0x135cdf=new accountLog_entity_1[(_0x419e07(0x26f))]();_0x135cdf[_0x419e07(0x1e1)]=_0x20adb7,_0x135cdf[_0x419e07(0x1d8)]='',_0x135cdf['days']=_0x455e89[_0x419e07(0x20e)],_0x135cdf[_0x419e07(0x1cf)]=balance_constant_1[_0x419e07(0x226)][_0x419e07(0x218)],_0x135cdf[_0x419e07(0x1ee)]=_0x5cd61[_0x419e07(0x224)],_0x135cdf[_0x419e07(0x210)]=_0x5cd61[_0x419e07(0x252)],_0x135cdf[_0x419e07(0x24f)]=_0x5cd61[_0x419e07(0x1f6)],_0x135cdf[_0x419e07(0x21e)]=_0x5cd61[_0x419e07(0x224)]-_0x57ae75[_0x419e07(0x224)],_0x135cdf[_0x419e07(0x24a)]=_0x5cd61[_0x419e07(0x252)]-_0x57ae75[_0x419e07(0x252)],_0x135cdf['drawMjDis']=_0x5cd61['memberDrawMjCount']-_0x57ae75[_0x419e07(0x1f6)],await this[_0x419e07(0x245)][_0x419e07(0x1cd)](_0x135cdf);}if(_0x484172['affected']===0x0)throw new common_1['HttpException'](_0x419e07(0x1ce),common_1[_0x419e07(0x221)][_0x419e07(0x1da)]);return!![];}async[_0x2ca97f(0x23c)](_0x3d38c5,_0x2a86cc){const _0x3f28b9=_0x2ca97f,_0x44fa04=await this[_0x3f28b9(0x271)]['findOne']({'where':{'userId':_0x3d38c5}});if(!_0x44fa04)throw new common_1['HttpException'](_0x3f28b9(0x21d),common_1['HttpStatus']['BAD_REQUEST']);const _0x325832={[_0x3f28b9(0x24f)]:_0x44fa04[_0x3f28b9(0x24f)]+_0x2a86cc,[_0x3f28b9(0x285)]:_0x44fa04[_0x3f28b9(0x285)]-_0x2a86cc},_0x194ad8=await this[_0x3f28b9(0x271)][_0x3f28b9(0x267)]({'userId':_0x3d38c5},_0x325832);if(_0x194ad8[_0x3f28b9(0x243)]===0x0)throw new common_1[(_0x3f28b9(0x1d5))](_0x3f28b9(0x1ce),common_1[_0x3f28b9(0x221)][_0x3f28b9(0x1da)]);}async['queryUserBalance'](_0x18beed){const _0x3af614=_0x2ca97f;try{const _0x1ff8b6=await this[_0x3af614(0x271)][_0x3af614(0x1df)]({'where':{'userId':_0x18beed},'select':[_0x3af614(0x205),_0x3af614(0x1ee),'model4Count','drawMjCount','memberModel3Count',_0x3af614(0x252),'memberDrawMjCount','useModel3Count',_0x3af614(0x266),'useModel3Token',_0x3af614(0x256),_0x3af614(0x285),_0x3af614(0x282)]});if(!_0x1ff8b6){const _0x2610ef=await this[_0x3af614(0x1eb)](_0x18beed);if(_0x2610ef)return await this['queryUserBalance'](_0x18beed);else throw new common_1['HttpException'](_0x3af614(0x246),common_1['HttpStatus'][_0x3af614(0x1da)]);}return _0x1ff8b6[_0x3af614(0x225)]=_0x1ff8b6[_0x3af614(0x205)]?_0x1ff8b6[_0x3af614(0x1ee)]+_0x1ff8b6[_0x3af614(0x224)]:_0x1ff8b6[_0x3af614(0x1ee)],_0x1ff8b6[_0x3af614(0x22f)]=_0x1ff8b6[_0x3af614(0x205)]?_0x1ff8b6[_0x3af614(0x210)]+_0x1ff8b6[_0x3af614(0x252)]:_0x1ff8b6[_0x3af614(0x210)],_0x1ff8b6[_0x3af614(0x1c5)]=_0x1ff8b6[_0x3af614(0x205)]?_0x1ff8b6['drawMjCount']+_0x1ff8b6[_0x3af614(0x1f6)]:_0x1ff8b6[_0x3af614(0x24f)],_0x1ff8b6[_0x3af614(0x282)]=_0x1ff8b6[_0x3af614(0x282)]?(0x0,date_1['formatDate'])(_0x1ff8b6[_0x3af614(0x282)],_0x3af614(0x235)):null,_0x1ff8b6;}catch(_0x40492f){console[_0x3af614(0x284)](_0x3af614(0x269),_0x40492f);}}async[_0x2ca97f(0x253)](_0x1154e0){const _0x791e0=_0x2ca97f,{userId:_0x18a91c,rechargeType:_0xd0afb2,model3Count:_0x4e8953,model4Count:_0x55dca7,drawMjCount:_0x5af485,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x1154e0;if(!_0x18a91c)throw new common_1[(_0x791e0(0x1d5))](_0x791e0(0x1fa),common_1[_0x791e0(0x221)][_0x791e0(0x1da)]);const _0x6e5d7d=(0x0,utils_1[_0x791e0(0x280)])();return await this[_0x791e0(0x245)]['save']({'userId':_0x18a91c,'rechargeType':_0xd0afb2,'model3Count':_0x4e8953,'model4Count':_0x55dca7,'drawMjCount':_0x5af485,'days':days,'extent':extent,'uid':_0x6e5d7d,'pkgName':pkgName});}async['createBaseUserBalance'](_0x4cd484,_0x3faff7={}){const _0x1df53e=_0x2ca97f,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3faff7,_0x247fb0=await this[_0x1df53e(0x271)]['findOne']({'where':{'userId':_0x4cd484}});if(_0x247fb0)throw new common_1[(_0x1df53e(0x1d5))](_0x1df53e(0x203),common_1[_0x1df53e(0x221)][_0x1df53e(0x1da)]);return await this[_0x1df53e(0x271)][_0x1df53e(0x1cd)]({'userId':_0x4cd484,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x5b171c,_0x52578b,_0x279f05=-0x1){const _0x25c50f=_0x2ca97f;try{const _0x578b6c=await this[_0x25c50f(0x271)][_0x25c50f(0x1df)]({'where':{'userId':_0x5b171c}})||await this[_0x25c50f(0x1eb)](_0x5b171c);if(!_0x578b6c)throw new common_1[(_0x25c50f(0x1d5))](_0x25c50f(0x1ff),common_1[_0x25c50f(0x221)][_0x25c50f(0x1da)]);const {model3Count:_0x8bc314,model4Count:_0x49f231,drawMjCount:_0x1195c1,memberModel3Count:_0x1c602d,memberModel4Count:_0x518867,memberDrawMjCount:_0x5df6de}=_0x578b6c;let _0x245bbe={};if(_0x279f05>0x0){const {packageId:_0x4950e4}=_0x52578b;if(!_0x4950e4)throw new common_1[(_0x25c50f(0x1d5))](_0x25c50f(0x1e2),common_1[_0x25c50f(0x221)][_0x25c50f(0x1da)]);const _0x326ebe=await this[_0x25c50f(0x27e)][_0x25c50f(0x1df)]({'where':{'id':_0x4950e4}});if(!_0x326ebe)throw new common_1[(_0x25c50f(0x1d5))](_0x25c50f(0x22c),common_1[_0x25c50f(0x221)][_0x25c50f(0x1da)]);const {weight:_0x34f2fc}=_0x326ebe;if(!_0x578b6c['packageId'])_0x245bbe={'memberModel3Count':_0x8bc314+_0x52578b[_0x25c50f(0x1ee)],'memberModel4Count':_0x49f231+_0x52578b['model4Count'],'memberDrawMjCount':_0x1195c1+_0x52578b[_0x25c50f(0x24f)],'expirationTime':(0x0,date_1[_0x25c50f(0x25a)])()[_0x25c50f(0x275)](_0x279f05>0x0?_0x279f05:0x0,'day')[_0x25c50f(0x26b)](_0x25c50f(0x277)),'packageId':_0x4950e4};else{const _0x347811=await this[_0x25c50f(0x27e)][_0x25c50f(0x1df)]({'where':{'id':_0x578b6c['packageId']}});_0x34f2fc>=_0x347811[_0x25c50f(0x286)]&&(_0x245bbe={'memberModel3Count':_0x1c602d+_0x52578b['model3Count'],'memberModel4Count':_0x518867+_0x52578b[_0x25c50f(0x210)],'memberDrawMjCount':_0x5df6de+_0x52578b['drawMjCount'],'expirationTime':(0x0,date_1['default'])(_0x578b6c[_0x25c50f(0x282)])[_0x25c50f(0x275)](_0x279f05>0x0?_0x279f05:0x0,_0x25c50f(0x23d))[_0x25c50f(0x26b)](_0x25c50f(0x277)),'packageId':_0x4950e4}),_0x34f2fc<_0x347811[_0x25c50f(0x286)]&&(_0x245bbe={'memberModel3Count':_0x1c602d+_0x52578b['model3Count'],'memberModel4Count':_0x518867+_0x52578b[_0x25c50f(0x210)],'memberDrawMjCount':_0x5df6de+_0x52578b[_0x25c50f(0x24f)]});}}_0x279f05<=0x0&&(_0x245bbe={'model3Count':_0x8bc314+_0x52578b[_0x25c50f(0x1ee)],'model4Count':_0x49f231+_0x52578b[_0x25c50f(0x210)],'drawMjCount':_0x1195c1+_0x52578b[_0x25c50f(0x24f)]});const _0x204962=await this[_0x25c50f(0x271)]['update']({'userId':_0x5b171c},_0x245bbe);if(_0x204962['affected']===0x0)throw new common_1[(_0x25c50f(0x1d5))](_0x5b171c+_0x25c50f(0x1f3),common_1['HttpStatus'][_0x25c50f(0x1da)]);}catch(_0x2c0da2){console[_0x25c50f(0x284)](_0x25c50f(0x269),_0x2c0da2);throw new common_1[(_0x25c50f(0x1d5))](_0x25c50f(0x281),common_1[_0x25c50f(0x221)][_0x25c50f(0x1da)]);}}async[_0x2ca97f(0x23b)](_0x2f6cf0){const _0x5301c3=_0x2ca97f;console['log'](_0x5301c3(0x276),_0x2f6cf0);try{const {userId:_0x3d8d76,goodsId:_0x5bd01e}=_0x2f6cf0,_0x8108a9=await this['cramiPackageEntity'][_0x5301c3(0x1df)]({'where':{'id':_0x2f6cf0[_0x5301c3(0x1dd)],'status':0x1}});if(!_0x8108a9)throw new common_1[(_0x5301c3(0x1d5))]('非法操作、当前充值套餐暂不存在！',common_1[_0x5301c3(0x221)][_0x5301c3(0x1da)]);const {model3Count:_0x3d73d7,model4Count:_0x2fe39d,drawMjCount:_0x1becbe,days:_0x529ec4,name:_0x5bdfd9}=_0x8108a9,_0x7c30e1={'model3Count':_0x3d73d7,'model4Count':_0x2fe39d,'drawMjCount':_0x1becbe,'days':_0x529ec4,'packageId':_0x2f6cf0[_0x5301c3(0x1dd)]};await this[_0x5301c3(0x238)](_0x3d8d76,_0x7c30e1,_0x529ec4),await this[_0x5301c3(0x253)]({'userId':_0x3d8d76,'rechargeType':balance_constant_1[_0x5301c3(0x226)][_0x5301c3(0x248)],'model3Count':_0x3d73d7,'model4Count':_0x2fe39d,'drawMjCount':_0x1becbe,'pkgName':_0x5bdfd9,'days':_0x529ec4});const _0x1b2db5=await this[_0x5301c3(0x21c)]['findOne']({'where':{'id':_0x3d8d76}}),{invitedBy:_0x8aaa26}=_0x1b2db5;if(_0x8aaa26){const _0x4e4870=await this['userEntity'][_0x5301c3(0x1df)]({'where':{'inviteCode':_0x8aaa26}}),_0x465a07=await this[_0x5301c3(0x20c)][_0x5301c3(0x1df)]({'where':{'userId':_0x4e4870['id']}});if(!_0x4e4870)return;const {id:_0xe1bfba}=_0x4e4870,{performanceRatio:_0x390dce}=_0x465a07,_0x37c202={'inviterUserId':_0xe1bfba,'inviteeUserId':_0x3d8d76,'orderId':_0x2f6cf0['id'],'orderPrice':_0x2f6cf0[_0x5301c3(0x1f1)],'commissionPercentage':_0x390dce,'commissionAmount':(_0x2f6cf0[_0x5301c3(0x1f1)]*_0x390dce/0x64)[_0x5301c3(0x1d4)](0x2)};await this[_0x5301c3(0x24d)][_0x5301c3(0x24e)](_0x37c202),await this['salesService'][_0x5301c3(0x26d)](_0xe1bfba,_0x37c202[_0x5301c3(0x1c2)]);}}catch(_0x41c2c5){console[_0x5301c3(0x284)](_0x5301c3(0x269),_0x41c2c5);throw new common_1[(_0x5301c3(0x1d5))](_0x5301c3(0x1f5),common_1[_0x5301c3(0x221)]['BAD_REQUEST']);}}async['getRechargeLog'](_0x162f4b,_0x4a6cce){const _0x5ebcd0=_0x2ca97f,{page:page=0x1,size:size=0x14}=_0x4a6cce,{id:_0x225bea}=_0x162f4b[_0x5ebcd0(0x26a)],[_0x4008f,_0x484c56]=await this[_0x5ebcd0(0x245)]['findAndCount']({'where':{'userId':_0x225bea},'order':{'id':_0x5ebcd0(0x24c)},'skip':(page-0x1)*size,'take':size});return _0x4008f[_0x5ebcd0(0x20d)](_0x324a7a=>{const _0x4caaed=_0x5ebcd0;_0x324a7a[_0x4caaed(0x27a)]=_0x324a7a[_0x4caaed(0x20e)]>0x0?_0x324a7a[_0x4caaed(0x20e)]+'天':'永久';}),{'rows':(0x0,date_1[_0x5ebcd0(0x273)])(_0x4008f),'count':_0x484c56};}async[_0x2ca97f(0x239)](_0xe8be96,_0x52cf5f){const _0x16ce71=_0x2ca97f;try{const {page:page=0x1,size:size=0xa,userId:_0x210b78,rechargeType:_0x448883,packageId:_0x44f196}=_0x52cf5f,{role:_0x1e6244}=_0xe8be96[_0x16ce71(0x26a)],_0x3648f0={};_0x448883&&(_0x3648f0[_0x16ce71(0x1cf)]=_0x448883),_0x3648f0['userId']=_0x210b78||(0x0,typeorm_2[_0x16ce71(0x1d1)])(0x186a0),_0x44f196&&(_0x3648f0['packageId']={'$like':'%'+_0x44f196+'%'});const [_0x4a5908,_0xeda7a3]=await this[_0x16ce71(0x245)][_0x16ce71(0x1ec)]({'where':_0x3648f0,'order':{'id':_0x16ce71(0x24c)},'skip':(page-0x1)*size,'take':size}),_0x3712a7=_0x4a5908[_0x16ce71(0x23e)](_0x4866c5=>_0x4866c5[_0x16ce71(0x1e1)]),_0x404652=await this[_0x16ce71(0x21c)][_0x16ce71(0x263)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3712a7)}});return _0x4a5908[_0x16ce71(0x20d)](_0x496e86=>{const _0x4bdd9d=_0x16ce71,_0x46df2a=_0x404652[_0x4bdd9d(0x263)](_0x53dc13=>_0x53dc13['id']===_0x496e86[_0x4bdd9d(0x1e1)]);_0x496e86[_0x4bdd9d(0x228)]=_0x46df2a?.[_0x4bdd9d(0x228)],_0x496e86[_0x4bdd9d(0x249)]=_0x46df2a?.[_0x4bdd9d(0x249)],_0x496e86[_0x4bdd9d(0x26e)]=_0x46df2a?.[_0x4bdd9d(0x26e)],_0x496e86['status']=_0x46df2a?.[_0x4bdd9d(0x1fc)],_0x496e86[_0x4bdd9d(0x219)]=_0x46df2a?.['avatar'];}),_0x1e6244!==_0x16ce71(0x259)&&_0x4a5908[_0x16ce71(0x20d)](_0x2ece2e=>{const _0x2d4b37=_0x16ce71;_0x2ece2e[_0x2d4b37(0x249)]=_0x2ece2e['email']?(0x0,utils_1[_0x2d4b37(0x1d7)])(_0x2ece2e['email']):'',_0x2ece2e[_0x2d4b37(0x26e)]=_0x2ece2e[_0x2d4b37(0x26e)]?(0x0,utils_1['hideString'])(_0x2ece2e[_0x2d4b37(0x26e)]):'';}),{'rows':_0x4a5908,'count':_0xeda7a3};}catch(_0x2d6723){console['log']('error:\x20',_0x2d6723);throw new common_1[(_0x16ce71(0x1d5))](_0x16ce71(0x261),common_1['HttpStatus'][_0x16ce71(0x1da)]);}}async[_0x2ca97f(0x1d3)](_0x49a164){const _0x1250a6=_0x2ca97f;return await this[_0x1250a6(0x271)][_0x1250a6(0x263)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x49a164)}});}async[_0x2ca97f(0x265)](){const _0x3de20e=_0x2ca97f,_0x3a4b61=await this[_0x3de20e(0x21c)][_0x3de20e(0x263)]();if(!_0x3a4b61[_0x3de20e(0x251)])return;const _0x41d376=await this[_0x3de20e(0x1cc)][_0x3de20e(0x278)](['upgradeStatus']);if(!_0x41d376)await this[_0x3de20e(0x1cc)]['setConfig']({'settings':[{'configKey':_0x3de20e(0x1fd),'configVal':'1'}]});else throw new common_1[(_0x3de20e(0x1d5))]('您已经升级过了、请勿重复操作！',common_1['HttpStatus'][_0x3de20e(0x1da)]);_0x3a4b61[_0x3de20e(0x20d)](_0x23cbf7=>{const _0x2bb078=_0x3de20e,{id:_0x293012}=_0x23cbf7;this[_0x2bb078(0x22e)][_0x2bb078(0x1df)]({'where':{'userId':_0x293012}})[_0x2bb078(0x231)](_0x266e30=>{if(!_0x266e30)return;this['writeOldBalanceToNewTable'](_0x293012,_0x266e30);});});}async['writeOldBalanceToNewTable'](_0x267aa8,_0x330745){const _0x224814=_0x2ca97f,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x330745,_0x87f0bb=await this['whiteListEntity'][_0x224814(0x1df)]({'where':{'userId':_0x267aa8}}),_0x434ccb={'userId':_0x267aa8,'model3Count':Number(usesLeft),'model4Count':_0x87f0bb?.[_0x224814(0x229)]||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':_0x87f0bb?.[_0x224814(0x237)]||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x4321e5=await this[_0x224814(0x271)][_0x224814(0x1df)]({'where':{'userId':_0x267aa8}});_0x4321e5?common_1['Logger'][_0x224814(0x1fb)]('用户'+_0x267aa8+_0x224814(0x233),_0x224814(0x1ca)):this[_0x224814(0x271)][_0x224814(0x1cd)](_0x434ccb)[_0x224814(0x231)](_0x2e9a44=>{const _0x480ef2=_0x224814;common_1['Logger'][_0x480ef2(0x1fb)]('用户'+_0x267aa8+'旧账户信息迁移成功','BalanceService');})['catch'](_0x58810c=>{const _0x4c8c47=_0x224814;console['log'](_0x4c8c47(0x269),_0x58810c),common_1['Logger'][_0x4c8c47(0x1fb)]('用户'+_0x267aa8+_0x4c8c47(0x268),_0x4c8c47(0x1ca));});}async['inheritVisitorData'](_0x78f85d){const _0x998d0e=_0x2ca97f,{fingerprint:_0x52e9dc}=_0x78f85d[_0x998d0e(0x222)],{id:_0x3fa5ff}=_0x78f85d[_0x998d0e(0x26a)];return await this[_0x998d0e(0x1c4)][_0x998d0e(0x267)]({'userId':Number(_0x52e9dc)},{'userId':_0x3fa5ff}),await this[_0x998d0e(0x25e)][_0x998d0e(0x267)]({'userId':Number(_0x52e9dc)},{'userId':_0x3fa5ff}),await this[_0x998d0e(0x1e4)]['update']({'userId':Number(_0x52e9dc)},{'userId':_0x3fa5ff}),0x1;}async[_0x2ca97f(0x208)](_0x56e216){const _0x47b3c2=_0x2ca97f,{fingerprint:_0x35e963}=_0x56e216[_0x47b3c2(0x222)],_0x4e16db=await this[_0x47b3c2(0x1c4)][_0x47b3c2(0x229)]({'where':{'userId':_0x35e963}}),_0x144461=await this[_0x47b3c2(0x25e)]['count']({'where':{'userId':_0x35e963}}),_0x26047a=await this[_0x47b3c2(0x1e4)][_0x47b3c2(0x229)]({'where':{'userId':_0x35e963}});return _0x4e16db||_0x144461||_0x26047a||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x2ca97f(0x201)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1[_0x2ca97f(0x1e0)])),__param(0x1,(0x0,typeorm_1[_0x2ca97f(0x250)])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1[_0x2ca97f(0x250)])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x2ca97f(0x250)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x4,(0x0,typeorm_1[_0x2ca97f(0x250)])(config_entity_1[_0x2ca97f(0x23f)])),__param(0x5,(0x0,typeorm_1[_0x2ca97f(0x250)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1[_0x2ca97f(0x250)])(salesUsers_entity_1[_0x2ca97f(0x211)])),__param(0x7,(0x0,typeorm_1[_0x2ca97f(0x250)])(whiteList_entity_1[_0x2ca97f(0x1ef)])),__param(0x8,(0x0,typeorm_1[_0x2ca97f(0x250)])(fingerprint_entity_1[_0x2ca97f(0x223)])),__param(0x9,(0x0,typeorm_1[_0x2ca97f(0x250)])(chatGroup_entity_1[_0x2ca97f(0x220)])),__param(0xa,(0x0,typeorm_1[_0x2ca97f(0x250)])(chatLog_entity_1[_0x2ca97f(0x1d6)])),__param(0xb,(0x0,typeorm_1[_0x2ca97f(0x250)])(midjourney_entity_1['MidjourneyEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x2ca97f(0x25b)],typeorm_2[_0x2ca97f(0x25b)],typeorm_2[_0x2ca97f(0x25b)],typeorm_2[_0x2ca97f(0x25b)],typeorm_2[_0x2ca97f(0x25b)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x2ca97f(0x25b)],typeorm_2['Repository'],typeorm_2[_0x2ca97f(0x25b)],typeorm_2[_0x2ca97f(0x25b)],typeorm_2['Repository'],sales_service_1['SalesService'],globalConfig_service_1['GlobalConfigService']])],UserBalanceService),exports[_0x2ca97f(0x241)]=UserBalanceService;